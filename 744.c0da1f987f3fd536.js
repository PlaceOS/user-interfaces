"use strict";(self.webpackChunkconcierge=self.webpackChunkconcierge||[]).push([[744],{1744:(q,k,a)=>{a.r(k),a.d(k,{COMPONENTS:()=>te,StaffModule:()=>ee});var p=a(177),c=a(9417),I=a(3141),d=a(467),V=a(8390),_=a(9928),b=a(9714),y=a(7915),g=a(5006),F=a(9090),f=a(8712),Y=a(3888),tt=a(3636),B=a(7383),u=a(2333),T=a(2185),t=a(4438);let E=(()=>{class s extends u.Tv{constructor(e){var n;super(),n=this,this._org=e,this._onsite={},this._events={},this._filters=new _.t({}),this._search=new _.t(""),this._loading=new _.t(!1),this._users=new _.t([]),this.loading=this._loading.asObservable(),this.filters=this._filters.asObservable(),this.users=this._filters.asObservable(),this.filtered_users=(0,b.zV)([this._search,this._users,this._filters]).pipe((0,g.T)(o=>{const[i,l,m]=o;return l.filter(v=>(!i||v.name.toLowerCase().includes(i)||v.email.toLowerCase().includes(i))&&(!m.only_onsite||this._onsite[v.email]))})),this.user_events=(0,b.zV)([this._filters]).pipe((0,F.n)(function(){var o=(0,d.A)(function*(i){n._loading.next(!0);const l=yield(0,y.tj)({period_start:(0,Y.A)((0,tt.A)(Date.now())),period_end:(0,Y.A)((0,B.A)(Date.now())),type:"staff"}).toPromise(),m={},v=(new Date).valueOf();for(const x of l)(0,u.dH)(v,v,x.date,x.date+60*x.duration*1e3)&&(m[x.asset_id]=x.checked_in,n._events[x.asset_id]=x);return n._onsite=m,n._loading.next(!1),m});return function(i){return o.apply(this,arguments)}}()),(0,f.t)(1)),this.loadUsers(),this.user_events.subscribe()}setFilters(e){this._filters.next({...this._filters.getValue(),...e})}setSearchString(e){this._search.next(e)}startPolling(e=3e4){this.setFilters(this._filters.getValue()),this.interval("poll",()=>this.setFilters(this._filters.getValue()),e)}stopPolling(){this.clearInterval("poll")}checkin(e){var n=this;return(0,d.A)(function*(){const o=yield(0,y.X0)({booking_start:Math.floor((new Date).valueOf()/1e3),booking_end:Math.floor((0,B.A)(new Date).valueOf()/1e3),asset_id:e.email,title:"Checked-in Onsite",description:n._org.building.display_name||n._org.building.name,zones:[n._org.building.id],booking_type:"staff"}).toPromise();yield(0,y.Z$)(o.id,!0).toPromise(),n._events[e.email]=o,n._onsite[e.email]=!0})()}checkout(e){var n=this;return(0,d.A)(function*(){const o=n._events[e.email];if(o){const i=yield(0,y.X0)({...o.toJSON(),booking_end:Math.floor((new Date).valueOf()/1e3)}).toPromise();yield(0,y.Z$)(i.id,!1).toPromise(),n._events[e.email]=i,n._onsite[e.email]=!1}})()}loadUsers(){var e=this;return(0,d.A)(function*(){const n=yield(0,V.N8)("").toPromise();n.sort((o,i)=>o.name.localeCompare(i.name)),e._users.next(n)})()}static#t=this.\u0275fac=function(n){return new(n||s)(t.KVO(T.yb))};static#e=this.\u0275prov=t.jDH({token:s,factory:s.\u0275fac,providedIn:"root"})}return s})();var et=a(4605),$=a(7575),nt=a(4046),ot=a(2236),M=a(3719),N=a(2798),C=a(6600),st=a(450);function it(s,r){if(1&s&&(t.j41(0,"mat-option",8),t.EFF(1),t.k0s()),2&s){const e=r.$implicit;t.Y8G("value",e.id),t.R7$(),t.SpI(" ",e.display_name||e.name," ")}}let w=(()=>{class s extends u.Tv{constructor(e,n,o,i){super(),this._state=e,this._org=n,this._route=o,this._router=i,this.zones=[],this.levels=this._org.active_levels,this.filters=this._state.filters,this.setDate=l=>this._state.setFilters({date:l}),this.setFilters=l=>this._state.setFilters(l),this.setSearch=l=>this._state.setSearchString(l),this.updateZones=l=>{this._router.navigate([],{relativeTo:this._route,queryParams:{zone_ids:l.join(",")}}),this._state.setFilters({zones:l})}}ngOnInit(){var e=this;return(0,d.A)(function*(){yield e._org.initialised.pipe((0,nt.$)(n=>n)).toPromise(),e.subscription("route.query",e._route.queryParamMap.subscribe(n=>{if(n.has("zone_ids")){const o=n.get("zone_ids").split(",");if(o.length){const i=e._org.levelWithID(o);if(!i)return;e._org.building=e._org.buildings.find(l=>l.id===i.parent_id),e.zones=o}}})),e.subscription("levels",e._org.active_levels.subscribe(n=>{e.zones=e.zones.filter(o=>n.find(i=>i.id===o)),!e.zones.length&&n.length&&e.zones.push(n[0].id),e.updateZones(e.zones)})),e.setSearch("")})()}static#t=this.\u0275fac=function(n){return new(n||s)(t.rXU(E),t.rXU(T.yb),t.rXU(I.nX),t.rXU(I.Ix))};static#e=this.\u0275cmp=t.VBU({type:s,selectors:[["staff-topbar"]],features:[t.Vt3],decls:11,vars:7,consts:[[1,"flex","items-center","bg-base-100","h-20","px-4","border-b","border-base-200","space-x-2"],["appearance","outline"],["multiple","","placeholder","All Levels",3,"ngModelChange","ngModel"],[3,"value",4,"ngFor","ngForOf"],[1,"m-2",3,"ngModelChange","ngModel"],[1,"text-xs"],[1,"flex-1","w-2"],[1,"mr-2",3,"modelChange"],[3,"value"]],template:function(n,o){if(1&n&&(t.j41(0,"div",0)(1,"mat-form-field",1)(2,"mat-select",2),t.mxI("ngModelChange",function(l){return t.DH7(o.zones,l)||(o.zones=l),l}),t.bIt("ngModelChange",function(l){return o.updateZones(l)}),t.DNE(3,it,2,2,"mat-option",3),t.nI1(4,"async"),t.k0s()(),t.j41(5,"mat-slide-toggle",4),t.nI1(6,"async"),t.bIt("ngModelChange",function(l){return o.setFilters({only_onsite:l})}),t.j41(7,"div",5),t.EFF(8,"Onsite Only"),t.k0s()(),t.nrm(9,"div",6),t.j41(10,"searchbar",7),t.bIt("modelChange",function(l){return o.setSearch(l)}),t.k0s()()),2&n){let i;t.R7$(2),t.R50("ngModel",o.zones),t.R7$(),t.Y8G("ngForOf",t.bMT(4,3,o.levels)),t.R7$(2),t.Y8G("ngModel",null==(i=t.bMT(6,5,o.filters))?null:i.only_onsite)}},dependencies:[p.Sq,c.BC,c.vS,ot.x,M.rl,N.VO,C.wT,st.sG,p.Jj],styles:["mat-form-field[_ngcontent-%COMP%]{height:3.25em;width:8em}"]})}return s})();var P=a(4823),at=a(8157),S=a(9434),lt=a(1193);function rt(s,r){1&s&&(t.j41(0,"div",11),t.EFF(1,"Onsite"),t.k0s())}function ct(s,r){if(1&s){const e=t.RV6();t.j41(0,"div",1),t.nrm(1,"a-user-avatar",2),t.j41(2,"div",3)(3,"div",4),t.EFF(4),t.k0s(),t.j41(5,"div",5),t.EFF(6),t.k0s()(),t.DNE(7,rt,2,0,"div",6),t.j41(8,"div",7)(9,"action-icon",8),t.bIt("click",function(){t.eBV(e);const o=t.XpG();return t.Njj(o.onsite?o.checkout():o.checkin())}),t.k0s(),t.j41(10,"a",9)(11,"app-icon"),t.EFF(12,"email"),t.k0s()(),t.j41(13,"a",10)(14,"app-icon"),t.EFF(15,"call"),t.k0s()()()()}if(2&s){const e=t.XpG();t.R7$(),t.Y8G("user",e.user),t.R7$(3),t.JRh(null==e.user?null:e.user.name),t.R7$(2),t.SpI(" ",null==e.user?null:e.user.email," "),t.R7$(),t.Y8G("ngIf",e.onsite),t.R7$(2),t.Y8G("matTooltip",e.onsite?"Checkout Staff":"Checkin Staff")("loading",e.loading)("content",e.onsite?"event_busy":"event_available"),t.R7$(),t.Y8G("href","mailto:"+(null==e.user?null:e.user.email),t.B4B),t.BMQ("disabled",!(null!=e.user&&e.user.email)),t.R7$(3),t.Y8G("href","tel:"+(null==e.user?null:e.user.phone),t.B4B),t.BMQ("disabled",!(null!=e.user&&e.user.phone))}}let z=(()=>{class s{constructor(e){var n=this;this._state=e,this.checkin=(0,d.A)(function*(){n.loading=!0,yield n._state.checkin(n.user).catch(o=>(0,u.UG)("Error checking in Staff member")),n.loading=!1}),this.checkout=(0,d.A)(function*(){n.loading=!0,yield n._state.checkout(n.user).catch(o=>(0,u.UG)("Error checking out Staff member")),n.loading=!1})}static#t=this.\u0275fac=function(n){return new(n||s)(t.rXU(E))};static#e=this.\u0275cmp=t.VBU({type:s,selectors:[["staff-details"]],inputs:{user:"user",onsite:"onsite"},decls:1,vars:1,consts:[["class","w-full flex items-center px-4 py-2 bg-base-100 border-b border-base-200 hover:opacity-80","details","",4,"ngIf"],["details","",1,"w-full","flex","items-center","px-4","py-2","bg-base-100","border-b","border-base-200","hover:opacity-80"],[3,"user"],[1,"flex","flex-col","flex-1"],[1,"px-2"],[1,"px-2","text-xs","text-opacity-50"],["class","text-xs opacity-50 px-4",4,"ngIf"],[1,"flex","items-center"],[3,"click","matTooltip","loading","content"],["icon","","matRipple","","matTooltip","Email Staff",3,"href"],["icon","","matRipple","","matTooltip","Phone Staff",3,"href"],[1,"text-xs","opacity-50","px-4"]],template:function(n,o){1&n&&t.DNE(0,ct,16,11,"div",0),2&n&&t.Y8G("ngIf",o.user)},dependencies:[p.bT,P.oV,C.r6,at.X,S.R,lt.a]})}return s})();const mt=["container"];function pt(s,r){if(1&s){const e=t.RV6();t.j41(0,"div",7),t.nI1(1,"async"),t.bIt("click",function(){const o=t.eBV(e).$implicit,i=t.XpG();return t.Njj(i.scrollTo(o))}),t.EFF(2),t.k0s()}if(2&s){const e=r.$implicit,n=t.XpG();t.AVh("disabled",t.bMT(1,5,n.user_list)[e].length<=0)("active",e===n.active_group),t.R7$(2),t.SpI(" ",e," ")}}function ft(s,r){if(1&s&&(t.nrm(0,"staff-details",12),t.nI1(1,"async"),t.nI1(2,"async")),2&s){const e=r.$implicit,n=r.index,o=t.XpG(2).$implicit,i=t.XpG(2);t.Y8G("id","letter-"+o+"-"+n)("user",e)("onsite",!!t.bMT(1,3,i.events)&&t.bMT(2,5,i.events)[e.email])}}function dt(s,r){if(1&s&&(t.qex(0),t.j41(1,"div",10),t.EFF(2),t.k0s(),t.DNE(3,ft,3,7,"staff-details",11),t.nI1(4,"async"),t.bVm()),2&s){const e=t.XpG().$implicit,n=t.XpG(2);t.R7$(),t.Y8G("id","letter-"+("#"===e?"0":e)),t.R7$(),t.SpI(" ",e," "),t.R7$(),t.Y8G("ngForOf",t.bMT(4,3,n.user_list)[e])}}function gt(s,r){if(1&s&&(t.qex(0),t.DNE(1,dt,5,5,"ng-container",9),t.nI1(2,"async"),t.bVm()),2&s){const e=r.$implicit,n=t.XpG(2);t.R7$(),t.Y8G("ngIf",t.bMT(2,1,n.user_list)[e].length)}}function ut(s,r){if(1&s&&(t.qex(0),t.DNE(1,gt,3,3,"ng-container",8),t.bVm()),2&s){const e=t.XpG();t.R7$(),t.Y8G("ngForOf",e.groups)}}function _t(s,r){1&s&&t.nrm(0,"mat-progress-bar",13)}function ht(s,r){1&s&&(t.j41(0,"div",14)(1,"p"),t.EFF(2,"No matching staff members"),t.k0s()())}const G="#abcdefghijklmnopqrstuvwxyz".split("");let O=(()=>{class s extends u.Tv{constructor(e){super(),this._state=e,this.active_group="#",this.groups=G,this.events=this._state.user_events,this.loading=this._state.loading,this.user_count=this._state.filtered_users.pipe((0,g.T)(n=>n.length)),this.user_list=this._state.filtered_users.pipe((0,g.T)(n=>{const o={};for(const i of G)o[i]=(n||[]).filter(l=>l.name.toLowerCase()[0].startsWith(i)||"#"===i&&!G.includes(l.name.toLowerCase()[0]));return this.timeout("scroll",()=>this.onScroll({}),30),o}))}onScroll(e){const n=this._el.nativeElement.scrollTop;for(const o of G){const i=document.querySelector(`#letter-${"#"===o?"0":o}`);if(i){if(i.offsetTop-n>0)break;this.active_group=o}}}scrollTo(e){const n=document.querySelector(`#letter-${e}-0`);n&&(n.scrollIntoView({behavior:"smooth",block:"center"}),this.active_group=e)}static#t=this.\u0275fac=function(n){return new(n||s)(t.rXU(E))};static#e=this.\u0275cmp=t.VBU({type:s,selectors:[["staff-listings"]],viewQuery:function(n,o){if(1&n&&t.GBs(mt,5),2&n){let i;t.mGM(i=t.lsd())&&(o._el=i.first)}},features:[t.Vt3],decls:10,vars:8,consts:[["container",""],["empty_state",""],[1,"w-full","p-2","flex","items-center","justify-center"],["letter","","class","capitalize h-6 w-6 flex items-center justify-center text-xs cursor-pointer",3,"disabled","active","click",4,"ngFor","ngForOf"],[1,"flex-1","overflow-auto","w-full","relative","bg-base-200",2,"height","50%",3,"scroll"],[4,"ngIf","ngIfElse"],["mode","indeterminate",4,"ngIf"],["letter","",1,"capitalize","h-6","w-6","flex","items-center","justify-center","text-xs","cursor-pointer",3,"click"],[4,"ngFor","ngForOf"],[4,"ngIf"],["group","",1,"capitalize","bg-base-200","border-b","text-sm","font-medium","sticky","top-0","z-10",3,"id"],[3,"id","user","onsite",4,"ngFor","ngForOf"],[3,"id","user","onsite"],["mode","indeterminate"],[1,"absolute","inset-0","flex","flex-col","items-center","justify-center"]],template:function(n,o){if(1&n){const i=t.RV6();t.j41(0,"div",2),t.DNE(1,pt,3,7,"div",3),t.k0s(),t.j41(2,"div",4,0),t.bIt("scroll",function(m){return t.eBV(i),t.Njj(o.onScroll(m))}),t.DNE(4,ut,2,1,"ng-container",5),t.nI1(5,"async"),t.k0s(),t.DNE(6,_t,1,0,"mat-progress-bar",6),t.nI1(7,"async"),t.DNE(8,ht,3,0,"ng-template",null,1,t.C5r)}if(2&n){const i=t.sdS(9);t.R7$(),t.Y8G("ngForOf",o.groups),t.R7$(3),t.Y8G("ngIf",t.bMT(5,4,o.user_count))("ngIfElse",i),t.R7$(2),t.Y8G("ngIf",t.bMT(7,6,o.loading))}},dependencies:[p.Sq,p.bT,$.HM,z,p.Jj],styles:["[_nghost-%COMP%]{display:flex;flex-direction:column;width:100%;height:50%}[letter][_ngcontent-%COMP%]{transition:font-size .2s,color .2s}[group][_ngcontent-%COMP%]{border-color:#ccc;padding:.5rem 1.65rem}.disabled[_ngcontent-%COMP%]{opacity:.2;pointer-events:none}.active[_ngcontent-%COMP%]{font-size:1.25rem;opacity:1;color:#d81b60}"]})}return s})();const vt=["app-staff",""];function bt(s,r){1&s&&t.nrm(0,"mat-progress-bar",4)}let U=(()=>{class s{constructor(e){this._state=e,this.loading=this._state.loading}ngOnInit(){this._state.startPolling()}ngOnDestroy(){this._state.stopPolling()}static#t=this.\u0275fac=function(n){return new(n||s)(t.rXU(E))};static#e=this.\u0275cmp=t.VBU({type:s,selectors:[["","app-staff",""]],attrs:vt,decls:6,vars:3,consts:[[1,"relative","overflow-hidden","flex-1","flex","flex-col"],[1,"w-full"],[1,"w-full","flex-1","h-0"],["class","w-full","mode","indeterminate",4,"ngIf"],["mode","indeterminate",1,"w-full"]],template:function(n,o){1&n&&(t.nrm(0,"sidebar"),t.j41(1,"main",0),t.nrm(2,"staff-topbar",1)(3,"staff-listings",2),t.DNE(4,bt,1,0,"mat-progress-bar",3),t.nI1(5,"async"),t.k0s()),2&n&&(t.R7$(4),t.Y8G("ngIf",t.bMT(5,1,o.loading)))},dependencies:[p.bT,et.k,$.HM,w,O,p.Jj],styles:["[_nghost-%COMP%]{display:flex;height:100%;width:100%;background:var(--b1)}"]})}return s})();var yt=a(363),A=a(5189),L=a(6843);const Ct=["app-new-staff",""];function xt(s,r){1&s&&t.nrm(0,"mat-progress-bar",5)}let J=(()=>{class s{constructor(e){this._state=e,this.loading=this._state.loading}ngOnInit(){this._state.startPolling()}ngOnDestroy(){this._state.stopPolling()}static#t=this.\u0275fac=function(n){return new(n||s)(t.rXU(E))};static#e=this.\u0275cmp=t.VBU({type:s,selectors:[["","app-new-staff",""]],attrs:Ct,decls:8,vars:3,consts:[[1,"flex","flex-1","h-px"],[1,"flex","flex-col","flex-1","w-1/2","h-full"],[1,"w-full"],[1,"w-full","flex-1","h-0"],["class","w-full","mode","indeterminate",4,"ngIf"],["mode","indeterminate",1,"w-full"]],template:function(n,o){1&n&&(t.nrm(0,"app-topbar"),t.j41(1,"div",0),t.nrm(2,"app-sidebar"),t.j41(3,"main",1),t.nrm(4,"staff-topbar",2)(5,"staff-listings",3),t.DNE(6,xt,1,0,"mat-progress-bar",4),t.nI1(7,"async"),t.k0s()()),2&n&&(t.R7$(6),t.Y8G("ngIf",t.bMT(7,1,o.loading)))},dependencies:[p.bT,A.S,L.c,$.HM,w,O,p.Jj],styles:["[_nghost-%COMP%]{display:flex;flex-direction:column;height:100%;width:100%;background-color:var(--b1)}"]})}return s})();var h=a(9596),D=a(8728),R=a(9493),j=a(4006),H=a(6815),X=a(9631),jt=a(9183),Ft=a(8e3),Z=a(2238);const Tt=()=>({standalone:!0}),Et=()=>[];function Mt(s,r){1&s&&(t.j41(0,"button",6)(1,"app-icon"),t.EFF(2,"close"),t.k0s()())}function Rt(s,r){if(1&s&&(t.j41(0,"mat-option",27),t.EFF(1),t.k0s()),2&s){const e=r.$implicit;t.Y8G("value",e.id),t.R7$(),t.SpI(" ",e.display_name||e.name," ")}}function kt(s,r){if(1&s&&(t.j41(0,"mat-option",27),t.EFF(1),t.k0s()),2&s){const e=t.XpG().$implicit;t.Y8G("value",e),t.R7$(),t.SpI(" ",e," ")}}function It(s,r){if(1&s&&(t.qex(0),t.DNE(1,kt,2,2,"mat-option",28),t.bVm()),2&s){const e=r.$implicit;t.R7$(),t.Y8G("ngIf",e)}}function St(s,r){if(1&s){const e=t.RV6();t.j41(0,"main",7)(1,"form",8)(2,"a-user-search-field",9),t.bIt("ngModelChange",function(o){t.eBV(e);const i=t.XpG();return t.Njj(i.setUser(o))}),t.k0s(),t.j41(3,"div",10)(4,"label",11),t.EFF(5,"Name:"),t.k0s(),t.j41(6,"mat-form-field",12),t.nrm(7,"input",13),t.k0s()(),t.j41(8,"div",14)(9,"div",15)(10,"label",16),t.EFF(11,"Email:"),t.k0s(),t.j41(12,"mat-form-field",12),t.nrm(13,"input",17),t.k0s()(),t.j41(14,"div",15)(15,"label",16),t.EFF(16,"Phone:"),t.k0s(),t.j41(17,"mat-form-field",12),t.nrm(18,"input",18),t.k0s()()(),t.j41(19,"div",10)(20,"label",11),t.EFF(21,"Level:"),t.k0s(),t.j41(22,"mat-form-field",12)(23,"mat-select",19)(24,"mat-option",20),t.EFF(25,"All Levels"),t.k0s(),t.DNE(26,Rt,2,2,"mat-option",21),t.nI1(27,"async"),t.k0s()()(),t.j41(28,"div",10)(29,"label",16),t.EFF(30,"Roles:"),t.k0s(),t.j41(31,"div",14)(32,"mat-form-field",22)(33,"mat-select",23),t.DNE(34,It,2,1,"ng-container",24),t.nI1(35,"async"),t.k0s()(),t.j41(36,"button",25)(37,"app-icon"),t.EFF(38,"add"),t.k0s(),t.j41(39,"div",26),t.EFF(40,"Add New Role"),t.k0s()()()()()()}if(2&s){let e;const n=t.XpG(),o=t.sdS(10);t.R7$(),t.Y8G("formGroup",n.form),t.R7$(),t.Y8G("ngModelOptions",t.lJ4(9,Tt)),t.R7$(24),t.Y8G("ngForOf",t.bMT(27,5,n.levels)),t.R7$(8),t.Y8G("ngForOf",(null==(e=t.bMT(35,7,n.data))?null:e.roles)||t.lJ4(10,Et)),t.R7$(2),t.Y8G("content",o)}}function Gt(s,r){if(1&s){const e=t.RV6();t.j41(0,"footer",29)(1,"button",30),t.bIt("click",function(){t.eBV(e);const o=t.XpG();return t.Njj(o.save())}),t.EFF(2,"Save"),t.k0s()()}}function Vt(s,r){1&s&&(t.j41(0,"main",31),t.nrm(1,"mat-spinner",32),t.j41(2,"p"),t.EFF(3,"Saving contact details..."),t.k0s()()),2&s&&(t.R7$(),t.Y8G("diameter",48))}function $t(s,r){if(1&s){const e=t.RV6();t.j41(0,"div",33)(1,"mat-form-field",12)(2,"input",34),t.mxI("ngModelChange",function(o){t.eBV(e);const i=t.XpG();return t.DH7(i.role_name,o)||(i.role_name=o),t.Njj(o)}),t.k0s()(),t.j41(3,"button",35),t.bIt("click",function(){t.eBV(e);const o=t.XpG();return t.Njj(o.addRole())}),t.EFF(4," Save Role "),t.k0s()()}if(2&s){const e=t.XpG();t.R7$(2),t.R50("ngModel",e.role_name)}}let Q=(()=>{class s{constructor(e,n,o){this._data=e,this._dialog_ref=n,this._org=o,this._changes=new _.t(0),this.loading=!1,this.contact=this._data,this.data=(0,b.zV)([this._org.active_building,this._changes]).pipe((0,D.p)(([i])=>!!i),(0,F.n)(([i])=>(0,h.bpY)(i.id,"emergency_contacts")),(0,g.T)(({details:i})=>i||{roles:[],contacts:[]}),(0,f.t)(1)),this.form=new c.gE({id:new c.MJ(this._data?.id||`ecntct-${(0,u.DU)(8)}`),name:new c.MJ(this._data?.name||""),email:new c.MJ(this._data?.email||""),phone:new c.MJ(this._data?.phone||""),zone:new c.MJ(this._data?.zone||""),roles:new c.MJ(this._data?.roles||[])}),this.levels=this._org.active_levels}addRole(){var e=this;return(0,d.A)(function*(){if(!e.role_name)return;e._tooltip.close(),e.loading=!0,e._dialog_ref.disableClose=!0;const n=yield e.data.pipe((0,R.s)(1)).toPromise();yield(0,h.D58)(e._org.building.id,{name:"emergency_contacts",description:"Emergency Contacts",details:{roles:[...n.roles||[],e.role_name].filter(o=>!!o),contacts:n.contacts}}).toPromise(),e._changes.next(0),e.form.patchValue({roles:[...e.form.value.roles||[],e.role_name]}),e.role_name="",e.loading=!1,e._dialog_ref.disableClose=!1})()}setUser(e){this.form.patchValue({name:e?.name,email:e?.email,phone:e?.phone})}save(){var e=this;return(0,d.A)(function*(){e.loading=!0,e._dialog_ref.disableClose=!0;const n=yield e.data.pipe((0,R.s)(1)).toPromise(),i=[...(n?.contacts||[]).filter(l=>l.id!==e.contact?.id),e.form.value].sort((l,m)=>l.name.localeCompare(m.name));yield(0,h.D58)(e._org.building.id,{name:"emergency_contacts",description:"Emergency Contacts",details:{roles:n.roles||[],contacts:i}}).toPromise(),e._dialog_ref.disableClose=!0,(0,u.VX)("Successfully updated emergency contacts."),e.loading=!1,e._dialog_ref.close()})()}static#t=this.\u0275fac=function(n){return new(n||s)(t.rXU(j.Vh),t.rXU(j.CP),t.rXU(T.yb))};static#e=this.\u0275cmp=t.VBU({type:s,selectors:[["emergency-contact-modal"]],viewQuery:function(n,o){if(1&n&&t.GBs(H.In,5),2&n){let i;t.mGM(i=t.lsd())&&(o._tooltip=i.first)}},decls:11,vars:5,consts:[["load_state",""],["role_form",""],[1,"flex-1","w-0"],["icon","","mat-dialog-close","",4,"ngIf"],["class","p-4 w-[36rem]",4,"ngIf","ngIfElse"],["class","flex justify-center items-center p-2 border-t border-base-200",4,"ngIf"],["icon","","mat-dialog-close",""],[1,"p-4","w-[36rem]"],[1,"space-y-4",3,"formGroup"],["ngModel","",1,"mb-4",3,"ngModelChange","ngModelOptions"],[1,"flex","flex-col"],["for","name"],["appearance","outline"],["matInput","","formControlName","name","placeholder","Full name"],[1,"flex","items-center","space-x-2"],[1,"flex","flex-col","flex-1"],["for","email"],["matInput","","formControlName","email","type","email","placeholder","Email address"],["matInput","","formControlName","phone","type","tel","placeholder","Emergency contact number"],["formControlName","zone","placeholder","All Levels"],["value",""],[3,"value",4,"ngFor","ngForOf"],["appearance","outline",1,"no-subscript","flex-1"],["multiple","","formControlName","roles","placeholder","Select roles"],[4,"ngFor","ngForOf"],["btn","","matRipple","","customTooltip","",1,"space-x-2",3,"content"],[1,"pr-2"],[3,"value"],[3,"value",4,"ngIf"],[1,"flex","justify-center","items-center","p-2","border-t","border-base-200"],["btn","","matRipple","",1,"w-32",3,"click"],["loading","",1,"h-64","flex","flex-col","items-center","justify-center"],[1,"mb-4",3,"diameter"],[1,"bg-base-100","p-4","rounded"],["matInput","","placeholder","Role name",3,"ngModelChange","ngModel"],["btn","","matRipple","",1,"w-full",3,"click"]],template:function(n,o){if(1&n&&(t.j41(0,"header")(1,"h2"),t.EFF(2),t.k0s(),t.nrm(3,"div",2),t.DNE(4,Mt,3,0,"button",3),t.k0s(),t.DNE(5,St,41,11,"main",4)(6,Gt,3,0,"footer",5)(7,Vt,4,1,"ng-template",null,0,t.C5r)(9,$t,5,1,"ng-template",null,1,t.C5r)),2&n){const i=t.sdS(8);t.R7$(2),t.SpI("",o.contact?"Edit":"New"," Emergency Contact"),t.R7$(2),t.Y8G("ngIf",!o.loading),t.R7$(),t.Y8G("ngIf",!o.loading)("ngIfElse",i),t.R7$(),t.Y8G("ngIf",!o.loading)}},dependencies:[p.Sq,p.bT,c.qT,c.me,c.BC,c.cb,c.vS,M.rl,X.fg,N.VO,C.wT,jt.LG,j.tx,C.r6,c.j4,c.JD,Ft.$,S.R,Z.I,p.Jj]})}return s})();function Nt(s,r){if(1&s){const e=t.RV6();t.qex(0),t.j41(1,"div",6)(2,"div",7),t.EFF(3),t.k0s(),t.j41(4,"button",8),t.bIt("click",function(){const o=t.eBV(e).$implicit,i=t.XpG();return i.active=o,t.Njj(i.role_name=o)}),t.j41(5,"app-icon"),t.EFF(6,"edit"),t.k0s()(),t.j41(7,"button",9),t.bIt("click",function(){const o=t.eBV(e).$implicit,i=t.XpG();return t.Njj(i.removeRole(o))}),t.j41(8,"app-icon"),t.EFF(9,"delete"),t.k0s()()(),t.bVm()}if(2&s){const e=r.$implicit;t.XpG();const n=t.sdS(15);t.R7$(3),t.JRh(e),t.R7$(),t.Y8G("content",n)}}function wt(s,r){if(1&s){const e=t.RV6();t.j41(0,"div",10)(1,"mat-form-field",11)(2,"input",12),t.mxI("ngModelChange",function(o){t.eBV(e);const i=t.XpG();return t.DH7(i.role_name,o)||(i.role_name=o),t.Njj(o)}),t.k0s()(),t.j41(3,"button",13),t.bIt("click",function(){t.eBV(e);const o=t.XpG();return t.Njj(o.updateRoles())}),t.EFF(4," Save Role "),t.k0s()()}if(2&s){const e=t.XpG();t.R7$(2),t.R50("ngModel",e.role_name)}}let W=(()=>{class s{removeRole(e){var n=this;return(0,d.A)(function*(){if(!e)return;n.loading=!0,n._dialog_ref.disableClose=!0;const o=yield n.data.pipe((0,R.s)(1)).toPromise();yield(0,h.D58)(n._org.building.id,{name:"emergency_contacts",description:"Emergency Contacts",details:{roles:[...o.roles.filter(i=>i!==e)].filter(i=>!!i).sort((i,l)=>i.localeCompare(l)),contacts:o.contacts.map(i=>({...i,roles:i.roles.filter(l=>l!==e)}))}}).toPromise(),n._changes.next(0),n.loading=!1,n._dialog_ref.disableClose=!1})()}updateRoles(){var e=this;return(0,d.A)(function*(){if(!e.role_name)return;e.loading=!0,e._tooltip.close(),e._dialog_ref.disableClose=!0;const n=yield e.data.pipe((0,R.s)(1)).toPromise();yield(0,h.D58)(e._org.building.id,{name:"emergency_contacts",description:"Emergency Contacts",details:{roles:[...n.roles.filter(o=>o!==e.active),e.role_name].filter(o=>!!o).sort((o,i)=>o.localeCompare(i)),contacts:n.contacts}}).toPromise(),e._changes.next(0),e.role_name="",e.active="",e.loading=!1,e._dialog_ref.disableClose=!1})()}constructor(e,n){this._org=e,this._dialog_ref=n,this._changes=new _.t(0),this.loading=!1,this.data=(0,b.zV)([this._org.active_building,this._changes]).pipe((0,D.p)(([o])=>!!o),(0,F.n)(([o])=>(0,h.bpY)(o.id,"emergency_contacts")),(0,g.T)(({details:o})=>{const i=o||{roles:[],contacts:[]};return i.roles||(i.roles=[]),i.contacts||(i.contacts=[]),i}),(0,f.t)(1)),this.roles=this.data.pipe((0,g.T)(o=>o.roles))}static#t=this.\u0275fac=function(n){return new(n||s)(t.rXU(T.yb),t.rXU(j.CP))};static#e=this.\u0275cmp=t.VBU({type:s,selectors:[["role-management-modal"]],viewQuery:function(n,o){if(1&n&&t.GBs(H.In,5),2&n){let i;t.mGM(i=t.lsd())&&(o._tooltip=i.first)}},decls:16,vars:4,consts:[["role_form",""],["btn","","icon","","matRipple","","mat-dialog-close",""],[1,"overflow-y-auto","min-w-[20rem]","divide-y","divide-base-200","max-h-[65vh]"],["btn","","matRipple","","customTooltip","",1,"flex","items-center","justify-center","space-x-2","w-[calc(100%-1rem)]","m-2",3,"click","content"],[1,"truncate"],[4,"ngFor","ngForOf"],[1,"flex","items-center","space-x-2","hover:bg-base-200:bg-base-300","p-2"],[1,"flex-1","truncate"],["btn","","icon","","matRipple","","customTooltip","",3,"click","content"],["btn","","icon","","matRipple","",3,"click"],[1,"bg-base-100","p-4","rounded"],["appearance","outline"],["matInput","","placeholder","Role name",3,"ngModelChange","ngModel"],["btn","","matRipple","",1,"w-full",3,"click"]],template:function(n,o){if(1&n){const i=t.RV6();t.j41(0,"header")(1,"h2"),t.EFF(2,"Manage Roles"),t.k0s(),t.j41(3,"button",1)(4,"app-icon"),t.EFF(5,"close"),t.k0s()()(),t.j41(6,"main",2)(7,"button",3),t.bIt("click",function(){return t.eBV(i),o.active="",t.Njj(o.role_name="")}),t.j41(8,"div",4),t.EFF(9,"New Role"),t.k0s(),t.j41(10,"app-icon"),t.EFF(11,"add"),t.k0s()(),t.DNE(12,Nt,10,2,"ng-container",5),t.nI1(13,"async"),t.k0s(),t.DNE(14,wt,5,1,"ng-template",null,0,t.C5r)}if(2&n){const i=t.sdS(15);t.R7$(7),t.Y8G("content",i),t.R7$(5),t.Y8G("ngForOf",t.bMT(13,2,o.roles))}},dependencies:[p.Sq,c.me,c.BC,c.vS,M.rl,X.fg,j.tx,C.r6,S.R,Z.I,p.Jj]})}return s})();var Ot=a(3801),Dt=a(8328),Xt=a(3666);const Yt=["app-emergency-contacts",""],Bt=()=>[],Pt=s=>({key:"name",name:"Person",content:s}),zt=s=>({key:"roles",name:"Roles",content:s,sortable:!1}),Ut=s=>({key:"zone",name:"Zone",content:s,size:"8rem",sortable:!1}),At=s=>({key:"actions",name:" ",content:s,size:"6rem",sortable:!1}),Lt=(s,r,e,n)=>[s,r,e,n];function Jt(s,r){if(1&s&&(t.j41(0,"mat-option",24),t.EFF(1),t.k0s()),2&s){const e=r.$implicit;t.Y8G("value",e),t.R7$(),t.SpI(" ",e," ")}}function Ht(s,r){if(1&s){const e=t.RV6();t.j41(0,"button",25),t.bIt("click",function(){const o=t.eBV(e).row,i=t.XpG();return t.Njj(i.copyToClipboard(o.email))}),t.j41(1,"div",26),t.EFF(2),t.k0s(),t.j41(3,"div",27),t.EFF(4),t.k0s()()}if(2&s){const e=r.row;t.R7$(2),t.JRh(e.name),t.R7$(2),t.SpI(" ",e.email," ")}}function Zt(s,r){if(1&s&&(t.j41(0,"span",30),t.EFF(1),t.k0s()),2&s){const e=r.$implicit;t.R7$(),t.SpI(" ",e," ")}}function Qt(s,r){if(1&s&&(t.j41(0,"div",28),t.DNE(1,Zt,2,1,"span",29),t.k0s()),2&s){const e=r.data;t.R7$(),t.Y8G("ngForOf",e)}}function Wt(s,r){if(1&s&&(t.j41(0,"div",31),t.EFF(1),t.nI1(2,"level"),t.k0s()),2&s){let e;const n=r.data;t.R7$(),t.SpI(" ",n?null==(e=t.bMT(2,1,n))?null:e.display_name:"All"," ")}}function Kt(s,r){if(1&s){const e=t.RV6();t.j41(0,"div",32)(1,"button",33),t.bIt("click",function(){const o=t.eBV(e).row,i=t.XpG();return t.Njj(i.editContact(o))}),t.j41(2,"app-icon"),t.EFF(3,"edit"),t.k0s()(),t.j41(4,"button",34),t.bIt("click",function(){const o=t.eBV(e).row,i=t.XpG();return t.Njj(i.removeContact(o))}),t.j41(5,"app-icon"),t.EFF(6,"delete"),t.k0s()()()}}let K=(()=>{class s{constructor(e,n,o){this._org=e,this._dialog=n,this._clipboard=o,this._change=new _.t(0),this.search="",this.role_filter=new _.t(""),this.data=(0,b.zV)([this._org.active_building,this._change]).pipe((0,D.p)(([i])=>!!i),(0,F.n)(([i])=>(0,h.bpY)(i.id,"emergency_contacts")),(0,g.T)(({details:i})=>i||{roles:[],contacts:[]}),(0,f.t)(1)),this.roles=this.data.pipe((0,g.T)(i=>i?.roles||[])),this.contacts=this.data.pipe((0,g.T)(i=>i?.contacts||[])),this.filtered_contacts=(0,b.zV)([this.contacts,this.role_filter]).pipe((0,g.T)(([i,l])=>i.filter(m=>!l||m.roles.includes(l)))),this.copyToClipboard=i=>{this._clipboard.copy(i)&&(0,u.VX)("User's email copied to clipboard.")}}ngOnInit(){}manageRoles(){this._dialog.open(W,{}).afterClosed().subscribe(()=>this._change.next(Date.now()))}editContact(e){this._dialog.open(Q,{data:e}).afterClosed().subscribe(()=>this._change.next(Date.now()))}removeContact(e){var n=this;return(0,d.A)(function*(){const o=yield(0,u.GE)({title:"Remove Emergency Contact",content:`Are you sure you want to remove ${e.name} from the emergency contacts?`,icon:{content:"delete"}},n._dialog);if("done"!==o.reason)return;o.loading("Removing contact...");const i=yield n.data.pipe((0,R.s)(1)).toPromise(),l=(i?.contacts||[]).filter(m=>m.id!==e.id);yield(0,h.D58)(n._org.building.id,{name:"emergency_contacts",description:"Emergency Contacts",details:{roles:i.roles,contacts:l}}).toPromise(),o.close(),n._change.next(Date.now()),(0,u.VX)("Successfully removed emergency contact.")})()}static#t=this.\u0275fac=function(n){return new(n||s)(t.rXU(T.yb),t.rXU(j.bZ),t.rXU(Ot.B0))};static#e=this.\u0275cmp=t.VBU({type:s,selectors:[["","app-emergency-contacts",""]],attrs:Yt,decls:40,vars:24,consts:[["person_template",""],["roles_template",""],["zone_template",""],["actions_template",""],[1,"flex","flex-1","h-px"],[1,"flex","flex-col","flex-1","w-1/2","h-full"],["topbar","",1,"px-8","py-4","flex","flex-col"],[1,"flex","items-center","justify-between"],[1,"text-2xl","font-medium"],[1,"flex","items-center","space-x-2"],["appearance","outline",1,"no-subscript"],["matPrefix","",1,"text-2xl"],["matInput","","placeholder","Filter contacts...",3,"ngModelChange","ngModel"],["btn","","matRipple","",1,"space-x-2",3,"click"],[1,"text-2xl"],[1,"pr-2"],[1,"flex","items-center","justify-between","py-2","mt-2"],["placeholder","All Roles",3,"ngModelChange","ngModel"],["value",""],[3,"value",4,"ngFor","ngForOf"],["icon","","matRipple","","matTooltip","Manage Roles",1,"h-12","w-12","bg-secondary","text-secondary-content","rounded",3,"click"],[1,"w-full","h-1/2","flex-1","overflow-auto","px-8"],[1,"min-w-[52rem]","block","text-sm",3,"data","filter","empty_message","columns","sortable"],[1,"w-full","h-12"],[3,"value"],[1,"px-4","py-2","text-left","leading-tight",3,"click"],[1,""],[1,"text-[0.625rem]","opacity-30","font-mono"],[1,"flex","flex-wrap","p-2"],["class","m-1 py-1 px-2 rounded-2xl text-xs font-mono bg-info text-info-content",4,"ngFor","ngForOf"],[1,"m-1","py-1","px-2","rounded-2xl","text-xs","font-mono","bg-info","text-info-content"],[1,"p-4"],[1,"flex","items-center","justify-end","w-full","space-x-2","p-2"],["icon","","matRipple","","matTooltip","Edit Emergency Contact",3,"click"],["icon","","matRipple","","matTooltip","Remove Emergency Contact",1,"text-error",3,"click"]],template:function(n,o){if(1&n){const i=t.RV6();t.nrm(0,"app-topbar"),t.j41(1,"div",4),t.nrm(2,"app-sidebar"),t.j41(3,"main",5)(4,"section",6)(5,"div",7)(6,"h2",8),t.EFF(7,"Emergency Contacts"),t.k0s(),t.j41(8,"div",9)(9,"mat-form-field",10)(10,"app-icon",11),t.EFF(11," search "),t.k0s(),t.j41(12,"input",12),t.mxI("ngModelChange",function(m){return t.eBV(i),t.DH7(o.search,m)||(o.search=m),t.Njj(m)}),t.k0s()(),t.j41(13,"button",13),t.bIt("click",function(){return t.eBV(i),t.Njj(o.editContact())}),t.j41(14,"app-icon",14),t.EFF(15,"add"),t.k0s(),t.j41(16,"div",15),t.EFF(17,"Add Contact"),t.k0s()()()(),t.j41(18,"div",16)(19,"mat-form-field",10)(20,"mat-select",17),t.bIt("ngModelChange",function(m){return t.eBV(i),t.Njj(o.role_filter.next(m))}),t.j41(21,"mat-option",18),t.EFF(22,"All Roles"),t.k0s(),t.DNE(23,Jt,2,2,"mat-option",19),t.nI1(24,"async"),t.k0s()(),t.j41(25,"div",9)(26,"button",20),t.bIt("click",function(){return t.eBV(i),t.Njj(o.manageRoles())}),t.j41(27,"app-icon"),t.EFF(28,"list_alt"),t.k0s()()()()(),t.j41(29,"section",21),t.nrm(30,"simple-table",22)(31,"div",23),t.DNE(32,Ht,5,2,"ng-template",null,0,t.C5r)(34,Qt,2,1,"ng-template",null,1,t.C5r)(36,Wt,3,3,"ng-template",null,2,t.C5r)(38,Kt,7,0,"ng-template",null,3,t.C5r),t.k0s()()()}if(2&n){const i=t.sdS(33),l=t.sdS(35),m=t.sdS(37),v=t.sdS(39);t.R7$(12),t.R50("ngModel",o.search),t.R7$(8),t.Y8G("ngModel",o.role_filter.getValue()),t.R7$(3),t.Y8G("ngForOf",t.bMT(24,8,o.roles)||t.lJ4(10,Bt)),t.R7$(7),t.Y8G("data",o.filtered_contacts)("filter",o.search)("empty_message",o.search?"No matching contacts":"No emergency contacts for this building")("columns",t.ziG(19,Lt,t.eq3(11,Pt,i),t.eq3(13,zt,l),t.eq3(15,Ut,m),t.eq3(17,At,v)))("sortable",!0)}},dependencies:[p.Sq,c.me,c.BC,c.vS,A.S,L.c,M.rl,M.JW,X.fg,N.VO,C.wT,P.oV,C.r6,S.R,Dt.O,p.Jj,Xt.D],styles:["[_nghost-%COMP%]{display:flex;flex-direction:column;height:100%;width:100%;background-color:var(--b1)}"]})}return s})();const qt=[{path:"",component:U},{path:"new",component:J},{path:"emergency-contacts",component:K}],te=[J,U,w,O,z,K,Q,W];let ee=(()=>{class s{static#t=this.\u0275fac=function(n){return new(n||s)};static#e=this.\u0275mod=t.$C({type:s});static#n=this.\u0275inj=t.G2t({imports:[p.MD,c.YN,yt.r,I.iI.forChild(qt)]})}return s})()},8390:(q,k,a)=>{a.d(k,{g8:()=>V,kR:()=>p.k,Gp:()=>_.Gp,N8:()=>g.N8,SZ:()=>g.SZ,is:()=>y.is});var p=a(1081),d=(a(1543),a(2613),a(3888));class V{constructor(f={}){this.type=f.type||f.location||"other",this.position=f.position||f.map_id||f.asset_id||{x:f.x/f.map_width||0,y:f.y/f.map_height||0},this.variance=f.variance||0,this.last_seen=f.last_seen||(0,d.A)(new Date),this.level=f.level,this.building=f.building,this.at_location=!!f.at_location,this.coordinates_from=f.coordinates_from||"top-left"}}var _=a(3693),y=(a(4129),a(6039)),g=a(2372)}}]);