"use strict";(self.webpackChunkworkplace=self.webpackChunkworkplace||[]).push([[592],{1966:(j,m,t)=>{t.d(m,{I:()=>_});var K=t(5861),M=t(3496),P=t(232),u=t(1299),C=t(6221),A=t(2886),I=t(9909),R=t(2641),E=t(9972),c=t(8115),y=t(2722),x=t(591),f=t(3426),a=t(1086),L=t(13),l=t(2994),T=t(2198),d=t(9184),h=t(7545),v=t(5778),o=t(4850),g=t(7221),r=t(5154),p=t(6353);class _ extends P.cx{constructor(i,U){super(),this._settings=i,this._org=U,this._poll=new x.X(0),this._poll_type=new x.X("api"),this._loading=new x.X(!1),this._filters=new x.X({shown_types:["event","desk","parking","visitor","locker"]}),this._date=new x.X(Date.now()),this._update=(0,f.aj)([this._date,this._poll]).pipe((0,L.b)(500),(0,l.b)(s=>this._loading.next(!0))),this._space_bookings=this._org.active_building.pipe((0,T.h)(s=>!!s),(0,d.g)("id"),(0,L.b)(300),(0,l.b)(s=>this.unsubWith("bind:")),(0,h.w)(({id:s})=>(this._loading.next(!0),(0,A.u2)(s))),(0,v.x)(([s],[e])=>s!==e),(0,h.w)(s=>(this._loading.next(!1),(0,f.aj)((s||[]).map(e=>{const n=(0,I.rTZ)(e.id,"Bookings").binding("bookings"),O=n.listen().pipe((0,o.U)(B=>(B||[]).map(W=>new u.ym({...W,resources:W.attendees.filter(Z=>Z.email===e.email||Z.resource),system:e}))),(0,g.K)(B=>(0,a.of)([])));return this.hasSubscription(`bind:${e.id}`)||this.subscription(`bind:${e.id}`,n.bind()),O})))),(0,o.U)(s=>(0,P.xH)(s)),(0,r.d)(1)),this.ws_events=(0,f.aj)([this._space_bookings,this._update]).pipe((0,o.U)(([s,[e]])=>{const n=(0,P.ar)();return s.filter(O=>(0,R.Z)(O.date,e)&&(O.host.toLowerCase()===n.email.toLowerCase()||O.attendees.find(B=>B.email.toLowerCase()===n.email.toLowerCase())))})),this.api_events=this._update.pipe((0,h.w)(([s])=>{const e={period_start:(0,E.Z)((0,c.Z)(s)),period_end:(0,E.Z)((0,y.Z)(s))};return this._settings.get("app.events.use_bookings")?(0,M.F2)({...e,type:"room"}).pipe((0,o.U)(n=>n.map(O=>(0,u.Yd)(O))),(0,g.K)(n=>(0,a.of)([]))):(0,u.u$)({...e}).pipe((0,g.K)(n=>(0,a.of)([])))}),(0,r.d)(1)),this.events=(0,f.aj)([this._poll_type]).pipe((0,h.w)(([s])=>"api"===s?this.api_events:this.ws_events),(0,l.b)(()=>this.timeout("end_loading",()=>this._loading.next(!1))),(0,r.d)(1)),this.visitors=this._update.pipe((0,h.w)(([s])=>(0,M.F2)({period_start:(0,E.Z)((0,c.Z)(s)),period_end:(0,E.Z)((0,y.Z)(s)),type:"visitor"}).pipe((0,g.K)(e=>(console.error(e),(0,a.of)([]))))),(0,l.b)(()=>this.timeout("end_loading",()=>this._loading.next(!1))),(0,r.d)(1)),this.desks=this._update.pipe((0,h.w)(([s])=>(0,M.F2)({period_start:(0,E.Z)((0,c.Z)(s)),period_end:(0,E.Z)((0,y.Z)(s)),include_checked_out:!0,type:"desk"}).pipe((0,g.K)(e=>(console.error(e),(0,a.of)([]))))),(0,l.b)(()=>this.timeout("end_loading",()=>this._loading.next(!1))),(0,r.d)(1)),this.parking=this._update.pipe((0,h.w)(([s])=>(0,M.F2)({period_start:(0,E.Z)((0,c.Z)(s)),period_end:(0,E.Z)((0,y.Z)(s)),type:"parking"}).pipe((0,g.K)(e=>(0,a.of)([])))),(0,l.b)(()=>this.timeout("end_loading",()=>this._loading.next(!1))),(0,r.d)(1)),this.lockers=this._update.pipe((0,h.w)(([s])=>{const e=this._org.binding("area_management");return e?(0,I.rTZ)(e,"Lockers").execute("lockers_allocated_to_me").catch(O=>[]):(0,a.of)([])}),(0,o.U)(s=>s.map(e=>new M.$N({date:(0,c.Z)(Date.now()).valueOf(),duration:1439,asset_id:e.locker_id,asset_name:e.locker_name,zones:[e.building,e.level],extension_data:{map_id:e.locker_id}}))),(0,g.K)(()=>(0,a.of)([])),(0,l.b)(()=>this.timeout("end_loading",()=>this._loading.next(!1))),(0,r.d)(1)),this.bookings=(0,f.aj)([this.events,this.visitors,this.desks,this.parking,this.lockers]).pipe((0,o.U)(([s,e,n,O,B])=>[...s,...e,...n,...O,...B].sort((W,Z)=>W.date-Z.date))),this.filtered_bookings=(0,f.aj)([this.bookings,this._filters]).pipe((0,o.U)(([s,e])=>s.filter(n=>n instanceof u.ym&&e?.shown_types?.includes("event")||e?.shown_types?.includes(n.booking_type)))),this.filters=this._filters.asObservable(),this.date=this._date.asObservable(),this.loading=this._loading.asObservable(),this.subscription("poll_type",this._org.active_building.subscribe(()=>this._poll_type.next(this._settings.get("app.schedule.use_websocket")?"ws":"api")))}triggerPoll(){this._poll.next(Date.now())}startPolling(i=6e4){return this.interval("poll",()=>{"visible"===document.visibilityState&&this._poll.next(Date.now())},i),()=>this.stopPolling()}stopPolling(){this.clearInterval("poll")}setDate(i){this._date.next(i)}removeItem(i){this._poll.next(Date.now())}toggleType(i,U=!1){var s=this;return(0,K.Z)(function*(){const e=s._filters.getValue()||{shown_types:[]},{shown_types:n}=e;n&&(n.includes(i)||U)?s._filters.next({...e,shown_types:n.filter(O=>O!==i)}):s._filters.next({...e,shown_types:[...n,i]})})()}}_.\u0275fac=function(i){return new(i||_)(p.LFG(P.gb),p.LFG(C.w7))},_.\u0275prov=p.Yz7({token:_,factory:_.\u0275fac,providedIn:"root"})},8676:(j,m,t)=>{t.d(m,{I:()=>o});var K=t(3496),M=t(9434),P=t(232),u=t(1299),C=t(9972),A=t(8115),I=t(5650),R=t(2722),E=t(591),c=t(7739),y=t(3426),x=t(567),f=t(7545),a=t(5154),L=t(13),l=t(1709),T=t(4850),d=t(7221),h=t(2994),v=t(6353);class o extends P.cx{constructor(r){super(),this._settings=r,this._poll=new E.X(0),this._options=new E.X({start:Date.now()}),this._loading=new E.X(""),this._schedule=new E.X([]),this.options=this._options.asObservable(),this.loading=this._loading.asObservable(),this.schedule=this._loading.asObservable(),this.calendars=(0,c.H)(1e3).pipe((0,f.w)(p=>(0,M.yJ)()),(0,a.d)(1)),this.events=(0,y.aj)([this._options,this._poll]).pipe((0,L.b)(1e3),(0,l.zg)(([p])=>{this._loading.next("Loading schedule...");const _={period_start:(0,C.Z)((0,A.Z)(p.start)),period_end:(0,C.Z)((0,I.Z)((0,R.Z)(p.start),6))};return p.calendar&&(_.calendar=p.calendar),this._schedule.next(this._schedule.getValue().filter(D=>!(0,P.MZ)(1e3*_.period_start,1e3*_.period_end,D.date,D.date+60*D.duration*1e3))),(0,x.D)([!0===this._settings.get("app.events.use_bookings")?(0,K.F2)({..._,type:"room"}).pipe((0,T.U)(D=>D.map(i=>(0,u.Yd)(i)))):(0,u.u$)({..._}),(0,K.F2)({..._,type:"desk"}),(0,K.F2)({..._,type:"parking"})]).pipe((0,d.K)(D=>[]))}),(0,T.U)(([p,_])=>{const D=[...this._schedule.getValue(),...p,..._.filter(i=>"declined"!==i.status)].sort((i,U)=>i.date-U.date);return this._schedule.next((0,P.Tw)(D,"id")),D}),(0,d.K)(p=>[]),(0,h.b)(p=>this._loading.next("")),(0,a.d)(1))}startPolling(r=15e3){this.interval("poll",()=>this._poll.next(Date.now()),r)}stopPolling(){this.clearInterval("poll")}setOptions(r){this._options.next({...this._options.getValue(),...r})}}o.\u0275fac=function(r){return new(r||o)(v.LFG(P.gb))},o.\u0275prov=v.Yz7({token:o,factory:o.\u0275fac,providedIn:"root"})},9434:(j,m,t)=>{t.d(m,{ot:()=>l,yJ:()=>a.yJ}),t(4603);var M=t(5861),P=t(591),u=t(2994),C=t(5154),A=t(7224),I=t(9972),R=t(8115),E=t(2722),c=t(9756),y=t(4871),x=t(719),f=t(565),a=t(6217),L=t(6353);class l extends y.c{constructor(d,h){super(),this._org=d,this._settings=h,this._calendars=new P.X([]),this.calendar_list=(0,a.yJ)().pipe((0,u.b)(v=>this._calendars.next(v)),(0,C.d)(1)),this.query=()=>(0,a.yJ)(),this.freeBusy=v=>(0,a.tS)(v,this._org),this.availability=v=>(0,a.v7)(v),this._org.initialised.pipe((0,A.P)(v=>v)).subscribe(()=>this.init())}init(){var d=this;return(0,M.Z)(function*(){d._settings.get("app.events.use_bookings")||d._initialised.next(!0)})()}get calendars(){return this._calendars.getValue()}getFreeBusyDate(d,h){return(0,a.tS)({period_start:(0,I.Z)((0,R.Z)(d)),period_end:(0,I.Z)((0,E.Z)(d)),calendars:h},this._org)}checkSpacesAvailability(d,h,v,o){return(0,M.Z)(function*(){const g=yield(0,a.v7)({period_start:h,period_end:v,system_ids:d.join(",")}).toPromise(),r=new Date(o?.date).valueOf(),p=(0,c.Z)(r,o?.duration).valueOf();return!!g.every(D=>{const i=D.availability;if(o&&D.id===o.system?.email){const U=i.findIndex(s=>s.date>=r&&(0,c.Z)(s.date,s.duration).valueOf()<=p);-1!==U&&i.splice(U,1)}return!i.length})})()}}l.\u0275fac=function(d){return new(d||l)(L.LFG(f.w),L.LFG(x.g))},l.\u0275prov=L.Yz7({token:l,factory:l.\u0275fac,providedIn:"root"})}}]);