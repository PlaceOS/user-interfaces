"use strict";(self.webpackChunkworkplace=self.webpackChunkworkplace||[]).push([["common"],{7625:(S,R,t)=>{t.d(R,{I:()=>g});var C=t(1670),u=t(3496),M=t(3610),f=t(5915),T=t(5912),m=t(2886),A=t(7502),W=t(5845),r=t(1810),L=t(9377),I=t(3200),x=t(4505),_=t(7716),E=t(4139),U=t(823),l=t(8759),K=t(9151),a=t(6116),d=t(9095),v=t(3298),c=t(6942),h=t(7418),D=t(9128),O=t(9445);let g=(()=>{class n extends M.cx{constructor(i,y){super(),this._settings=i,this._org=y,this._poll=new x.X(0),this._poll_type=new x.X("api"),this._loading=new x.X(!1),this._filters=new x.X({shown_types:["event","desk","parking","visitor","locker"]}),this._date=new x.X(Date.now()),this._update=(0,_.aj)([this._date,this._poll]).pipe((0,U.b)(500),(0,l.b)(s=>this._loading.next(!0))),this._deleted=[],this._space_bookings=this._org.active_building.pipe((0,K.h)(s=>!!s),(0,a.g)("id"),(0,U.b)(300),(0,l.b)(s=>this.unsubWith("bind:")),(0,d.w)(({id:s})=>(this._loading.next(!0),(0,m.u2)(s))),(0,v.x)(([s],[e])=>s!==e),(0,d.w)(s=>(this._loading.next(!1),(0,_.aj)((s||[]).map(e=>{const o=(0,A.rTZ)(e.id,"Bookings").binding("bookings"),P=o.listen().pipe((0,c.U)(B=>(B||[]).map(Z=>new f.ym({...Z,resources:Z.attendees.filter(j=>j.email===e.email||j.resource),system:e}))),(0,h.K)(B=>(0,E.of)([])));return this.hasSubscription(`bind:${e.id}`)||this.subscription(`bind:${e.id}`,o.bind()),P})))),(0,c.U)(s=>(0,M.xH)(s)),(0,D.d)(1)),this.ws_events=(0,_.aj)([this._space_bookings,this._update]).pipe((0,c.U)(([s,[e]])=>{const o=(0,M.ar)();return s.filter(P=>(0,W.Z)(P.date,e)&&(P.host.toLowerCase()===o.email.toLowerCase()||P.attendees.find(B=>B.email.toLowerCase()===o.email.toLowerCase())))})),this.api_events=this._update.pipe((0,d.w)(([s])=>{const e={period_start:(0,r.Z)((0,L.Z)(s)),period_end:(0,r.Z)((0,I.Z)(s))};return this._settings.get("app.events.use_bookings")?(0,u.F2)({...e,type:"room"}).pipe((0,c.U)(o=>o.map(P=>(0,f.Yd)(P))),(0,h.K)(o=>(0,E.of)([]))):(0,f.u$)({...e}).pipe((0,h.K)(o=>(0,E.of)([])))}),(0,D.d)(1)),this.events=(0,_.aj)([this._poll_type]).pipe((0,d.w)(([s])=>"api"===s?this.api_events:this.ws_events),(0,l.b)(()=>this.timeout("end_loading",()=>this._loading.next(!1))),(0,D.d)(1)),this.visitors=this._update.pipe((0,d.w)(([s])=>(0,u.F2)({period_start:(0,r.Z)((0,L.Z)(s)),period_end:(0,r.Z)((0,I.Z)(s)),type:"visitor"}).pipe((0,h.K)(e=>(console.error(e),(0,E.of)([]))))),(0,l.b)(()=>this.timeout("end_loading",()=>this._loading.next(!1))),(0,D.d)(1)),this.desks=this._update.pipe((0,d.w)(([s])=>(0,u.F2)({period_start:(0,r.Z)((0,L.Z)(s)),period_end:(0,r.Z)((0,I.Z)(s)),include_checked_out:!0,type:"desk"}).pipe((0,h.K)(e=>(console.error(e),(0,E.of)([]))))),(0,l.b)(()=>this.timeout("end_loading",()=>this._loading.next(!1))),(0,D.d)(1)),this.parking=this._update.pipe((0,d.w)(([s])=>(0,u.F2)({period_start:(0,r.Z)((0,L.Z)(s)),period_end:(0,r.Z)((0,I.Z)(s)),type:"parking"}).pipe((0,h.K)(e=>(0,E.of)([])))),(0,l.b)(()=>this.timeout("end_loading",()=>this._loading.next(!1))),(0,D.d)(1)),this.lockers=this._org.active_building.pipe((0,K.h)(s=>!!s),(0,a.g)("id"),(0,U.b)(300),(0,d.w)(s=>{const e=this._org.binding("lockers");return console.log("Lockers:",s,e),e?(0,A.rTZ)(e,"LockerLocations").execute("lockers_allocated_to_me").catch(P=>[]):(0,E.of)([])}),(0,c.U)(s=>s.map(e=>new u.$N({date:(0,L.Z)(Date.now()).valueOf(),duration:1439,title:"Locker Booking",description:e.locker_name,booking_type:"locker",all_day:!0,asset_id:e.locker_id,asset_name:e.locker_name,zones:[e.building,e.level],extension_data:{map_id:e.locker_id}}))),(0,h.K)(s=>(console.error(s),(0,E.of)([]))),(0,l.b)(s=>{console.log("Your Lockers:",s),this.timeout("end_loading",()=>this._loading.next(!1))}),(0,D.d)(1)),this.bookings=(0,_.aj)([this.events,this.visitors,this.desks,this.parking,this.lockers]).pipe((0,c.U)(([s,e,o,P,B])=>[...s,...e,...o,...P,...B].sort((Z,j)=>Z.date-j.date))),this.filtered_bookings=(0,_.aj)([this.bookings,this._filters]).pipe((0,c.U)(([s,e])=>s.filter(o=>!this._deleted.includes(o.id)&&o instanceof f.ym&&e?.shown_types?.includes("event")||e?.shown_types?.includes(o.booking_type)))),this.filters=this._filters.asObservable(),this.date=this._date.asObservable(),this.loading=this._loading.asObservable(),this.subscription("poll_type",this._org.active_building.subscribe(()=>this._poll_type.next(this._settings.get("app.schedule.use_websocket")?"ws":"api"))),this._deleted=JSON.parse(sessionStorage.getItem("PLACEOS.events.deleted")||"[]")}triggerPoll(){this._poll.next(Date.now())}startPolling(i=6e4){return this.interval("poll",()=>{"visible"===document.visibilityState&&this._poll.next(Date.now())},i),()=>this.stopPolling()}stopPolling(){this.clearInterval("poll")}setDate(i){this._date.next(i)}removeItem(i){this.setAsDeleted(i.id),this._poll.next(Date.now())}setAsDeleted(i){this._deleted.push(i),sessionStorage.setItem("PLACEOS.events.deleted",JSON.stringify(this._deleted))}toggleType(i,y=!1){var s=this;return(0,C.Z)(function*(){const e=s._filters.getValue()||{shown_types:[]},{shown_types:o}=e;o&&(o.includes(i)||y)?s._filters.next({...e,shown_types:o.filter(P=>P!==i)}):s._filters.next({...e,shown_types:[...o,i]})})()}}return n.\u0275fac=function(i){return new(i||n)(O.LFG(M.gb),O.LFG(T.w7))},n.\u0275prov=O.Yz7({token:n,factory:n.\u0275fac,providedIn:"root"}),n})()},8676:(S,R,t)=>{t.d(R,{I:()=>c});var C=t(3496),u=t(9434),M=t(3610),f=t(5915),T=t(1810),m=t(9377),A=t(312),W=t(3200),r=t(4505),L=t(5398),I=t(7716),x=t(4350),_=t(9095),E=t(9128),U=t(823),l=t(522),K=t(6942),a=t(7418),d=t(8759),v=t(9445);let c=(()=>{class h extends M.cx{constructor(O){super(),this._settings=O,this._poll=new r.X(0),this._options=new r.X({start:Date.now()}),this._loading=new r.X(""),this._schedule=new r.X([]),this.options=this._options.asObservable(),this.loading=this._loading.asObservable(),this.schedule=this._loading.asObservable(),this.calendars=(0,L.H)(1e3).pipe((0,_.w)(g=>(0,u.yJ)()),(0,E.d)(1)),this.events=(0,I.aj)([this._options,this._poll]).pipe((0,U.b)(1e3),(0,l.zg)(([g])=>{this._loading.next("Loading schedule...");const n={period_start:(0,T.Z)((0,m.Z)(g.start)),period_end:(0,T.Z)((0,A.Z)((0,W.Z)(g.start),6))};return g.calendar&&(n.calendar=g.calendar),this._schedule.next(this._schedule.getValue().filter(p=>!(0,M.MZ)(1e3*n.period_start,1e3*n.period_end,p.date,p.date+60*p.duration*1e3))),(0,x.D)([!0===this._settings.get("app.events.use_bookings")?(0,C.F2)({...n,type:"room"}).pipe((0,K.U)(p=>p.map(i=>(0,f.Yd)(i)))):(0,f.u$)({...n}),(0,C.F2)({...n,type:"desk"}),(0,C.F2)({...n,type:"parking"})]).pipe((0,a.K)(p=>[]))}),(0,K.U)(([g,n])=>{const p=[...this._schedule.getValue(),...g,...n.filter(i=>"declined"!==i.status)].sort((i,y)=>i.date-y.date);return this._schedule.next((0,M.Tw)(p,"id")),p}),(0,a.K)(g=>[]),(0,d.b)(g=>this._loading.next("")),(0,E.d)(1))}startPolling(O=15e3){this.interval("poll",()=>this._poll.next(Date.now()),O)}stopPolling(){this.clearInterval("poll")}setOptions(O){this._options.next({...this._options.getValue(),...O})}}return h.\u0275fac=function(O){return new(O||h)(v.LFG(M.gb))},h.\u0275prov=v.Yz7({token:h,factory:h.\u0275fac,providedIn:"root"}),h})()},9434:(S,R,t)=>{t.d(R,{ot:()=>U,yJ:()=>_.yJ});var C=t(1670),u=t(4505),M=t(8759),f=t(9128),T=t(5670),m=t(1810),A=t(9377),W=t(3200),r=t(2317),L=t(4871),I=t(719),x=t(3174),_=t(8313),E=t(9445);let U=(()=>{class l extends L.c{constructor(a,d){super(),this._org=a,this._settings=d,this._calendars=new u.X([]),this.calendar_list=(0,_.yJ)().pipe((0,M.b)(v=>this._calendars.next(v)),(0,f.d)(1)),this.query=()=>(0,_.yJ)(),this.freeBusy=v=>(0,_.tS)(v,this._org),this.availability=v=>(0,_.v7)(v),this._org.initialised.pipe((0,T.P)(v=>v)).subscribe(()=>this.init())}init(){var a=this;return(0,C.Z)(function*(){a._settings.get("app.events.use_bookings")||a._initialised.next(!0)})()}get calendars(){return this._calendars.getValue()}getFreeBusyDate(a,d){return(0,_.tS)({period_start:(0,m.Z)((0,A.Z)(a)),period_end:(0,m.Z)((0,W.Z)(a)),calendars:d},this._org)}checkSpacesAvailability(a,d,v,c){return(0,C.Z)(function*(){const h=yield(0,_.v7)({period_start:d,period_end:v,system_ids:a.join(",")}).toPromise(),D=new Date(c?.date).valueOf(),O=(0,r.Z)(D,c?.duration).valueOf();return!!h.every(n=>{const p=n.availability;if(c&&n.id===c.system?.email){const i=p.findIndex(y=>y.date>=D&&(0,r.Z)(y.date,y.duration).valueOf()<=O);-1!==i&&p.splice(i,1)}return!p.length})})()}}return l.\u0275fac=function(a){return new(a||l)(E.LFG(x.w),E.LFG(I.g))},l.\u0275prov=E.Yz7({token:l,factory:l.\u0275fac,providedIn:"root"}),l})()}}]);
//# sourceMappingURL=common.js.map