"use strict";(self.webpackChunkworkplace=self.webpackChunkworkplace||[]).push([["common"],{75323:(Q,$,t)=>{t.d($,{y:()=>X});var M=t(89204),O=t(57915),D=t(21157),L=t(68113),K=t(12185),U=t(22168),R=t(9080),H=t(26078),r=t(67450),C=t(27419),W=t(13264),S=t(46247),u=t(53838),I=t(80433),j=t(61031),P=t(90521),A=t(42175),a=t(71536),m=t(86020),d=t(19803),h=t(66e3),y=t(8627),z=t(47504),l=t(71963),v=t(6109),o=t(35443),_=t(29314),p=t(7841),x=t(89273),T=t(68559),G=t(12587);let X=(()=>{class k extends D.Tv{constructor(g,F,Y,Z){var f;super(),f=this,this._settings=g,this._org=F,this._lockers=Y,this._dialog=Z,this._poll=new P.t(0),this._poll_type=new P.t("api"),this._loading=new P.t(!1),this._filters=new P.t({shown_types:["event","desk","parking","visitor","locker","group-event"]}),this._date=new P.t(Date.now()),this._update=(0,A.zV)([this._date,this._poll]).pipe((0,d.B)(500),(0,h.M)(s=>this._loading.next(!0))),this._deleted=[],this._space_bookings=this._org.active_building.pipe((0,y.p)(s=>!!s),(0,z.w)("id"),(0,d.B)(300),(0,h.M)(s=>this.unsubWith("bind:")),(0,l.n)(({id:s})=>(this._loading.next(!0),(0,U.Ot)(s))),(0,v.F)(([s],[i])=>s!==i),(0,l.n)(s=>(this._loading.next(!1),(0,A.zV)((s||[]).map(i=>{const e=(0,R.f_4)(i.id,"Bookings").binding("bookings"),n=e.listen().pipe((0,o.T)(E=>(E||[]).map(B=>new L.LR({...B,resources:B.attendees.filter(V=>V.email===i.email||V.resource),system:i}))),(0,_.W)(E=>(0,a.of)([])));return this.hasSubscription(`bind:${i.id}`)||this.subscription(`bind:${i.id}`,e.bind()),n})))),(0,o.T)(s=>(0,D.Bq)(s)),(0,p.t)(1)),this.ws_events=(0,A.zV)([this._space_bookings,this._update]).pipe((0,o.T)(([s,[i]])=>{const e=(0,D.Ny)();return s.filter(n=>(0,H.A)(n.date,i)&&(n.host.toLowerCase()===e.email.toLowerCase()||n.attendees.find(E=>E.email.toLowerCase()===e.email.toLowerCase()))&&!n.linked_bookings?.find(E=>"group-event"===E.booking_type))})),this.api_events=this._update.pipe((0,l.n)(([s])=>{const i={period_start:(0,r.A)((0,C.A)(s)),period_end:(0,r.A)((0,W.A)(s))};return this._settings.get("app.events.use_bookings")?(0,O.tj)({...i,type:"room"}).pipe((0,o.T)(e=>e.map(n=>(0,L.Uv)(n))),(0,_.W)(e=>(0,a.of)([]))):(0,L.UU)({...i}).pipe((0,_.W)(e=>(0,a.of)([])))}),(0,p.t)(1)),this.events=(0,A.zV)([this._poll_type]).pipe((0,l.n)(([s])=>"api"===s?this.api_events:this.ws_events),(0,h.M)(()=>this.timeout("end_loading",()=>this._loading.next(!1))),(0,p.t)(1)),this.visitors=this._update.pipe((0,l.n)(([s])=>(0,O.tj)({period_start:(0,r.A)((0,C.A)(s)),period_end:(0,r.A)((0,W.A)(s)),type:"visitor"}).pipe((0,_.W)(i=>(0,a.of)([])))),(0,o.T)(s=>s.filter(i=>!i.parent_id&&!i.linked_event)),(0,h.M)(()=>this.timeout("end_loading",()=>this._loading.next(!1))),(0,p.t)(1)),this.desks=this._update.pipe((0,l.n)(([s])=>(0,O.tj)({period_start:(0,r.A)((0,C.A)(s)),period_end:(0,r.A)((0,W.A)(s)),include_checked_out:!0,type:"desk"}).pipe((0,_.W)(i=>(0,a.of)([])))),(0,h.M)(()=>this.timeout("end_loading",()=>this._loading.next(!1))),(0,p.t)(1)),this.parking=this._update.pipe((0,l.n)(([s])=>(0,O.tj)({period_start:(0,r.A)((0,C.A)(s)),period_end:(0,r.A)((0,W.A)(s)),type:"parking"}).pipe((0,_.W)(i=>(0,a.of)([])))),(0,h.M)(()=>this.timeout("end_loading",()=>this._loading.next(!1))),(0,p.t)(1)),this.group_events=this._update.pipe((0,l.n)(([s])=>(0,O.tj)({period_start:(0,r.A)((0,C.A)(s)),period_end:(0,r.A)((0,W.A)(s)),type:"group-event"}).pipe((0,_.W)(i=>(0,a.of)([])))),(0,h.M)(()=>this.timeout("end_loading",()=>this._loading.next(!1))),(0,p.t)(1)),this.lockers=(0,A.zV)([this._org.active_building.pipe((0,y.p)(s=>!!s),(0,z.w)("id")),this._lockers.lockers$]).pipe((0,d.B)(300),(0,l.n)(function(){var s=(0,M.A)(function*([i,e]){const n=f._org.binding("lockers");return n?[yield(0,R.f_4)(n,"LockerLocations").execute("lockers_allocated_to_me").catch(V=>[]),e]:[[],e]});return function(i){return s.apply(this,arguments)}}()),(0,o.T)(([s,i])=>s.map(e=>{const n=i.find(E=>E.id===e.locker_id);return n||e.level&&e.building?(e.level=e.level||n?.level_id,e.building=e.building||this._org.levelWithID([n?.level_id])?.parent_id,new O.Qr({date:(0,C.A)(Date.now()).valueOf(),duration:1439,title:"Locker Booking",description:e.locker_name,booking_type:"locker",all_day:!0,asset_id:n.map_id,asset_name:e.locker_name,zones:[e.building,e.level],extension_data:{}})):null}).filter(e=>e)),(0,_.W)(s=>(console.error(s),(0,a.of)([]))),(0,h.M)(()=>this.timeout("end_loading",()=>this._loading.next(!1))),(0,p.t)(1)),this.bookings=(0,A.zV)([this.events,this.visitors,this.desks,this.parking,this.lockers,this.group_events]).pipe((0,o.T)(([s,i,e,n,E,B])=>[...s.filter(c=>!e.find(b=>`${c.meeting_id}`==`${b.id}`)&&"group-event"!==c.linked_bookings[0]?.booking_type),...i,...e,...n,...E,...B].sort((c,b)=>c.date-b.date))),this.filtered_bookings=(0,A.zV)([this.bookings,this._filters]).pipe((0,o.T)(([s,i])=>s.filter(e=>!this._deleted.includes(e.id)&&e instanceof L.LR&&i?.shown_types?.includes("event")||i?.shown_types?.includes(e.booking_type)))),this.filters=this._filters.asObservable(),this.date=this._date.asObservable(),this.loading=this._loading.asObservable(),this._ignore_cancel=[],this._checkCancel=(0,A.zV)([D.U5,(0,m.Y)(6e4).pipe((0,x.Z)(0))]).pipe((0,y.p)(([s])=>!!s),(0,o.T)(function(){var s=(0,M.A)(function*([i]){const e="wfo"!==i.location,n=f._settings.get("app.auto_release");if(n&&e&&(n.time_after||n.time_before)&&n.resources?.length)for(const E of n.resources){const B=yield(0,O.tj)({period_start:(0,r.A)((0,S.A)(Date.now())),period_end:(0,r.A)((0,u.A)(Date.now(),(n.time_after||5)+(n.time_before||0))),type:E}).toPromise(),V=(n.time_after||0)+(n.time_before||0);for(const c of B){if(f._ignore_cancel.includes(c.id)||c.checked_in||c.rejected)continue;f._dialog.closeAll();const b=(0,I.A)((0,u.A)(c.date,n.time_after||0),Date.now());if(b>V||b<0)continue;const w=(0,u.A)(c.date,n.time_after||0),N="parking"===E?"reservation":"booking",J=yield(0,D.GE)({title:`Keep ${E} ${N}`,content:`You have indicated you are not in the office. \n                                Your  ${N} for "<i>${c.asset_name||c.title}</i>" at ${(0,j.A)(c.date,f._settings.time_format)} will be cancelled at ${(0,j.A)(w,f._settings.time_format)}.<br/><br/>\n                                Do you wish to keep this ${N}?`,icon:{content:"event_busy"},confirm_text:"Keep",cancel_text:"Dismiss"},f._dialog);"done"===J.reason?(J.loading("Checking in booking..."),yield(0,O.Z$)(c.id,!0).toPromise(),J.close()):f._ignore_cancel.push(c.id)}}});return function(i){return s.apply(this,arguments)}}())),this.subscription("poll_type",this._org.active_building.subscribe(()=>this._poll_type.next(this._settings.get("app.schedule.use_websocket")?"ws":"api"))),this.subscription("chat_event",this._settings.listen("CHAT:task_complete").subscribe(()=>this.triggerPoll())),this.subscription("wfh_checks",this._checkCancel.subscribe()),this._deleted=JSON.parse(sessionStorage.getItem("PLACEOS.events.deleted")||"[]")}triggerPoll(){this._poll.next(Date.now())}startPolling(g=6e4){return this.interval("poll",()=>this._poll.next(Date.now()),g),()=>this.stopPolling()}stopPolling(){this.clearInterval("poll")}setDate(g){this._date.next(g)}removeItem(g){this.setAsDeleted(g.id),this._poll.next(Date.now())}setAsDeleted(g){this._deleted.push(g),sessionStorage.setItem("PLACEOS.events.deleted",JSON.stringify(this._deleted))}toggleType(g,F=!1){var Y=this;return(0,M.A)(function*(){const Z=Y._filters.getValue()||{shown_types:[]},{shown_types:f}=Z;f&&(f.includes(g)||F)?Y._filters.next({...Z,shown_types:f.filter(s=>s!==g)}):Y._filters.next({...Z,shown_types:[...f,g]})})()}static#t=this.\u0275fac=function(F){return new(F||k)(T.KVO(D.h$),T.KVO(K.yb),T.KVO(O.$H),T.KVO(G.bZ))};static#s=this.\u0275prov=T.jDH({token:k,factory:k.\u0275fac,providedIn:"root"})}return k})()},79184:(Q,$,t)=>{t.d($,{y:()=>h});var M=t(57915),O=t(14055),D=t(21157),L=t(68113),K=t(67450),U=t(27419),R=t(88402),H=t(13264),r=t(90521),C=t(26320),W=t(42175),S=t(68757),u=t(71963),I=t(7841),j=t(19803),P=t(3107),A=t(35443),a=t(29314),m=t(66e3),d=t(68559);let h=(()=>{class y extends D.Tv{constructor(l){super(),this._settings=l,this._poll=new r.t(0),this._options=new r.t({start:Date.now()}),this._loading=new r.t(""),this._schedule=new r.t([]),this.options=this._options.asObservable(),this.loading=this._loading.asObservable(),this.schedule=this._loading.asObservable(),this.calendars=(0,C.O)(1e3).pipe((0,u.n)(v=>(0,O.CH)()),(0,I.t)(1)),this.events=(0,W.zV)([this._options,this._poll]).pipe((0,j.B)(1e3),(0,P.ZZ)(([v])=>{this._loading.next("Loading schedule...");const o={period_start:(0,K.A)((0,U.A)(v.start)),period_end:(0,K.A)((0,R.A)((0,H.A)(v.start),6))};return v.calendar&&(o.calendar=v.calendar),this._schedule.next(this._schedule.getValue().filter(_=>!(0,D.dH)(1e3*o.period_start,1e3*o.period_end,_.date,_.date+60*_.duration*1e3))),(0,S.p)([!0===this._settings.get("app.events.use_bookings")?(0,M.tj)({...o,type:"room"}).pipe((0,A.T)(_=>_.map(p=>(0,L.Uv)(p)))):(0,L.UU)({...o}),(0,M.tj)({...o,type:"desk"}),(0,M.tj)({...o,type:"parking"}),(0,M.tj)({...o,type:"group-event"})]).pipe((0,a.W)(_=>[]))}),(0,A.T)(([v,o,_,p])=>{const x=[...this._schedule.getValue(),...v,...o.filter(T=>"declined"!==T.status),...p.filter(T=>"declined"!==T.status)].sort((T,G)=>T.date-G.date);return this._schedule.next((0,D.Am)(x,"id")),x}),(0,a.W)(v=>[]),(0,m.M)(v=>this._loading.next("")),(0,I.t)(1))}startPolling(l=15e3){this.interval("poll",()=>this._poll.next(Date.now()),l)}stopPolling(){this.clearInterval("poll")}setOptions(l){this._options.next({...this._options.getValue(),...l})}static#t=this.\u0275fac=function(v){return new(v||y)(d.KVO(D.h$))};static#s=this.\u0275prov=d.jDH({token:y,factory:y.\u0275fac,providedIn:"root"})}return y})()},14055:(Q,$,t)=>{t.d($,{IE:()=>j,CH:()=>u.CH});var M=t(89204),O=t(90521),D=t(66e3),L=t(7841),K=t(57871),U=t(67450),R=t(27419),H=t(13264),r=t(53838),C=t(75354),W=t(14233),S=t(45762),u=t(96576),I=t(68559);let j=(()=>{class P extends C.T{constructor(a,m){super(),this._org=a,this._settings=m,this._calendars=new O.t([]),this.calendar_list=(0,u.CH)().pipe((0,D.M)(d=>this._calendars.next(d)),(0,L.t)(1)),this.query=()=>(0,u.CH)(),this.freeBusy=d=>(0,u.Yj)(d,this._org),this.availability=d=>(0,u.Sh)(d),this._org.initialised.pipe((0,K.$)(d=>d)).subscribe(()=>this.init())}init(){var a=this;return(0,M.A)(function*(){a._settings.get("app.events.use_bookings")||a._initialised.next(!0)})()}get calendars(){return this._calendars.getValue()}getFreeBusyDate(a,m){return(0,u.Yj)({period_start:(0,U.A)((0,R.A)(a)),period_end:(0,U.A)((0,H.A)(a)),calendars:m},this._org)}checkSpacesAvailability(a,m,d,h){return(0,M.A)(function*(){const y=yield(0,u.Sh)({period_start:m,period_end:d,system_ids:a.join(",")}).toPromise(),z=new Date(h?.date).valueOf(),l=(0,r.A)(z,h?.duration).valueOf();return!!y.every(o=>{const _=o.availability;if(h&&o.id===h.system?.email){const p=_.findIndex(x=>x.date>=z&&(0,r.A)(x.date,x.duration).valueOf()<=l);-1!==p&&_.splice(p,1)}return!_.length})})()}static#t=this.\u0275fac=function(m){return new(m||P)(I.KVO(S.y),I.KVO(W.h))};static#s=this.\u0275prov=I.jDH({token:P,factory:P.\u0275fac,providedIn:"root"})}return P})()}}]);
//# sourceMappingURL=common.js.map