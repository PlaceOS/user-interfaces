"use strict";(self.webpackChunkworkplace=self.webpackChunkworkplace||[]).push([["common"],{6205:(k,b,t)=>{t.d(b,{I:()=>N});var P=t(1670),D=t(8466),E=t(8927),C=t(6975),R=t(3121),Z=t(7049),j=t(2141),F=t(7393),l=t(7343),I=t(7016),T=t(4512),S=t(5702),O=t(8415),B=t(9737),U=t(462),d=t(8159),M=t(9681),h=t(7827),p=t(5933),r=t(5746),m=t(5046),y=t(8737),f=t(6520),L=t(5083),o=t(7422),_=t(8175),a=t(680),x=t(1062),u=t(9039),V=t(7401);let N=(()=>{class X extends E.cx{constructor(c,$,G,J){var v;super(),v=this,this._settings=c,this._org=$,this._lockers=G,this._dialog=J,this._poll=new U.X(0),this._poll_type=new U.X("api"),this._loading=new U.X(!1),this._filters=new U.X({shown_types:["event","desk","parking","visitor","locker"]}),this._date=new U.X(Date.now()),this._update=(0,d.aj)([this._date,this._poll]).pipe((0,p.b)(500),(0,r.b)(s=>this._loading.next(!0))),this._deleted=[],this._space_bookings=this._org.active_building.pipe((0,m.h)(s=>!!s),(0,y.g)("id"),(0,p.b)(300),(0,r.b)(s=>this.unsubWith("bind:")),(0,f.w)(({id:s})=>(this._loading.next(!0),(0,Z.u2)(s))),(0,L.x)(([s],[i])=>s!==i),(0,f.w)(s=>(this._loading.next(!1),(0,d.aj)((s||[]).map(i=>{const e=(0,j.rTZ)(i.id,"Bookings").binding("bookings"),n=e.listen().pipe((0,o.U)(g=>(g||[]).map(W=>new C.ym({...W,resources:W.attendees.filter(K=>K.email===i.email||K.resource),system:i}))),(0,_.K)(g=>(0,M.of)([])));return this.hasSubscription(`bind:${i.id}`)||this.subscription(`bind:${i.id}`,e.bind()),n})))),(0,o.U)(s=>(0,E.xH)(s)),(0,a.d)(1)),this.ws_events=(0,d.aj)([this._space_bookings,this._update]).pipe((0,o.U)(([s,[i]])=>{const e=(0,E.ar)();return s.filter(n=>(0,F.Z)(n.date,i)&&(n.host.toLowerCase()===e.email.toLowerCase()||n.attendees.find(g=>g.email.toLowerCase()===e.email.toLowerCase())))})),this.api_events=this._update.pipe((0,f.w)(([s])=>{const i={period_start:(0,l.Z)((0,I.Z)(s)),period_end:(0,l.Z)((0,T.Z)(s))};return this._settings.get("app.events.use_bookings")?(0,D.F2)({...i,type:"room"}).pipe((0,o.U)(e=>e.map(n=>(0,C.Yd)(n))),(0,_.K)(e=>(0,M.of)([]))):(0,C.u$)({...i}).pipe((0,_.K)(e=>(0,M.of)([])))}),(0,a.d)(1)),this.events=(0,d.aj)([this._poll_type]).pipe((0,f.w)(([s])=>"api"===s?this.api_events:this.ws_events),(0,r.b)(()=>this.timeout("end_loading",()=>this._loading.next(!1))),(0,a.d)(1)),this.visitors=this._update.pipe((0,f.w)(([s])=>(0,D.F2)({period_start:(0,l.Z)((0,I.Z)(s)),period_end:(0,l.Z)((0,T.Z)(s)),type:"visitor"}).pipe((0,_.K)(i=>(0,M.of)([])))),(0,o.U)(s=>s.filter(i=>!i.parent_id&&!i.linked_event)),(0,r.b)(()=>this.timeout("end_loading",()=>this._loading.next(!1))),(0,a.d)(1)),this.desks=this._update.pipe((0,f.w)(([s])=>(0,D.F2)({period_start:(0,l.Z)((0,I.Z)(s)),period_end:(0,l.Z)((0,T.Z)(s)),include_checked_out:!0,type:"desk"}).pipe((0,_.K)(i=>(0,M.of)([])))),(0,r.b)(()=>this.timeout("end_loading",()=>this._loading.next(!1))),(0,a.d)(1)),this.parking=this._update.pipe((0,f.w)(([s])=>(0,D.F2)({period_start:(0,l.Z)((0,I.Z)(s)),period_end:(0,l.Z)((0,T.Z)(s)),type:"parking"}).pipe((0,_.K)(i=>(0,M.of)([])))),(0,r.b)(()=>this.timeout("end_loading",()=>this._loading.next(!1))),(0,a.d)(1)),this.lockers=(0,d.aj)([this._org.active_building.pipe((0,m.h)(s=>!!s),(0,y.g)("id")),this._lockers.lockers$]).pipe((0,p.b)(300),(0,f.w)(function(){var s=(0,P.Z)(function*([i,e]){const n=v._org.binding("lockers");return n?[yield(0,j.rTZ)(n,"LockerLocations").execute("lockers_allocated_to_me").catch(K=>[]),e]:[[],e]});return function(i){return s.apply(this,arguments)}}()),(0,o.U)(([s,i])=>s.map(e=>{const n=i.find(g=>g.id===e.locker_id);return n||e.level&&e.building?(e.level=e.level||n?.level_id,e.building=e.building||this._org.levelWithID([n?.level_id])?.parent_id,new D.$N({date:(0,I.Z)(Date.now()).valueOf(),duration:1439,title:"Locker Booking",description:e.locker_name,booking_type:"locker",all_day:!0,asset_id:n.map_id,asset_name:e.locker_name,zones:[e.building,e.level],extension_data:{}})):null}).filter(e=>e)),(0,_.K)(s=>(console.error(s),(0,M.of)([]))),(0,r.b)(()=>this.timeout("end_loading",()=>this._loading.next(!1))),(0,a.d)(1)),this.bookings=(0,d.aj)([this.events,this.visitors,this.desks,this.parking,this.lockers]).pipe((0,o.U)(([s,i,e,n,g])=>[...s.filter(K=>!e.find(A=>`${K.meeting_id}`==`${A.id}`)),...i,...e,...n,...g].sort((K,A)=>K.date-A.date))),this.filtered_bookings=(0,d.aj)([this.bookings,this._filters]).pipe((0,o.U)(([s,i])=>s.filter(e=>!this._deleted.includes(e.id)&&e instanceof C.ym&&i?.shown_types?.includes("event")||i?.shown_types?.includes(e.booking_type)))),this.filters=this._filters.asObservable(),this.date=this._date.asObservable(),this.loading=this._loading.asObservable(),this._ignore_cancel=[],this._checkCancel=(0,d.aj)([E.pN,(0,h.F)(6e4).pipe((0,x.O)(0))]).pipe((0,m.h)(([s])=>!!s),(0,o.U)(function(){var s=(0,P.Z)(function*([i]){const e="wfo"!==i.location,n=v._settings.get("app.auto_release");if(n&&e&&(n.time_after||n.time_before)&&n.resources?.length)for(const g of n.resources){const W=yield(0,D.F2)({period_start:(0,l.Z)((0,S.Z)(Date.now())),period_end:(0,l.Z)((0,O.Z)(Date.now(),(n.time_after||5)+(n.time_before||0))),type:g}).toPromise();console.log("Check Bookings:",g,W,v._ignore_cancel);const K=(n.time_after||0)+(n.time_before||0);for(const A of W){if(v._ignore_cancel.includes(A.id)||A.checked_in)continue;v._dialog.closeAll();const z=(0,B.Z)((0,O.Z)(A.date,n.time_after||0),Date.now());if(z>K)continue;const Y=yield(0,E._5)({title:`Keep ${g} booking`,content:`You have indicated you are not in the office. \n                                Your booking will be cancelled in about ${z} minutes. \n                                Do you wish to keep this booking?`,icon:{content:"cancel"},confirm_text:"Keep",cancel_text:"Dismiss"},v._dialog);"done"===Y.reason?(Y.loading("Checking in booking..."),yield(0,D.FD)(A.id,!0).toPromise(),Y.close()):v._ignore_cancel.push(A.id)}}});return function(i){return s.apply(this,arguments)}}())),this.subscription("poll_type",this._org.active_building.subscribe(()=>this._poll_type.next(this._settings.get("app.schedule.use_websocket")?"ws":"api"))),this.subscription("chat_event",this._settings.listen("CHAT:task_complete").subscribe(()=>this.triggerPoll())),this.subscription("wfh_checks",this._checkCancel.subscribe()),this._deleted=JSON.parse(sessionStorage.getItem("PLACEOS.events.deleted")||"[]")}triggerPoll(){this._poll.next(Date.now())}startPolling(c=6e4){return this.interval("poll",()=>this._poll.next(Date.now()),c),()=>this.stopPolling()}stopPolling(){this.clearInterval("poll")}setDate(c){this._date.next(c)}removeItem(c){this.setAsDeleted(c.id),this._poll.next(Date.now())}setAsDeleted(c){this._deleted.push(c),sessionStorage.setItem("PLACEOS.events.deleted",JSON.stringify(this._deleted))}toggleType(c,$=!1){var G=this;return(0,P.Z)(function*(){const J=G._filters.getValue()||{shown_types:[]},{shown_types:v}=J;v&&(v.includes(c)||$)?G._filters.next({...J,shown_types:v.filter(s=>s!==c)}):G._filters.next({...J,shown_types:[...v,c]})})()}static#t=this.\u0275fac=function($){return new($||X)(u.LFG(E.gb),u.LFG(R.w7),u.LFG(D.At),u.LFG(V.uw))};static#s=this.\u0275prov=u.Yz7({token:X,factory:X.\u0275fac,providedIn:"root"})}return X})()},6386:(k,b,t)=>{t.d(b,{I:()=>m});var P=t(8466),D=t(8691),E=t(8927),C=t(6975),R=t(7343),Z=t(7016),j=t(5822),F=t(4512),l=t(462),I=t(8435),T=t(8159),S=t(2130),O=t(6520),B=t(680),U=t(5933),d=t(7965),M=t(7422),h=t(8175),p=t(5746),r=t(9039);let m=(()=>{class y extends E.cx{constructor(L){super(),this._settings=L,this._poll=new l.X(0),this._options=new l.X({start:Date.now()}),this._loading=new l.X(""),this._schedule=new l.X([]),this.options=this._options.asObservable(),this.loading=this._loading.asObservable(),this.schedule=this._loading.asObservable(),this.calendars=(0,I.H)(1e3).pipe((0,O.w)(o=>(0,D.yJ)()),(0,B.d)(1)),this.events=(0,T.aj)([this._options,this._poll]).pipe((0,U.b)(1e3),(0,d.zg)(([o])=>{this._loading.next("Loading schedule...");const _={period_start:(0,R.Z)((0,Z.Z)(o.start)),period_end:(0,R.Z)((0,j.Z)((0,F.Z)(o.start),6))};return o.calendar&&(_.calendar=o.calendar),this._schedule.next(this._schedule.getValue().filter(a=>!(0,E.MZ)(1e3*_.period_start,1e3*_.period_end,a.date,a.date+60*a.duration*1e3))),(0,S.D)([!0===this._settings.get("app.events.use_bookings")?(0,P.F2)({..._,type:"room"}).pipe((0,M.U)(a=>a.map(x=>(0,C.Yd)(x)))):(0,C.u$)({..._}),(0,P.F2)({..._,type:"desk"}),(0,P.F2)({..._,type:"parking"})]).pipe((0,h.K)(a=>[]))}),(0,M.U)(([o,_])=>{const a=[...this._schedule.getValue(),...o,..._.filter(x=>"declined"!==x.status)].sort((x,u)=>x.date-u.date);return this._schedule.next((0,E.Tw)(a,"id")),a}),(0,h.K)(o=>[]),(0,p.b)(o=>this._loading.next("")),(0,B.d)(1))}startPolling(L=15e3){this.interval("poll",()=>this._poll.next(Date.now()),L)}stopPolling(){this.clearInterval("poll")}setOptions(L){this._options.next({...this._options.getValue(),...L})}static#t=this.\u0275fac=function(o){return new(o||y)(r.LFG(E.gb))};static#s=this.\u0275prov=r.Yz7({token:y,factory:y.\u0275fac,providedIn:"root"})}return y})()},8691:(k,b,t)=>{t.d(b,{ot:()=>U,yJ:()=>O.yJ});var P=t(1670),D=t(462),E=t(5746),C=t(680),R=t(7627),Z=t(7343),j=t(7016),F=t(4512),l=t(8415),I=t(6474),T=t(4411),S=t(4955),O=t(6511),B=t(9039);let U=(()=>{class d extends I.c{constructor(h,p){super(),this._org=h,this._settings=p,this._calendars=new D.X([]),this.calendar_list=(0,O.yJ)().pipe((0,E.b)(r=>this._calendars.next(r)),(0,C.d)(1)),this.query=()=>(0,O.yJ)(),this.freeBusy=r=>(0,O.tS)(r,this._org),this.availability=r=>(0,O.v7)(r),this._org.initialised.pipe((0,R.P)(r=>r)).subscribe(()=>this.init())}init(){var h=this;return(0,P.Z)(function*(){h._settings.get("app.events.use_bookings")||h._initialised.next(!0)})()}get calendars(){return this._calendars.getValue()}getFreeBusyDate(h,p){return(0,O.tS)({period_start:(0,Z.Z)((0,j.Z)(h)),period_end:(0,Z.Z)((0,F.Z)(h)),calendars:p},this._org)}checkSpacesAvailability(h,p,r,m){return(0,P.Z)(function*(){const y=yield(0,O.v7)({period_start:p,period_end:r,system_ids:h.join(",")}).toPromise(),f=new Date(m?.date).valueOf(),L=(0,l.Z)(f,m?.duration).valueOf();return!!y.every(_=>{const a=_.availability;if(m&&_.id===m.system?.email){const x=a.findIndex(u=>u.date>=f&&(0,l.Z)(u.date,u.duration).valueOf()<=L);-1!==x&&a.splice(x,1)}return!a.length})})()}static#t=this.\u0275fac=function(p){return new(p||d)(B.LFG(S.w),B.LFG(T.g))};static#s=this.\u0275prov=B.Yz7({token:d,factory:d.\u0275fac,providedIn:"root"})}return d})()}}]);
//# sourceMappingURL=common.js.map