"use strict";(self.webpackChunkworkplace=self.webpackChunkworkplace||[]).push([["common"],{5323:(w,H,t)=>{t.d(H,{y:()=>st});var u=t(9204),f=t(7915),D=t(2768),T=t(8113),R=t(2185),j=t(2168),V=t(118),S=t(1257),l=t(9908),A=t(3240),L=t(6441),k=t(3206),O=t(9675),x=t(1874),F=t(5213),m=t(4268),I=t(521),o=t(2175),d=t(1536),E=t(6020),y=t(9803),p=t(6e3),$=t(8627),P=t(7504),r=t(1963),c=t(6109),n=t(5443),v=t(9314),g=t(7841),U=t(9273),W=t(7404),et=t(2587);let st=(()=>{class G extends D.Tv{constructor(h,Y,Z,N,b){var M;super(),M=this,this._settings=h,this._org=Y,this._lockers=Z,this._dialog=N,this._parking=b,this._poll=new I.t(0),this._poll_type=new I.t("api"),this._loading=new I.t(!1),this._filters=new I.t({shown_types:["event","desk","parking","visitor","locker","group-event"]}),this._date=new I.t(Date.now()),this._update=(0,o.zV)([this._date,this._poll]).pipe((0,y.B)(500),(0,p.M)(e=>this._loading.next(!0))),this._deleted=[],this._space_bookings=this._org.active_building.pipe((0,$.p)(e=>!!e),(0,P.w)("id"),(0,y.B)(300),(0,p.M)(e=>this.unsubWith("bind:")),(0,r.n)(({id:e})=>(this._loading.next(!0),(0,j.Ot)(e))),(0,c.F)(([e],[i])=>e!==i),(0,r.n)(e=>(this._loading.next(!1),(0,o.zV)((e||[]).map(i=>{const s=(0,V.f_4)(i.id,"Bookings").binding("bookings"),_=s.listen().pipe((0,n.T)(a=>(a||[]).map(B=>new T.LR({...B,resources:B.attendees.filter(K=>K.email===i.email||K.resource),system:i}))),(0,v.W)(a=>(0,d.of)([])));return this.hasSubscription(`bind:${i.id}`)||this.subscription(`bind:${i.id}`,s.bind()),_})))),(0,n.T)(e=>(0,D.Bq)(e)),(0,g.t)(1)),this.ws_events=(0,o.zV)([this._space_bookings,this._update]).pipe((0,n.T)(([e,[i]])=>{const s=(0,D.Ny)();return e.filter(_=>(0,S.r)(_.date,i)&&(_.host.toLowerCase()===s.email.toLowerCase()||_.attendees.find(a=>a.email.toLowerCase()===s.email.toLowerCase()))&&!_.linked_bookings?.find(a=>"group-event"===a.booking_type))})),this.api_events=this._update.pipe((0,r.n)(([e])=>{const i={period_start:(0,l._)((0,A.o)(e)),period_end:(0,l._)((0,L.D)(e))};return this._settings.get("app.events.use_bookings")?(0,f.tj)({...i,type:"room"}).pipe((0,n.T)(s=>s.map(_=>(0,T.Uv)(_))),(0,v.W)(s=>(0,d.of)([]))):(0,T.UU)({...i}).pipe((0,v.W)(s=>(0,d.of)([])))}),(0,g.t)(1)),this.raw_events=(0,o.zV)([this._poll_type]).pipe((0,r.n)(([e])=>"api"===e?this.api_events:this.ws_events),(0,p.M)(()=>this.timeout("end_loading",()=>this._loading.next(!1))),(0,g.t)(1)),this.events=this.raw_events.pipe((0,n.T)(e=>e.filter(i=>!i.extension_data?.shared_event))),this.visitors=this._update.pipe((0,r.n)(([e])=>(0,f.tj)({period_start:(0,l._)((0,A.o)(e)),period_end:(0,l._)((0,L.D)(e)),type:"visitor"}).pipe((0,v.W)(i=>(0,d.of)([])))),(0,n.T)(e=>e.filter(i=>!i.parent_id&&!i.linked_event)),(0,p.M)(()=>this.timeout("end_loading",()=>this._loading.next(!1))),(0,g.t)(1)),this.desks=this._update.pipe((0,r.n)(([e])=>(0,f.tj)({period_start:(0,l._)((0,A.o)(e)),period_end:(0,l._)((0,L.D)(e)),include_checked_out:!0,type:"desk"}).pipe((0,v.W)(i=>(0,d.of)([])))),(0,p.M)(()=>this.timeout("end_loading",()=>this._loading.next(!1))),(0,g.t)(1)),this.parking=this._update.pipe((0,r.n)(([e])=>(0,f.tj)({period_start:(0,l._)((0,A.o)(e)),period_end:(0,l._)((0,L.D)(e)),type:"parking",include_deleted:"recurring"}).pipe((0,v.W)(i=>(0,d.of)([])))),(0,p.M)(()=>this.timeout("end_loading",()=>this._loading.next(!1))),(0,g.t)(1)),this.group_events=this.raw_events.pipe((0,n.T)(e=>e.filter(i=>i.extension_data?.shared_event))),this.lockers=(0,o.zV)([this._org.active_building.pipe((0,$.p)(e=>!!e),(0,P.w)("id")),this._lockers.lockers$]).pipe((0,y.B)(300),(0,r.n)(function(){var e=(0,u.A)(function*([i,s]){const _=M._org.binding("lockers");return _?[yield(0,V.f_4)(_,"LockerLocations").execute("lockers_allocated_to_me").catch(K=>[]),s]:[[],s]});return function(i){return e.apply(this,arguments)}}()),(0,n.T)(([e,i])=>e.map(s=>{const _=i.find(a=>a.id===s.locker_id);return _||s.level&&s.building?(s.level=s.level||_?.level_id,s.building=s.building||this._org.levelWithID([_?.level_id])?.parent_id,new f.Qr({date:(0,A.o)(Date.now()).valueOf(),duration:1439,title:"Locker Booking",description:s.locker_name,booking_type:"locker",all_day:!0,asset_id:_.map_id,asset_name:s.locker_name,zones:[s.building,s.level],extension_data:{}})):null}).filter(s=>s)),(0,v.W)(e=>(console.error(e),(0,d.of)([]))),(0,p.M)(()=>this.timeout("end_loading",()=>this._loading.next(!1))),(0,g.t)(1)),this.bookings=(0,o.zV)([this.events,this.visitors,this.desks,this.parking,this.lockers,this.group_events]).pipe((0,n.T)(([e,i,s,_,a,B])=>[...e.filter(z=>!s.find(J=>`${z.meeting_id}`==`${J.id}`)&&"group-event"!==z.linked_bookings[0]?.booking_type),...i,...s,..._,...a,...B].sort((z,J)=>z.date-J.date))),this.filtered_bookings=(0,o.zV)([this.bookings,this._filters]).pipe((0,n.T)(([e,i])=>e.filter(s=>!(this._deleted.includes(s.instance?`${s.id}|${s.instance}`:s.id)||s.extension_data?.shared_event&&!i?.shown_types?.includes("group-event")||s instanceof T.LR&&!s.extension_data?.shared_event&&!i?.shown_types?.includes("event"))&&(s instanceof T.LR||i?.shown_types?.includes(s.booking_type))))),this.filters=this._filters.asObservable(),this.date=this._date.asObservable(),this.loading=this._loading.asObservable(),this._ignore_cancel=[],this._checkCancel=(0,o.zV)([D.U5,(0,E.Y)(6e4).pipe((0,U.Z)(0))]).pipe((0,$.p)(([e])=>!!e),(0,n.T)(function(){var e=(0,u.A)(function*([i]){const s="wfo"!==i.location,_=i.in_hours,a=M._settings.get("app.auto_release");if(a&&s&&_&&(a.time_after||a.time_before)&&a.resources?.length){const B=Math.min(60,a.time_before||0);for(const K of a.resources){const z=yield(0,f.tj)({period_start:(0,l._)((0,k.c)(Date.now())),period_end:(0,l._)((0,O.z)(Date.now(),(a.time_after||5)+B)),type:K}).toPromise(),J=(a.time_after||0)+B;for(const C of z){if(M._ignore_cancel.includes(C.id)||C.checked_in||C.rejected)continue;M._dialog.closeAll();const q=(0,x.o)((0,O.z)(C.date,a.time_after||0),Date.now());if(q>J||q<0)continue;const tt=(0,O.z)(C.date,a.time_after||0),it=(0,F.b)(tt.getTime()+6e4,Date.now()),Q="parking"===K?"reservation":"booking",X=yield(0,D.GE)({title:`Keep ${K} ${Q}`,content:`You have indicated you are not in the office. \n                                Your  ${Q} for "<i>${C.asset_name||C.title}</i>" at ${(0,m.GP)(C.date,M._settings.time_format)} will be cancelled at ${(0,m.GP)(tt,M._settings.time_format)}.<br/><br/>\n                                Do you wish to keep this ${Q}?`,icon:{content:"event_busy"},confirm_text:"Keep",cancel_text:"Dismiss",close_delay:it},M._dialog);"done"===X.reason?(X.loading("Checking in booking..."),yield(0,f.Z$)(C.id,!0).toPromise(),X.close()):M._ignore_cancel.push(C.id)}}}});return function(i){return e.apply(this,arguments)}}())),this.subscription("poll_type",this._org.active_building.subscribe(()=>this._poll_type.next(this._settings.get("app.schedule.use_websocket")?"ws":"api"))),this.subscription("chat_event",this._settings.listen("CHAT:task_complete").subscribe(()=>this.triggerPoll())),this.subscription("wfh_checks",this._checkCancel.subscribe()),this._deleted=JSON.parse(sessionStorage.getItem("PLACEOS.events.deleted")||"[]")}triggerPoll(){this._poll.next(Date.now())}startPolling(h=6e4){return this.interval("poll",()=>this._poll.next(Date.now()),h),()=>this.stopPolling()}stopPolling(){this.clearInterval("poll")}setDate(h){this._date.next(h)}removeItem(h){this.setAsDeleted(h.instance?`${h.id}|${h.instance}`:h.id),this._poll.next(Date.now())}setAsDeleted(h){this._deleted.push(h),sessionStorage.setItem("PLACEOS.events.deleted",JSON.stringify(this._deleted))}toggleType(h,Y=!1){var Z=this;return(0,u.A)(function*(){const N=Z._filters.getValue()||{shown_types:[]},{shown_types:b}=N;b&&(b.includes(h)||Y)?Z._filters.next({...N,shown_types:b.filter(M=>M!==h)}):Z._filters.next({...N,shown_types:[...b,h]})})()}static#t=this.\u0275fac=function(Y){return new(Y||G)(W.KVO(D.h$),W.KVO(R.yb),W.KVO(f.$H),W.KVO(et.bZ),W.KVO(f.wu))};static#e=this.\u0275prov=W.jDH({token:G,factory:G.\u0275fac,providedIn:"root"})}return G})()},9184:(w,H,t)=>{t.d(H,{y:()=>y});var u=t(7915),f=t(4055),D=t(2768),T=t(8113),R=t(9908),j=t(3240),V=t(8797),S=t(6441),l=t(521),A=t(6320),L=t(2175),k=t(8757),O=t(1963),x=t(7841),F=t(9803),m=t(3107),I=t(5443),o=t(9314),d=t(6e3),E=t(7404);let y=(()=>{class p extends D.Tv{constructor(P){super(),this._settings=P,this._poll=new l.t(0),this._options=new l.t({start:Date.now()}),this._loading=new l.t(""),this._schedule=new l.t([]),this.options=this._options.asObservable(),this.loading=this._loading.asObservable(),this.schedule=this._loading.asObservable(),this.calendars=(0,A.O)(1e3).pipe((0,O.n)(r=>(0,f.CH)()),(0,x.t)(1)),this.events=(0,L.zV)([this._options,this._poll]).pipe((0,F.B)(1e3),(0,m.ZZ)(([r])=>{this._loading.next("Loading schedule...");const c={period_start:(0,R._)((0,j.o)(r.start)),period_end:(0,R._)((0,V.f)((0,S.D)(r.start),6))};return r.calendar&&(c.calendar=r.calendar),this._schedule.next(this._schedule.getValue().filter(n=>!(0,D.dH)(1e3*c.period_start,1e3*c.period_end,n.date,n.date+60*n.duration*1e3))),(0,k.p)([!0===this._settings.get("app.events.use_bookings")?(0,u.tj)({...c,type:"room"}).pipe((0,I.T)(n=>n.map(v=>(0,T.Uv)(v)))):(0,T.UU)({...c}),(0,u.tj)({...c,type:"desk"}),(0,u.tj)({...c,type:"parking"}),(0,u.tj)({...c,type:"group-event"})]).pipe((0,o.W)(n=>[]))}),(0,I.T)(([r,c,n,v])=>{const g=[...this._schedule.getValue(),...r,...c.filter(U=>"declined"!==U.status),...v.filter(U=>"declined"!==U.status)].sort((U,W)=>U.date-W.date);return this._schedule.next((0,D.Am)(g,"id")),g}),(0,o.W)(r=>[]),(0,d.M)(r=>this._loading.next("")),(0,x.t)(1))}startPolling(P=15e3){this.interval("poll",()=>this._poll.next(Date.now()),P)}stopPolling(){this.clearInterval("poll")}setOptions(P){this._options.next({...this._options.getValue(),...P})}static#t=this.\u0275fac=function(r){return new(r||p)(E.KVO(D.h$))};static#e=this.\u0275prov=E.jDH({token:p,factory:p.\u0275fac,providedIn:"root"})}return p})()},4055:(w,H,t)=>{t.d(H,{IE:()=>F,CH:()=>O.CH});var u=t(9204),f=t(521),D=t(6e3),T=t(7841),R=t(7871),j=t(9908),V=t(3240),S=t(6441),l=t(9675),A=t(5354),L=t(4233),k=t(5762),O=t(6576),x=t(7404);let F=(()=>{class m extends A.T{constructor(o,d){super(),this._org=o,this._settings=d,this._calendars=new f.t([]),this.calendar_list=(0,O.CH)().pipe((0,D.M)(E=>this._calendars.next(E)),(0,T.t)(1)),this.query=()=>(0,O.CH)(),this.freeBusy=E=>(0,O.Yj)(E,this._org),this.availability=E=>(0,O.Sh)(E),this._org.initialised.pipe((0,R.$)(E=>E)).subscribe(()=>this.init())}init(){var o=this;return(0,u.A)(function*(){o._settings.get("app.events.use_bookings")||o._initialised.next(!0)})()}get calendars(){return this._calendars.getValue()}getFreeBusyDate(o,d){return(0,O.Yj)({period_start:(0,j._)((0,V.o)(o)),period_end:(0,j._)((0,S.D)(o)),calendars:d},this._org)}checkSpacesAvailability(o,d,E,y){return(0,u.A)(function*(){const p=yield(0,O.Sh)({period_start:d,period_end:E,system_ids:o.join(",")}).toPromise(),$=new Date(y?.date).valueOf(),P=(0,l.z)($,y?.duration).valueOf();return!!p.every(c=>{const n=c.availability;if(y&&c.id===y.system?.email){const v=n.findIndex(g=>g.date>=$&&(0,l.z)(g.date,g.duration).valueOf()<=P);-1!==v&&n.splice(v,1)}return!n.length})})()}static#t=this.\u0275fac=function(d){return new(d||m)(x.KVO(k.y),x.KVO(L.h))};static#e=this.\u0275prov=x.jDH({token:m,factory:m.\u0275fac,providedIn:"root"})}return m})()}}]);
//# sourceMappingURL=common.js.map