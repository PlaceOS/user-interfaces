"use strict";(self.webpackChunkworkplace=self.webpackChunkworkplace||[]).push([["common"],{6205:(V,j,t)=>{t.d(j,{I:()=>H});var L=t(1670),P=t(8466),g=t(2767),x=t(6975),T=t(3121),B=t(7049),W=t(2141),b=t(7393),_=t(7343),C=t(7016),U=t(4512),F=t(5702),D=t(8415),K=t(9737),R=t(873),f=t(462),M=t(8159),a=t(9681),m=t(7827),d=t(5933),E=t(5746),y=t(5046),$=t(8737),l=t(6520),c=t(5083),o=t(7422),r=t(8175),h=t(680),A=t(1062),S=t(9039),k=t(7401);let H=(()=>{class X extends g.cx{constructor(p,G,J,Y){var v;super(),v=this,this._settings=p,this._org=G,this._lockers=J,this._dialog=Y,this._poll=new f.X(0),this._poll_type=new f.X("api"),this._loading=new f.X(!1),this._filters=new f.X({shown_types:["event","desk","parking","visitor","locker"]}),this._date=new f.X(Date.now()),this._update=(0,M.aj)([this._date,this._poll]).pipe((0,d.b)(500),(0,E.b)(s=>this._loading.next(!0))),this._deleted=[],this._space_bookings=this._org.active_building.pipe((0,y.h)(s=>!!s),(0,$.g)("id"),(0,d.b)(300),(0,E.b)(s=>this.unsubWith("bind:")),(0,l.w)(({id:s})=>(this._loading.next(!0),(0,B.u2)(s))),(0,c.x)(([s],[i])=>s!==i),(0,l.w)(s=>(this._loading.next(!1),(0,M.aj)((s||[]).map(i=>{const e=(0,W.rTZ)(i.id,"Bookings").binding("bookings"),n=e.listen().pipe((0,o.U)(u=>(u||[]).map(Z=>new x.ym({...Z,resources:Z.attendees.filter(I=>I.email===i.email||I.resource),system:i}))),(0,r.K)(u=>(0,a.of)([])));return this.hasSubscription(`bind:${i.id}`)||this.subscription(`bind:${i.id}`,e.bind()),n})))),(0,o.U)(s=>(0,g.xH)(s)),(0,h.d)(1)),this.ws_events=(0,M.aj)([this._space_bookings,this._update]).pipe((0,o.U)(([s,[i]])=>{const e=(0,g.ar)();return s.filter(n=>(0,b.Z)(n.date,i)&&(n.host.toLowerCase()===e.email.toLowerCase()||n.attendees.find(u=>u.email.toLowerCase()===e.email.toLowerCase())))})),this.api_events=this._update.pipe((0,l.w)(([s])=>{const i={period_start:(0,_.Z)((0,C.Z)(s)),period_end:(0,_.Z)((0,U.Z)(s))};return this._settings.get("app.events.use_bookings")?(0,P.F2)({...i,type:"room"}).pipe((0,o.U)(e=>e.map(n=>(0,x.Yd)(n))),(0,r.K)(e=>(0,a.of)([]))):(0,x.u$)({...i}).pipe((0,r.K)(e=>(0,a.of)([])))}),(0,h.d)(1)),this.events=(0,M.aj)([this._poll_type]).pipe((0,l.w)(([s])=>"api"===s?this.api_events:this.ws_events),(0,E.b)(()=>this.timeout("end_loading",()=>this._loading.next(!1))),(0,h.d)(1)),this.visitors=this._update.pipe((0,l.w)(([s])=>(0,P.F2)({period_start:(0,_.Z)((0,C.Z)(s)),period_end:(0,_.Z)((0,U.Z)(s)),type:"visitor"}).pipe((0,r.K)(i=>(0,a.of)([])))),(0,o.U)(s=>s.filter(i=>!i.parent_id&&!i.linked_event)),(0,E.b)(()=>this.timeout("end_loading",()=>this._loading.next(!1))),(0,h.d)(1)),this.desks=this._update.pipe((0,l.w)(([s])=>(0,P.F2)({period_start:(0,_.Z)((0,C.Z)(s)),period_end:(0,_.Z)((0,U.Z)(s)),include_checked_out:!0,type:"desk"}).pipe((0,r.K)(i=>(0,a.of)([])))),(0,E.b)(()=>this.timeout("end_loading",()=>this._loading.next(!1))),(0,h.d)(1)),this.parking=this._update.pipe((0,l.w)(([s])=>(0,P.F2)({period_start:(0,_.Z)((0,C.Z)(s)),period_end:(0,_.Z)((0,U.Z)(s)),type:"parking"}).pipe((0,r.K)(i=>(0,a.of)([])))),(0,E.b)(()=>this.timeout("end_loading",()=>this._loading.next(!1))),(0,h.d)(1)),this.lockers=(0,M.aj)([this._org.active_building.pipe((0,y.h)(s=>!!s),(0,$.g)("id")),this._lockers.lockers$]).pipe((0,d.b)(300),(0,l.w)(function(){var s=(0,L.Z)(function*([i,e]){const n=v._org.binding("lockers");return n?[yield(0,W.rTZ)(n,"LockerLocations").execute("lockers_allocated_to_me").catch(I=>[]),e]:[[],e]});return function(i){return s.apply(this,arguments)}}()),(0,o.U)(([s,i])=>s.map(e=>{const n=i.find(u=>u.id===e.locker_id);return n||e.level&&e.building?(e.level=e.level||n?.level_id,e.building=e.building||this._org.levelWithID([n?.level_id])?.parent_id,new P.$N({date:(0,C.Z)(Date.now()).valueOf(),duration:1439,title:"Locker Booking",description:e.locker_name,booking_type:"locker",all_day:!0,asset_id:n.map_id,asset_name:e.locker_name,zones:[e.building,e.level],extension_data:{}})):null}).filter(e=>e)),(0,r.K)(s=>(console.error(s),(0,a.of)([]))),(0,E.b)(()=>this.timeout("end_loading",()=>this._loading.next(!1))),(0,h.d)(1)),this.bookings=(0,M.aj)([this.events,this.visitors,this.desks,this.parking,this.lockers]).pipe((0,o.U)(([s,i,e,n,u])=>[...s.filter(I=>!e.find(O=>`${I.meeting_id}`==`${O.id}`)),...i,...e,...n,...u].sort((I,O)=>I.date-O.date))),this.filtered_bookings=(0,M.aj)([this.bookings,this._filters]).pipe((0,o.U)(([s,i])=>s.filter(e=>!this._deleted.includes(e.id)&&e instanceof x.ym&&i?.shown_types?.includes("event")||i?.shown_types?.includes(e.booking_type)))),this.filters=this._filters.asObservable(),this.date=this._date.asObservable(),this.loading=this._loading.asObservable(),this._ignore_cancel=[],this._checkCancel=(0,M.aj)([g.pN,(0,m.F)(6e4).pipe((0,A.O)(0))]).pipe((0,y.h)(([s])=>!!s),(0,o.U)(function(){var s=(0,L.Z)(function*([i]){const e="wfo"!==i.location,n=v._settings.get("app.auto_release");if(n&&e&&(n.time_after||n.time_before)&&n.resources?.length)for(const u of n.resources){const Z=yield(0,P.F2)({period_start:(0,_.Z)((0,F.Z)(Date.now())),period_end:(0,_.Z)((0,D.Z)(Date.now(),(n.time_after||5)+(n.time_before||0))),type:u}).toPromise(),I=(n.time_after||0)+(n.time_before||0);for(const O of Z){if(v._ignore_cancel.includes(O.id)||O.checked_in||O.rejected)continue;v._dialog.closeAll();const N=(0,K.Z)((0,D.Z)(O.date,n.time_after||0),Date.now());if(N>I||N<0)continue;const w=(0,D.Z)(O.date,n.time_after||0),z=yield(0,g._5)({title:`Keep ${u} booking`,content:`You have indicated you are not in the office. \n                                Your booking "${O.title}" for ${(0,R.Z)(O.date,v._settings.time_format)} will be cancelled at ${(0,R.Z)(w,v._settings.time_format)}.<br/><br/>\n                                Do you wish to keep this booking?`,icon:{content:"cancel"},confirm_text:"Keep",cancel_text:"Dismiss"},v._dialog);"done"===z.reason?(z.loading("Checking in booking..."),yield(0,P.FD)(O.id,!0).toPromise(),z.close()):v._ignore_cancel.push(O.id)}}});return function(i){return s.apply(this,arguments)}}())),this.subscription("poll_type",this._org.active_building.subscribe(()=>this._poll_type.next(this._settings.get("app.schedule.use_websocket")?"ws":"api"))),this.subscription("chat_event",this._settings.listen("CHAT:task_complete").subscribe(()=>this.triggerPoll())),this.subscription("wfh_checks",this._checkCancel.subscribe()),this._deleted=JSON.parse(sessionStorage.getItem("PLACEOS.events.deleted")||"[]")}triggerPoll(){this._poll.next(Date.now())}startPolling(p=6e4){return this.interval("poll",()=>this._poll.next(Date.now()),p),()=>this.stopPolling()}stopPolling(){this.clearInterval("poll")}setDate(p){this._date.next(p)}removeItem(p){this.setAsDeleted(p.id),this._poll.next(Date.now())}setAsDeleted(p){this._deleted.push(p),sessionStorage.setItem("PLACEOS.events.deleted",JSON.stringify(this._deleted))}toggleType(p,G=!1){var J=this;return(0,L.Z)(function*(){const Y=J._filters.getValue()||{shown_types:[]},{shown_types:v}=Y;v&&(v.includes(p)||G)?J._filters.next({...Y,shown_types:v.filter(s=>s!==p)}):J._filters.next({...Y,shown_types:[...v,p]})})()}static#t=this.\u0275fac=function(G){return new(G||X)(S.LFG(g.gb),S.LFG(T.w7),S.LFG(P.At),S.LFG(k.uw))};static#s=this.\u0275prov=S.Yz7({token:X,factory:X.\u0275fac,providedIn:"root"})}return X})()},6386:(V,j,t)=>{t.d(j,{I:()=>E});var L=t(8466),P=t(8691),g=t(2767),x=t(6975),T=t(7343),B=t(7016),W=t(5822),b=t(4512),_=t(462),C=t(8435),U=t(8159),F=t(2130),D=t(6520),K=t(680),R=t(5933),f=t(7965),M=t(7422),a=t(8175),m=t(5746),d=t(9039);let E=(()=>{class y extends g.cx{constructor(l){super(),this._settings=l,this._poll=new _.X(0),this._options=new _.X({start:Date.now()}),this._loading=new _.X(""),this._schedule=new _.X([]),this.options=this._options.asObservable(),this.loading=this._loading.asObservable(),this.schedule=this._loading.asObservable(),this.calendars=(0,C.H)(1e3).pipe((0,D.w)(c=>(0,P.yJ)()),(0,K.d)(1)),this.events=(0,U.aj)([this._options,this._poll]).pipe((0,R.b)(1e3),(0,f.zg)(([c])=>{this._loading.next("Loading schedule...");const o={period_start:(0,T.Z)((0,B.Z)(c.start)),period_end:(0,T.Z)((0,W.Z)((0,b.Z)(c.start),6))};return c.calendar&&(o.calendar=c.calendar),this._schedule.next(this._schedule.getValue().filter(r=>!(0,g.MZ)(1e3*o.period_start,1e3*o.period_end,r.date,r.date+60*r.duration*1e3))),(0,F.D)([!0===this._settings.get("app.events.use_bookings")?(0,L.F2)({...o,type:"room"}).pipe((0,M.U)(r=>r.map(h=>(0,x.Yd)(h)))):(0,x.u$)({...o}),(0,L.F2)({...o,type:"desk"}),(0,L.F2)({...o,type:"parking"})]).pipe((0,a.K)(r=>[]))}),(0,M.U)(([c,o])=>{const r=[...this._schedule.getValue(),...c,...o.filter(h=>"declined"!==h.status)].sort((h,A)=>h.date-A.date);return this._schedule.next((0,g.Tw)(r,"id")),r}),(0,a.K)(c=>[]),(0,m.b)(c=>this._loading.next("")),(0,K.d)(1))}startPolling(l=15e3){this.interval("poll",()=>this._poll.next(Date.now()),l)}stopPolling(){this.clearInterval("poll")}setOptions(l){this._options.next({...this._options.getValue(),...l})}static#t=this.\u0275fac=function(c){return new(c||y)(d.LFG(g.gb))};static#s=this.\u0275prov=d.Yz7({token:y,factory:y.\u0275fac,providedIn:"root"})}return y})()},8691:(V,j,t)=>{t.d(j,{ot:()=>R,yJ:()=>D.yJ});var L=t(1670),P=t(462),g=t(5746),x=t(680),T=t(7627),B=t(7343),W=t(7016),b=t(4512),_=t(8415),C=t(6474),U=t(4411),F=t(4955),D=t(6511),K=t(9039);let R=(()=>{class f extends C.c{constructor(a,m){super(),this._org=a,this._settings=m,this._calendars=new P.X([]),this.calendar_list=(0,D.yJ)().pipe((0,g.b)(d=>this._calendars.next(d)),(0,x.d)(1)),this.query=()=>(0,D.yJ)(),this.freeBusy=d=>(0,D.tS)(d,this._org),this.availability=d=>(0,D.v7)(d),this._org.initialised.pipe((0,T.P)(d=>d)).subscribe(()=>this.init())}init(){var a=this;return(0,L.Z)(function*(){a._settings.get("app.events.use_bookings")||a._initialised.next(!0)})()}get calendars(){return this._calendars.getValue()}getFreeBusyDate(a,m){return(0,D.tS)({period_start:(0,B.Z)((0,W.Z)(a)),period_end:(0,B.Z)((0,b.Z)(a)),calendars:m},this._org)}checkSpacesAvailability(a,m,d,E){return(0,L.Z)(function*(){const y=yield(0,D.v7)({period_start:m,period_end:d,system_ids:a.join(",")}).toPromise(),$=new Date(E?.date).valueOf(),l=(0,_.Z)($,E?.duration).valueOf();return!!y.every(o=>{const r=o.availability;if(E&&o.id===E.system?.email){const h=r.findIndex(A=>A.date>=$&&(0,_.Z)(A.date,A.duration).valueOf()<=l);-1!==h&&r.splice(h,1)}return!r.length})})()}static#t=this.\u0275fac=function(m){return new(m||f)(K.LFG(F.w),K.LFG(U.g))};static#s=this.\u0275prov=K.Yz7({token:f,factory:f.\u0275fac,providedIn:"root"})}return f})()}}]);
//# sourceMappingURL=common.js.map