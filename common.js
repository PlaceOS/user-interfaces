"use strict";(self.webpackChunkworkplace=self.webpackChunkworkplace||[]).push([["common"],{7625:(j,B,t)=>{t.d(B,{I:()=>a});var C=t(1670),u=t(3496),P=t(3644),f=t(1299),K=t(6221),T=t(2886),m=t(7502),R=t(5845),_=t(1810),x=t(9377),U=t(3200),L=t(4505),l=t(7716),E=t(4139),g=t(823),M=t(8759),d=t(9151),c=t(6116),o=t(9095),y=t(3298),h=t(6942),O=t(7418),r=t(9128),v=t(9676);class a extends P.cx{constructor(i,I){super(),this._settings=i,this._org=I,this._poll=new L.X(0),this._poll_type=new L.X("api"),this._loading=new L.X(!1),this._filters=new L.X({shown_types:["event","desk","parking","visitor","locker"]}),this._date=new L.X(Date.now()),this._update=(0,l.aj)([this._date,this._poll]).pipe((0,g.b)(500),(0,M.b)(s=>this._loading.next(!0))),this._deleted=[],this._space_bookings=this._org.active_building.pipe((0,d.h)(s=>!!s),(0,c.g)("id"),(0,g.b)(300),(0,M.b)(s=>this.unsubWith("bind:")),(0,o.w)(({id:s})=>(this._loading.next(!0),(0,T.u2)(s))),(0,y.x)(([s],[e])=>s!==e),(0,o.w)(s=>(this._loading.next(!1),(0,l.aj)((s||[]).map(e=>{const n=(0,m.rTZ)(e.id,"Bookings").binding("bookings"),D=n.listen().pipe((0,h.U)(A=>(A||[]).map(W=>new f.ym({...W,resources:W.attendees.filter(Z=>Z.email===e.email||Z.resource),system:e}))),(0,O.K)(A=>(0,E.of)([])));return this.hasSubscription(`bind:${e.id}`)||this.subscription(`bind:${e.id}`,n.bind()),D})))),(0,h.U)(s=>(0,P.xH)(s)),(0,r.d)(1)),this.ws_events=(0,l.aj)([this._space_bookings,this._update]).pipe((0,h.U)(([s,[e]])=>{const n=(0,P.ar)();return s.filter(D=>(0,R.Z)(D.date,e)&&(D.host.toLowerCase()===n.email.toLowerCase()||D.attendees.find(A=>A.email.toLowerCase()===n.email.toLowerCase())))})),this.api_events=this._update.pipe((0,o.w)(([s])=>{const e={period_start:(0,_.Z)((0,x.Z)(s)),period_end:(0,_.Z)((0,U.Z)(s))};return this._settings.get("app.events.use_bookings")?(0,u.F2)({...e,type:"room"}).pipe((0,h.U)(n=>n.map(D=>(0,f.Yd)(D))),(0,O.K)(n=>(0,E.of)([]))):(0,f.u$)({...e}).pipe((0,O.K)(n=>(0,E.of)([])))}),(0,r.d)(1)),this.events=(0,l.aj)([this._poll_type]).pipe((0,o.w)(([s])=>"api"===s?this.api_events:this.ws_events),(0,M.b)(()=>this.timeout("end_loading",()=>this._loading.next(!1))),(0,r.d)(1)),this.visitors=this._update.pipe((0,o.w)(([s])=>(0,u.F2)({period_start:(0,_.Z)((0,x.Z)(s)),period_end:(0,_.Z)((0,U.Z)(s)),type:"visitor"}).pipe((0,O.K)(e=>(console.error(e),(0,E.of)([]))))),(0,M.b)(()=>this.timeout("end_loading",()=>this._loading.next(!1))),(0,r.d)(1)),this.desks=this._update.pipe((0,o.w)(([s])=>(0,u.F2)({period_start:(0,_.Z)((0,x.Z)(s)),period_end:(0,_.Z)((0,U.Z)(s)),include_checked_out:!0,type:"desk"}).pipe((0,O.K)(e=>(console.error(e),(0,E.of)([]))))),(0,M.b)(()=>this.timeout("end_loading",()=>this._loading.next(!1))),(0,r.d)(1)),this.parking=this._update.pipe((0,o.w)(([s])=>(0,u.F2)({period_start:(0,_.Z)((0,x.Z)(s)),period_end:(0,_.Z)((0,U.Z)(s)),type:"parking"}).pipe((0,O.K)(e=>(0,E.of)([])))),(0,M.b)(()=>this.timeout("end_loading",()=>this._loading.next(!1))),(0,r.d)(1)),this.lockers=this._update.pipe((0,o.w)(([s])=>{const e=this._org.binding("area_management");return e?(0,m.rTZ)(e,"Lockers").execute("lockers_allocated_to_me").catch(D=>[]):(0,E.of)([])}),(0,h.U)(s=>s.map(e=>new u.$N({date:(0,x.Z)(Date.now()).valueOf(),duration:1439,asset_id:e.locker_id,asset_name:e.locker_name,zones:[e.building,e.level],extension_data:{map_id:e.locker_id}}))),(0,O.K)(()=>(0,E.of)([])),(0,M.b)(()=>this.timeout("end_loading",()=>this._loading.next(!1))),(0,r.d)(1)),this.bookings=(0,l.aj)([this.events,this.visitors,this.desks,this.parking,this.lockers]).pipe((0,h.U)(([s,e,n,D,A])=>[...s,...e,...n,...D,...A].sort((W,Z)=>W.date-Z.date))),this.filtered_bookings=(0,l.aj)([this.bookings,this._filters]).pipe((0,h.U)(([s,e])=>s.filter(n=>!this._deleted.includes(n.id)&&n instanceof f.ym&&e?.shown_types?.includes("event")||e?.shown_types?.includes(n.booking_type)))),this.filters=this._filters.asObservable(),this.date=this._date.asObservable(),this.loading=this._loading.asObservable(),this.subscription("poll_type",this._org.active_building.subscribe(()=>this._poll_type.next(this._settings.get("app.schedule.use_websocket")?"ws":"api"))),this._deleted=JSON.parse(sessionStorage.getItem("PLACEOS.events.deleted")||"[]")}triggerPoll(){this._poll.next(Date.now())}startPolling(i=6e4){return this.interval("poll",()=>{"visible"===document.visibilityState&&this._poll.next(Date.now())},i),()=>this.stopPolling()}stopPolling(){this.clearInterval("poll")}setDate(i){this._date.next(i)}removeItem(i){this.setAsDeleted(i.id),this._poll.next(Date.now())}setAsDeleted(i){this._deleted.push(i),sessionStorage.setItem("PLACEOS.events.deleted",JSON.stringify(this._deleted))}toggleType(i,I=!1){var s=this;return(0,C.Z)(function*(){const e=s._filters.getValue()||{shown_types:[]},{shown_types:n}=e;n&&(n.includes(i)||I)?s._filters.next({...e,shown_types:n.filter(D=>D!==i)}):s._filters.next({...e,shown_types:[...n,i]})})()}}a.\u0275fac=function(i){return new(i||a)(v.LFG(P.gb),v.LFG(K.w7))},a.\u0275prov=v.Yz7({token:a,factory:a.\u0275fac,providedIn:"root"})},8676:(j,B,t)=>{t.d(B,{I:()=>h});var C=t(3496),u=t(9434),P=t(3644),f=t(1299),K=t(1810),T=t(9377),m=t(312),R=t(3200),_=t(4505),x=t(1942),U=t(7716),L=t(4350),l=t(9095),E=t(9128),g=t(823),M=t(522),d=t(6942),c=t(7418),o=t(8759),y=t(9676);class h extends P.cx{constructor(r){super(),this._settings=r,this._poll=new _.X(0),this._options=new _.X({start:Date.now()}),this._loading=new _.X(""),this._schedule=new _.X([]),this.options=this._options.asObservable(),this.loading=this._loading.asObservable(),this.schedule=this._loading.asObservable(),this.calendars=(0,x.H)(1e3).pipe((0,l.w)(v=>(0,u.yJ)()),(0,E.d)(1)),this.events=(0,U.aj)([this._options,this._poll]).pipe((0,g.b)(1e3),(0,M.zg)(([v])=>{this._loading.next("Loading schedule...");const a={period_start:(0,K.Z)((0,T.Z)(v.start)),period_end:(0,K.Z)((0,m.Z)((0,R.Z)(v.start),6))};return v.calendar&&(a.calendar=v.calendar),this._schedule.next(this._schedule.getValue().filter(p=>!(0,P.MZ)(1e3*a.period_start,1e3*a.period_end,p.date,p.date+60*p.duration*1e3))),(0,L.D)([!0===this._settings.get("app.events.use_bookings")?(0,C.F2)({...a,type:"room"}).pipe((0,d.U)(p=>p.map(i=>(0,f.Yd)(i)))):(0,f.u$)({...a}),(0,C.F2)({...a,type:"desk"}),(0,C.F2)({...a,type:"parking"})]).pipe((0,c.K)(p=>[]))}),(0,d.U)(([v,a])=>{const p=[...this._schedule.getValue(),...v,...a.filter(i=>"declined"!==i.status)].sort((i,I)=>i.date-I.date);return this._schedule.next((0,P.Tw)(p,"id")),p}),(0,c.K)(v=>[]),(0,o.b)(v=>this._loading.next("")),(0,E.d)(1))}startPolling(r=15e3){this.interval("poll",()=>this._poll.next(Date.now()),r)}stopPolling(){this.clearInterval("poll")}setOptions(r){this._options.next({...this._options.getValue(),...r})}}h.\u0275fac=function(r){return new(r||h)(y.LFG(P.gb))},h.\u0275prov=y.Yz7({token:h,factory:h.\u0275fac,providedIn:"root"})},9434:(j,B,t)=>{t.d(B,{ot:()=>g,yJ:()=>l.yJ});var C=t(1670),u=t(4505),P=t(8759),f=t(9128),K=t(5670),T=t(1810),m=t(9377),R=t(3200),_=t(2317),x=t(4871),U=t(719),L=t(565),l=t(8313),E=t(9676);class g extends x.c{constructor(d,c){super(),this._org=d,this._settings=c,this._calendars=new u.X([]),this.calendar_list=(0,l.yJ)().pipe((0,P.b)(o=>this._calendars.next(o)),(0,f.d)(1)),this.query=()=>(0,l.yJ)(),this.freeBusy=o=>(0,l.tS)(o,this._org),this.availability=o=>(0,l.v7)(o),this._org.initialised.pipe((0,K.P)(o=>o)).subscribe(()=>this.init())}init(){var d=this;return(0,C.Z)(function*(){d._settings.get("app.events.use_bookings")||d._initialised.next(!0)})()}get calendars(){return this._calendars.getValue()}getFreeBusyDate(d,c){return(0,l.tS)({period_start:(0,T.Z)((0,m.Z)(d)),period_end:(0,T.Z)((0,R.Z)(d)),calendars:c},this._org)}checkSpacesAvailability(d,c,o,y){return(0,C.Z)(function*(){const h=yield(0,l.v7)({period_start:c,period_end:o,system_ids:d.join(",")}).toPromise(),O=new Date(y?.date).valueOf(),r=(0,_.Z)(O,y?.duration).valueOf();return!!h.every(a=>{const p=a.availability;if(y&&a.id===y.system?.email){const i=p.findIndex(I=>I.date>=O&&(0,_.Z)(I.date,I.duration).valueOf()<=r);-1!==i&&p.splice(i,1)}return!p.length})})()}}g.\u0275fac=function(d){return new(d||g)(E.LFG(L.w),E.LFG(U.g))},g.\u0275prov=E.Yz7({token:g,factory:g.\u0275fac,providedIn:"root"})}}]);
//# sourceMappingURL=common.js.map