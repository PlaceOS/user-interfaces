"use strict";(self.webpackChunkworkplace=self.webpackChunkworkplace||[]).push([["common"],{75323:(Q,H,t)=>{t.d(H,{y:()=>tt});var P=t(89204),D=t(57915),u=t(21157),C=t(68113),U=t(12185),R=t(22168),j=t(46484),S=t(26078),r=t(67450),m=t(27419),L=t(13264),z=t(46247),M=t(53838),I=t(80433),k=t(83020),y=t(61031),B=t(90521),o=t(42175),l=t(71536),c=t(86020),T=t(19803),d=t(66e3),V=t(8627),A=t(47504),a=t(71963),h=t(6109),_=t(35443),p=t(29314),E=t(7841),x=t(89273),K=t(68559),q=t(12587);let tt=(()=>{class F extends u.Tv{constructor(v,Y,Z,G){var g;super(),g=this,this._settings=v,this._org=Y,this._lockers=Z,this._dialog=G,this._poll=new B.t(0),this._poll_type=new B.t("api"),this._loading=new B.t(!1),this._filters=new B.t({shown_types:["event","desk","parking","visitor","locker","group-event"]}),this._date=new B.t(Date.now()),this._update=(0,o.zV)([this._date,this._poll]).pipe((0,T.B)(500),(0,d.M)(s=>this._loading.next(!0))),this._deleted=[],this._space_bookings=this._org.active_building.pipe((0,V.p)(s=>!!s),(0,A.w)("id"),(0,T.B)(300),(0,d.M)(s=>this.unsubWith("bind:")),(0,a.n)(({id:s})=>(this._loading.next(!0),(0,R.Ot)(s))),(0,h.F)(([s],[i])=>s!==i),(0,a.n)(s=>(this._loading.next(!1),(0,o.zV)((s||[]).map(i=>{const e=(0,j.f_4)(i.id,"Bookings").binding("bookings"),n=e.listen().pipe((0,_.T)(f=>(f||[]).map(W=>new C.LR({...W,resources:W.attendees.filter($=>$.email===i.email||$.resource),system:i}))),(0,p.W)(f=>(0,l.of)([])));return this.hasSubscription(`bind:${i.id}`)||this.subscription(`bind:${i.id}`,e.bind()),n})))),(0,_.T)(s=>(0,u.Bq)(s)),(0,E.t)(1)),this.ws_events=(0,o.zV)([this._space_bookings,this._update]).pipe((0,_.T)(([s,[i]])=>{const e=(0,u.Ny)();return s.filter(n=>(0,S.A)(n.date,i)&&(n.host.toLowerCase()===e.email.toLowerCase()||n.attendees.find(f=>f.email.toLowerCase()===e.email.toLowerCase()))&&!n.linked_bookings?.find(f=>"group-event"===f.booking_type))})),this.api_events=this._update.pipe((0,a.n)(([s])=>{const i={period_start:(0,r.A)((0,m.A)(s)),period_end:(0,r.A)((0,L.A)(s))};return this._settings.get("app.events.use_bookings")?(0,D.tj)({...i,type:"room"}).pipe((0,_.T)(e=>e.map(n=>(0,C.Uv)(n))),(0,p.W)(e=>(0,l.of)([]))):(0,C.UU)({...i}).pipe((0,p.W)(e=>(0,l.of)([])))}),(0,E.t)(1)),this.events=(0,o.zV)([this._poll_type]).pipe((0,a.n)(([s])=>"api"===s?this.api_events:this.ws_events),(0,d.M)(()=>this.timeout("end_loading",()=>this._loading.next(!1))),(0,E.t)(1)),this.visitors=this._update.pipe((0,a.n)(([s])=>(0,D.tj)({period_start:(0,r.A)((0,m.A)(s)),period_end:(0,r.A)((0,L.A)(s)),type:"visitor"}).pipe((0,p.W)(i=>(0,l.of)([])))),(0,_.T)(s=>s.filter(i=>!i.parent_id&&!i.linked_event)),(0,d.M)(()=>this.timeout("end_loading",()=>this._loading.next(!1))),(0,E.t)(1)),this.desks=this._update.pipe((0,a.n)(([s])=>(0,D.tj)({period_start:(0,r.A)((0,m.A)(s)),period_end:(0,r.A)((0,L.A)(s)),include_checked_out:!0,type:"desk"}).pipe((0,p.W)(i=>(0,l.of)([])))),(0,d.M)(()=>this.timeout("end_loading",()=>this._loading.next(!1))),(0,E.t)(1)),this.parking=this._update.pipe((0,a.n)(([s])=>(0,D.tj)({period_start:(0,r.A)((0,m.A)(s)),period_end:(0,r.A)((0,L.A)(s)),type:"parking"}).pipe((0,p.W)(i=>(0,l.of)([])))),(0,d.M)(()=>this.timeout("end_loading",()=>this._loading.next(!1))),(0,E.t)(1)),this.group_events=this._update.pipe((0,a.n)(([s])=>(0,D.tj)({period_start:(0,r.A)((0,m.A)(s)),period_end:(0,r.A)((0,L.A)(s)),type:"group-event"}).pipe((0,p.W)(i=>(0,l.of)([])))),(0,d.M)(()=>this.timeout("end_loading",()=>this._loading.next(!1))),(0,E.t)(1)),this.lockers=(0,o.zV)([this._org.active_building.pipe((0,V.p)(s=>!!s),(0,A.w)("id")),this._lockers.lockers$]).pipe((0,T.B)(300),(0,a.n)(function(){var s=(0,P.A)(function*([i,e]){const n=g._org.binding("lockers");return n?[yield(0,j.f_4)(n,"LockerLocations").execute("lockers_allocated_to_me").catch($=>[]),e]:[[],e]});return function(i){return s.apply(this,arguments)}}()),(0,_.T)(([s,i])=>s.map(e=>{const n=i.find(f=>f.id===e.locker_id);return n||e.level&&e.building?(e.level=e.level||n?.level_id,e.building=e.building||this._org.levelWithID([n?.level_id])?.parent_id,new D.Qr({date:(0,m.A)(Date.now()).valueOf(),duration:1439,title:"Locker Booking",description:e.locker_name,booking_type:"locker",all_day:!0,asset_id:n.map_id,asset_name:e.locker_name,zones:[e.building,e.level],extension_data:{}})):null}).filter(e=>e)),(0,p.W)(s=>(console.error(s),(0,l.of)([]))),(0,d.M)(()=>this.timeout("end_loading",()=>this._loading.next(!1))),(0,E.t)(1)),this.bookings=(0,o.zV)([this.events,this.visitors,this.desks,this.parking,this.lockers,this.group_events]).pipe((0,_.T)(([s,i,e,n,f,W])=>[...s.filter(b=>!e.find(O=>`${b.meeting_id}`==`${O.id}`)&&"group-event"!==b.linked_bookings[0]?.booking_type),...i,...e,...n,...f,...W].sort((b,O)=>b.date-O.date))),this.filtered_bookings=(0,o.zV)([this.bookings,this._filters]).pipe((0,_.T)(([s,i])=>s.filter(e=>!this._deleted.includes(e.id)&&e instanceof C.LR&&i?.shown_types?.includes("event")||i?.shown_types?.includes(e.booking_type)))),this.filters=this._filters.asObservable(),this.date=this._date.asObservable(),this.loading=this._loading.asObservable(),this._ignore_cancel=[],this._checkCancel=(0,o.zV)([u.U5,(0,c.Y)(6e4).pipe((0,x.Z)(0))]).pipe((0,V.p)(([s])=>!!s),(0,_.T)(function(){var s=(0,P.A)(function*([i]){const e="wfo"!==i.location,n=g._settings.get("app.auto_release");if(n&&e&&(n.time_after||n.time_before)&&n.resources?.length){const f=Math.min(60,n.time_before||0);for(const W of n.resources){const $=yield(0,D.tj)({period_start:(0,r.A)((0,z.A)(Date.now())),period_end:(0,r.A)((0,M.A)(Date.now(),(n.time_after||5)+f)),type:W}).toPromise(),b=(n.time_after||0)+f;for(const O of $){if(g._ignore_cancel.includes(O.id)||O.checked_in||O.rejected)continue;g._dialog.closeAll();const X=(0,I.A)((0,M.A)(O.date,n.time_after||0),Date.now());if(X>b||X<0)continue;const w=(0,M.A)(O.date,n.time_after||0),st=(0,k.A)(w.getTime()+6e4,Date.now()),N="parking"===W?"reservation":"booking",J=yield(0,u.GE)({title:`Keep ${W} ${N}`,content:`You have indicated you are not in the office. \n                                Your  ${N} for "<i>${O.asset_name||O.title}</i>" at ${(0,y.A)(O.date,g._settings.time_format)} will be cancelled at ${(0,y.A)(w,g._settings.time_format)}.<br/><br/>\n                                Do you wish to keep this ${N}?`,icon:{content:"event_busy"},confirm_text:"Keep",cancel_text:"Dismiss",close_delay:st},g._dialog);"done"===J.reason?(J.loading("Checking in booking..."),yield(0,D.Z$)(O.id,!0).toPromise(),J.close()):g._ignore_cancel.push(O.id)}}}});return function(i){return s.apply(this,arguments)}}())),this.subscription("poll_type",this._org.active_building.subscribe(()=>this._poll_type.next(this._settings.get("app.schedule.use_websocket")?"ws":"api"))),this.subscription("chat_event",this._settings.listen("CHAT:task_complete").subscribe(()=>this.triggerPoll())),this.subscription("wfh_checks",this._checkCancel.subscribe()),this._deleted=JSON.parse(sessionStorage.getItem("PLACEOS.events.deleted")||"[]")}triggerPoll(){this._poll.next(Date.now())}startPolling(v=6e4){return this.interval("poll",()=>this._poll.next(Date.now()),v),()=>this.stopPolling()}stopPolling(){this.clearInterval("poll")}setDate(v){this._date.next(v)}removeItem(v){this.setAsDeleted(v.id),this._poll.next(Date.now())}setAsDeleted(v){this._deleted.push(v),sessionStorage.setItem("PLACEOS.events.deleted",JSON.stringify(this._deleted))}toggleType(v,Y=!1){var Z=this;return(0,P.A)(function*(){const G=Z._filters.getValue()||{shown_types:[]},{shown_types:g}=G;g&&(g.includes(v)||Y)?Z._filters.next({...G,shown_types:g.filter(s=>s!==v)}):Z._filters.next({...G,shown_types:[...g,v]})})()}static#t=this.\u0275fac=function(Y){return new(Y||F)(K.KVO(u.h$),K.KVO(U.yb),K.KVO(D.$H),K.KVO(q.bZ))};static#s=this.\u0275prov=K.jDH({token:F,factory:F.\u0275fac,providedIn:"root"})}return F})()},79184:(Q,H,t)=>{t.d(H,{y:()=>T});var P=t(57915),D=t(14055),u=t(21157),C=t(68113),U=t(67450),R=t(27419),j=t(88402),S=t(13264),r=t(90521),m=t(26320),L=t(42175),z=t(68757),M=t(71963),I=t(7841),k=t(19803),y=t(3107),B=t(35443),o=t(29314),l=t(66e3),c=t(68559);let T=(()=>{class d extends u.Tv{constructor(A){super(),this._settings=A,this._poll=new r.t(0),this._options=new r.t({start:Date.now()}),this._loading=new r.t(""),this._schedule=new r.t([]),this.options=this._options.asObservable(),this.loading=this._loading.asObservable(),this.schedule=this._loading.asObservable(),this.calendars=(0,m.O)(1e3).pipe((0,M.n)(a=>(0,D.CH)()),(0,I.t)(1)),this.events=(0,L.zV)([this._options,this._poll]).pipe((0,k.B)(1e3),(0,y.ZZ)(([a])=>{this._loading.next("Loading schedule...");const h={period_start:(0,U.A)((0,R.A)(a.start)),period_end:(0,U.A)((0,j.A)((0,S.A)(a.start),6))};return a.calendar&&(h.calendar=a.calendar),this._schedule.next(this._schedule.getValue().filter(_=>!(0,u.dH)(1e3*h.period_start,1e3*h.period_end,_.date,_.date+60*_.duration*1e3))),(0,z.p)([!0===this._settings.get("app.events.use_bookings")?(0,P.tj)({...h,type:"room"}).pipe((0,B.T)(_=>_.map(p=>(0,C.Uv)(p)))):(0,C.UU)({...h}),(0,P.tj)({...h,type:"desk"}),(0,P.tj)({...h,type:"parking"}),(0,P.tj)({...h,type:"group-event"})]).pipe((0,o.W)(_=>[]))}),(0,B.T)(([a,h,_,p])=>{const E=[...this._schedule.getValue(),...a,...h.filter(x=>"declined"!==x.status),...p.filter(x=>"declined"!==x.status)].sort((x,K)=>x.date-K.date);return this._schedule.next((0,u.Am)(E,"id")),E}),(0,o.W)(a=>[]),(0,l.M)(a=>this._loading.next("")),(0,I.t)(1))}startPolling(A=15e3){this.interval("poll",()=>this._poll.next(Date.now()),A)}stopPolling(){this.clearInterval("poll")}setOptions(A){this._options.next({...this._options.getValue(),...A})}static#t=this.\u0275fac=function(a){return new(a||d)(c.KVO(u.h$))};static#s=this.\u0275prov=c.jDH({token:d,factory:d.\u0275fac,providedIn:"root"})}return d})()},14055:(Q,H,t)=>{t.d(H,{IE:()=>k,CH:()=>M.CH});var P=t(89204),D=t(90521),u=t(66e3),C=t(7841),U=t(57871),R=t(67450),j=t(27419),S=t(13264),r=t(53838),m=t(75354),L=t(14233),z=t(45762),M=t(96576),I=t(68559);let k=(()=>{class y extends m.T{constructor(o,l){super(),this._org=o,this._settings=l,this._calendars=new D.t([]),this.calendar_list=(0,M.CH)().pipe((0,u.M)(c=>this._calendars.next(c)),(0,C.t)(1)),this.query=()=>(0,M.CH)(),this.freeBusy=c=>(0,M.Yj)(c,this._org),this.availability=c=>(0,M.Sh)(c),this._org.initialised.pipe((0,U.$)(c=>c)).subscribe(()=>this.init())}init(){var o=this;return(0,P.A)(function*(){o._settings.get("app.events.use_bookings")||o._initialised.next(!0)})()}get calendars(){return this._calendars.getValue()}getFreeBusyDate(o,l){return(0,M.Yj)({period_start:(0,R.A)((0,j.A)(o)),period_end:(0,R.A)((0,S.A)(o)),calendars:l},this._org)}checkSpacesAvailability(o,l,c,T){return(0,P.A)(function*(){const d=yield(0,M.Sh)({period_start:l,period_end:c,system_ids:o.join(",")}).toPromise(),V=new Date(T?.date).valueOf(),A=(0,r.A)(V,T?.duration).valueOf();return!!d.every(h=>{const _=h.availability;if(T&&h.id===T.system?.email){const p=_.findIndex(E=>E.date>=V&&(0,r.A)(E.date,E.duration).valueOf()<=A);-1!==p&&_.splice(p,1)}return!_.length})})()}static#t=this.\u0275fac=function(l){return new(l||y)(I.KVO(z.y),I.KVO(L.h))};static#s=this.\u0275prov=I.jDH({token:y,factory:y.\u0275fac,providedIn:"root"})}return y})()}}]);
//# sourceMappingURL=common.js.map