"use strict";(self.webpackChunkconcierge=self.webpackChunkconcierge||[]).push([["common"],{20631:(j,B,t)=>{t.d(B,{v:()=>K});var h=t(89204),D=t(3998),u=t(90521),c=t(71536),M=t(33119),P=t(42175),p=t(19803),O=t(71963),a=t(35443),g=t(29314),A=t(7841),v=t(66e3),C=t(6109),R=t(22508),x=t(67450),W=t(27419),U=t(13264),T=t(83866),l=t(57915),_=t(82333),k=t(12185),f=(t(83259),t(68559)),I=t(12587);let K=(()=>{class r extends _.Tv{get new_desk_count(){return this._new_desks.getValue()?.length||0}nextPage(){this._call_next_page.next(`NEXT_${Date.now()}`)}constructor(s,i){super(),this._org=s,this._dialog=i,this._filters=new u.t({}),this._new_desks=new u.t([]),this._desk_bookings=[],this._loading=new u.t(!1),this.new_desks=this._new_desks.asObservable(),this.loading=this._loading.asObservable(),this.filters=this._filters.asObservable(),this.desks=this._filters.pipe((0,p.B)(500),(0,O.n)(e=>{const n=e.zones||[];return n&&!n.includes("All")?(0,D.bpY)(n[0],"desks").pipe((0,a.T)(o=>o.details instanceof Array?o.details:[]),(0,g.W)(o=>(0,c.of)([]))):(0,D.WsZ)(this._org.building?.id,{name:"desks"}).pipe((0,a.T)(o=>o.map(d=>d.metadata?.desks?.details||[]).reduce((d,E)=>[...d,...E],[])),(0,g.W)(o=>(0,c.of)([])))}),(0,a.T)(e=>(e instanceof Array||(e=[]),e.sort((n,o)=>n.name?.localeCompare(o.name)),e.map(n=>new k.gB({...n,qr_code:""})))),(0,A.t)(1)),this._next_page=new M.B7,this._call_next_page=new M.B7,this._all_zones_keys=["All",-1,"-1"],this.setup_paging=(0,P.zV)([this._filters,this._org.initialised]).pipe((0,p.B)(500),(0,v.M)(([e,n])=>{if(!n)return;const o=e.date||Date.now(),d=!e.zones||e.zones.some(E=>this._all_zones_keys.includes(E))?[this._org.building.id]:e.zones;this._next_page.next(()=>(0,l.WE)({period_start:(0,x.A)((0,W.A)(o)),period_end:(0,x.A)((0,U.A)(o)),type:"desk",zones:d.join(","),include_checked_out:!0}).pipe((0,g.W)(E=>(0,c.of)({data:[],total:0,next:null})))),this._call_next_page.next(`RESET_${Date.now()}`)})),this.paged_bookings=(0,P.zV)([this._next_page,this._call_next_page]).pipe((0,C.F)((e,n)=>e[1]===n[1]),(0,O.n)(([e,n])=>(this._loading.next(!0),e?n.includes("RESET")?e().pipe((0,a.T)(o=>({...o,reset:!0})),(0,g.W)(o=>(0,c.of)({data:[],total:0,next:null}))):e().pipe((0,a.T)(o=>({...o,reset:!1})),(0,g.W)(o=>(0,c.of)({data:[],total:0,next:null}))):(0,c.of)({data:[],total:0,next:null,reset:n.includes("RESET")}))),(0,R.S)((e,{data:n,total:o,next:d,reset:E})=>{const m=n;return this._next_page.next(d),E?{list:m,total:o}:{list:[...e.list,...m],total:o}},{list:[],total:0}),(0,v.M)(e=>this._loading.next(!1)),(0,A.t)(1)),this.has_more_pages=this.paged_bookings.pipe((0,a.T)(e=>e.list.length<e.total)),this.bookings=this.paged_bookings.pipe((0,a.T)(e=>e.list)),this.setup_paging.subscribe()}setFilters(s){s.zones?.includes("All")?s.zones=["All",...this._org.levelsForBuilding(this._org.building).map(i=>i.id)]:s.zones&&this._filters.getValue()?.zones?.includes("All")&&(s.zones=[]),this._filters.next({...this._filters.getValue(),...s})}refresh(){this._loading.next(!0),this.timeout("poll",()=>this.setFilters(this._filters.getValue()))}addDesks(s){this._new_desks.next(this._new_desks.getValue().concat(s))}removeNewDesk(s){this._filters.next(this._filters.getValue()),this._new_desks.next(this._new_desks.getValue().filter(i=>i.id!==s.id))}clearNewDesks(){this._filters.next(this._filters.getValue()),this._new_desks.next([])}checkinDesk(s,i=!0){return(0,h.A)(function*(){const e=yield(0,l.Z$)(s.id,i??!0).toPromise().catch(n=>({failed:!0,error:n}));if(e.failed)throw(0,_.UG)(e.error?`Error: ${e.error}`:`Error checking ${i?"in":"out"} desk booking`),e.error;(0,_.VX)(`Checked ${i?"in":"out"} ${s.user_name}.`)})()}approveDesk(s){return(0,h.A)(function*(){if("failed"===(yield(0,l.DD)(s.id).toPromise().catch(e=>"failed")))return(0,_.UG)("Error approving in desk booking");(0,_.VX)(`Approved desk booking for ${s.user_name} on ${(0,T.A)(s.date,"MMM do")}.`),s.approved=!0,s.rejected=!1})()}rejectDesk(s){return(0,h.A)(function*(){if("failed"===(yield(0,l.vB)(s.id).toPromise().catch(e=>"failed")))return(0,_.UG)("Error rejecting in desk booking");(0,_.VX)(`Rejected desk booking for ${s.user_name} on ${(0,T.A)(s.date,"MMM do")}.`),s.approved=!1,s.rejected=!0})()}giveAccess(s){var i=this;return(0,h.A)(function*(){const e=yield(0,l.X0)(new l.Qr({...s,access:!0})).toPromise().catch(n=>"failed");if("failed"===e)return(0,_.UG)("Error giving building access booking host");(0,_.VX)(`Successfully gave building access to ${s.user_name} for desk booking.`),i._desk_bookings=[...i._desk_bookings,e]})()}rejectAllDesks(){var s=this;return(0,h.A)(function*(){const i=s._desk_bookings||[];if(i.length<=0)return(0,_.uA)("No desks to reject for the selected date");const e=yield(0,_.GE)({title:"Cancel all desk bookings",content:"Are you sure you want to cancel all bookings for the selected date?",icon:{type:"icon",class:"material-icons",content:"delete"}},s._dialog);"done"===e.reason&&(e.loading("Rejecting all desks for selected date..."),yield Promise.all(i.map(n=>(0,l.vB)(n.id).toPromise())),(0,_.VX)("Successfully rejected all desk bookings for selected date."),e.close())})()}static#e=this.\u0275fac=function(i){return new(i||r)(f.KVO(k.yb),f.KVO(I.bZ))};static#s=this.\u0275prov=f.jDH({token:r,factory:r.\u0275fac,providedIn:"root"})}return r})()}}]);
//# sourceMappingURL=common.js.map