"use strict";(self.webpackChunkworkplace=self.webpackChunkworkplace||[]).push([["common"],{96205:(N,F,t)=>{t.d(F,{I:()=>H});var M=t(71670),D=t(78466),u=t(82767),I=t(91781),B=t(93121),W=t(46514),R=t(52141),$=t(77393),r=t(67343),C=t(57016),K=t(4512),S=t(55702),O=t(58415),U=t(29737),Z=t(30873),P=t(70462),m=t(28159),a=t(9681),y=t(17827),d=t(95933),h=t(15746),L=t(85046),k=t(18020),l=t(36520),E=t(45083),o=t(47422),_=t(58175),p=t(680),A=t(1062),x=t(29039),z=t(17401);let H=(()=>{class X extends u.cx{constructor(c,G,J,Y){var g;super(),g=this,this._settings=c,this._org=G,this._lockers=J,this._dialog=Y,this._poll=new P.X(0),this._poll_type=new P.X("api"),this._loading=new P.X(!1),this._filters=new P.X({shown_types:["event","desk","parking","visitor","locker","group-event"]}),this._date=new P.X(Date.now()),this._update=(0,m.aj)([this._date,this._poll]).pipe((0,d.b)(500),(0,h.b)(s=>this._loading.next(!0))),this._deleted=[],this._space_bookings=this._org.active_building.pipe((0,L.h)(s=>!!s),(0,k.g)("id"),(0,d.b)(300),(0,h.b)(s=>this.unsubWith("bind:")),(0,l.w)(({id:s})=>(this._loading.next(!0),(0,W.u2)(s))),(0,E.x)(([s],[i])=>s!==i),(0,l.w)(s=>(this._loading.next(!1),(0,m.aj)((s||[]).map(i=>{const e=(0,R.rTZ)(i.id,"Bookings").binding("bookings"),n=e.listen().pipe((0,o.U)(v=>(v||[]).map(T=>new I.ym({...T,resources:T.attendees.filter(j=>j.email===i.email||j.resource),system:i}))),(0,_.K)(v=>(0,a.of)([])));return this.hasSubscription(`bind:${i.id}`)||this.subscription(`bind:${i.id}`,e.bind()),n})))),(0,o.U)(s=>(0,u.xH)(s)),(0,p.d)(1)),this.ws_events=(0,m.aj)([this._space_bookings,this._update]).pipe((0,o.U)(([s,[i]])=>{const e=(0,u.ar)();return s.filter(n=>(0,$.Z)(n.date,i)&&(n.host.toLowerCase()===e.email.toLowerCase()||n.attendees.find(v=>v.email.toLowerCase()===e.email.toLowerCase()))&&!n.linked_bookings?.find(v=>"group-event"===v.booking_type))})),this.api_events=this._update.pipe((0,l.w)(([s])=>{const i={period_start:(0,r.Z)((0,C.Z)(s)),period_end:(0,r.Z)((0,K.Z)(s))};return this._settings.get("app.events.use_bookings")?(0,D.F2)({...i,type:"room"}).pipe((0,o.U)(e=>e.map(n=>(0,I.Yd)(n))),(0,_.K)(e=>(0,a.of)([]))):(0,I.u$)({...i}).pipe((0,_.K)(e=>(0,a.of)([])))}),(0,p.d)(1)),this.events=(0,m.aj)([this._poll_type]).pipe((0,l.w)(([s])=>"api"===s?this.api_events:this.ws_events),(0,h.b)(()=>this.timeout("end_loading",()=>this._loading.next(!1))),(0,p.d)(1)),this.visitors=this._update.pipe((0,l.w)(([s])=>(0,D.F2)({period_start:(0,r.Z)((0,C.Z)(s)),period_end:(0,r.Z)((0,K.Z)(s)),type:"visitor"}).pipe((0,_.K)(i=>(0,a.of)([])))),(0,o.U)(s=>s.filter(i=>!i.parent_id&&!i.linked_event)),(0,h.b)(()=>this.timeout("end_loading",()=>this._loading.next(!1))),(0,p.d)(1)),this.desks=this._update.pipe((0,l.w)(([s])=>(0,D.F2)({period_start:(0,r.Z)((0,C.Z)(s)),period_end:(0,r.Z)((0,K.Z)(s)),include_checked_out:!0,type:"desk"}).pipe((0,_.K)(i=>(0,a.of)([])))),(0,h.b)(()=>this.timeout("end_loading",()=>this._loading.next(!1))),(0,p.d)(1)),this.parking=this._update.pipe((0,l.w)(([s])=>(0,D.F2)({period_start:(0,r.Z)((0,C.Z)(s)),period_end:(0,r.Z)((0,K.Z)(s)),type:"parking"}).pipe((0,_.K)(i=>(0,a.of)([])))),(0,h.b)(()=>this.timeout("end_loading",()=>this._loading.next(!1))),(0,p.d)(1)),this.group_events=this._update.pipe((0,l.w)(([s])=>(0,D.F2)({period_start:(0,r.Z)((0,C.Z)(s)),period_end:(0,r.Z)((0,K.Z)(s)),type:"group-event"}).pipe((0,_.K)(i=>(0,a.of)([])))),(0,h.b)(()=>this.timeout("end_loading",()=>this._loading.next(!1))),(0,p.d)(1)),this.lockers=(0,m.aj)([this._org.active_building.pipe((0,L.h)(s=>!!s),(0,k.g)("id")),this._lockers.lockers$]).pipe((0,d.b)(300),(0,l.w)(function(){var s=(0,M.Z)(function*([i,e]){const n=g._org.binding("lockers");return n?[yield(0,R.rTZ)(n,"LockerLocations").execute("lockers_allocated_to_me").catch(j=>[]),e]:[[],e]});return function(i){return s.apply(this,arguments)}}()),(0,o.U)(([s,i])=>s.map(e=>{const n=i.find(v=>v.id===e.locker_id);return n||e.level&&e.building?(e.level=e.level||n?.level_id,e.building=e.building||this._org.levelWithID([n?.level_id])?.parent_id,new D.$N({date:(0,C.Z)(Date.now()).valueOf(),duration:1439,title:"Locker Booking",description:e.locker_name,booking_type:"locker",all_day:!0,asset_id:n.map_id,asset_name:e.locker_name,zones:[e.building,e.level],extension_data:{}})):null}).filter(e=>e)),(0,_.K)(s=>(console.error(s),(0,a.of)([]))),(0,h.b)(()=>this.timeout("end_loading",()=>this._loading.next(!1))),(0,p.d)(1)),this.bookings=(0,m.aj)([this.events,this.visitors,this.desks,this.parking,this.lockers,this.group_events]).pipe((0,o.U)(([s,i,e,n,v,T])=>[...s.filter(f=>!e.find(b=>`${f.meeting_id}`==`${b.id}`)&&"group-event"!==f.linked_bookings[0]?.booking_type),...i,...e,...n,...v,...T].sort((f,b)=>f.date-b.date))),this.filtered_bookings=(0,m.aj)([this.bookings,this._filters]).pipe((0,o.U)(([s,i])=>s.filter(e=>!this._deleted.includes(e.id)&&e instanceof I.ym&&i?.shown_types?.includes("event")||i?.shown_types?.includes(e.booking_type)))),this.filters=this._filters.asObservable(),this.date=this._date.asObservable(),this.loading=this._loading.asObservable(),this._ignore_cancel=[],this._checkCancel=(0,m.aj)([u.pN,(0,y.F)(6e4).pipe((0,A.O)(0))]).pipe((0,L.h)(([s])=>!!s),(0,o.U)(function(){var s=(0,M.Z)(function*([i]){const e="wfo"!==i.location,n=g._settings.get("app.auto_release");if(n&&e&&(n.time_after||n.time_before)&&n.resources?.length)for(const v of n.resources){const T=yield(0,D.F2)({period_start:(0,r.Z)((0,S.Z)(Date.now())),period_end:(0,r.Z)((0,O.Z)(Date.now(),(n.time_after||5)+(n.time_before||0))),type:v}).toPromise(),j=(n.time_after||0)+(n.time_before||0);for(const f of T){if(g._ignore_cancel.includes(f.id)||f.checked_in||f.rejected)continue;g._dialog.closeAll();const b=(0,U.Z)((0,O.Z)(f.date,n.time_after||0),Date.now());if(b>j||b<0)continue;const w=(0,O.Z)(f.date,n.time_after||0),V=yield(0,u._5)({title:`Keep ${v} booking`,content:`You have indicated you are not in the office. \n                                Your booking "<i>${f.title}</i>" for ${(0,Z.Z)(f.date,g._settings.time_format)} will be cancelled at ${(0,Z.Z)(w,g._settings.time_format)}.<br/><br/>\n                                Do you wish to keep this booking?`,icon:{content:"event_busy"},confirm_text:"Keep",cancel_text:"Dismiss"},g._dialog);"done"===V.reason?(V.loading("Checking in booking..."),yield(0,D.FD)(f.id,!0).toPromise(),V.close()):g._ignore_cancel.push(f.id)}}});return function(i){return s.apply(this,arguments)}}())),this.subscription("poll_type",this._org.active_building.subscribe(()=>this._poll_type.next(this._settings.get("app.schedule.use_websocket")?"ws":"api"))),this.subscription("chat_event",this._settings.listen("CHAT:task_complete").subscribe(()=>this.triggerPoll())),this.subscription("wfh_checks",this._checkCancel.subscribe()),this._deleted=JSON.parse(sessionStorage.getItem("PLACEOS.events.deleted")||"[]")}triggerPoll(){this._poll.next(Date.now())}startPolling(c=6e4){return this.interval("poll",()=>this._poll.next(Date.now()),c),()=>this.stopPolling()}stopPolling(){this.clearInterval("poll")}setDate(c){this._date.next(c)}removeItem(c){this.setAsDeleted(c.id),this._poll.next(Date.now())}setAsDeleted(c){this._deleted.push(c),sessionStorage.setItem("PLACEOS.events.deleted",JSON.stringify(this._deleted))}toggleType(c,G=!1){var J=this;return(0,M.Z)(function*(){const Y=J._filters.getValue()||{shown_types:[]},{shown_types:g}=Y;g&&(g.includes(c)||G)?J._filters.next({...Y,shown_types:g.filter(s=>s!==c)}):J._filters.next({...Y,shown_types:[...g,c]})})()}static#t=this.\u0275fac=function(G){return new(G||X)(x.LFG(u.gb),x.LFG(B.w7),x.LFG(D.At),x.LFG(z.uw))};static#s=this.\u0275prov=x.Yz7({token:X,factory:X.\u0275fac,providedIn:"root"})}return X})()},16386:(N,F,t)=>{t.d(F,{I:()=>h});var M=t(78466),D=t(58691),u=t(82767),I=t(91781),B=t(67343),W=t(57016),R=t(65822),$=t(4512),r=t(70462),C=t(38435),K=t(28159),S=t(92130),O=t(36520),U=t(680),Z=t(95933),P=t(87965),m=t(47422),a=t(58175),y=t(15746),d=t(29039);let h=(()=>{class L extends u.cx{constructor(l){super(),this._settings=l,this._poll=new r.X(0),this._options=new r.X({start:Date.now()}),this._loading=new r.X(""),this._schedule=new r.X([]),this.options=this._options.asObservable(),this.loading=this._loading.asObservable(),this.schedule=this._loading.asObservable(),this.calendars=(0,C.H)(1e3).pipe((0,O.w)(E=>(0,D.yJ)()),(0,U.d)(1)),this.events=(0,K.aj)([this._options,this._poll]).pipe((0,Z.b)(1e3),(0,P.zg)(([E])=>{this._loading.next("Loading schedule...");const o={period_start:(0,B.Z)((0,W.Z)(E.start)),period_end:(0,B.Z)((0,R.Z)((0,$.Z)(E.start),6))};return E.calendar&&(o.calendar=E.calendar),this._schedule.next(this._schedule.getValue().filter(_=>!(0,u.MZ)(1e3*o.period_start,1e3*o.period_end,_.date,_.date+60*_.duration*1e3))),(0,S.D)([!0===this._settings.get("app.events.use_bookings")?(0,M.F2)({...o,type:"room"}).pipe((0,m.U)(_=>_.map(p=>(0,I.Yd)(p)))):(0,I.u$)({...o}),(0,M.F2)({...o,type:"desk"}),(0,M.F2)({...o,type:"parking"}),(0,M.F2)({...o,type:"group-event"})]).pipe((0,a.K)(_=>[]))}),(0,m.U)(([E,o,_,p])=>{const A=[...this._schedule.getValue(),...E,...o.filter(x=>"declined"!==x.status),...p.filter(x=>"declined"!==x.status)].sort((x,z)=>x.date-z.date);return this._schedule.next((0,u.Tw)(A,"id")),A}),(0,a.K)(E=>[]),(0,y.b)(E=>this._loading.next("")),(0,U.d)(1))}startPolling(l=15e3){this.interval("poll",()=>this._poll.next(Date.now()),l)}stopPolling(){this.clearInterval("poll")}setOptions(l){this._options.next({...this._options.getValue(),...l})}static#t=this.\u0275fac=function(E){return new(E||L)(d.LFG(u.gb))};static#s=this.\u0275prov=d.Yz7({token:L,factory:L.\u0275fac,providedIn:"root"})}return L})()},58691:(N,F,t)=>{t.d(F,{ot:()=>Z,yJ:()=>O.yJ});var M=t(71670),D=t(70462),u=t(15746),I=t(680),B=t(17627),W=t(67343),R=t(57016),$=t(4512),r=t(58415),C=t(26474),K=t(84411),S=t(54955),O=t(66511),U=t(29039);let Z=(()=>{class P extends C.c{constructor(a,y){super(),this._org=a,this._settings=y,this._calendars=new D.X([]),this.calendar_list=(0,O.yJ)().pipe((0,u.b)(d=>this._calendars.next(d)),(0,I.d)(1)),this.query=()=>(0,O.yJ)(),this.freeBusy=d=>(0,O.tS)(d,this._org),this.availability=d=>(0,O.v7)(d),this._org.initialised.pipe((0,B.P)(d=>d)).subscribe(()=>this.init())}init(){var a=this;return(0,M.Z)(function*(){a._settings.get("app.events.use_bookings")||a._initialised.next(!0)})()}get calendars(){return this._calendars.getValue()}getFreeBusyDate(a,y){return(0,O.tS)({period_start:(0,W.Z)((0,R.Z)(a)),period_end:(0,W.Z)((0,$.Z)(a)),calendars:y},this._org)}checkSpacesAvailability(a,y,d,h){return(0,M.Z)(function*(){const L=yield(0,O.v7)({period_start:y,period_end:d,system_ids:a.join(",")}).toPromise(),k=new Date(h?.date).valueOf(),l=(0,r.Z)(k,h?.duration).valueOf();return!!L.every(o=>{const _=o.availability;if(h&&o.id===h.system?.email){const p=_.findIndex(A=>A.date>=k&&(0,r.Z)(A.date,A.duration).valueOf()<=l);-1!==p&&_.splice(p,1)}return!_.length})})()}static#t=this.\u0275fac=function(y){return new(y||P)(U.LFG(S.w),U.LFG(K.g))};static#s=this.\u0275prov=U.Yz7({token:P,factory:P.\u0275fac,providedIn:"root"})}return P})()}}]);
//# sourceMappingURL=common.js.map