"use strict";(self.webpackChunkconcierge=self.webpackChunkconcierge||[]).push([["apps_concierge_src_app_building-manager_building-manager_module_ts"],{37014:(vt,A,l)=>{l.r(A),l.d(A,{BuildingManagerModule:()=>ht});var _=l(26575),g=l(28849),E=l(92649),U=l(97910),P=l(47049),O=l(10060),u=l(71670),m=l(22798),b=l(93121),c=l(47298),B=l(70462),G=l(28159),C=l(47422),p=l(17401),t=l(29039),x=l(94888),T=l(71268),S=l(99674),y=l(96355),f=l(10257),R=l(33910),I=l(99892);function J(i,d){if(1&i&&(t.TgZ(0,"mat-option",22),t._uU(1),t.qZA()),2&i){const e=d.$implicit;t.Q6J("value",e.id),t.xp6(),t.hij(" ",e.display_name||e.name," ")}}function F(i,d){if(1&i&&(t.TgZ(0,"div",5)(1,"label",19),t.SDv(2,20),t.qZA(),t.TgZ(3,"mat-form-field",8)(4,"mat-select",21)(5,"mat-option",22),t._uU(6,"None"),t.qZA(),t.YNc(7,J,2,2,"mat-option",14),t.ALo(8,"async"),t.qZA()()()),2&i){const e=t.oxw(3);t.xp6(5),t.Q6J("value",e.default_parent),t.xp6(2),t.Q6J("ngForOf",t.lcZ(8,2,e.region_list))}}function z(i,d){if(1&i&&(t.TgZ(0,"mat-option",22),t._uU(1),t.qZA()),2&i){const e=d.$implicit;t.Q6J("value",e),t.xp6(),t.Oqu(e)}}function D(i,d){1&i&&(t.TgZ(0,"mat-option",23),t._uU(1," No matching timezones "),t.qZA()),2&i&&t.Q6J("disabled",!0)}function $(i,d){if(1&i&&(t.TgZ(0,"form",3),t.YNc(1,F,9,4,"div",4),t.ALo(2,"async"),t.TgZ(3,"div",5)(4,"label",6),t.SDv(5,7),t.qZA(),t.TgZ(6,"mat-form-field",8),t._UZ(7,"input",9),t.qZA()(),t.TgZ(8,"div",5)(9,"label",6),t.SDv(10,10),t.qZA(),t.TgZ(11,"mat-form-field",8)(12,"app-icon",11),t._uU(13,"search"),t.qZA(),t._UZ(14,"input",12),t.qZA(),t.TgZ(15,"mat-autocomplete",null,13),t.YNc(17,z,2,2,"mat-option",14)(18,D,2,1,"mat-option",15),t.qZA()(),t.TgZ(19,"div",5)(20,"label",16),t.SDv(21,17),t.qZA(),t.TgZ(22,"mat-form-field",8),t._UZ(23,"input",18),t.qZA()()()),2&i){const e=t.MAs(16),n=t.oxw(2);let o;t.Q6J("formGroup",n.form),t.xp6(),t.Q6J("ngIf",null==(o=t.lcZ(2,5,n.region_list))?null:o.length),t.xp6(13),t.Q6J("matAutocomplete",e),t.xp6(3),t.Q6J("ngForOf",n.filtered_timezones),t.xp6(),t.Q6J("ngIf",!n.timezones.length)}}function Q(i,d){if(1&i&&(t.ynx(0),t.YNc(1,$,24,7,"form",2),t.BQk()),2&i){const e=t.oxw();t.xp6(),t.Q6J("ngIf",e.form)}}function Y(i,d){1&i&&(t.TgZ(0,"div",24),t._UZ(1,"mat-spinner",25),t.TgZ(2,"p",26),t._uU(3,"Saving building..."),t.qZA()())}let q=(()=>{class i extends m.cx{get default_parent(){return this._org.organisation.id}constructor(e){super(),this._org=e,this.building=null,this.save=0,this.loading=!1,this.loadingChange=new t.vpe,this.done=new t.vpe,this.timezones=[],this.filtered_timezones=[],this.region_list=this._org.region_list,this.form=new g.cw({id:new g.NI(""),parent_id:new g.NI(this._org.organisation.id,[g.kI.required]),display_name:new g.NI("",[g.kI.required]),timezone:new g.NI(Intl?.DateTimeFormat()?.resolvedOptions()?.timeZone||""),location:new g.NI("")})}ngOnInit(){this._updateTimezoneList(),this.subscription("tz-change",this.form.valueChanges.subscribe(({timezone:e})=>this.filtered_timezones=this.timezones.filter(n=>n.toLowerCase().includes(e.toLowerCase())))),this.building&&this.form.patchValue(this.building)}ngOnChanges(e){e.building&&this.building&&this.form.patchValue(this.building),e.save&&this.save&&this.saveChanges()}saveChanges(){var e=this;return(0,u.Z)(function*(){if(e.form.patchValue({parent_id:e.form.value.parent_id||e._org.organisation.id}),!e.form.valid)return(0,m.cB)(`Some form fields are invalid. [${(0,m.RD)(e.form).join(", ")}]`);const n=e.form.getRawValue();e.loading=!0,e.loadingChange.emit(!0);const o={...n,tags:["building"],name:`BLD ${(0,c.N9E)().description} ${n.display_name}`},a=yield(n.id?(0,c.BfP)(n.id,o):(0,c.ri3)(o)).toPromise().catch(s=>{throw(0,m.cB)(`Error saving building: ${s.message||s.error||s}`),e.loading=!1,e.loadingChange.emit(!1),s});(0,m.t5)("Successfully saved building."),e.loading=!1,e.loadingChange.emit(!1),e.done.emit(a)})()}_updateTimezoneList(){const e=this.form?.value?.timezone||"";this.timezones=m.sM,this.filtered_timezones=this.timezones.filter(n=>n.toLowerCase().includes(e.toLowerCase()))}static#t=this.\u0275fac=function(n){return new(n||i)(t.Y36(b.w7))};static#e=this.\u0275cmp=t.Xpm({type:i,selectors:[["building-form"]],inputs:{building:"building",save:"save",loading:"loading"},outputs:{loadingChange:"loadingChange",done:"done"},features:[t.qOj,t.TTD],decls:3,vars:2,consts:()=>{let e,n,o,a;return e=$localize`:@@displayNameLabel␟8d766661ed5e178519720ec8e959d2a737f600a6␟1377207093952578744: Display Name: `,n=$localize`:@@displayNameLabel␟dbd34479df566856113383ebef3a2cb98e494642␟7608711767660448404: Timezone: `,o=$localize`:@@displayNameLabel␟8dfcfa872af9be0ad27411537a6944e3d33a278f␟2698045878883517755: Location: `,a=$localize`:@@displayNameLabel␟88b397510643ec67156f0eb2d333d4012801a8c1␟2672381863752151894: Region: `,[[4,"ngIf","ngIfElse"],["load_state",""],["building","","class","flex flex-col w-[36rem] max-w-[calc(100vw-4rem)]",3,"formGroup",4,"ngIf"],["building","",1,"flex","flex-col","w-[36rem]","max-w-[calc(100vw-4rem)]",3,"formGroup"],["class","flex flex-col",4,"ngIf"],[1,"flex","flex-col"],["for","display-name"],e,["appearance","outline"],["matInput","","name","display-name","placeholder","Display Name","formControlName","display_name"],n,["matPrefix","",1,"text-2xl"],["matInput","","formControlName","timezone","placeholder","Building timezone",3,"matAutocomplete"],["auto","matAutocomplete"],[3,"value",4,"ngFor","ngForOf"],[3,"disabled",4,"ngIf"],["for","address"],o,["matInput","","name","address","placeholder","Location or Address...","formControlName","location"],["for","region"],a,["name","region","formControlName","parent_id","placeholder","Select Region..."],[3,"value"],[3,"disabled"],[1,"flex","flex-col","items-center","justify-center","w-64","h-64"],["diameter","32"],[1,"mt-4"]]},template:function(n,o){if(1&n&&t.YNc(0,Q,2,1,"ng-container",0)(1,Y,4,0,"ng-template",null,1,t.W1O),2&n){const a=t.MAs(2);t.Q6J("ngIf",!o.loading)("ngIfElse",a)}},dependencies:[_.sg,_.O5,g._Y,g.Fj,g.JJ,g.JL,T.KE,T.qo,S.Nt,y.gD,f.ey,R.Ou,I.XC,I.ZL,g.sg,g.u,x.o,_.Ov]})}return i})();function j(i,d){1&i&&(t.TgZ(0,"button",4)(1,"app-icon"),t._uU(2,"close"),t.qZA()())}function X(i,d){if(1&i){const e=t.EpF();t.TgZ(0,"footer",5)(1,"button",6),t.NdJ("click",function(){t.CHM(e);const o=t.oxw();return t.KtG(o.save())}),t._uU(2,"Save"),t.qZA()()}}let K=(()=>{class i{constructor(e,n){this._data=e,this._dialog_ref=n,this.loading=!1,this.save_state=0,this.building=this._data,this.close=o=>this._dialog_ref.close(o),this.save=()=>this.save_state=Date.now()}static#t=this.\u0275fac=function(n){return new(n||i)(t.Y36(p.WI),t.Y36(p.so))};static#e=this.\u0275cmp=t.Xpm({type:i,selectors:[["building-modal"]],decls:7,vars:6,consts:[["btn","","icon","","mat-dialog-close","",4,"ngIf"],[1,"max-h-[65vh]","overflow-y-auto","overflow-x-hidden","p-4"],[3,"building","save","loading","loadingChange","done"],["class","p-2 flex justify-end border-t border-base-200",4,"ngIf"],["btn","","icon","","mat-dialog-close",""],[1,"p-2","flex","justify-end","border-t","border-base-200"],["btn","",1,"w-32",3,"click"]],template:function(n,o){1&n&&(t.TgZ(0,"header")(1,"h2"),t._uU(2),t.qZA(),t.YNc(3,j,3,0,"button",0),t.qZA(),t.TgZ(4,"main",1)(5,"building-form",2),t.NdJ("loadingChange",function(s){return o.loading=s})("done",function(s){return o.close(s)}),t.qZA()(),t.YNc(6,X,3,0,"footer",3)),2&n&&(t.xp6(2),t.hij("",o.building.id?"Edit":"Add"," Building"),t.xp6(),t.Q6J("ngIf",!o.loading),t.xp6(2),t.Q6J("building",o.building)("save",o.save_state)("loading",o.loading),t.xp6(),t.Q6J("ngIf",!o.loading))},dependencies:[_.O5,p.ZT,x.o,q]})}return i})();var H=l(66229);let L=(()=>{class i{constructor(e,n){this._org=e,this._dialog=n,this._options=new B.X({}),this._change=new B.X(0),this.options=this._options.asObservable(),this.filtered_buildings=(0,G.aj)([this._org.region_list,this._org.building_list,this._options,this._org.initialised]).pipe((0,C.U)(([o,a,s])=>{s.zone&&(a=a.filter(r=>r.parent_id===s.zone)),s.search&&(a=a.filter(r=>r.name.toLowerCase().includes(s.search.toLowerCase())));for(const r of a){const h=o.find(v=>v.id===r.parent_id);h&&(r.region=h.display_name||h.name),r.level_count=this._org.levelsForBuilding(r)?.length||0}return a}))}setFilters(e){this._options.next({...this._options.getValue(),...e})}setSearchString(e){this._options.next({...this._options.getValue(),search:e})}editBuilding(e=new c.TT8){this._dialog.open(K,{data:e}).afterClosed().subscribe(o=>{o&&this._org.addZone(o)})}editBuildingMetadata(e=new c.TT8){this._dialog.open(H.K,{data:{zone:e}}).afterClosed().subscribe(o=>{o&&setTimeout(()=>location.reload(),300)})}removeBuilding(e){var n=this;return(0,u.Z)(function*(){const o=yield(0,m._5)({title:"Remove Building",content:`Are you sure you want to remove the building "${e.name}"?`,icon:{content:"delete_forever"},confirm_text:"Remove"},n._dialog);if("done"!==o.reason)return o.close();o.loading("Removing building..."),yield(0,c.Jwl)(e.id).toPromise(),n._org.removeZone({id:e.id,tags:["building"]}),(0,m.t5)("Successfully removed building."),o.close()})()}static#t=this.\u0275fac=function(n){return new(n||i)(t.LFG(b.w7),t.LFG(p.uw))};static#e=this.\u0275prov=t.Yz7({token:i,factory:i.\u0275fac,providedIn:"root"})}return i})();var k=l(33005),V=l(19842),Z=l(43811),N=l(78128),W=l(28442),tt=l(27442),et=l(78075),nt=l(6612);function it(i,d){if(1&i&&(t._uU(0),t.ALo(1,"level"),t.ALo(2,"level")),2&i){const e=d.data;let n;t.hij(" ",(null==(n=t.lcZ(1,1,e))?null:n.display_name)||(null==(n=t.lcZ(2,3,e))?null:n.name)," ")}}function ot(i,d){if(1&i&&t._UZ(0,"img",7),2&i){const e=t.oxw().data;t.Q6J("source",e[0])}}function at(i,d){1&i&&(t.TgZ(0,"span",8),t._uU(1,"No Images"),t.qZA())}function st(i,d){if(1&i&&t.YNc(0,ot,1,1,"img",5)(1,at,2,0,"span",6),2&i){const e=d.data;t.Q6J("ngIf",e.length),t.xp6(),t.Q6J("ngIf",!e.length)}}function lt(i,d){if(1&i){const e=t.EpF();t.TgZ(0,"div",22),t.NdJ("click",function(o){return o.stopPropagation()}),t.TgZ(1,"label"),t._uU(2,"Before Event"),t.qZA(),t.TgZ(3,"a-duration-field",23),t.NdJ("ngModelChange",function(o){t.CHM(e);const a=t.oxw().row,s=t.oxw();return t.KtG(s.settings[a.id].time_before=o)}),t.qZA(),t.TgZ(4,"label"),t._uU(5,"After Event"),t.qZA(),t.TgZ(6,"a-duration-field",23),t.NdJ("ngModelChange",function(o){t.CHM(e);const a=t.oxw().row,s=t.oxw();return t.KtG(s.settings[a.id].time_after=o)}),t.qZA(),t.TgZ(7,"label"),t._uU(8,"Event Types"),t.qZA(),t.TgZ(9,"mat-form-field",24)(10,"mat-select",25),t.NdJ("ngModelChange",function(o){t.CHM(e);const a=t.oxw().row,s=t.oxw();return t.KtG(s.settings[a.id].resources=o)}),t.TgZ(11,"mat-option",26),t._uU(12," Desks "),t.qZA(),t.TgZ(13,"mat-option",27),t._uU(14," Visitors "),t.qZA(),t.TgZ(15,"mat-option",28),t._uU(16," Parking "),t.qZA()()()()}if(2&i){const e=t.oxw().row,n=t.oxw();t.xp6(3),t.Q6J("min",0)("ngModel",n.settings[e.id].time_before),t.xp6(3),t.Q6J("min",0)("ngModel",n.settings[e.id].time_after),t.xp6(4),t.Q6J("ngModel",n.settings[e.id].resources)}}function rt(i,d){if(1&i){const e=t.EpF();t.TgZ(0,"div",9)(1,"button",10)(2,"app-icon"),t._uU(3,"more_vert"),t.qZA()(),t.TgZ(4,"mat-menu",null,11)(6,"button",12),t.NdJ("click",function(){const a=t.CHM(e).row,s=t.oxw();return t.KtG(s.editBuildingMetadata(a))}),t.TgZ(7,"div",13)(8,"app-icon",14),t._uU(9,"edit_square"),t.qZA(),t.TgZ(10,"span"),t._uU(11,"App Configuration"),t.qZA()()(),t.TgZ(12,"button",12),t.NdJ("click",function(){const a=t.CHM(e).row,s=t.oxw();return t.KtG(s.editBuilding(a))}),t.TgZ(13,"div",13)(14,"app-icon",14),t._uU(15,"edit"),t.qZA(),t.TgZ(16,"span"),t._uU(17,"Edit Building"),t.qZA()()(),t.TgZ(18,"button",15),t.NdJ("click",function(o){const s=t.CHM(e).row,r=t.oxw();return t.KtG(r.loadSettings(o,s.id))})("mouseenter",function(o){const s=t.CHM(e).row,r=t.oxw();return t.KtG(r.settings[s.id]?"":r.loadSettings(o,s.id))}),t.TgZ(19,"div",13)(20,"app-icon",16),t._uU(21,"release_alert"),t.qZA(),t.TgZ(22,"span"),t._uU(23,"Auto-release Settings"),t.qZA()(),t.TgZ(24,"mat-menu",null,17),t.YNc(26,lt,17,5,"div",18),t.TgZ(27,"button",19),t.NdJ("click",function(){const a=t.CHM(e).row,s=t.oxw();return t.KtG(s.saveSettings(a.id))}),t._uU(28," Save "),t.qZA()()(),t.TgZ(29,"button",12),t.NdJ("click",function(){const a=t.CHM(e).row,s=t.oxw();return t.KtG(s.removeBuilding(a))}),t.TgZ(30,"div",20)(31,"app-icon",21),t._uU(32,"delete"),t.qZA(),t.TgZ(33,"span"),t._uU(34,"Delete Building"),t.qZA()()()()()}if(2&i){const e=d.row,n=t.MAs(5),o=t.MAs(25),a=t.oxw();t.xp6(),t.Q6J("matMenuTriggerFor",n),t.xp6(17),t.Q6J("matMenuTriggerFor",o),t.xp6(8),t.Q6J("ngIf",a.settings[e.id])}}const dt=()=>["display_name","address","timezone","region","level_count","actions"],gt=()=>["Name","Location","Timezone","Region","Levels"," "],ct=()=>["12r","flex","12r","10r","6r","3.75r"],mt=(i,d,e)=>({images:i,zones:d,actions:e});let _t=(()=>{class i{constructor(e,n){this._manager=e,this._settings=n,this.buildings=this._manager.filtered_buildings,this.settings={},this.editBuilding=o=>this._manager.editBuilding(o),this.editBuildingMetadata=o=>this._manager.editBuildingMetadata(o),this.removeBuilding=o=>this._manager.removeBuilding(o)}loadSettings(e,n){var o=this;return(0,u.Z)(function*(){e.preventDefault(),e.stopPropagation(),o.settings[n]={};const s=(yield(0,c.oOs)({parent_id:n}).pipe((0,C.U)(r=>r.data)).toPromise()).find(r=>r.encryption_level===c.sUp.None);if(s){try{o.settings[n]=Z.zD(s.settings_string)?.auto_release||{}}catch{}console.log("Settings:",o.settings[n],s.settings_string)}})()}saveSettings(e){var n=this;return(0,u.Z)(function*(){let a=(yield(0,c.oOs)({parent_id:e}).pipe((0,C.U)(M=>M.data)).toPromise()).find(M=>M.encryption_level===c.sUp.None);a||(a=new c.iJM({parent_id:e,encryption_level:c.sUp.None,settings_string:""}));let s={};try{s=Z.zD(a.settings_string)||{}}catch{}a.settings_string=Z.$w({...s,auto_release:n.settings[e]}),a.id?yield(0,c.VPJ)(a.id,a).toPromise():yield(0,c.zZM)(a).toPromise();const r=n._settings.get("app.workplace_metadata_key")||"workplace_app",v=(yield(0,c.rlq)(e,r).toPromise()).details||{};v.auto_release=n.settings[e],yield(0,c.Ymr)(e,{name:r,details:v,description:""}).toPromise(),(0,m.t5)("Auto-release settings updated")})()}static#t=this.\u0275fac=function(n){return new(n||i)(t.Y36(L),t.Y36(m.gb))};static#e=this.\u0275cmp=t.Xpm({type:i,selectors:[["building-list"]],decls:8,vars:12,consts:[[1,"absolute","inset-0","overflow-auto","px-4"],["empty","No buildings",1,"block","min-w-[60rem]","w-full","h-full",3,"dataSource","columns","display_column","column_size","template"],["level_template",""],["image_template",""],["action_template",""],["auth","","class","max-h-[3rem] max-w-[8rem]",3,"source",4,"ngIf"],["class","opacity-30",4,"ngIf"],["auth","",1,"max-h-[3rem]","max-w-[8rem]",3,"source"],[1,"opacity-30"],[1,"w-full","flex","justify-end","space-x-2"],["btn","","icon","","matRipple","",3,"matMenuTriggerFor"],["menu","matMenu"],["mat-menu-item","",3,"click"],[1,"flex","items-center","space-x-2"],[1,"text-xl"],["mat-menu-item","",3,"matMenuTriggerFor","click","mouseenter"],["className","material-symbols-rounded",1,"text-xl"],["auto_release_menu","matMenu"],["class","px-2",3,"click",4,"ngIf"],["btn","","matRipple","",1,"w-[calc(100%-1rem)]","mx-auto",3,"click"],[1,"flex","items-center","space-x-2","text-red-500"],[1,"text-error","text-xl"],[1,"px-2",3,"click"],[3,"min","ngModel","ngModelChange"],["appearance","outline",1,"w-full"],["multiple","","placeholder","Set Event Types...",3,"ngModel","ngModelChange"],["value","desk"],["value","visitor"],["value","parking"]],template:function(n,o){if(1&n&&(t.TgZ(0,"div",0),t._UZ(1,"custom-table",1),t.qZA(),t.YNc(2,it,3,5,"ng-template",null,2,t.W1O)(4,st,2,2,"ng-template",null,3,t.W1O)(6,rt,35,3,"ng-template",null,4,t.W1O)),2&n){const a=t.MAs(3),s=t.MAs(5),r=t.MAs(7);t.xp6(),t.Q6J("dataSource",o.buildings)("columns",t.DdM(5,dt))("display_column",t.DdM(6,gt))("column_size",t.DdM(7,ct))("template",t.kEZ(8,mt,s,a,r))}},dependencies:[_.O5,g.JJ,g.On,T.KE,y.gD,f.ey,N.VK,N.OP,N.p6,f.wG,W.B,x.o,tt.C,et.A,nt.M]})}return i})();const ut=["app-building-manager",""];let w=(()=>{class i{constructor(e){this._state=e,this.newBuilding=()=>this._state.editBuilding()}static#t=this.\u0275fac=function(n){return new(n||i)(t.Y36(L))};static#e=this.\u0275cmp=t.Xpm({type:i,selectors:[["","app-building-manager",""]],attrs:ut,decls:10,vars:0,consts:[[1,"flex","flex-1","h-px"],[1,"flex","flex-col","flex-1","w-1/2","h-full"],[1,"flex","items-center","justify-between","mb-2","p-8"],[1,"text-2xl","font-medium"],["btn","","matRipple","",3,"click"],[1,"block","w-full","relative","flex-1","h-1/2"]],template:function(n,o){1&n&&(t._UZ(0,"app-topbar"),t.TgZ(1,"div",0),t._UZ(2,"app-sidebar"),t.TgZ(3,"main",1)(4,"header",2)(5,"h2",3),t._uU(6,"Building Management"),t.qZA(),t.TgZ(7,"button",4),t.NdJ("click",function(){return o.newBuilding()}),t._uU(8," Add Building "),t.qZA()(),t._UZ(9,"building-list",5),t.qZA()())},dependencies:[k.O,V.u,f.wG,_t],styles:["[_nghost-%COMP%]{display:flex;flex-direction:column;height:100%;width:100%;background-color:var(--b1)}sidebar[_ngcontent-%COMP%]{height:100%}main[_ngcontent-%COMP%]{display:flex;flex-direction:column;flex:1;min-width:50%;height:100%}\n\n/*# sourceMappingURL=building-manager.component.ts-angular-inline--184.css.map*/"]})}return i})();var pt=l(21757);const ft=[{path:"",component:w},{path:"new",component:w}];let ht=(()=>{class i{static#t=this.\u0275fac=function(n){return new(n||i)};static#e=this.\u0275mod=t.oAB({type:i});static#n=this.\u0275inj=t.cJS({imports:[_.ez,g.u5,U.v,P.YR,O.PP,pt.Hi,E.Bz.forChild(ft)]})}return i})()}}]);
//# sourceMappingURL=apps_concierge_src_app_building-manager_building-manager_module_ts.js.map