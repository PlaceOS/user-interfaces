"use strict";(self.webpackChunkconcierge=self.webpackChunkconcierge||[]).push([["default-apps_concierge_src_app_desks_desks-state_service_ts"],{71578:(X,T,t)=>{t.d(T,{v:()=>q});var p=t(89204),v=t(3998),D=t(90521),E=t(42175),l=t(71536),M=t(33119),I=t(19803),A=t(71963),h=t(35443),y=t(29314),S=t(7841),P=t(66e3),G=t(6109),R=t(22508),V=t(33602),O=t(57871),$=t(99908),F=t(33240),b=t(56441),C=t(10764),g=t(57915),f=t(77375),z=t(12185),e=(t(83259),t(7404)),c=t(34456),x=t(12587),N=t(60316),B=t(24950),k=t(87984),_=t(97024),J=t(41134),L=t(85060),Y=t(20212),Q=t(69434);function Z(d,W){1&d&&(e.j41(0,"button",6)(1,"app-icon"),e.EFF(2,"close"),e.k0s()())}function w(d,W){if(1&d){const s=e.RV6();e.j41(0,"main",7)(1,"div",8)(2,"div",9)(3,"label",10),e.EFF(4,"Desk Name"),e.j41(5,"span"),e.EFF(6,"*"),e.k0s()(),e.j41(7,"mat-form-field",11),e.nrm(8,"input",12),e.j41(9,"mat-error"),e.EFF(10,"A name is required for desks"),e.k0s()()(),e.j41(11,"div",9)(12,"label",13),e.EFF(13,"Map ID"),e.j41(14,"span"),e.EFF(15,"*"),e.k0s()(),e.j41(16,"mat-form-field",11),e.nrm(17,"input",14),e.j41(18,"mat-error"),e.EFF(19," A Map ID is required for desks "),e.k0s()()()(),e.j41(20,"label",15),e.EFF(21,"Groups"),e.k0s(),e.nrm(22,"item-list-field",16),e.j41(23,"label",15),e.EFF(24,"Features"),e.k0s(),e.nrm(25,"item-list-field",17),e.j41(26,"label",15),e.EFF(27,"Notes"),e.k0s(),e.j41(28,"mat-form-field",18),e.nrm(29,"textarea",19),e.k0s(),e.j41(30,"div",20)(31,"mat-checkbox",21),e.EFF(32," Bookable "),e.k0s()(),e.j41(33,"div",22)(34,"button",23),e.EFF(35," Cancel "),e.k0s(),e.j41(36,"button",24),e.bIt("click",function(){e.eBV(s);const i=e.XpG();return e.Njj(i.postForm())}),e.EFF(37," Save "),e.k0s()()()}if(2&d){const s=e.XpG();e.Y8G("formGroup",s.form)}}function K(d,W){1&d&&(e.j41(0,"main",25),e.nrm(1,"mat-spinner",26),e.j41(2,"p"),e.EFF(3,"Saving desk details..."),e.k0s()())}let H=(()=>{class d{get id(){return this._data?.desk?.id||""}constructor(s,n){this._data=s,this._dialog_ref=n,this.event=new e.bkB,this.form=new c.gE({id:new c.MJ(""),name:new c.MJ("",[c.k0.required]),map_id:new c.MJ("",[c.k0.required]),groups:new c.MJ([]),features:new c.MJ([]),bookable:new c.MJ(!1),notes:new c.MJ("")}),s?.desk&&this.form.patchValue(s.desk)}postForm(){if(this.form.markAllAsTouched(),this.form.updateValueAndValidity(),!this.form.valid)return;this.loading=!0;const s=this.form.value;this._dialog_ref.disableClose=!0,this.event.emit({reason:"done",metadata:s})}static#e=this.\u0275fac=function(n){return new(n||d)(e.rXU(x.Vh),e.rXU(x.CP))};static#t=this.\u0275cmp=e.VBU({type:d,selectors:[["desk-modal"]],outputs:{event:"event"},decls:8,vars:4,consts:[["load_state",""],[1,"w-[28rem]"],[1,"flex","items-center","justify-between","px-2","w-full"],[1,"px-2"],["icon","","matRipple","","mat-dialog-close","",4,"ngIf"],["class","p-4 flex flex-col",3,"formGroup",4,"ngIf","ngIfElse"],["icon","","matRipple","","mat-dialog-close",""],[1,"p-4","flex","flex-col",3,"formGroup"],[1,"flex","space-x-2"],[1,"flex-1","w-1/3"],["for","name"],["appearance","outline",1,"w-full"],["matInput","","name","name","formControlName","name","placeholder","e.g. Office Desk"],["for","map-id"],["matInput","","name","map-id","formControlName","map_id","placeholder","e.g. table-01.012"],["for","notes"],["placeholder","Add user groups...","formControlName","groups",1,"w-full"],["placeholder","Add features...","formControlName","features",1,"w-full"],["appearance","outline",1,"no-subscript"],["matInput","","name","notes","formControlName","notes"],[1,"flex","py-4"],["formControlName","bookable"],[1,"flex","items-center","justify-end","space-x-2"],["btn","","matRipple","","mat-dialog-close","",1,"w-32","inverse"],["btn","","matRipple","",1,"w-32",3,"click"],[1,"p-8","flex","flex-col","items-center","justify-center","space-y-2"],["diameter","32"]],template:function(n,i){if(1&n&&(e.j41(0,"div",1)(1,"header",2)(2,"h2",3),e.EFF(3),e.k0s(),e.DNE(4,Z,3,0,"button",4),e.k0s(),e.DNE(5,w,38,1,"main",5),e.k0s(),e.DNE(6,K,4,0,"ng-template",null,0,e.C5r)),2&n){const o=e.sdS(7);e.R7$(3),e.SpI("",i.id?"Edit":"New"," Desk"),e.R7$(),e.Y8G("ngIf",!i.loading),e.R7$(),e.Y8G("ngIf",!i.loading)("ngIfElse",o)}},dependencies:[N.bT,c.me,c.BC,c.cb,c.j4,c.JD,B.rl,B.TL,k.fg,_.So,J.LG,x.tx,L.r6,Y.DR,Q.R]})}return d})(),q=(()=>{class d extends f.Tv{nextPage(){this._call_next_page.next(`NEXT_${Date.now()}`)}constructor(s,n,i){super(),this._org=s,this._dialog=n,this._settings=i,this._filters=new D.t({}),this._desk_bookings=[],this._loading=new D.t(!1),this._change=new D.t(0),this.loading=this._loading.asObservable(),this.filters=this._filters.asObservable(),this.desks=(0,E.zV)([this._filters,this._change]).pipe((0,I.B)(500),(0,A.n)(([o])=>{const r=o.zones||[];return r&&!r.includes("All")?(0,v.bpY)(r[0],"desks").pipe((0,h.T)(a=>a.details instanceof Array?a.details:[]),(0,y.W)(a=>(0,l.of)([]))):(0,v.WsZ)(this._org.building?.id,{name:"desks"}).pipe((0,h.T)(a=>a.map(m=>m.metadata?.desks?.details||[]).reduce((m,u)=>[...m,...u],[])),(0,y.W)(a=>(0,l.of)([])))}),(0,h.T)(o=>(o instanceof Array||(o=[]),o.sort((r,a)=>r.name?.localeCompare(a.name)),o.map(r=>new z.gB({...r,qr_code:""})))),(0,S.t)(1)),this._next_page=new M.B7,this._call_next_page=new M.B7,this._all_zones_keys=["All",-1,"-1"],this.setup_paging=(0,E.zV)([this._filters,this._org.initialised]).pipe((0,I.B)(500),(0,P.M)(([o,r])=>{if(!r)return;const a=o.date||Date.now(),m=!o.zones||o.zones.some(u=>this._all_zones_keys.includes(u))?this._settings.get("app.use_region")?this._org.buildingsForRegion().map(u=>u.id):[this._org.building.id]:o.zones;this._next_page.next(()=>(0,g.WE)({period_start:(0,$._)((0,F.o)(a)),period_end:(0,$._)((0,b.D)(a)),type:"desk",zones:m.join(","),include_checked_out:!0}).pipe((0,y.W)(u=>(0,l.of)({data:[],total:0,next:null})))),this._call_next_page.next(`RESET_${Date.now()}`)})),this.paged_bookings=(0,E.zV)([this._next_page,this._call_next_page]).pipe((0,G.F)((o,r)=>o[1]===r[1]),(0,A.n)(([o,r])=>(this._loading.next(!0),o?r.includes("RESET")?o().pipe((0,h.T)(a=>({...a,reset:!0})),(0,y.W)(a=>(0,l.of)({data:[],total:0,next:null}))):o().pipe((0,h.T)(a=>({...a,reset:!1})),(0,y.W)(a=>(0,l.of)({data:[],total:0,next:null}))):(0,l.of)({data:[],total:0,next:null,reset:r.includes("RESET")}))),(0,R.S)((o,{data:r,total:a,next:m,reset:u})=>{const j=r;return this._next_page.next(m),u?{list:j,total:a}:{list:[...o.list,...j],total:a}},{list:[],total:0}),(0,P.M)(o=>this._loading.next(!1)),(0,S.t)(1)),this.has_more_pages=this.paged_bookings.pipe((0,h.T)(o=>o.list.length<o.total)),this.bookings=this.paged_bookings.pipe((0,h.T)(o=>o.list)),this.setup_paging.subscribe()}setFilters(s){s.zones?.includes("All")?s.zones=["All",...this._org.levelsForBuilding(this._org.building).map(n=>n.id)]:s.zones&&this._filters.getValue()?.zones?.includes("All")&&(s.zones=[]),this._filters.next({...this._filters.getValue(),...s})}refresh(){this._loading.next(!0),this.timeout("poll",()=>this.setFilters(this._filters.getValue()))}addDesks(s){var n=this;return(0,p.A)(function*(){const i=n._filters.getValue().zones[0],o=yield n.desks.pipe((0,V.s)(1)).toPromise();for(const r of s){const a=o.findIndex(m=>m.id===r.id);a>=0?o[a]=r:o.push(r)}yield(0,v.D58)(i,{name:"desks",details:o,description:"List of available desks"}).toPromise(),n._change.next(Date.now())})()}editDesk(s){var n=this;return(0,p.A)(function*(){const i=n._dialog.open(H,{data:{desk:s}}),o=yield Promise.race([i.afterClosed().toPromise(),i.componentInstance.event.pipe((0,O.$)(j=>"done"===j.reason)).toPromise()]);if("done"!==o?.reason)return;const r=n._filters.getValue().zones[0],a={...o.metadata,id:o.metadata.id||`parking-${r}.${(0,f.HO)(999999)}`},m=yield n.desks.pipe((0,V.s)(1)).toPromise(),u=m.findIndex(j=>j.id===a.id);u>=0?m[u]=a:m.push(a),yield(0,v.D58)(r,{name:"desks",details:m,description:"List of available desks"}).toPromise(),n._change.next(Date.now()),i.close()})()}checkinDesk(s,n=!0){return(0,p.A)(function*(){const i=yield(0,g.Z$)(s.id,n??!0).toPromise().catch(o=>({failed:!0,error:o}));if(i.failed)throw(0,f.UG)(i.error?`Error: ${i.error}`:`Error checking ${n?"in":"out"} desk booking`),i.error;(0,f.VX)(`Checked ${n?"in":"out"} ${s.user_name}.`)})()}approveDesk(s){return(0,p.A)(function*(){if("failed"===(yield(0,g.DD)(s.id).toPromise().catch(i=>"failed")))return(0,f.UG)("Error approving in desk booking");(0,f.VX)(`Approved desk booking for ${s.user_name} on ${(0,C.GP)(s.date,"MMM do")}.`),s.approved=!0,s.rejected=!1})()}rejectDesk(s){return(0,p.A)(function*(){if("failed"===(yield(0,g.vB)(s.id).toPromise().catch(i=>"failed")))return(0,f.UG)("Error rejecting in desk booking");(0,f.VX)(`Rejected desk booking for ${s.user_name} on ${(0,C.GP)(s.date,"MMM do")}.`),s.approved=!1,s.rejected=!0})()}giveAccess(s){var n=this;return(0,p.A)(function*(){const i=yield(0,g.X0)(new g.Qr({...s,access:!0})).toPromise().catch(o=>"failed");if("failed"===i)return(0,f.UG)("Error giving building access booking host");(0,f.VX)(`Successfully gave building access to ${s.user_name} for desk booking.`),n._desk_bookings=[...n._desk_bookings,i]})()}rejectAllDesks(){var s=this;return(0,p.A)(function*(){const n=s._desk_bookings||[];if(n.length<=0)return(0,f.uA)("No desks to reject for the selected date");const i=yield(0,f.GE)({title:"Cancel all desk bookings",content:"Are you sure you want to cancel all bookings for the selected date?",icon:{type:"icon",class:"material-icons",content:"delete"}},s._dialog);"done"===i.reason&&(i.loading("Rejecting all desks for selected date..."),yield Promise.all(n.map(o=>(0,g.vB)(o.id).toPromise())),(0,f.VX)("Successfully rejected all desk bookings for selected date."),i.close())})()}static#e=this.\u0275fac=function(n){return new(n||d)(e.KVO(z.yb),e.KVO(x.bZ),e.KVO(f.h$))};static#t=this.\u0275prov=e.jDH({token:d,factory:d.\u0275fac,providedIn:"root"})}return d})()},57915:(X,T,t)=>{t.d(T,{Qr:()=>D.Qr,nx:()=>v.n,WS:()=>D.WS,SG:()=>p.S,DD:()=>l.DD,wk:()=>l.wk,Z$:()=>l.Z$,eW:()=>l.eW,u3:()=>l.u3,tj:()=>l.tj,WE:()=>l.WE,vB:()=>l.vB,U:()=>l.U,UN:()=>l.UN,X0:()=>l.X0,DO:()=>l.DO,vq:()=>l.vq,MV:()=>l.MV});var p=t(49478),v=t(18379),D=t(53857),l=(t(17141),t(18026));t(77375),t(45762),t(3367),t(67254),t(98796),t(1781),t(27547),t(67642),t(1593)}}]);
//# sourceMappingURL=default-apps_concierge_src_app_desks_desks-state_service_ts.js.map