(window.webpackJsonp=window.webpackJsonp||[]).push([[2],{j4gA:function(t,e,s){"use strict";s.d(e,"a",function(){return c});var n=s("8Y7J"),i=s("knde"),o=s("Dxy4"),a=s("z03u");let c=(()=>{class t{constructor(t){this._state=t,this.zoomIn=()=>this._state.setPositions(Math.min(10,1.2*this._state.positions.zoom),this._state.positions.center),this.zoomOut=()=>this._state.setPositions(Math.max(1,this._state.positions.zoom*(1/1.2)),this._state.positions.center),this.reset=()=>this._state.setPositions(1,{x:.5,y:.5})}}return t.\u0275fac=function(e){return new(e||t)(n.Rb(i.a))},t.\u0275cmp=n.Lb({type:t,selectors:[["explore-zoom-controls"]],decls:9,vars:0,consts:[["z-in","","mat-icon-button","",1,"bg-white",3,"click"],["z-out","","mat-icon-button","",1,"bg-white",3,"click"],["reset","","mat-icon-button","",1,"bg-white",3,"click"]],template:function(t,e){1&t&&(n.Xb(0,"button",0),n.ic("click",function(){return e.zoomIn()}),n.Xb(1,"app-icon"),n.Nc(2,"add"),n.Wb(),n.Wb(),n.Xb(3,"button",1),n.ic("click",function(){return e.zoomOut()}),n.Xb(4,"app-icon"),n.Nc(5,"remove"),n.Wb(),n.Wb(),n.Xb(6,"button",2),n.ic("click",function(){return e.reset()}),n.Xb(7,"app-icon"),n.Nc(8,"autorenew"),n.Wb(),n.Wb())},directives:[o.b,a.a],styles:["[_nghost-%COMP%] {\n                display: flex;\n                flex-direction: column;\n                padding: 0.5rem;\n            }\n\n            button[_ngcontent-%COMP%] {\n                border: 1px solid #ccc;\n                border-radius: 0;\n            }\n\n            button[_ngcontent-%COMP%]:first-child {\n                border-radius: 0.25rem 0.25rem 0 0;\n                border-bottom: none;\n            }\n\n            button[_ngcontent-%COMP%]:last-child {\n                border-radius: 0 0 0.25rem 0.25rem;\n                border-top: none;\n            }"]}),t})()},knde:function(t,e,s){"use strict";s.d(e,"a",function(){return p});var n=s("mrSG"),i=s("2Vo4"),o=s("itXk"),a=s("lJxs"),c=s("Kj3r"),r=s("SxV6"),l=s("pLZG"),u=s("grfs"),b=s("8Y7J"),d=s("InVF"),h=s("EE6m");let p=(()=>{class t extends u.b{constructor(t,e,s){super(),this._org=t,this._spaces=e,this._settings=s,this._level=new i.a(null),this._positions=new i.a({zoom:1,center:{x:.5,y:.5}}),this._styles=new i.a({}),this._features=new i.a({}),this._actions=new i.a({}),this._labels=new i.a({}),this._options=new i.a({}),this._message=new i.a(""),this.level=this._level.asObservable(),this.message=this._message.asObservable(),this.spaces=Object(o.a)([this._level,this._spaces.list]).pipe(Object(a.a)(([t,e])=>e.filter(e=>e.zones.includes(t.id)))),this.map_url=this._level.pipe(Object(a.a)(t=>(t?t.map_id:"")||"")),this.map_positions=this._positions.asObservable(),this.map_features=Object(o.a)([this._features,this._options]).pipe(Object(c.a)(200),Object(a.a)(([t,e])=>{let s=[];for(const n in t)switch(n){case"devices":e.show_zones&&e.show_devices&&(s=s.concat(t[n]));break;case"contacts":e.show_contacts&&(s=s.concat(t[n]));break;default:s=s.concat(t[n])}return s})),this.map_actions=this._actions.pipe(Object(c.a)(200),Object(a.a)(t=>Object.values(t).reduce((t,e)=>t.concat(e),[]))),this.map_labels=Object(o.a)([this._labels,this._options]).pipe(Object(c.a)(200),Object(a.a)(([t,e])=>{let s=[];for(const n in t)("zones"!==n||e.show_zones)&&(s=s.concat(t[n]));return s})),this.map_styles=Object(o.a)([this._styles,this._options]).pipe(Object(c.a)(200),Object(a.a)(([t,e])=>{const s=Object.keys(t).reduce((e,s)=>Object.assign(Object.assign({},e),t[s]),{});return e.show_zones||(s["#zones"]={display:"none"},s["#Zones"]={display:"none"}),s.text={display:"none"},s})),this.options=this._options.asObservable(),this.init()}get positions(){return this._positions.getValue()}get active_level(){return this._level.getValue()}init(){return Object(n.a)(this,void 0,void 0,function*(){yield this._org.initialised.pipe(Object(r.a)(t=>t)).toPromise(),this._org.active_building.pipe(Object(l.a)(t=>!!t)).subscribe(t=>{const e=this._level.getValue(),s=this._org.levelsForBuilding(t);!s.find(t=>(null==e?void 0:e.id)===t.id)&&s.length&&this.setLevel(s[0].id),this.setOptions({show_devices:!1!==this._settings.get("app.explore.display_devices")})})})}setOptions(t){this._options.next(Object.assign(Object.assign({},this._options.getValue()),t))}setLevel(t){const e=this._org.levelWithID([t]);e&&this._level.next(e)}setStyles(t,e){const s=this._styles.getValue();s[t]=e,this._styles.next(s)}setFeatures(t,e){const s=this._features.getValue();s[t]=e,this._features.next(s)}setActions(t,e){const s=this._actions.getValue();s[t]=e,this._actions.next(s)}setLabels(t,e){const s=this._labels.getValue();s[t]=e,this._labels.next(s)}setPositions(t,e){this._positions.next({zoom:t,center:e})}}return t.\u0275fac=function(e){return new(e||t)(b.ec(d.c),b.ec(h.c),b.ec(u.d))},t.\u0275prov=b.Nb({token:t,factory:t.\u0275fac,providedIn:"root"}),t})()},s5id:function(t,e,s){"use strict";s.d(e,"c",function(){return J}),s.d(e,"a",function(){return T}),s.d(e,"b",function(){return _.a});var n=s("SVse"),i=s("s7LF"),o=s("gXqq"),a=s("jMqV"),c=s("1O3W"),r=s("1z/I"),l=s("xnnP"),u=s("mrSG"),b=s("grfs"),d=s("SxV6"),h=s("8Y7J"),p=s("InVF"),_=s("knde");s("iInd"),s("Q2Ze"),s("ZTz/"),s("UhP/");var m=s("K2Fw"),f=(s("qdGH"),s("lJxs"));s("D01k"),s("iELJ"),s("VNFA"),s("Dxy4"),s("z03u"),s("e6WT"),s("rS+9"),s("pu8Q");const g={free:"#43a047",pending:"#ffb300",reserved:"#e65100",busy:"#e53935","not-bookable":"#757575",unknown:"#757575"};var v=s("2Vo4"),O=s("itXk"),k=s("eIep"),y=s("JIr8"),j=s("odh7"),w=s("M34a"),x=s("piIK"),I=s("Qfz5"),P=s("7xvl"),X=s("jG/O");const W=["dot"],F=["explore-device-info",""];function z(t,e){if(1&t&&(h.Xb(0,"p",12),h.Xb(1,"label"),h.Nc(2,"Manufacturer:"),h.Wb(),h.Nc(3),h.Wb()),2&t){const t=h.mc(2);h.Fb(3),h.Pc(" ",t.manufacturer," ")}}function M(t,e){if(1&t&&(h.Xb(0,"p",13),h.Xb(1,"label"),h.Nc(2,"OS:"),h.Wb(),h.Nc(3),h.Wb()),2&t){const t=h.mc(2);h.Fb(3),h.Pc(" ",t.os,"")}}function N(t,e){if(1&t&&(h.Xb(0,"p",14),h.Xb(1,"label"),h.Nc(2,"SSID:"),h.Wb(),h.Nc(3),h.Wb()),2&t){const t=h.mc(2);h.Fb(3),h.Pc(" ",t.ssid,"")}}function C(t,e){if(1&t&&(h.Xb(0,"p",15),h.Xb(1,"label"),h.Nc(2,"Username:"),h.Wb(),h.Nc(3),h.Wb()),2&t){const t=h.mc(2);h.Fb(3),h.Pc(" ",(null==t.user?null:t.user.name)||(null==t.user?null:t.user.username)||t.username," ")}}function L(t,e){if(1&t&&(h.Xb(0,"p",16),h.Xb(1,"label"),h.Nc(2,"Type:"),h.Wb(),h.Nc(3),h.Wb()),2&t){const t=h.mc(2);h.Fb(3),h.Pc(" ",t.user.type," ")}}function S(t,e){if(1&t){const t=h.Yb();h.Xb(0,"div",4),h.ic("mouseleave",function(){return h.Cc(t),h.mc().close()}),h.Sb(1,"div",5),h.Xb(2,"div",6),h.Xb(3,"p"),h.Xb(4,"label"),h.Nc(5,"MAC:"),h.Wb(),h.Nc(6),h.Wb(),h.Xb(7,"p"),h.Xb(8,"label"),h.Nc(9,"Accuracy:"),h.Wb(),h.Nc(10),h.Wb(),h.Xb(11,"p"),h.Xb(12,"label"),h.Nc(13,"Last Seen:"),h.Wb(),h.Nc(14),h.Wb(),h.Lc(15,z,4,1,"p",7),h.Lc(16,M,4,1,"p",8),h.Lc(17,N,4,1,"p",9),h.Lc(18,C,4,1,"p",10),h.Lc(19,L,4,1,"p",11),h.Wb(),h.Wb()}if(2&t){const t=h.mc();h.Fb(6),h.Pc(" ",t.mac,""),h.Fb(4),h.Pc(" ",t.variance,"m"),h.Fb(4),h.Pc(" ",t.last_seen,""),h.Fb(1),h.tc("ngIf",t.manufacturer),h.Fb(1),h.tc("ngIf",t.os),h.Fb(1),h.tc("ngIf",t.ssid),h.Fb(1),h.tc("ngIf",t.username),h.Fb(1),h.tc("ngIf",t.user)}}let V=(()=>{class t{constructor(t,e,s){var n;this._details=t,this._element=e,this._overlay=s,this.username="",this.user=this._details.user,this.mac=this._details.mac,this.manufacturer=this._details.manufacturer,this.os=this._details.os,this.ssid=this._details.ssid,this.variance=null===(n=this._details.variance)||void 0===n?void 0:n.toFixed(2),this.diameter=100*this._details.variance,this.bg_color=this._details.bg_color||this.distance_color,this.overlay_ref=null,this.onEnter=()=>this.loadUser(),this.onLeave=()=>this.close(),this.onClick=()=>this.loadUser(),this.onTouch=()=>this.loadUser()}get last_seen(){return Object(P.a)(1e3*(this._details.last_seen||0),{addSuffix:!0})}get distance(){return Math.abs(Object(X.a)(1e3*(this._details.last_seen||0),new Date))}get distance_color(){return this.distance<10?"#43a047":this.distance<20?"#ffb300":"#e53935"}ngOnInit(t=0){t>10||setTimeout(()=>{var e;const s=null===(e=this._element.nativeElement.parentElement)||void 0===e?void 0:e.parentElement;if(!s)return this.ngOnInit(++t);const n=parseInt(s.style.top,10)/100,i=parseInt(s.style.left,10)/100;this.y_pos=n>=.5?"bottom":"top",this.x_pos=i>=.5?"end":"start"},200)}loadUser(){return Object(u.a)(this,void 0,void 0,function*(){if(this.open(),this.username)return;const t=Object(m.f)(this._details.system,"LocationServices");if(t){this.username="Loading...";const e=yield t.execute("check_ownership_of",[this.mac]).catch(t=>null);this.username=e&&e.assigned_to?e.assigned_to:""}})}open(){this.overlay_ref&&this.close(),this._portal&&(this.overlay_ref=this._overlay.create({positionStrategy:this._overlay.position().flexibleConnectedTo(this._dot).withPositions([{originX:"start"===this.x_pos?"end":"start",originY:"top"===this.y_pos?"bottom":"top",overlayX:this.x_pos||"end",overlayY:this.y_pos||"bottom"}])}),this.overlay_ref.attach(this._portal),console.log("Open"))}close(){this.overlay_ref&&(this.overlay_ref.dispose(),this.overlay_ref=null)}}return t.\u0275fac=function(e){return new(e||t)(h.Rb(o.d),h.Rb(h.m),h.Rb(c.c))},t.\u0275cmp=h.Lb({type:t,selectors:[["","explore-device-info",""]],viewQuery:function(t,e){if(1&t&&(h.Sc(r.b,1),h.Sc(W,1)),2&t){let t;h.xc(t=h.jc())&&(e._portal=t.first),h.xc(t=h.jc())&&(e._dot=t.first)}},hostBindings:function(t,e){1&t&&h.ic("mouseenter",function(){return e.onEnter()})("mouseleave",function(){return e.onLeave()})("click",function(){return e.onClick()})("touchend",function(){return e.onTouch()})},attrs:F,decls:4,vars:4,consts:[["name","radius",1,"radius","absolute","center","bg-blue-600","bg-opacity-25","border-4","border-dashed","border-blue-600","rounded-full",3,"mouseenter"],["name","dot",1,"h-2","w-2","absolute","center","rounded-full","pointer-events-auto","shadow"],["dot",""],["cdk-portal",""],["name","device-info",1,"w-64","rounded","bg-white","p-4","top-0","left-0","shadow","pointer-events-none",3,"mouseleave"],[1,"arrow"],[1,"details"],["type","",4,"ngIf"],["os","",4,"ngIf"],["ssid","",4,"ngIf"],["username","",4,"ngIf"],["user","",4,"ngIf"],["type",""],["os",""],["ssid",""],["username",""],["user",""]],template:function(t,e){1&t&&(h.Xb(0,"div",0),h.ic("mouseenter",function(){return e.loadUser()}),h.Wb(),h.Sb(1,"div",1,2),h.Lc(3,S,20,8,"ng-template",3)),2&t&&(h.Hc("height: "+e.diameter+"%; width: "+e.diameter+"%;"),h.Fb(1),h.Ic("background-color",e.bg_color))},directives:[r.h,n.n],styles:["[_nghost-%COMP%] {\n                pointer-events: auto;\n            }\n\n            [_nghost-%COMP%]    > [name='dot'][_ngcontent-%COMP%] {\n                background-color: #616161;\n            }\n\n            [_nghost-%COMP%]:hover    > [name='radius'][_ngcontent-%COMP%] {\n                opacity: 1;\n            }\n\n            [name='radius'][_ngcontent-%COMP%] {\n                opacity: 0;\n                transition: opacity 200ms;\n                pointer-events: none;\n            }"]}),t})();function D(t,e){if(1&t&&(h.Xb(0,"p",6),h.Nc(1),h.Wb()),2&t){const t=h.mc();h.Fb(1),h.Oc(t.user)}}function E(t,e){if(1&t&&(h.Xb(0,"p",7),h.Nc(1),h.nc(2,"date"),h.nc(3,"date"),h.Wb()),2&t){const t=h.mc();h.Fb(1),h.Qc(" ",h.pc(2,2,t.start,"shortTime")," \u2013 ",h.pc(3,5,t.end,"shortTime")," ")}}let A=(()=>{class t{constructor(t,e){this._details=t,this._element=e,this.map_id=this._details.map_id,this.user=this._details.user,this.start=this._details.start,this.end=this._details.end}ngOnInit(t=0){t>10||setTimeout(()=>{var e;const s=null===(e=this._element.nativeElement.parentElement)||void 0===e?void 0:e.parentElement;if(!s)return this.ngOnInit(++t);const n=parseInt(s.style.top,10)/100,i=parseInt(s.style.left,10)/100;this.y_pos=n>=.5?"bottom":"top",this.x_pos=i>=.5?"right":"left"},200)}get available_until(){return""}}return t.\u0275fac=function(e){return new(e||t)(h.Rb(o.d),h.Rb(h.m))},t.\u0275cmp=h.Lb({type:t,selectors:[["explore-desk-info"]],decls:7,vars:6,consts:[["name","space-info",3,"id"],[1,"arrow"],[1,"details"],["map-id","",1,"m-0","font-medium"],["user","","class","mt-2 text-sm",4,"ngIf"],["start","","class","mt-1 text-sm",4,"ngIf"],["user","",1,"mt-2","text-sm"],["start","",1,"mt-1","text-sm"]],template:function(t,e){1&t&&(h.Xb(0,"div",0),h.Sb(1,"div",1),h.Xb(2,"div",2),h.Xb(3,"h4",3),h.Nc(4),h.Wb(),h.Lc(5,D,2,1,"p",4),h.Lc(6,E,4,8,"p",5),h.Wb(),h.Wb()),2&t&&(h.Hb("absolute rounded bg-white p-4 top-0 left-0 shadow "+e.x_pos+" "+e.y_pos),h.tc("id",e.map_id),h.Fb(4),h.Oc(e.map_id),h.Fb(1),h.tc("ngIf",e.user),h.Fb(1),h.tc("ngIf",e.start))},directives:[n.n],pipes:[n.f],styles:["[_nghost-%COMP%] {\n                position: absolute;\n                top: 50%;\n                left: 50%;\n                transform: translate(-50%, -50%);\n                pointer-events: none;\n                z-index: 1;\n            }\n\n            [name='space-info'][_ngcontent-%COMP%] {\n                width: 16rem;\n            }\n\n            [name='status'][_ngcontent-%COMP%] {\n                background-color: #43a047;\n                font-weight: 500;\n            }\n\n            [name='status'].busy[_ngcontent-%COMP%] {\n                background-color: #e53935;\n            }\n\n            [name='status'].pending[_ngcontent-%COMP%] {\n                background-color: #ffb300;\n            }\n\n            [name='status'].not-bookable[_ngcontent-%COMP%] {\n                background-color: #757575;\n            }"]}),t})(),T=(()=>{class t extends b.b{constructor(t,e,s,n){super(),this._state=t,this._org=e,this._settings=s,this._desks_service=n,this._in_use=new v.a([]),this._options=new v.a({}),this._desks=new v.a([]),this._reserved=new v.a([]),this._statuses={},this._poll=new v.a(0),this._desk_bookings=Object(O.a)([this._state.level,this._poll]).pipe(Object(k.a)(([t])=>Object(I.e)({period_start:Object(j.a)(Object(w.a)(new Date)),period_end:Object(j.a)(Object(x.a)(new Date)),type:"desk",zones:t.id}))),this.desk_list=this._state.level.pipe(Object(k.a)(t=>Object(m.t)(t.id,{name:"desks"}).pipe(Object(f.a)(e=>(e.details instanceof Array?e.details:[]).map(e=>new p.b(Object.assign(Object.assign({},e),{zone:t})))))),Object(y.a)(t=>[])),this._bind=this._state.level.pipe(Object(f.a)(t=>{var e,s;if(this._statuses={},this.unsubWith("lvl"),!t)return;const n=this._org.buildings.find(e=>e.id===t.parent_id);if(!n)return;const i=(null===(e=n.bindings)||void 0===e?void 0:e.area_management)||(null===(s=this._org.organisation.bindings)||void 0===s?void 0:s.area_management);if(!i)return;let o=Object(m.f)(i,"AreaManagement").binding(t.id);this.subscription("lvl-in_use",o.listen().subscribe(t=>this.processBindingChange(t,i))),this.subscription("lvl-in_use_bind",o.bind()),o=Object(m.f)(i,"AreaManagement").binding(`${t.id}:desk_ids`),this.subscription("lvl-desks_list",o.listen().subscribe(t=>this._desks.next(t||[]))),this.subscription("lvl-desk_list_bind",o.bind())})),this._state_change=Object(O.a)([this.desk_list,this._in_use,this._reserved,this._options]).pipe(Object(f.a)(([t,e,s])=>{this._statuses={};for(const{id:n,bookable:i}of t){const t=e.some(t=>n===t),o=s.some(t=>n===t);this._statuses[n]=i?t?o?"reserved":"busy":"free":"not-bookable"}this.processDesks(t)})),this.init()}init(){return Object(u.a)(this,void 0,void 0,function*(){yield this._org.initialised.pipe(Object(d.a)(t=>t)).toPromise(),this.setOptions({enable_booking:!1!==this._settings.get("app.desks.enabled")}),this.subscription("bind",this._bind.subscribe()),this.subscription("changes",this._state_change.subscribe()),this.subscription("desks",this.desk_list.subscribe(t=>this.processDesks(t)))})}startPolling(t=3e4){this.subscription("desks_in_use_bookings",this._desk_bookings.subscribe(t=>this._in_use.next(t.map(t=>t.asset_id)))),this.interval("poll",()=>this._poll.next((new Date).valueOf()),t)}stopPolling(){this.clearInterval("poll")}setOptions(t){this._options.next(Object.assign(Object.assign({},this._options.getValue()),t))}processBindingChange({value:t},e){const s=(t||[]).filter(t=>!["desk","booking"].includes(t.location)),n=(t||[]).filter(t=>"desk"===t.location||"booking"===t.location&&"desk"===t.type);this._in_use.next(n.map(t=>t.map_id||t.asset_id)),this._reserved.next(n.filter(t=>!t.at_location).map(t=>t.map_id||t.asset_id)),this.processDevices(s,e),this.timeout("update",()=>this.updateStatus(),100)}updateStatus(){const t={},e=this._settings.get("app.explore.colors")||{};for(const s in this._statuses)this._statuses[s]&&(t[`#${s}`]={fill:e[`desk-${this._statuses[s]}`]||e[`${this._statuses[s]}`]||g[`${this._statuses[s]}`],opacity:.6});this._state.setStyles("desks",t)}processDevices(t,e){var s,n;const i=[];for(const o of t){const t=o.x/o.map_width,a=o.y/o.map_height;i.push({location:{x:(null===(s=o.coordinates_from)||void 0===s?void 0:s.includes("right"))?1-t:t,y:(null===(n=o.coordinates_from)||void 0===n?void 0:n.includes("bottom"))?1-a:a},content:V,data:Object.assign(Object.assign({},o),{system:e})})}this._state.setFeatures("devices",i)}processDesks(t){const e=[],s=[],n=this._options.getValue();for(const i of t){e.push({location:i.id,content:A,hover:!0,data:{map_id:i.name,status:this._statuses[i.map_id]}});const t=()=>this._desks_service.bookDesk({desks:[i],host:n.host,date:n.date});s.push({id:i.id,action:"click",callback:t}),s.push({id:i.id,action:"touchend",callback:t})}this._state.setActions("desks",this._options.getValue().enable_booking?s:[]),this._state.setFeatures("desks",e),this.timeout("update",()=>this.updateStatus(),100)}}return t.\u0275fac=function(e){return new(e||t)(h.ec(_.a),h.ec(p.c),h.ec(b.d),h.ec(I.b))},t.\u0275prov=h.Nb({token:t,factory:t.\u0275fac}),t})();s("EE6m"),s("OuDT"),s("j4gA"),s("LRne"),s("Kj3r"),s("vkgz"),s("UXun"),s("vrAh");let J=(()=>{class t{}return t.\u0275fac=function(e){return new(e||t)},t.\u0275mod=h.Pb({type:t}),t.\u0275inj=h.Ob({imports:[[n.c,o.b,i.h,i.p,a.b,c.f,r.f,l.a]]}),t})()}}]);
//# sourceMappingURL=default~desks-desks-module~facilities-facilities-module.js.map