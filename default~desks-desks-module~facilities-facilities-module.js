(window.webpackJsonp=window.webpackJsonp||[]).push([[2],{j4gA:function(t,e,s){"use strict";s.d(e,"a",function(){return c});var n=s("8Y7J"),i=s("knde"),o=s("Dxy4"),a=s("z03u");let c=(()=>{class t{constructor(t){this._state=t,this.zoomIn=()=>this._state.setPositions(Math.min(10,1.2*this._state.positions.zoom),this._state.positions.center),this.zoomOut=()=>this._state.setPositions(Math.max(1,this._state.positions.zoom*(1/1.2)),this._state.positions.center),this.reset=()=>this._state.setPositions(1,{x:.5,y:.5})}}return t.\u0275fac=function(e){return new(e||t)(n.Rb(i.a))},t.\u0275cmp=n.Lb({type:t,selectors:[["explore-zoom-controls"]],decls:9,vars:0,consts:[["mat-icon-button","",1,"bg-white",3,"click"]],template:function(t,e){1&t&&(n.Xb(0,"button",0),n.ic("click",function(){return e.zoomIn()}),n.Xb(1,"app-icon"),n.Lc(2,"add"),n.Wb(),n.Wb(),n.Xb(3,"button",0),n.ic("click",function(){return e.zoomOut()}),n.Xb(4,"app-icon"),n.Lc(5,"remove"),n.Wb(),n.Wb(),n.Xb(6,"button",0),n.ic("click",function(){return e.reset()}),n.Xb(7,"app-icon"),n.Lc(8,"autorenew"),n.Wb(),n.Wb())},directives:[o.b,a.a],styles:["[_nghost-%COMP%] {\n                display: flex;\n                flex-direction: column;\n                padding: .5rem;\n            }\n\n            button[_ngcontent-%COMP%] {\n                border: 1px solid #ccc;\n                border-radius: 0;\n            }\n\n            button[_ngcontent-%COMP%]:first-child {\n                border-radius: 0.25rem 0.25rem 0 0;\n                border-bottom: none;\n            }\n\n            button[_ngcontent-%COMP%]:last-child {\n                border-radius: 0 0 0.25rem 0.25rem;\n                border-top: none;\n            }"]}),t})()},knde:function(t,e,s){"use strict";s.d(e,"a",function(){return u});var n=s("2Vo4"),i=s("itXk"),o=s("lJxs"),a=s("Kj3r"),c=s("SxV6"),r=s("pLZG"),l=s("grfs"),h=s("8Y7J"),b=s("InVF"),d=s("EE6m");let u=(()=>{class t extends l.b{constructor(t,e,s){super(),this._org=t,this._spaces=e,this._settings=s,this._level=new n.a(null),this._positions=new n.a({zoom:1,center:{x:.5,y:.5}}),this._styles=new n.a({}),this._features=new n.a({}),this._actions=new n.a({}),this._labels=new n.a({}),this._options=new n.a({}),this._message=new n.a(""),this.level=this._level.asObservable(),this.message=this._message.asObservable(),this.spaces=Object(i.a)([this._level,this._spaces.list]).pipe(Object(o.a)(([t,e])=>e.filter(e=>e.zones.includes(t.id)))),this.map_url=this._level.pipe(Object(o.a)(t=>(t?t.map_id:"")||"")),this.map_positions=this._positions.asObservable(),this.map_features=Object(i.a)([this._features,this._options]).pipe(Object(a.a)(200),Object(o.a)(t=>{const[e,s]=t;let n=[];for(const i in e)switch(i){case"devices":s.show_zones&&s.show_devices&&(n=n.concat(e[i]));break;case"contacts":s.show_contacts&&(n=n.concat(e[i]));break;default:n=n.concat(e[i])}return n})),this.map_actions=this._actions.pipe(Object(a.a)(200),Object(o.a)(t=>Object.values(t).reduce((t,e)=>t.concat(e),[]))),this.map_labels=Object(i.a)([this._labels,this._options]).pipe(Object(a.a)(200),Object(o.a)(t=>{const[e,s]=t;let n=[];for(const i in e)("zones"!==i||s.show_zones)&&(n=n.concat(e[i]));return n})),this.map_styles=Object(i.a)([this._styles,this._options]).pipe(Object(a.a)(200),Object(o.a)(t=>{const[e,s]=t,n=Object.keys(e).reduce((t,s)=>Object.assign(Object.assign({},t),e[s]),{});return s.show_zones||(n["#zones"]={display:"none"},n["#Zones"]={display:"none"}),n.text={display:"none"},n})),this.options=this._options.asObservable(),this._org.initialised.pipe(Object(c.a)(t=>t)).subscribe(()=>{this.subscription("building",this._org.active_building.pipe(Object(r.a)(t=>!!t)).subscribe(t=>{const e=this._level.getValue(),s=this._org.levelsForBuilding(t);!s.find(t=>(null==e?void 0:e.id)===t.id)&&s.length&&this.setLevel(s[0].id),this.setOptions({show_devices:!1!==this._settings.get("app.explore.display_devices")})}))})}get positions(){return this._positions.getValue()}get active_level(){return this._level.getValue()}setOptions(t){this._options.next(Object.assign(Object.assign({},this._options.getValue()),t))}setLevel(t){const e=this._org.levelWithID([t]);e&&this._level.next(e)}setStyles(t,e){const s=this._styles.getValue();s[t]=e,this._styles.next(s)}setFeatures(t,e){const s=this._features.getValue();s[t]=e,this._features.next(s)}setActions(t,e){const s=this._actions.getValue();s[t]=e,this._actions.next(s)}setLabels(t,e){const s=this._labels.getValue();s[t]=e,this._labels.next(s)}setPositions(t,e){this._positions.next({zoom:t,center:e})}}return t.\u0275fac=function(e){return new(e||t)(h.ec(b.c),h.ec(d.c),h.ec(l.e))},t.\u0275prov=h.Nb({token:t,factory:t.\u0275fac,providedIn:"root"}),t})()},s5id:function(t,e,s){"use strict";s.d(e,"c",function(){return N}),s.d(e,"a",function(){return A}),s.d(e,"b",function(){return p.a});var n=s("SVse"),i=s("s7LF"),o=s("gXqq"),a=s("jMqV"),c=s("1O3W"),r=s("1z/I"),l=s("xnnP"),h=s("mrSG"),b=s("grfs"),d=s("SxV6"),u=s("8Y7J"),_=s("InVF"),p=s("knde");s("iInd"),s("Q2Ze"),s("ZTz/"),s("UhP/");var f=s("K2Fw");s("qdGH"),s("D01k"),s("iELJ"),s("VNFA"),s("Dxy4"),s("z03u"),s("e6WT"),s("rS+9"),s("pu8Q");const m={free:"#43a047",pending:"#ffb300",reserved:"#e65100",busy:"#e53935","not-bookable":"#757575",unknown:"#757575"};var g=s("2Vo4"),v=s("itXk"),O=s("Qfz5"),k=s("7xvl"),y=s("jG/O");const w=["dot"],x=["explore-device-info",""];function j(t,e){if(1&t&&(u.Xb(0,"p"),u.Xb(1,"label"),u.Lc(2,"Manufacturer:"),u.Wb(),u.Lc(3),u.Wb()),2&t){const t=u.mc(2);u.Fb(3),u.Nc(" ",t.manufacturer," ")}}function L(t,e){if(1&t&&(u.Xb(0,"p"),u.Xb(1,"label"),u.Lc(2,"OS:"),u.Wb(),u.Lc(3),u.Wb()),2&t){const t=u.mc(2);u.Fb(3),u.Nc(" ",t.os,"")}}function X(t,e){if(1&t&&(u.Xb(0,"p"),u.Xb(1,"label"),u.Lc(2,"SSID:"),u.Wb(),u.Lc(3),u.Wb()),2&t){const t=u.mc(2);u.Fb(3),u.Nc(" ",t.ssid,"")}}function M(t,e){if(1&t&&(u.Xb(0,"p"),u.Xb(1,"label"),u.Lc(2,"Username:"),u.Wb(),u.Lc(3),u.Wb()),2&t){const t=u.mc(2);u.Fb(3),u.Nc(" ",(null==t.user?null:t.user.name)||(null==t.user?null:t.user.username)||t.username," ")}}function W(t,e){if(1&t&&(u.Xb(0,"p"),u.Xb(1,"label"),u.Lc(2,"Type:"),u.Wb(),u.Lc(3),u.Wb()),2&t){const t=u.mc(2);u.Fb(3),u.Nc(" ",t.user.type,"")}}function I(t,e){if(1&t){const t=u.Yb();u.Xb(0,"div",4),u.ic("mouseleave",function(){return u.Ac(t),u.mc().close()}),u.Sb(1,"div",5),u.Xb(2,"div",6),u.Xb(3,"p"),u.Xb(4,"label"),u.Lc(5,"MAC:"),u.Wb(),u.Lc(6),u.Wb(),u.Xb(7,"p"),u.Xb(8,"label"),u.Lc(9,"Accuracy:"),u.Wb(),u.Lc(10),u.Wb(),u.Xb(11,"p"),u.Xb(12,"label"),u.Lc(13,"Last Seen:"),u.Wb(),u.Lc(14),u.Wb(),u.Jc(15,j,4,1,"p",7),u.Jc(16,L,4,1,"p",7),u.Jc(17,X,4,1,"p",7),u.Jc(18,M,4,1,"p",7),u.Jc(19,W,4,1,"p",7),u.Wb(),u.Wb()}if(2&t){const t=u.mc();u.Fb(6),u.Nc(" ",t.mac,""),u.Fb(4),u.Nc(" ",t.variance,"m"),u.Fb(4),u.Nc(" ",t.last_seen,""),u.Fb(1),u.sc("ngIf",t.manufacturer),u.Fb(1),u.sc("ngIf",t.os),u.Fb(1),u.sc("ngIf",t.ssid),u.Fb(1),u.sc("ngIf",t.username),u.Fb(1),u.sc("ngIf",t.user)}}let F=(()=>{class t{constructor(t,e,s){this._details=t,this._element=e,this._overlay=s,this.username="",this.user=this._details.user,this.mac=this._details.mac,this.manufacturer=this._details.manufacturer,this.os=this._details.os,this.ssid=this._details.ssid,this.variance=this._details.variance.toFixed(2),this.diameter=100*this._details.variance,this.bg_color=this._details.bg_color||this.distance_color,this.overlay_ref=null,this.onEnter=()=>this.loadUser(),this.onLeave=()=>this.close(),this.onClick=()=>this.loadUser(),this.onTouch=()=>this.loadUser()}get last_seen(){return Object(k.a)(new Date(1e3*this._details.last_seen),{addSuffix:!0})}get distance(){return Math.abs(Object(y.a)(1e3*this._details.last_seen,new Date))}get distance_color(){return this.distance<10?"#43a047":this.distance<20?"#ffb300":"#e53935"}ngOnInit(t=0){t>10||setTimeout(()=>{var e;const s=null===(e=this._element.nativeElement.parentElement)||void 0===e?void 0:e.parentElement;if(!s)return this.ngOnInit(++t);const n=parseInt(s.style.top,10)/100,i=parseInt(s.style.left,10)/100;this.y_pos=n>=.5?"bottom":"top",this.x_pos=i>=.5?"end":"start"},200)}loadUser(){return Object(h.a)(this,void 0,void 0,function*(){if(this.open(),this.username)return;const t=Object(f.e)(this._details.system,"LocationServices");if(t){this.username="Loading...";const e=yield t.execute("check_ownership_of",[this.mac]).catch(t=>null);this.username=e&&e.assigned_to?e.assigned_to:""}})}open(){this.overlay_ref&&this.close(),this._portal&&(this.overlay_ref=this._overlay.create({positionStrategy:this._overlay.position().flexibleConnectedTo(this._dot).withPositions([{originX:"start"===this.x_pos?"end":"start",originY:"top"===this.y_pos?"bottom":"top",overlayX:this.x_pos||"end",overlayY:this.y_pos||"bottom"}])}),this.overlay_ref.attach(this._portal))}close(){this.overlay_ref&&(this.overlay_ref.dispose(),this.overlay_ref=null)}}return t.\u0275fac=function(e){return new(e||t)(u.Rb(o.d),u.Rb(u.m),u.Rb(c.c))},t.\u0275cmp=u.Lb({type:t,selectors:[["","explore-device-info",""]],viewQuery:function(t,e){if(1&t&&(u.Qc(r.b,1),u.Qc(w,1)),2&t){let t;u.wc(t=u.jc())&&(e._portal=t.first),u.wc(t=u.jc())&&(e._dot=t.first)}},hostBindings:function(t,e){1&t&&u.ic("mouseenter",function(){return e.onEnter()})("mouseleave",function(){return e.onLeave()})("click",function(){return e.onClick()})("touchend",function(){return e.onTouch()})},attrs:x,decls:4,vars:4,consts:[["name","radius",1,"radius","absolute","center","bg-blue-600","bg-opacity-25","border-4","border-dashed","border-blue-600","rounded-full",3,"mouseenter"],["name","dot",1,"h-2","w-2","absolute","center","rounded-full","pointer-events-auto"],["dot",""],["cdk-portal",""],["name","device-info",1,"rounded","bg-white","p-4","top-0","left-0","shadow","pointer-events-none",3,"mouseleave"],[1,"arrow"],[1,"details"],[4,"ngIf"]],template:function(t,e){1&t&&(u.Xb(0,"div",0),u.ic("mouseenter",function(){return e.loadUser()}),u.Wb(),u.Sb(1,"div",1,2),u.Jc(3,I,20,8,"ng-template",3)),2&t&&(u.Fc("height: "+e.diameter+"%; width: "+e.diameter+"%;"),u.Fb(1),u.Gc("background-color",e.bg_color))},directives:[r.h,n.n],styles:["[_nghost-%COMP%] {\n                pointer-events: auto;\n            }\n\n            [_nghost-%COMP%]    > [name='dot'][_ngcontent-%COMP%] {\n                box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.35);\n                background-color: #616161;\n            }\n\n            [_nghost-%COMP%]:hover    > [name='radius'][_ngcontent-%COMP%] {\n                opacity: 1;\n            }\n\n            [name='radius'][_ngcontent-%COMP%] {\n                opacity: 0;\n                transition: opacity 200ms;\n                pointer-events: none;\n            }\n\n            [name='device-info'][_ngcontent-%COMP%] {\n                width: 16rem;\n                pointer-events: none;\n            }"]}),t})();function P(t,e){if(1&t&&(u.Xb(0,"p",6),u.Lc(1),u.Wb()),2&t){const t=u.mc();u.Fb(1),u.Mc(t.user)}}function z(t,e){if(1&t&&(u.Xb(0,"p",7),u.Lc(1),u.nc(2,"date"),u.nc(3,"date"),u.Wb()),2&t){const t=u.mc();u.Fb(1),u.Oc(" ",u.pc(2,2,t.start,"shortTime")," \u2013 ",u.pc(3,5,t.end,"shortTime")," ")}}let D=(()=>{class t{constructor(t,e){this._details=t,this._element=e,this.map_id=this._details.map_id,this.user=this._details.user,this.start=this._details.start,this.end=this._details.end}ngOnInit(t=0){t>10||setTimeout(()=>{var e;const s=null===(e=this._element.nativeElement.parentElement)||void 0===e?void 0:e.parentElement;if(!s)return this.ngOnInit(++t);const n=parseInt(s.style.top,10)/100,i=parseInt(s.style.left,10)/100;this.y_pos=n>=.5?"bottom":"top",this.x_pos=i>=.5?"right":"left"},200)}get available_until(){return""}}return t.\u0275fac=function(e){return new(e||t)(u.Rb(o.d),u.Rb(u.m))},t.\u0275cmp=u.Lb({type:t,selectors:[["explore-desk-info"]],decls:7,vars:6,consts:[["name","space-info",3,"id"],[1,"arrow"],[1,"details"],[1,"m-0","font-medium"],["class","mt-2 text-sm",4,"ngIf"],["class","mt-1 text-sm",4,"ngIf"],[1,"mt-2","text-sm"],[1,"mt-1","text-sm"]],template:function(t,e){1&t&&(u.Xb(0,"div",0),u.Sb(1,"div",1),u.Xb(2,"div",2),u.Xb(3,"h4",3),u.Lc(4),u.Wb(),u.Jc(5,P,2,1,"p",4),u.Jc(6,z,4,8,"p",5),u.Wb(),u.Wb()),2&t&&(u.Hb("absolute rounded bg-white p-4 top-0 left-0 shadow "+e.x_pos+" "+e.y_pos),u.sc("id",e.map_id),u.Fb(4),u.Mc(e.map_id),u.Fb(1),u.sc("ngIf",e.user),u.Fb(1),u.sc("ngIf",e.start))},directives:[n.n],pipes:[n.f],styles:["[_nghost-%COMP%] {\n                position: absolute;\n                top: 50%;\n                left: 50%;\n                transform: translate(-50%, -50%);\n                pointer-events: none;\n                z-index: 1;\n            }\n\n            [name='space-info'][_ngcontent-%COMP%] {\n                width: 16rem;\n            }\n\n            [name='status'][_ngcontent-%COMP%] {\n                background-color: #43a047;\n                font-weight: 500;\n            }\n\n            [name='status'].busy[_ngcontent-%COMP%] {\n                background-color: #e53935;\n            }\n\n            [name='status'].pending[_ngcontent-%COMP%] {\n                background-color: #ffb300;\n            }\n\n            [name='status'].not-bookable[_ngcontent-%COMP%] {\n                background-color: #757575;\n            }"]}),t})();var C=s("eIep"),V=s("lJxs"),S=s("JIr8"),J=s("odh7"),E=s("M34a"),T=s("piIK");let A=(()=>{class t extends b.b{constructor(t,e,s,n){super(),this._state=t,this._org=e,this._settings=s,this._desks_service=n,this._level=null,this._in_use=new g.a([]),this._options=new g.a({}),this._desks=new g.a([]),this._reserved=new g.a([]),this._statuses={},this._bindings=[],this._stats=new g.a({free:0,occupied:0,total:0}),this._poll=new g.a(0),this._desk_bookings=Object(v.a)([this._state.level,this._poll]).pipe(Object(C.a)(([t])=>Object(O.e)({period_start:Object(J.a)(Object(E.a)(new Date)),period_end:Object(J.a)(Object(T.a)(new Date)),type:"desk",zones:t.id}))),this.desk_list=this._state.level.pipe(Object(C.a)(t=>Object(f.s)(t.id,{name:"desks"}).pipe(Object(V.a)(e=>e.details.map(e=>new _.b(Object.assign(Object.assign({},e),{zone:t})))))),Object(S.a)(()=>[])),this.init()}init(){return Object(h.a)(this,void 0,void 0,function*(){yield this._org.initialised.pipe(Object(d.a)(t=>t)).toPromise(),this.setOptions({enable_booking:!1!==this._settings.get("app.desks.enabled")}),this.subscription("spaces",this._state.level.subscribe(t=>{this.clearBindings(),this._level=t,this.bindToDesks()})),this.subscription("changes",Object(v.a)([this.desk_list,this._in_use,this._reserved,this._options]).subscribe(([t,e,s])=>{this._statuses={};for(const{id:n,bookable:i}of t){const t=e.some(t=>n===t),o=s.some(t=>n===t);this._statuses[n]=i?t?o?"reserved":"busy":"free":"not-bookable"}this.processDesks(t),this.timeout("update",()=>this.updateStatus(),100)})),this.subscription("desks",this.desk_list.subscribe(t=>this.processDesks(t))),this.subscription("desks_in_use_bookings",this._desk_bookings.subscribe(t=>this._in_use.next(t.map(t=>t.asset_id))))})}ngOnDestroy(){super.ngOnDestroy(),this.clearBindings()}startPolling(t=3e4){this.interval("poll",()=>this._poll.next((new Date).valueOf()),t)}stopPolling(){this.clearInterval("poll")}setOptions(t){this._options.next(Object.assign(Object.assign({},this._options.getValue()),t))}clearBindings(){const t=["desks_in_use","desk_list"];for(const e of t)this.unsub(e);this._bindings.forEach(t=>t.unbind()),this._bindings=[],this._statuses={}}bindToDesks(){if(!this._level)return;if(!this._org.buildings.find(t=>t.id===this._level.parent_id))return;const t=this._org.building.bindings.area_management||this._org.organisation.bindings.area_management;if(!t)return void this.startPolling();let e=Object(f.e)(t,"AreaManagement").binding(this._level.id);this.subscription("desks_in_use",e.listen().subscribe(e=>{const s=((null==e?void 0:e.value)||[]).filter(t=>"desk"!==t.location),n=((null==e?void 0:e.value)||[]).filter(t=>"desk"===t.location||"booking"===t.location&&"desk"===t.type);this._in_use.next(n.map(t=>t.map_id)),this._reserved.next(n.filter(t=>!t.at_location).map(t=>t.map_id)),this.processDevices(s,t)})),e.bind(),this._bindings.push(e),e=Object(f.e)(t,"AreaManagement").binding(`${this._level.id}:desk_ids`),this.subscription("desks_list",e.listen().subscribe(t=>this._desks.next(t||[]))),e.bind(),this._bindings.push(e)}updateStatus(){const t={},e=this._settings.get("app.explore.colors")||{};for(const s in this._statuses)this._statuses[s]&&(t[`#${s}`]={fill:e[`desk-${this._statuses[s]}`]||e[`${this._statuses[s]}`]||m[`${this._statuses[s]}`],opacity:.6});this._state.setStyles("desks",t)}processDevices(t,e){var s,n;const i=[];for(const o of t){const t=o.x/o.map_width,a=o.y/o.map_height;i.push({location:{x:(null===(s=o.coordinates_from)||void 0===s?void 0:s.includes("right"))?1-t:t,y:(null===(n=o.coordinates_from)||void 0===n?void 0:n.includes("bottom"))?1-a:a},content:F,data:Object.assign(Object.assign({},o),{system:e})})}i.sort((t,e)=>1-Math.sqrt(Math.pow(t.x-.5,2)+Math.pow(t.x-.5,2))-(1-Math.sqrt(Math.pow(e.x-.5,2)+Math.pow(e.x-.5,2)))),this._state.setFeatures("devices",i)}processDesks(t){const e=[],s=[],n=this._options.getValue();for(const i of t)e.push({location:i.id,content:D,hover:!0,data:{map_id:i.name,status:this._statuses[i.map_id]}}),s.push({id:i.id,action:"click",callback:()=>this._desks_service.bookDesk({desks:[i],host:n.host,date:n.date})}),s.push({id:i.id,action:"touchend",callback:()=>this._desks_service.bookDesk({desks:[i],host:n.host,date:n.date})});this._state.setActions("desks",this._options.getValue().enable_booking?s:[]),this._state.setFeatures("desks",e)}}return t.\u0275fac=function(e){return new(e||t)(u.ec(p.a),u.ec(_.c),u.ec(b.e),u.ec(O.b))},t.\u0275prov=u.Nb({token:t,factory:t.\u0275fac}),t})();s("EE6m"),s("OuDT"),s("j4gA"),s("LRne"),s("Kj3r"),s("UXun"),s("vrAh");let N=(()=>{class t{}return t.\u0275fac=function(e){return new(e||t)},t.\u0275mod=u.Pb({type:t}),t.\u0275inj=u.Ob({imports:[[n.c,o.b,i.h,i.p,a.b,c.f,r.f,l.a]]}),t})()}}]);
//# sourceMappingURL=default~desks-desks-module~facilities-facilities-module.js.map