"use strict";(self.webpackChunkconcierge=self.webpackChunkconcierge||[]).push([[592],{9519:(z,A,e)=>{e.d(A,{H:()=>c});var v=e(5861),M=e(8186),P=e(591),C=e(13),l=e(7545),h=e(4850),D=e(7221),y=e(5154),E=e(8115),I=e(2722),p=e(9925),g=e(5375),r=e(9112),B=e(6221),U=e(6168),k=e(4650),F=e(5938);class c extends r.cx{get new_desk_count(){return this._new_desks.getValue()?.length||0}constructor(s,d){super(),this._org=s,this._dialog=d,this._filters=new P.X({}),this._new_desks=new P.X([]),this._desk_bookings=[],this._desks=[],this._loading=new P.X(!1),this.new_desks=this._new_desks.asObservable(),this.loading=this._loading.asObservable(),this.filters=this._filters.asObservable(),this.desks=this._filters.pipe((0,C.b)(500),(0,l.w)(n=>{const i=n.zones||[];return i.includes("All")?(0,M.BW_)(this._org.building?.id,{name:"desks"}).pipe((0,h.U)(o=>o.map(t=>t.metadata.desks.details).reduce((t,m)=>[...t,...m],[]))):(0,M.rlq)(i[0],"desks").pipe((0,h.U)(o=>o.details))}),(0,D.K)(n=>[]),(0,h.U)(n=>(n instanceof Array||(n=[]),n.sort((i,o)=>i.name.localeCompare(o.name)),this._desks=n.map(i=>new B.nk({...i,qr_code:""})),this._desks)),(0,y.d)(1)),this.bookings=this._filters.pipe((0,C.b)(500),(0,l.w)(n=>{this._loading.next(!0);const i=n.date?new Date(n.date):new Date;let o=(n.zones||[]).filter(t=>-1!==t&&"-1"!==t&&"All"!==t);return o?.length||(o=this._org.levelsForBuilding(this._org.building).map(t=>t.id)),(0,g.F2)({period_start:Math.floor((0,E.Z)(i).valueOf()/1e3),period_end:Math.floor((0,I.Z)(i).valueOf()/1e3),type:"desk",zones:(o||[]).join(","),include_checked_out:!0})}),(0,h.U)(n=>(n.sort((i,o)=>i.date-o.date),this._desk_bookings=n.map(i=>new g.$N({...i,extension_data:{...i.extension_data,checkin_qr_code:(0,U.w)(`/workplace/#/book/code?asset_id=${encodeURIComponent(i.asset_id)}`)}})),this._loading.next(!1),n)),(0,y.d)(1))}setFilters(s){s.zones?.includes("All")?s.zones=["All",...this._org.levelsForBuilding(this._org.building).map(d=>d.id)]:s.zones&&this._filters.getValue()?.zones?.includes("All")&&(s.zones=[]),this._filters.next({...this._filters.getValue(),...s})}startPolling(s=3e4){this.interval("poll",()=>this.setFilters(this._filters.getValue()),s)}stopPolling(){this.clearInterval("poll")}addDesks(s){this._new_desks.next(this._new_desks.getValue().concat(s))}clearNewDesks(){this._new_desks.next([])}checkinDesk(s){return(0,v.Z)(function*(){"failed"===(yield(0,g.FD)(s.id,!0).toPromise().catch(n=>"failed"))?(0,r.cB)("Error checking in desk booking"):(0,r.t5)(`Checked in ${s.user_name}.`)})()}approveDesk(s){return(0,v.Z)(function*(){"failed"===(yield(0,g.jT)(s.id).toPromise().catch(n=>"failed"))?(0,r.cB)("Error approving in desk booking"):(0,r.t5)(`Approved desk booking for ${s.user_name} on ${(0,p.Z)(s.date,"MMM do")}.`)})()}rejectDesk(s){return(0,v.Z)(function*(){"failed"===(yield(0,g.FP)(s.id).toPromise().catch(n=>"failed"))?(0,r.cB)("Error rejecting in desk booking"):(0,r.t5)(`Rejected desk booking for ${s.user_name} on ${(0,p.Z)(s.date,"MMM do")}.`)})()}giveAccess(s){var d=this;return(0,v.Z)(function*(){const n=yield(0,g.km)(new g.$N({...s,access:!0})).toPromise().catch(i=>"failed");if("failed"===n)return(0,r.cB)("Error giving building access booking host");(0,r.t5)(`Successfully gave building access to ${s.user_name} for desk booking.`),d._desk_bookings=[...d._desk_bookings,n]})()}rejectAllDesks(){var s=this;return(0,v.Z)(function*(){const d=s._desk_bookings||[];if(d.length<=0)return(0,r.QD)("No desks to reject for the selected date");const n=yield(0,r._5)({title:"Cancel all desk bookings",content:"Are you sure you want to cancel all bookings for the selected date?",icon:{type:"icon",class:"material-icons",content:"delete"}},s._dialog);"done"!==n.reason&&(n.loading("Rejecting all desks for selected date..."),yield Promise.all(d.map(i=>(0,g.FP)(i.id).toPromise())),(0,r.t5)("Successfully rejected all desk bookings for selected date."),n.close())})()}}c.\u0275fac=function(s){return new(s||c)(k.LFG(B.w7),k.LFG(F.uw))},c.\u0275prov=k.Yz7({token:c,factory:c.\u0275fac,providedIn:"root"})},5375:(z,A,e)=>{e.d(A,{$N:()=>P.$,fy:()=>M.f,EP:()=>v.E,jT:()=>l.jT,FD:()=>l.FD,ad:()=>l.ad,F2:()=>l.F2,FP:()=>l.FP,km:()=>l.km,Fo:()=>l.Fo,Wp:()=>l.Wp});var v=e(8665),M=e(2084),P=e(6962),l=(e(1980),e(354)),h=e(5861),D=e(9112),y=e(6221),E=e(9972),I=e(8115),p=e(2722),g=e(7224),r=e(4850),B=e(6165),U=e(4282),k=e(4650),F=e(5938);class c{constructor(o,t){this._org=o,this._dialog=t,this.can_set_date=!0,this.error_on_host=!0}bookDesk({desks:o,host:t,reason:m,attendees:L,date:_}){var f=this;return(0,h.Z)(function*(){if(f.error_on_host&&!t)return(0,D.cB)("You need to select a host to book a desk.");t=t||(0,D.ar)(),m=m||"";const T=f._org.levelWithID(o[0].zone instanceof Array?o[0].zone:[o[0].zone?.id]);let a=f._dialog.open(U.I),O=yield Promise.race([a.componentInstance.event.pipe((0,g.P)(u=>"done"===u.reason)).toPromise(),a.afterClosed().pipe((0,r.U)(u=>null)).toPromise()]);if(!O||(a.close(),a=f._dialog.open(B.X,{data:{host:t,desks:o,date:_?new Date(_):new Date,reason:m,level:T,can_set_date:f.can_set_date}}),O=yield Promise.race([a.componentInstance.event.pipe((0,g.P)(u=>"done"===u.reason)).toPromise(),a.afterClosed().pipe((0,r.U)(u=>null)).toPromise()]),!O))return;if(_=a.componentInstance.date||_,m=a.componentInstance.reason||m,!(t=a.componentInstance.host||t))return a.close(),(0,D.cB)("You need to select a host to book a desk. ");if(a.componentInstance.loading="Checking for existing desk bookings...",(yield(0,l.F2)({type:"desk",period_start:(0,E.Z)((0,I.Z)(_||new Date)),period_end:(0,E.Z)((0,p.Z)(_||new Date))}).toPromise()).filter(u=>u.user_email.toLowerCase()===t.email.toLowerCase())?.length)return a.close(),(0,D.cB)("You currently already have a desk booked for the selected date.");a.componentInstance.loading="Booking desk...";const R=[t,...L||[]];return yield Promise.all([o.map((u,j)=>f.makeDeskBooking(u,t,_.valueOf()||(new Date).valueOf(),m,R[j]))]),(0,D.t5)("Successfully booked desk"),a.close(),!0})()}makeDeskBooking(o,t,m,L,_=null){var f=this;return(0,h.Z)(function*(){const T=`${o.zone?.name}-${o.id}`,a=f._org.levelWithID(o.zone instanceof Array?o.zone:[o.zone?.id]),O=o.zone?.id?[o.zone?.id,a?.parent_id]:[a?.parent_id],b={booking_start:(0,E.Z)((0,I.Z)(m)),user_id:_?.id||t.id,user_name:_?.name||t.name,user_email:_?.email||t.email,booking_end:Math.floor((0,p.Z)(m).valueOf()/1e3),asset_id:o.id,asset_name:o.name,title:L,description:T,zones:O,booking_type:"desk",extension_data:{map_id:o?.map_id||o?.id,groups:o.groups,for_user:_?.email}};return(0,l.km)(b).toPromise()})()}}c.\u0275fac=function(o){return new(o||c)(k.LFG(y.w7),k.LFG(F.uw))},c.\u0275prov=k.Yz7({token:c,factory:c.\u0275fac,providedIn:"root"}),e(7121),e(8883),e(4088),e(7304)}}]);