"use strict";(self.webpackChunkworkplace=self.webpackChunkworkplace||[]).push([[592],{6205:(X,R,t)=>{t.d(R,{I:()=>O});var y=t(5861),M=t(8466),P=t(5307),L=t(6975),T=t(3121),A=t(7049),B=t(618),Z=t(3166),l=t(3740),x=t(9189),C=t(8372),I=t(5125),r=t(2994),v=t(9193),K=t(6776),h=t(7927),j=t(7734),d=t(958),o=t(5222),g=t(2068),p=t(6124),E=t(2413),f=t(9185),D=t(7691);let O=(()=>{class a extends P.cx{constructor(n,u,b){var W;super(),W=this,this._settings=n,this._org=u,this._lockers=b,this._poll=new I.X(0),this._poll_type=new I.X("api"),this._loading=new I.X(!1),this._filters=new I.X({shown_types:["event","desk","parking","visitor","locker"]}),this._date=new I.X(Date.now()),this._update=(0,r.aj)([this._date,this._poll]).pipe((0,K.b)(500),(0,h.b)(s=>this._loading.next(!0))),this._deleted=[],this._space_bookings=this._org.active_building.pipe((0,j.h)(s=>!!s),(0,d.g)("id"),(0,K.b)(300),(0,h.b)(s=>this.unsubWith("bind:")),(0,o.w)(({id:s})=>(this._loading.next(!0),(0,A.u2)(s))),(0,g.x)(([s],[i])=>s!==i),(0,o.w)(s=>(this._loading.next(!1),(0,r.aj)((s||[]).map(i=>{const e=(0,B.rTZ)(i.id,"Bookings").binding("bookings"),_=e.listen().pipe((0,p.U)(U=>(U||[]).map(F=>new L.ym({...F,resources:F.attendees.filter(m=>m.email===i.email||m.resource),system:i}))),(0,E.K)(U=>(0,v.of)([])));return this.hasSubscription(`bind:${i.id}`)||this.subscription(`bind:${i.id}`,e.bind()),_})))),(0,p.U)(s=>(0,P.xH)(s)),(0,f.d)(1)),this.ws_events=(0,r.aj)([this._space_bookings,this._update]).pipe((0,p.U)(([s,[i]])=>{const e=(0,P.ar)();return s.filter(_=>(0,Z.Z)(_.date,i)&&(_.host.toLowerCase()===e.email.toLowerCase()||_.attendees.find(U=>U.email.toLowerCase()===e.email.toLowerCase())))})),this.api_events=this._update.pipe((0,o.w)(([s])=>{const i={period_start:(0,l.Z)((0,x.Z)(s)),period_end:(0,l.Z)((0,C.Z)(s))};return this._settings.get("app.events.use_bookings")?(0,M.F2)({...i,type:"room"}).pipe((0,p.U)(e=>e.map(_=>(0,L.Yd)(_))),(0,E.K)(e=>(0,v.of)([]))):(0,L.u$)({...i}).pipe((0,E.K)(e=>(0,v.of)([])))}),(0,f.d)(1)),this.events=(0,r.aj)([this._poll_type]).pipe((0,o.w)(([s])=>"api"===s?this.api_events:this.ws_events),(0,h.b)(()=>this.timeout("end_loading",()=>this._loading.next(!1))),(0,f.d)(1)),this.visitors=this._update.pipe((0,o.w)(([s])=>(0,M.F2)({period_start:(0,l.Z)((0,x.Z)(s)),period_end:(0,l.Z)((0,C.Z)(s)),type:"visitor"}).pipe((0,E.K)(i=>(0,v.of)([])))),(0,p.U)(s=>s.filter(i=>!i.parent_id&&!i.linked_event)),(0,h.b)(()=>this.timeout("end_loading",()=>this._loading.next(!1))),(0,f.d)(1)),this.desks=this._update.pipe((0,o.w)(([s])=>(0,M.F2)({period_start:(0,l.Z)((0,x.Z)(s)),period_end:(0,l.Z)((0,C.Z)(s)),include_checked_out:!0,type:"desk"}).pipe((0,E.K)(i=>(0,v.of)([])))),(0,h.b)(()=>this.timeout("end_loading",()=>this._loading.next(!1))),(0,f.d)(1)),this.parking=this._update.pipe((0,o.w)(([s])=>(0,M.F2)({period_start:(0,l.Z)((0,x.Z)(s)),period_end:(0,l.Z)((0,C.Z)(s)),type:"parking"}).pipe((0,E.K)(i=>(0,v.of)([])))),(0,h.b)(()=>this.timeout("end_loading",()=>this._loading.next(!1))),(0,f.d)(1)),this.lockers=(0,r.aj)([this._org.active_building.pipe((0,j.h)(s=>!!s),(0,d.g)("id")),this._lockers.lockers$]).pipe((0,K.b)(300),(0,o.w)(function(){var s=(0,y.Z)(function*([i,e]){const _=W._org.binding("lockers");return _?[yield(0,B.rTZ)(_,"LockerLocations").execute("lockers_allocated_to_me").catch(m=>[]),e]:[[],e]});return function(i){return s.apply(this,arguments)}}()),(0,p.U)(([s,i])=>s.map(e=>{const _=i.find(U=>U.id===e.locker_id);return _||e.level&&e.building?(e.level=e.level||_?.level_id,e.building=e.building||this._org.levelWithID([_?.level_id])?.parent_id,new M.$N({date:(0,x.Z)(Date.now()).valueOf(),duration:1439,title:"Locker Booking",description:e.locker_name,booking_type:"locker",all_day:!0,asset_id:_.map_id,asset_name:e.locker_name,zones:[e.building,e.level],extension_data:{map_id:e.locker_id}})):null}).filter(e=>e)),(0,E.K)(s=>(console.error(s),(0,v.of)([]))),(0,h.b)(()=>this.timeout("end_loading",()=>this._loading.next(!1))),(0,f.d)(1)),this.bookings=(0,r.aj)([this.events,this.visitors,this.desks,this.parking,this.lockers]).pipe((0,p.U)(([s,i,e,_,U])=>{const F=e.filter(m=>!s.find(S=>`${S.meeting_id}`==`${m.id}`));return[...s,...i,...F,..._,...U].sort((m,S)=>m.date-S.date)})),this.filtered_bookings=(0,r.aj)([this.bookings,this._filters]).pipe((0,p.U)(([s,i])=>s.filter(e=>!this._deleted.includes(e.id)&&e instanceof L.ym&&i?.shown_types?.includes("event")||i?.shown_types?.includes(e.booking_type)))),this.filters=this._filters.asObservable(),this.date=this._date.asObservable(),this.loading=this._loading.asObservable(),this.subscription("poll_type",this._org.active_building.subscribe(()=>this._poll_type.next(this._settings.get("app.schedule.use_websocket")?"ws":"api"))),this.subscription("chat_event",this._settings.listen("CHAT:task_complete").subscribe(()=>this.triggerPoll())),this._deleted=JSON.parse(sessionStorage.getItem("PLACEOS.events.deleted")||"[]")}triggerPoll(){this._poll.next(Date.now())}startPolling(n=6e4){return this.interval("poll",()=>this._poll.next(Date.now()),n),()=>this.stopPolling()}stopPolling(){this.clearInterval("poll")}setDate(n){this._date.next(n)}removeItem(n){this.setAsDeleted(n.id),this._poll.next(Date.now())}setAsDeleted(n){this._deleted.push(n),sessionStorage.setItem("PLACEOS.events.deleted",JSON.stringify(this._deleted))}toggleType(n,u=!1){var b=this;return(0,y.Z)(function*(){const W=b._filters.getValue()||{shown_types:[]},{shown_types:s}=W;s&&(s.includes(n)||u)?b._filters.next({...W,shown_types:s.filter(i=>i!==n)}):b._filters.next({...W,shown_types:[...s,n]})})()}static#t=this.\u0275fac=function(u){return new(u||a)(D.LFG(P.gb),D.LFG(T.w7),D.LFG(M.At))};static#s=this.\u0275prov=D.Yz7({token:a,factory:a.\u0275fac,providedIn:"root"})}return a})()},6386:(X,R,t)=>{t.d(R,{I:()=>p});var y=t(8466),M=t(8691),P=t(5307),L=t(6975),T=t(3740),A=t(9189),B=t(8584),Z=t(8372),l=t(5125),x=t(1928),C=t(2994),I=t(7504),r=t(5222),v=t(9185),K=t(6776),h=t(6743),j=t(6124),d=t(2413),o=t(7927),g=t(7691);let p=(()=>{class E extends P.cx{constructor(D){super(),this._settings=D,this._poll=new l.X(0),this._options=new l.X({start:Date.now()}),this._loading=new l.X(""),this._schedule=new l.X([]),this.options=this._options.asObservable(),this.loading=this._loading.asObservable(),this.schedule=this._loading.asObservable(),this.calendars=(0,x.H)(1e3).pipe((0,r.w)(O=>(0,M.yJ)()),(0,v.d)(1)),this.events=(0,C.aj)([this._options,this._poll]).pipe((0,K.b)(1e3),(0,h.zg)(([O])=>{this._loading.next("Loading schedule...");const a={period_start:(0,T.Z)((0,A.Z)(O.start)),period_end:(0,T.Z)((0,B.Z)((0,Z.Z)(O.start),6))};return O.calendar&&(a.calendar=O.calendar),this._schedule.next(this._schedule.getValue().filter(c=>!(0,P.MZ)(1e3*a.period_start,1e3*a.period_end,c.date,c.date+60*c.duration*1e3))),(0,I.D)([!0===this._settings.get("app.events.use_bookings")?(0,y.F2)({...a,type:"room"}).pipe((0,j.U)(c=>c.map(n=>(0,L.Yd)(n)))):(0,L.u$)({...a}),(0,y.F2)({...a,type:"desk"}),(0,y.F2)({...a,type:"parking"})]).pipe((0,d.K)(c=>[]))}),(0,j.U)(([O,a])=>{const c=[...this._schedule.getValue(),...O,...a.filter(n=>"declined"!==n.status)].sort((n,u)=>n.date-u.date);return this._schedule.next((0,P.Tw)(c,"id")),c}),(0,d.K)(O=>[]),(0,o.b)(O=>this._loading.next("")),(0,v.d)(1))}startPolling(D=15e3){this.interval("poll",()=>this._poll.next(Date.now()),D)}stopPolling(){this.clearInterval("poll")}setOptions(D){this._options.next({...this._options.getValue(),...D})}static#t=this.\u0275fac=function(O){return new(O||E)(g.LFG(P.gb))};static#s=this.\u0275prov=g.Yz7({token:E,factory:E.\u0275fac,providedIn:"root"})}return E})()},8691:(X,R,t)=>{t.d(R,{ot:()=>K,yJ:()=>r.yJ});var y=t(5861),M=t(5125),P=t(7927),L=t(9185),T=t(8419),A=t(3740),B=t(9189),Z=t(8372),l=t(5091),x=t(6474),C=t(4411),I=t(4955),r=t(6511),v=t(7691);let K=(()=>{class h extends x.c{constructor(d,o){super(),this._org=d,this._settings=o,this._calendars=new M.X([]),this.calendar_list=(0,r.yJ)().pipe((0,P.b)(g=>this._calendars.next(g)),(0,L.d)(1)),this.query=()=>(0,r.yJ)(),this.freeBusy=g=>(0,r.tS)(g,this._org),this.availability=g=>(0,r.v7)(g),this._org.initialised.pipe((0,T.P)(g=>g)).subscribe(()=>this.init())}init(){var d=this;return(0,y.Z)(function*(){d._settings.get("app.events.use_bookings")||d._initialised.next(!0)})()}get calendars(){return this._calendars.getValue()}getFreeBusyDate(d,o){return(0,r.tS)({period_start:(0,A.Z)((0,B.Z)(d)),period_end:(0,A.Z)((0,Z.Z)(d)),calendars:o},this._org)}checkSpacesAvailability(d,o,g,p){return(0,y.Z)(function*(){const E=yield(0,r.v7)({period_start:o,period_end:g,system_ids:d.join(",")}).toPromise(),f=new Date(p?.date).valueOf(),D=(0,l.Z)(f,p?.duration).valueOf();return!!E.every(a=>{const c=a.availability;if(p&&a.id===p.system?.email){const n=c.findIndex(u=>u.date>=f&&(0,l.Z)(u.date,u.duration).valueOf()<=D);-1!==n&&c.splice(n,1)}return!c.length})})()}static#t=this.\u0275fac=function(o){return new(o||h)(v.LFG(I.w),v.LFG(C.g))};static#s=this.\u0275prov=v.Yz7({token:h,factory:h.\u0275fac,providedIn:"root"})}return h})()}}]);