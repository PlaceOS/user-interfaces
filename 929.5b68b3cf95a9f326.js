"use strict";(self.webpackChunkconcierge=self.webpackChunkconcierge||[]).push([[929],{2084:($,U,o)=>{o.d(U,{f:()=>v});var _=o(9671),T=o(3007),S=o(3770),b=o(4351),t=o(9972),L=o(9756),D=o(9925),F=o(3337),h=o(591),f=o(1086),O=o(3426),r=o(5154),g=o(13),M=o(9184),C=o(7545),N=o(2994),I=o(4850),W=o(2198),k=o(7224),x=o(2986),G=o(565),B=o(6962),y=o(1980),K=o(354),Z=o(4282),w=o(8871),V=o(4367),A=o(4650),Q=o(5559);const Y=["book/desks","book/parking","book/newdesk","book/new-parking"];class v extends S.KG{constructor(e,s,a,i,d){super(),this._router=e,this._settings=s,this._org=a,this._dialog=i,this._payments=d,this._view=new h.X("form"),this._options=new h.X({type:"desk"}),this._form=new h.X((0,y.PR)()),this._booking=new h.X(null),this._loading=new h.X(""),this.last_success=new B.$(JSON.parse(sessionStorage.getItem("PLACEOS.last_booked_booking")||"{}")),this.loading=this._loading.asObservable(),this.options=this._options.pipe((0,r.d)(1)),this.assets=this.options.pipe((0,g.b)(300),(0,M.g)("type"),(0,C.w)(({type:n})=>{if(!this._org.building)return(0,f.of)([]);switch(n){case"desk":return this._loading.next("Loading desks..."),this.loadAssets("desks");case"parking":return this._loading.next("Loading parking spaces..."),this.loadAssets("parking_spaces")}return(0,f.of)([])}),(0,N.b)(()=>this._loading.next("")),(0,r.d)(1)),this.features=this.assets.pipe((0,I.U)(n=>{const l=[];for(const{features:u}of n)u instanceof Array&&u.forEach(E=>l.push(E));return(0,S.Tw)(l).sort((u,E)=>u.localeCompare(E))}),(0,r.d)(1)),this.available_assets=(0,O.aj)([this.options,this.assets,this._form]).pipe((0,W.h)(([n,l,u])=>u.getRawValue().date>0&&u.getRawValue().duration>0),(0,g.b)(500),(0,N.b)(([{type:n}])=>this._loading.next(`Checking ${n} availability...`)),(0,C.w)(([n,l,u])=>(0,K.F2)({period_start:(0,t.Z)(u.getRawValue().date),period_end:(0,t.Z)((0,L.Z)(u.getRawValue().date,u.getRawValue().duration||1440)),type:n.type,zones:n.zone_id}).pipe((0,I.U)(E=>l.filter(c=>!1!==c.bookable&&(!n.features||n.features?.every(p=>c.features.includes(p)))&&(!n.zone_id||n.zone_id===c.zone?.id||n.zone_id===c.zone?.parent_id)&&!E.find(p=>p.asset_id===c.id&&"declined"!==p.status))))),(0,N.b)(()=>this._loading.next("")),(0,r.d)(1)),this.grouped_availability=(0,O.aj)([this.options,this.available_assets]).pipe((0,I.U)(([n,l])=>{const u=[],E=[...l].sort((p,m)=>p.zone?.id?.localeCompare(m.zone?.id)),c=n.members?.length?n.members:[(0,S.ar)()];for(;E.length;){const p=[];let m=E.pop();for(;p.length<c.length&&(!p.length||p.find(P=>P.zone?.id===m.zone?.id));)p.push(m),m=E.pop();p.length<c.length||u.push(p)}return u})),this.subscription("router.bookings",this._router.events.subscribe(n=>{n instanceof T.m2&&!Y.find(l=>n.url.includes(l))&&this.clearForm()})),this._org.initialised.pipe((0,k.P)(n=>n)).subscribe(()=>this.setOptions({}))}get view(){return this._view.getValue()}get form(){return this._form.getValue()}get booking(){return this._booking.getValue()}newForm(e=new B.$){this._form.next((0,y.PR)(e)),this.subscription("form_change",this._form.getValue().valueChanges.subscribe(()=>this.storeForm())),this._booking.next(e),this._options.next({type:this._options.getValue().type})}setView(e){this._view.next(e)}setOptions(e){this._options.next({...this._options.getValue(),...e})}setFeature(e,s){if(!e?.length)return;const a=this._options.getValue()?.features||[];s&&!a.includes(e)&&a.push(e),!s&&a.includes(e)&&a.splice(a.findIndex(i=>i===e),1),this.setOptions({features:a})}resetForm(){this._form.getValue()||this.newForm();const e=this._booking.getValue();this._form.getValue().patchValue({...e||{},...e?.extension_data||{}}),this._options.next({type:this._options.getValue().type})}clearForm(){sessionStorage.removeItem("PLACEOS.booking_form"),sessionStorage.removeItem("PLACEOS.booking_form_options"),this.newForm()}storeForm(){sessionStorage.setItem("PLACEOS.booking_form",JSON.stringify(this._form.getValue()?.getRawValue()||{})),sessionStorage.setItem("PLACEOS.booking_form_filters",JSON.stringify(this._options.getValue()||{}))}loadForm(){this._form.getValue()||this.newForm(),this._form.getValue().patchValue({...JSON.parse(sessionStorage.getItem("PLACEOS.booking_form")||"{}")}),this.setOptions({zone_id:this._org.building?.id,...JSON.parse(sessionStorage.getItem("PLACEOS.booking_form_filters")||"{}")})}openBookingLinkModal(e=!1){const s=this._form.getValue();if(s.markAllAsTouched(),!s.valid&&!e)return;const a=new B.$({...this.booking,...s.getRawValue()});this._dialog.open(V.w,{data:a})}confirmPost(){var e=this;return(0,_.Z)(function*(){yield e.checkQuestions();const s=e._options.getValue(),i=e._form.getValue().getRawValue();let d=`Would you like to book the ${s.type} ${i.asset_name} for ${(0,D.Z)(i.date,"dd MMM yyyy")}${i.duration<720?" at "+(0,D.Z)(i.date,"h:mm a"):""}`;s.group&&(d=`${d}.<br>You group members will be assigned desks nearby your selected desk.`);const n=yield(0,S._5)({title:`Book ${s.type}`,content:d,icon:{content:"event_available"}},e._dialog);if("done"!==n?.reason)throw"User cancelled";n.loading("Performing booking request..."),s.group?yield e.postFormForGroup().catch(l=>{throw(0,S.cB)(l),n.close(),l}):yield e.postForm().catch(l=>{throw(0,S.cB)(l),n.close(),l}),n.close()})()}postForm(e=!1){var s=this;return(0,_.Z)(function*(){const a=s._form.getValue();if(!a)throw"No form for booking";if(!a.valid)throw`Some form fields are invalid. [${(0,S.RD)(a).join(", ")}]`;a.patchValue({booking_type:a.getRawValue().booking_type||s._options.getValue().type});const i=a.getRawValue();if(e||(yield s.checkResourceAvailable(i,s._options.getValue().type)),(i.duration>=720||i.all_day)&&a.patchValue({date:(0,F.Z)(i.date,{hours:11,minutes:59}).valueOf(),duration:720}),s._payments.payment_module){const l=yield s._payments.makePayment({type:s._options.getValue().type,resource_name:i.asset_name,date:i.date,duration:i.duration,all_day:i.all_day});if(!l?.success)return;i.extension_data={invoice:l,invoice_id:l.invoice_id}}s._loading.next("Saving booking");const d=yield(0,K.km)(new B.$({...s._options.getValue(),...i,approved:!!s._settings.get("app.bookings.no_approval")})).toPromise();s._loading.next("");const{booking_type:n}=i;return s.clearForm(),a?.patchValue({booking_type:n}),s.last_success=d,sessionStorage.setItem("PLACEOS.last_booked_booking",JSON.stringify(d)),s.setView("success"),d})()}postFormForGroup(){var e=this;return(0,_.Z)(function*(){const{members:s,group:a,type:i}=e._options.getValue();if(!a)throw"No group available to book for";const d=s.filter(m=>m.email!==(0,S.ar)().email);if(d.length<=0)throw"No members in your group to book for.";const n=e._form.getValue().value,l=yield e.available_assets.pipe((0,x.q)(1)).toPromise(),u=l.find(m=>m.id===n.asset_id||m.map_id===n.asset_id),E=e._org.levelWithID([u.zone?.id]),c=[u,...yield e._getNearbyResources(E.map_id,n.asset_id,l,d.length)],p=[(0,S.ar)(),...d];yield Promise.all(p.map((m,P)=>e.checkResourceAvailable({...n,asset_id:c[P].map_id||c[P].id,user_email:m.email},i)));for(let m=0;m<p.length;m++){const P=p[m],R=c[m];e._form.getValue().patchValue({...n,user:P,asset_id:R?.id,asset_name:R.name,map_id:R?.map_id||R?.id,description:R.name,zones:R.zone?[R.zone?.parent_id,R.zone?.id]:[]}),e.postForm(!0)}})()}checkQuestions(){var e=this;return(0,_.Z)(function*(){if(!1!==e._settings.get("app.desks.ignore_questions"))return;const s=e._dialog.open(Z.I);if("done"!==(yield Promise.race([s.componentInstance.event.pipe((0,k.P)(d=>"done"===d.reason)).toPromise(),s.afterClosed().toPromise()]))?.reason)throw"User cancelled";const i=s.componentInstance.form.getRawValue();for(const d in i)if(i[d])throw"User failed questionaire";s.close()})()}checkResourceAvailable({asset_id:e,date:s,duration:a,user_email:i,all_day:d},n){var l=this;return(0,_.Z)(function*(){a=d?720:a||60;const u=yield(0,K.F2)({period_start:(0,t.Z)(s),period_end:(0,t.Z)(s+60*a*1e3),type:n}).toPromise();if(u.find(c=>c.asset_id===e))throw e.includes("@")?`${e} already has an invite for the selected time`:`${e} is not available at the selected time`;const E=l._settings.get(`app.booking.allowed_daily_${n}_count`)??1;if(E>0&&u.filter(c=>c.user_email===(i||(0,S.ar)()?.email)&&"declined"!==c.status).length>=E){const c=i===(0,S.ar)()?.email;throw`${c?"You":i} already ${c?"have":"has"} a ${n} booked`}return!0})()}loadAssets(e){return(0,b.BW_)(this._org.building.id,{name:e}).pipe((0,I.U)(s=>(0,S.xH)(s.map(a=>(a.metadata[e]?.details instanceof Array?a.metadata[e]?.details:[]).map(i=>({...i,zone:a.zone}))))))}_getNearbyResources(e,s,a,i){return(0,_.Z)(function*(){const d=[];let n=a.filter(l=>l.id!==s&&l.map_id!==s);for(let l=0;l<i;l++){const u=yield(0,y.gV)(e,s,n.map(E=>E.map_id||E.id));u&&(d.push(a.find(E=>E.id===u||E.map_id===u)),n=n.filter(E=>E.id!==u&&E.map_id!==u))}return d})()}}v.\u0275fac=function(e){return new(e||v)(A.LFG(T.F0),A.LFG(S.gb),A.LFG(G.w),A.LFG(Q.on),A.LFG(w.c))},v.\u0275prov=A.Yz7({token:v,factory:v.\u0275fac,providedIn:"root"})},4367:($,U,o)=>{o.d(U,{w:()=>f});var _=o(5559),T=o(719),S=o(9497),t=(o(6962),o(4650)),L=o(9818),D=o(5306),F=o(158),h=o(7202);class f{constructor(r,g){this._event=r,this._settings=g,this.outlook_link=(0,S.Y$)(this._event),this.google_link=(0,S.T$)(this._event),this.ical_link=(0,S.KS)(this._event)}}f.\u0275fac=function(r){return new(r||f)(t.Y36(_.eJ),t.Y36(T.g))},f.\u0275cmp=t.Xpm({type:f,selectors:[["booking-link-modal"]],decls:22,vars:12,consts:function(){let O,r,g;return O=$localize`:␟34c16b14ad0e33db574c8bea543e66e766aa3a01␟4015832758698516701:Create in Outlook`,r=$localize`:␟f745484670e6b6bbb8a1c327c222e665fb25b863␟3788591245559456526:Create in Google Calendar`,g=$localize`:␟1af54061e7f4bcfb1048ffaa05c9b8f7c4b41679␟4894641609416495396:Download iCal File`,[[1,"p-4","w-full","pb-2"],[1,"flex","flex-col","items-center","space-y-4","p-4","relative"],["button","","matRipple","","target","_blank","rel","noopener noreferer",1,"flex","items-center","p-2","space-x-2","pr-4","w-64","rounded","inverse",3,"href"],["src","assets/icons/outlook.svg",1,"w-6"],O,["src","assets/icons/gcal.svg",1,"w-6"],r,[1,"text-xl"],g,["mat-icon-button","","mat-dialog-close","",1,"absolute","top-2","right-0"]]},template:function(r,g){1&r&&(t.TgZ(0,"div",0),t._uU(1," Add event to your calendar "),t.qZA(),t.TgZ(2,"div",1)(3,"a",2),t.ALo(4,"sanitize"),t._UZ(5,"img",3),t.TgZ(6,"span"),t.SDv(7,4),t.qZA()(),t.TgZ(8,"a",2),t.ALo(9,"sanitize"),t._UZ(10,"img",5),t.TgZ(11,"span"),t.SDv(12,6),t.qZA()(),t.TgZ(13,"a",2),t.ALo(14,"safe"),t.TgZ(15,"app-icon",7),t._uU(16,"download"),t.qZA(),t.TgZ(17,"span"),t.SDv(18,8),t.qZA()()(),t.TgZ(19,"button",9)(20,"app-icon"),t._uU(21,"close"),t.qZA()()),2&r&&(t.xp6(3),t.Q6J("href",t.xi3(4,3,g.outlook_link,"url"),t.LSH),t.xp6(5),t.Q6J("href",t.xi3(9,6,g.google_link,"url"),t.LSH),t.xp6(5),t.Q6J("href",t.xi3(14,9,g.ical_link,"url"),t.LSH))},dependencies:[L.eB,_.aO,D.o,F.y,h.n],styles:["[_nghost-%COMP%]{position:relative}"]})},4282:($,U,o)=>{o.d(U,{I:()=>f});var _=o(4650),T=o(4006),b=(o(3770),o(6895)),t=o(4454),L=o(9818),D=o(5559);function F(O,r){if(1&O){const g=_.EpF();_.TgZ(0,"div",2)(1,"h2",3),_.SDv(2,4),_.qZA(),_.TgZ(3,"main",5)(4,"div",6)(5,"label"),_.tHW(6,7),_._UZ(7,"span"),_.N_p(),_.qZA(),_.TgZ(8,"mat-radio-group",8)(9,"mat-radio-button",9),_._uU(10,"Yes"),_.qZA(),_.TgZ(11,"mat-radio-button",9),_._uU(12,"No"),_.qZA()()(),_.TgZ(13,"div",6)(14,"label"),_.tHW(15,10),_._UZ(16,"span"),_.N_p(),_.qZA(),_.TgZ(17,"mat-radio-group",11)(18,"mat-radio-button",9),_._uU(19,"Yes"),_.qZA(),_.TgZ(20,"mat-radio-button",9),_._uU(21,"No"),_.qZA()()(),_.TgZ(22,"div",12)(23,"label"),_.tHW(24,13),_._UZ(25,"span"),_.N_p(),_.qZA(),_.TgZ(26,"mat-radio-group",14)(27,"mat-radio-button",9),_._uU(28,"Yes"),_.qZA(),_.TgZ(29,"mat-radio-button",9),_._uU(30,"No"),_.qZA()()()(),_.TgZ(31,"footer",15)(32,"button",16),_.NdJ("click",function(){_.CHM(g);const C=_.oxw();return _.KtG(C.submit())}),_.SDv(33,17),_.qZA()(),_.TgZ(34,"button",18)(35,"i",19),_._uU(36,"close"),_.qZA()()()}if(2&O){const g=_.oxw();_.xp6(3),_.Q6J("formGroup",g.form),_.xp6(6),_.Q6J("value",!0),_.xp6(2),_.Q6J("value",!1),_.xp6(7),_.Q6J("value",!0),_.xp6(2),_.Q6J("value",!1),_.xp6(7),_.Q6J("value",!0),_.xp6(2),_.Q6J("value",!1)}}function h(O,r){1&O&&(_.TgZ(0,"main",20)(1,"p",21),_.SDv(2,22),_.qZA(),_.TgZ(3,"button",18)(4,"i",19),_._uU(5,"close"),_.qZA()()())}class f{constructor(){this.event=new _.vpe,this.form=new T.cw({travelled:new T.NI(!1),unwell:new T.NI(!1),contact:new T.NI(!1)})}submit(){this.form.markAllAsTouched(),Object.keys(this.form.value).find(r=>!0===this.form.value[r]||"true"===this.form.value[r])?this.failure=!0:this.event.emit({reason:"done"})}}f.\u0275fac=function(r){return new(r||f)},f.\u0275cmp=_.Xpm({type:f,selectors:[["desk-question-modal"]],outputs:{event:"event"},decls:3,vars:2,consts:function(){let O,r,g,M,C,N;return O=$localize`:␟02006a13b8e6aacb7a6e15bafd8004ed529f5d81␟877348132538805077:COVID-19 Questionnaire`,r=$localize`:␟dad7efbd2320e5ea935aef911f18cbcb24690133␟1650520403092579087: Have you travelled overseas within the last 14 days?${"\ufffd#7\ufffd"}:START_TAG_SPAN:*${"\ufffd/#7\ufffd"}:CLOSE_TAG_SPAN:`,g=$localize`:␟cf50bf8de6c6db836da440c89a375631f7ba3fb0␟1182497320820036810: Are you unwell or experiencing any cold or flu-like symptoms?${"\ufffd#16\ufffd"}:START_TAG_SPAN:*${"\ufffd/#16\ufffd"}:CLOSE_TAG_SPAN:`,M=$localize`:␟273153c91358de15d124ff2966859d9949080f4c␟737527639567676154: Have you had contact with anyone with suspected COVID-19?${"\ufffd#25\ufffd"}:START_TAG_SPAN:*${"\ufffd/#25\ufffd"}:CLOSE_TAG_SPAN:`,C=$localize`:␟71c77bb8cecdf11ec3eead24dd1ba506573fa9cd␟935187492052582731:Submit`,N=$localize`:␟17d62f424c2c025579e1ec0e3f5ad971f57681df␟4401678084033805848: Your request to work from the office has been rejected based on your response to the compulsory Covid-19 questions. Please feel free to submit a new request when circumstances change in a way that changes your answer to the questions. `,[["class","relative",4,"ngIf","ngIfElse"],["fail_state",""],[1,"relative"],[1,"p-4","text-xl"],O,[1,"p-4",3,"formGroup"],[1,"flex","flex-col","mb-4"],r,["formControlName","travelled",1,"space-x-2"],[3,"value"],g,["formControlName","unwell",1,"space-x-2"],[1,"flex","flex-col"],M,["formControlName","contact",1,"space-x-2"],[1,"flex","justify-center","items-center","p-2"],["mat-button","",3,"click"],C,["close","","mat-icon-button","","mat-dialog-close",""],[1,"material-icons"],["failure","",1,"pt-8","relative"],[1,"p-4"],N]},template:function(r,g){if(1&r&&(_.YNc(0,F,37,7,"div",0),_.YNc(1,h,6,0,"ng-template",null,1,_.W1O)),2&r){const M=_.MAs(2);_.Q6J("ngIf",!g.failure)("ngIfElse",M)}},dependencies:[b.O5,T.JJ,T.JL,T.sg,T.u,t.OY,t.vy,L.eB,D.aO],styles:["main[_ngcontent-%COMP%]{width:24rem;max-width:calc(100vw - 4.5rem)}[close][_ngcontent-%COMP%]{position:absolute;top:.5rem;right:.5rem}"]})}}]);