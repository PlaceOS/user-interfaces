"use strict";(self.webpackChunkconcierge=self.webpackChunkconcierge||[]).push([["default-libs_bookings_src_index_ts"],{4099:(we,L,a)=>{a.d(L,{$N:()=>k,fy:()=>Me,jT:()=>ye,FD:()=>xe,F2:()=>O,FP:()=>Ze,km:()=>E,Fo:()=>ke,Wp:()=>$}),a(3362);var e=a(3184),I=a(5758),h=a(3294),D=a(6362),S=a(7317),d=(a(9697),a(587));a(2306),a(4770),a(4683),a(4742);var F=a(8390);function ae(t,n){if(1&t){const o=e.EpF();e.TgZ(0,"div",2),e.TgZ(1,"h2",3),e._uU(2,"COVID-19 Questionnaire"),e.qZA(),e.TgZ(3,"main",4),e.TgZ(4,"div",5),e.TgZ(5,"label"),e._uU(6," Have you travelled overseas within the last 14 days?"),e.TgZ(7,"span"),e._uU(8,"*"),e.qZA(),e.qZA(),e.TgZ(9,"mat-radio-group",6),e.TgZ(10,"mat-radio-button",7),e._uU(11,"Yes"),e.qZA(),e.TgZ(12,"mat-radio-button",7),e._uU(13,"No"),e.qZA(),e.qZA(),e.qZA(),e.TgZ(14,"div",5),e.TgZ(15,"label"),e._uU(16," Are you unwell or experiencing any cold or flu-like symptoms?"),e.TgZ(17,"span"),e._uU(18,"*"),e.qZA(),e.qZA(),e.TgZ(19,"mat-radio-group",8),e.TgZ(20,"mat-radio-button",7),e._uU(21,"Yes"),e.qZA(),e.TgZ(22,"mat-radio-button",7),e._uU(23,"No"),e.qZA(),e.qZA(),e.qZA(),e.TgZ(24,"div",9),e.TgZ(25,"label"),e._uU(26," Have you had contact with anyone with suspected COVID-19?"),e.TgZ(27,"span"),e._uU(28,"*"),e.qZA(),e.qZA(),e.TgZ(29,"mat-radio-group",10),e.TgZ(30,"mat-radio-button",7),e._uU(31,"Yes"),e.qZA(),e.TgZ(32,"mat-radio-button",7),e._uU(33,"No"),e.qZA(),e.qZA(),e.qZA(),e.qZA(),e.TgZ(34,"footer",11),e.TgZ(35,"button",12),e.NdJ("click",function(){return e.CHM(o),e.oxw().submit()}),e._uU(36,"Submit"),e.qZA(),e.qZA(),e.TgZ(37,"button",13),e.TgZ(38,"i",14),e._uU(39,"close"),e.qZA(),e.qZA(),e.qZA()}if(2&t){const o=e.oxw();e.xp6(3),e.Q6J("formGroup",o.form),e.xp6(7),e.Q6J("value",!0),e.xp6(2),e.Q6J("value",!1),e.xp6(8),e.Q6J("value",!0),e.xp6(2),e.Q6J("value",!1),e.xp6(8),e.Q6J("value",!0),e.xp6(2),e.Q6J("value",!1)}}function re(t,n){1&t&&(e.TgZ(0,"main",15),e.TgZ(1,"p",16),e._uU(2," Your request to work from the office has been rejected based on your response to the compulsory Covid-19 questions. Please feel free to submit a new request when circumstances change in a way that changes your answer to the questions. "),e.qZA(),e.TgZ(3,"button",13),e.TgZ(4,"i",14),e._uU(5,"close"),e.qZA(),e.qZA(),e.qZA())}let B=(()=>{class t{constructor(){this.event=new e.vpe}ngOnInit(){this.form=new d.cw({travelled:new d.NI("",[d.kI.required]),unwell:new d.NI("",[d.kI.required]),contact:new d.NI("",[d.kI.required])})}submit(){this.form.markAllAsTouched(),this.form.valid?Object.keys(this.form.value).find(o=>!0===this.form.value[o]||"true"===this.form.value[o])?this.failure=!0:this.event.emit({reason:"done"}):(0,h.cB)("All the questions must be answered")}}return t.\u0275fac=function(o){return new(o||t)},t.\u0275cmp=e.Xpm({type:t,selectors:[["desk-question-modal"]],outputs:{event:"event"},decls:3,vars:2,consts:[["class","relative",4,"ngIf","ngIfElse"],["fail_state",""],[1,"relative"],[1,"p-4","text-xl"],[1,"p-4",3,"formGroup"],[1,"flex","flex-col","mb-4"],["formControlName","travelled",1,"space-x-2"],[3,"value"],["formControlName","unwell",1,"space-x-2"],[1,"flex","flex-col"],["formControlName","contact",1,"space-x-2"],[1,"flex","justify-center","items-center","p-2"],["mat-button","",3,"click"],["close","","mat-icon-button","","mat-dialog-close",""],[1,"material-icons"],["failure","",1,"pt-8","relative"],[1,"p-4"]],template:function(o,s){if(1&o&&(e.YNc(0,ae,40,7,"div",0),e.YNc(1,re,6,0,"ng-template",null,1,e.W1O)),2&o){const i=e.MAs(2);e.Q6J("ngIf",!s.failure)("ngIfElse",i)}},directives:[D.O5,d.JL,d.sg,F.VQ,d.JJ,d.u,F.U0,S.lW,I.ZT],styles:["main[_ngcontent-%COMP%]{width:24rem;max-width:calc(100vw - 4.5rem)}[close][_ngcontent-%COMP%]{position:absolute;top:.5rem;right:.5rem}\n/*# sourceMappingURL=desk-questions-modal.component.ts-angular-inline--48.css.map*/"]}),t})();var U=a(4929),Q=a(9481),le=a(3619),y=a(3674),M=a(1810),T=a(2317),J=a(5148),de=a(8235),w=a(4505),P=a(4139),q=a(7716),A=a(9128),ue=a(3298),z=a(9095),v=a(6942),N=a(8759),me=a(823),V=a(5670),ge=a(5692),_e=a(8987),fe=a(5845),pe=a(2757),he=a(1233);class k{constructor(n={}){var o,s,i;this.id=n.id||"",this.asset_id=n.asset_id||"",this.asset_name=n.asset_name||(null===(o=n.extension_data)||void 0===o?void 0:o.asset_name)||"",this.zones=n.zones||[],this.booking_start=n.date/1e3||n.booking_start||(0,M.Z)((0,ge.Z)((0,T.Z)(Date.now(),5),{nearestTo:5})),this.booking_end=n.date/1e3+60*n.duration||n.booking_end||(0,M.Z)((0,T.Z)(1e3*this.booking_start,n.duration||60)),this.booking_type=n.booking_type||"",this.type=n.type||"booking",this.date=n.date||1e3*this.booking_start,this.duration=n.duration||Math.abs((0,_e.Z)(1e3*this.booking_start,1e3*this.booking_end)),this.timezone=n.timezone||Intl.DateTimeFormat().resolvedOptions().timeZone,this.user_email=n.user_email||"",this.user_id=n.user_id||"",this.user_name=n.user_name||"",this.title=n.title||"Desk booking",this.description=n.description||"",this.checked_in=!!n.checked_in,this.rejected=!!n.rejected,this.approved=!!n.approved,this.booked_by_id=n.booked_by_id||"",this.booked_by_name=n.booked_by_name||"",this.booked_by_email=n.booked_by_email||"",this.approver_id=n.approver_id||"",this.approver_email=n.approver_email||"",this.approver_name=n.approver_name||"",this.extension_data=n.extension_data||{},this.access=!!(null===(s=n.extension_data)||void 0===s?void 0:s.access),this.all_day=null!==(i=n.all_day)&&void 0!==i?i:this.duration>720,this.status=this.rejected?"declined":this.approved?"approved":"tentative";for(const l in n)l in this||(this.extension_data[l]=n[l]||this.extension_data[l])}toJSON(){const n=Object.assign({},this);return this.id||delete n.id,delete n.date,delete n.duration,n}get location(){return this.description}get is_today(){return(0,fe.Z)(this.date,new Date)}get is_done(){const n=new Date,o=this.all_day?(0,pe.Z)(this.date,24):(0,T.Z)(this.date,this.duration);return(0,he.Z)(n,o)}}a(4922);var j=a(5038);const Z="/api/staff/v1/bookings";function O(t){const n=(0,j.U)(t);return(0,y.U2M)(`${Z}${n?"?"+n:""}`).pipe((0,v.U)(o=>o.map(s=>new k(s))))}function ke(t){return(0,y.U2M)(`${Z}/${encodeURIComponent(t)}`).pipe((0,v.U)(n=>new k(n)))}function $(t,n,o="patch"){return("patch"===o?y.r$K:y.gzd)(`${Z}/${encodeURIComponent(t)}`,n).pipe((0,v.U)(s=>new k(s)))}const E=t=>t.id?$(t.id,t):function be(t){return(0,y.v_Q)(`${Z}`,t).pipe((0,v.U)(n=>new k(n)))}(t);function ye(t){return(0,y.v_Q)(`${Z}/${encodeURIComponent(t)}/approve`,"").pipe((0,v.U)(n=>new k(n)))}function Ze(t){return(0,y.v_Q)(`${Z}/${encodeURIComponent(t)}/reject`,"").pipe((0,v.U)(n=>new k(n)))}function xe(t,n){const o=(0,j.U)({state:n});return(0,y.v_Q)(`${Z}/${encodeURIComponent(t)}/check_in?${o}`,"").pipe((0,v.U)(s=>new k(s)))}const Ce=["book/desks"];let Me=(()=>{class t extends h.KG{constructor(o,s,i,l){super(),this._router=o,this._settings=s,this._org=i,this._dialog=l,this._view=new w.X("form"),this._options=new w.X({type:"desk"}),this._form=new w.X(null),this._form_value=new w.X({}),this._booking=new w.X(null),this._loading=new w.X(""),this.last_success=new k(JSON.parse(sessionStorage.getItem("PLACEOS.last_booked_booking")||"{}")),this.loading=this._loading.asObservable(),this.options=this._options.pipe((0,A.d)(1)),this.assets=this.options.pipe(function ce(t,n){return(0,ue.x)((o,s)=>n?n(o[t],s[t]):o[t]===s[t])}("zone_id"),(0,z.w)(({type:r})=>this._org.building&&"desk"===r?(this._loading.next("Loading desks..."),(0,y.BW_)(this._org.building.id,{name:"desks"}).pipe((0,v.U)(g=>(0,h.xH)(g.map(c=>{var m,u;return((null===(m=c.metadata.desks)||void 0===m?void 0:m.details)instanceof Array?null===(u=c.metadata.desks)||void 0===u?void 0:u.details:[]).map(f=>Object.assign(Object.assign({},f),{zone:c.zone}))}))))):(0,P.of)([])),(0,N.b)(()=>this._loading.next("")),(0,A.d)(1)),this.features=this.assets.pipe((0,v.U)(r=>{var g;const c=[];for(const m of r)null===(g=m.features)||void 0===g||g.forEach(u=>c.push(u));return(0,h.Tw)(c).sort((m,u)=>m.localeCompare(u))}),(0,A.d)(1)),this.available_assets=(0,q.aj)([this.options,this.assets,this._form_value]).pipe((0,me.b)(500),(0,N.b)(([{type:r}])=>this._loading.next(`Checking ${r} availability...`)),(0,z.w)(([r,g,c])=>O({period_start:(0,M.Z)(c.date),period_end:(0,M.Z)((0,T.Z)(c.date,c.duration||1440)),type:r.type,zones:r.zone_id}).pipe((0,v.U)(m=>g.filter(u=>{var f,_,b;return!1!==u.bookable&&(!r.features||(null===(f=r.features)||void 0===f?void 0:f.every(p=>u.features.includes(p))))&&(!r.zone_id||r.zone_id===(null===(_=u.zone)||void 0===_?void 0:_.id)||r.zone_id===(null===(b=u.zone)||void 0===b?void 0:b.parent_id))&&!m.find(p=>p.asset_id===u.id&&"declined"!==p.status)})))),(0,N.b)(()=>this._loading.next("")),(0,A.d)(1)),this.grouped_availability=(0,q.aj)([this.options,this.available_assets]).pipe((0,v.U)(([r,g])=>{var c;const m=[],u=[...g].sort((_,b)=>{var p,x,C;return null===(x=null===(p=_.zone)||void 0===p?void 0:p.id)||void 0===x?void 0:x.localeCompare(null===(C=b.zone)||void 0===C?void 0:C.id)}),f=(null===(c=r.members)||void 0===c?void 0:c.length)?r.members:[(0,h.ar)()];for(;u.length;){const _=[];let b=u.pop();for(;_.length<f.length&&(!_.length||_.find(p=>{var x,C;return(null===(x=p.zone)||void 0===x?void 0:x.id)===(null===(C=b.zone)||void 0===C?void 0:C.id)}));)_.push(b),b=u.pop();_.length<f.length||m.push(_)}return m})),this.subscription("router.bookings",this._router.events.subscribe(r=>{r instanceof Q.m2&&!Ce.find(g=>r.url.includes(g))&&this.clearForm()})),this._org.initialised.pipe((0,V.P)(r=>r)).subscribe(()=>this.setOptions({}))}get view(){return this._view.getValue()}get form(){return this._form.getValue()}get booking(){return this._booking.getValue()}newForm(o=new k){this._form.next(function ve(t={}){var n,o;const s=new d.cw({id:new d.NI(t.id||""),date:new d.NI(t.date,[]),all_day:new d.NI(null!==(n=t.all_day)&&void 0!==n&&n),duration:new d.NI(t.duration),booking_type:new d.NI(t.booking_type),zones:new d.NI(t.zones),title:new d.NI(t.title),description:new d.NI(t.description),asset_id:new d.NI(t.asset_id),asset_name:new d.NI(t.description),map_id:new d.NI(null===(o=t.extension_data)||void 0===o?void 0:o.map_id),user:new d.NI((0,h.ar)()),user_id:new d.NI(t.user_id),user_email:new d.NI(t.user_email),booked_by:new d.NI((0,h.ar)()),booked_by_id:new d.NI(t.booked_by_id),booked_by_email:new d.NI(t.booked_by_email)});return s.valueChanges.subscribe(i=>{const l=i.user,r=i.booked_by;(r||l)&&s.patchValue({user_id:l.id||r.id,user_email:l.email||r.id,booked_by_id:r.id,booked_by_email:r.email},{emitEvent:!1})}),s}(o)),this.subscription("form_change",this._form.getValue().valueChanges.subscribe(()=>this.storeForm())),this._booking.next(o),this._options.next({type:this._options.getValue().type})}setView(o){this._view.next(o)}setOptions(o){this._options.next(Object.assign(Object.assign({},this._options.getValue()),o))}resetForm(){this._form.getValue()||this.newForm();const o=this._booking.getValue();this._form.getValue().patchValue(Object.assign(Object.assign({},o||{}),(null==o?void 0:o.extension_data)||{})),this._options.next({type:this._options.getValue().type})}clearForm(){sessionStorage.removeItem("PLACEOS.booking_form"),sessionStorage.removeItem("PLACEOS.booking_form_options"),this.newForm()}storeForm(){var o,s;sessionStorage.setItem("PLACEOS.booking_form",JSON.stringify((null===(o=this._form.getValue())||void 0===o?void 0:o.value)||{})),sessionStorage.setItem("PLACEOS.booking_form_filters",JSON.stringify(this._options.getValue()||{})),this._form_value.next((null===(s=this._form.getValue())||void 0===s?void 0:s.value)||{})}loadForm(){var o;this._form.getValue()||this.newForm(),this._form.getValue().patchValue(Object.assign({},JSON.parse(sessionStorage.getItem("PLACEOS.booking_form")||"{}"))),this.setOptions(Object.assign({zone_id:null===(o=this._org.building)||void 0===o?void 0:o.id},JSON.parse(sessionStorage.getItem("PLACEOS.booking_form_filters")||"{}")))}confirmPost(){return(0,U.mG)(this,void 0,void 0,function*(){yield this.checkQuestions();const o=this._options.getValue(),s=this._form.getValue(),i=yield(0,h._5)({title:`Book ${o.type}`,content:`Would you like to book the ${o.type} ${s.value.asset_name} for ${(0,J.Z)(s.value.date,"dd MMM yyyy")}${s.value.duration<720?" at "+(0,J.Z)(s.value.date,"h:mm a"):""}`,icon:{content:"event_available"}},this._dialog);if("done"!==(null==i?void 0:i.reason))throw"User cancelled";i.loading("Performing booking request..."),yield this.postForm().catch(l=>{throw(0,h.cB)(l),i.close(),l}),i.close()})}postForm(){var o,s;return(0,U.mG)(this,void 0,void 0,function*(){const i=this._form.getValue();if(!i)throw"No form for booking";if(!i.valid)throw`Some form fields are invalid. [${(0,h.RD)(i).join(", ")}]`;const l=i.get("asset_id").value,r=yield O({period_start:(0,M.Z)(i.value.date),period_end:(0,M.Z)(i.value.date+60*i.value.duration*1e3),type:this._options.getValue().type}).toPromise();if(r.find(u=>u.asset_id===l))throw`${l} is not available at the selected time`;const g=null!==(o=this._settings.get(`app.booking.allowed_daily_${this._options.getValue().type}_count`))&&void 0!==o?o:1;if(g>0&&r.filter(u=>{var f;return u.user_email===(i.value.user_email||(null===(f=(0,h.ar)())||void 0===f?void 0:f.email))&&"declined"!==u.status}).length>=g)throw"You already have a desk booked";(i.value.duration>1380||i.value.all_day)&&i.patchValue({date:(0,de.Z)(i.value.date,{hours:12,minutes:0}),duration:60});const c=yield E(new k(i.value)).toPromise(),{booking_type:m}=i.value;return this.clearForm(),null===(s=this._form.getValue())||void 0===s||s.patchValue({booking_type:m}),this.last_success=c,sessionStorage.setItem("PLACEOS.last_booked_booking",JSON.stringify(c)),this.setView("success"),c})}checkQuestions(){return(0,U.mG)(this,void 0,void 0,function*(){if(!1!==this._settings.get("app.desks.ignore_questions"))return;const o=this._dialog.open(B),s=yield Promise.race([o.componentInstance.event.pipe((0,V.P)(l=>"done"===l.reason)).toPromise(),o.afterClosed().toPromise()]);if("done"!==(null==s?void 0:s.reason))throw"User cancelled";const i=o.componentInstance.form.value;for(const l in i)if(i[l])throw"User failed questionaire";o.close()})}}return t.\u0275fac=function(o){return new(o||t)(e.LFG(Q.F0),e.LFG(h.gb),e.LFG(le.w7),e.LFG(I.uw))},t.\u0275prov=e.Yz7({token:t,factory:t.\u0275fac,providedIn:"root"}),t})()}}]);
//# sourceMappingURL=default-libs_bookings_src_index_ts.js.map