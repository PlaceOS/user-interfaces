"use strict";(self.webpackChunkconcierge=self.webpackChunkconcierge||[]).push([["default-libs_bookings_src_index_ts"],{363:(ye,L,a)=>{a.d(L,{$N:()=>I.$,fy:()=>q,jT:()=>h.jT,FD:()=>h.FD,gV:()=>F.gV,F2:()=>h.F2,FP:()=>h.FP,km:()=>h.km,Fo:()=>h.Fo,Wp:()=>h.Wp}),a(6850);var e=a(2560),C=a(1484),p=a(1506),b=a(4666),g=a(2508),A=(a(5074),a(1267),a(4522));a(1708),a(2306),a(9697);var O=a(2922);function oe(o,c){if(1&o){const t=e.EpF();e.TgZ(0,"div",2)(1,"h2",3),e._uU(2,"COVID-19 Questionnaire"),e.qZA(),e.TgZ(3,"main",4)(4,"div",5)(5,"label"),e._uU(6," Have you travelled overseas within the last 14 days?"),e.TgZ(7,"span"),e._uU(8,"*"),e.qZA()(),e.TgZ(9,"mat-radio-group",6)(10,"mat-radio-button",7),e._uU(11,"Yes"),e.qZA(),e.TgZ(12,"mat-radio-button",7),e._uU(13,"No"),e.qZA()()(),e.TgZ(14,"div",5)(15,"label"),e._uU(16," Are you unwell or experiencing any cold or flu-like symptoms?"),e.TgZ(17,"span"),e._uU(18,"*"),e.qZA()(),e.TgZ(19,"mat-radio-group",8)(20,"mat-radio-button",7),e._uU(21,"Yes"),e.qZA(),e.TgZ(22,"mat-radio-button",7),e._uU(23,"No"),e.qZA()()(),e.TgZ(24,"div",9)(25,"label"),e._uU(26," Have you had contact with anyone with suspected COVID-19?"),e.TgZ(27,"span"),e._uU(28,"*"),e.qZA()(),e.TgZ(29,"mat-radio-group",10)(30,"mat-radio-button",7),e._uU(31,"Yes"),e.qZA(),e.TgZ(32,"mat-radio-button",7),e._uU(33,"No"),e.qZA()()()(),e.TgZ(34,"footer",11)(35,"button",12),e.NdJ("click",function(){e.CHM(t);const s=e.oxw();return e.KtG(s.submit())}),e._uU(36,"Submit"),e.qZA()(),e.TgZ(37,"button",13)(38,"i",14),e._uU(39,"close"),e.qZA()()()}if(2&o){const t=e.oxw();e.xp6(3),e.Q6J("formGroup",t.form),e.xp6(7),e.Q6J("value",!0),e.xp6(2),e.Q6J("value",!1),e.xp6(8),e.Q6J("value",!0),e.xp6(2),e.Q6J("value",!1),e.xp6(8),e.Q6J("value",!0),e.xp6(2),e.Q6J("value",!1)}}function ne(o,c){1&o&&(e.TgZ(0,"main",15)(1,"p",16),e._uU(2," Your request to work from the office has been rejected based on your response to the compulsory Covid-19 questions. Please feel free to submit a new request when circumstances change in a way that changes your answer to the questions. "),e.qZA(),e.TgZ(3,"button",13)(4,"i",14),e._uU(5,"close"),e.qZA()()())}let J=(()=>{class o{constructor(){this.event=new e.vpe,this.form=new g.cw({travelled:new g.NI(!1),unwell:new g.NI(!1),contact:new g.NI(!1)})}submit(){this.form.markAllAsTouched(),Object.keys(this.form.value).find(t=>!0===this.form.value[t]||"true"===this.form.value[t])?this.failure=!0:this.event.emit({reason:"done"})}}return o.\u0275fac=function(t){return new(t||o)},o.\u0275cmp=e.Xpm({type:o,selectors:[["desk-question-modal"]],outputs:{event:"event"},decls:3,vars:2,consts:[["class","relative",4,"ngIf","ngIfElse"],["fail_state",""],[1,"relative"],[1,"p-4","text-xl"],[1,"p-4",3,"formGroup"],[1,"flex","flex-col","mb-4"],["formControlName","travelled",1,"space-x-2"],[3,"value"],["formControlName","unwell",1,"space-x-2"],[1,"flex","flex-col"],["formControlName","contact",1,"space-x-2"],[1,"flex","justify-center","items-center","p-2"],["mat-button","",3,"click"],["close","","mat-icon-button","","mat-dialog-close",""],[1,"material-icons"],["failure","",1,"pt-8","relative"],[1,"p-4"]],template:function(t,n){if(1&t&&(e.YNc(0,oe,40,7,"div",0),e.YNc(1,ne,6,0,"ng-template",null,1,e.W1O)),2&t){const s=e.MAs(2);e.Q6J("ngIf",!n.failure)("ngIfElse",s)}},dependencies:[b.O5,g.JJ,g.JL,g.sg,g.u,O.VQ,O.U0,A.lW,C.ZT],styles:["main[_ngcontent-%COMP%]{width:24rem;max-width:calc(100vw - 4.5rem)}[close][_ngcontent-%COMP%]{position:absolute;top:.5rem;right:.5rem}\n/*# sourceMappingURL=desk-questions-modal.component.ts-angular-inline--57.css.map*/"]}),o})();var Z=a(1670),Q=a(3619),P=a(9885),se=a(3690),T=a(1810),ie=a(2317),E=a(5148),ae=a(8235),y=a(4505),z=a(4139),Y=a(7716),M=a(9128),re=a(6116),B=a(9095),w=a(6942),U=a(8759),le=a(9151),de=a(823),R=a(5670),ce=a(3910),I=a(6962),F=a(1980),h=a(354);const ue=["book/desks"];let q=(()=>{class o extends p.KG{constructor(t,n,s,l){super(),this._router=t,this._settings=n,this._org=s,this._dialog=l,this._view=new y.X("form"),this._options=new y.X({type:"desk"}),this._form=new y.X((0,F.PR)()),this._booking=new y.X(null),this._loading=new y.X(""),this.last_success=new I.$(JSON.parse(sessionStorage.getItem("PLACEOS.last_booked_booking")||"{}")),this.loading=this._loading.asObservable(),this.options=this._options.pipe((0,M.d)(1)),this.assets=this.options.pipe((0,re.g)("zone_id"),(0,B.w)(({type:i})=>this._org.building&&"desk"===i?(this._loading.next("Loading desks..."),(0,se.BW_)(this._org.building.id,{name:"desks"}).pipe((0,w.U)(d=>(0,p.xH)(d.map(r=>(r.metadata.desks?.details instanceof Array?r.metadata.desks?.details:[]).map(u=>({...u,zone:r.zone}))))))):(0,z.of)([])),(0,U.b)(()=>this._loading.next("")),(0,M.d)(1)),this.features=this.assets.pipe((0,w.U)(i=>{const d=[];for(const{features:r}of i)r instanceof Array&&r.forEach(u=>d.push(u));return(0,p.Tw)(d).sort((r,u)=>r.localeCompare(u))}),(0,M.d)(1)),this.available_assets=(0,Y.aj)([this.options,this.assets,this._form]).pipe((0,le.h)(([i,d,r])=>r.getRawValue().date>0&&r.getRawValue().duration>0),(0,de.b)(500),(0,U.b)(([{type:i}])=>this._loading.next(`Checking ${i} availability...`)),(0,B.w)(([i,d,r])=>(0,h.F2)({period_start:(0,T.Z)(r.getRawValue().date),period_end:(0,T.Z)((0,ie.Z)(r.getRawValue().date,r.getRawValue().duration||1440)),type:i.type,zones:i.zone_id}).pipe((0,w.U)(u=>d.filter(f=>!1!==f.bookable&&(!i.features||i.features?.every(m=>f.features.includes(m)))&&(!i.zone_id||i.zone_id===f.zone?.id||i.zone_id===f.zone?.parent_id)&&!u.find(m=>m.asset_id===f.id&&"declined"!==m.status)&&(!i?.show_fav||this.favorite_desks.includes(f.id)))))),(0,U.b)(()=>this._loading.next("")),(0,M.d)(1)),this.grouped_availability=(0,Y.aj)([this.options,this.available_assets]).pipe((0,w.U)(([i,d])=>{const r=[],u=[...d].sort((m,v)=>m.zone?.id?.localeCompare(v.zone?.id)),f=i.members?.length?i.members:[(0,p.ar)()];for(;u.length;){const m=[];let v=u.pop();for(;m.length<f.length&&(!m.length||m.find(_=>_.zone?.id===v.zone?.id));)m.push(v),v=u.pop();m.length<f.length||r.push(m)}return r})),this.subscription("router.bookings",this._router.events.subscribe(i=>{i instanceof P.m2&&!ue.find(d=>i.url.includes(d))&&this.clearForm()})),this._org.initialised.pipe((0,R.P)(i=>i)).subscribe(()=>this.setOptions({}))}get view(){return this._view.getValue()}get form(){return this._form.getValue()}get booking(){return this._booking.getValue()}get favorite_desks(){return this._settings.get("favourite_desks")||[]}newForm(t=new I.$){this._form.next((0,F.PR)(t)),this.subscription("form_change",this._form.getValue().valueChanges.subscribe(()=>this.storeForm())),this._booking.next(t),this._options.next({type:this._options.getValue().type})}setView(t){this._view.next(t)}setOptions(t){this._options.next({...this._options.getValue(),...t})}setFeature(t,n){if(!t?.length)return;const s=this._options.getValue()?.features||[];n&&!s.includes(t)&&s.push(t),!n&&s.includes(t)&&s.splice(s.findIndex(l=>l===t),1),this.setOptions({features:s})}resetForm(){this._form.getValue()||this.newForm();const t=this._booking.getValue();this._form.getValue().patchValue({...t||{},...t?.extension_data||{}}),this._options.next({type:this._options.getValue().type})}clearForm(){sessionStorage.removeItem("PLACEOS.booking_form"),sessionStorage.removeItem("PLACEOS.booking_form_options"),this.newForm()}storeForm(){sessionStorage.setItem("PLACEOS.booking_form",JSON.stringify(this._form.getValue()?.getRawValue()||{})),sessionStorage.setItem("PLACEOS.booking_form_filters",JSON.stringify(this._options.getValue()||{}))}loadForm(){this._form.getValue()||this.newForm(),this._form.getValue().patchValue({...JSON.parse(sessionStorage.getItem("PLACEOS.booking_form")||"{}")}),this.setOptions({zone_id:this._org.building?.id,...JSON.parse(sessionStorage.getItem("PLACEOS.booking_form_filters")||"{}")})}confirmPost(){var t=this;return(0,Z.Z)(function*(){yield t.checkQuestions();const n=t._options.getValue(),l=t._form.getValue().getRawValue();let i=`Would you like to book the ${n.type} ${l.asset_name} for ${(0,E.Z)(l.date,"dd MMM yyyy")}${l.duration<720?" at "+(0,E.Z)(l.date,"h:mm a"):""}`;n.group&&(i=`${i}.<br>You group members will be assigned desks nearby your selected desk.`);const d=yield(0,p._5)({title:`Book ${n.type}`,content:i,icon:{content:"event_available"}},t._dialog);if("done"!==d?.reason)throw"User cancelled";d.loading("Performing booking request..."),n.group?yield t.postFormForGroup().catch(r=>{throw(0,p.cB)(r),d.close(),r}):yield t.postForm().catch(r=>{throw(0,p.cB)(r),d.close(),r}),d.close()})()}postForm(t=!1){var n=this;return(0,Z.Z)(function*(){const s=n._form.getValue();if(!s)throw"No form for booking";if(!s.valid)throw`Some form fields are invalid. [${(0,p.RD)(s).join(", ")}]`;const l=s.getRawValue();t||(yield n.checkResourceAvailable(l,n._options.getValue().type)),(l.duration>=720||l.all_day)&&s.patchValue({date:(0,ae.Z)(l.date,{hours:11,minutes:59}).valueOf(),duration:720}),n._loading.next("Saving booking");const i=yield(0,h.km)(new I.$({...l,approved:!!n._settings.get("app.bookings.no_approval")})).toPromise();n._loading.next("");const{booking_type:d}=l;return n.clearForm(),s?.patchValue({booking_type:d}),n.last_success=i,sessionStorage.setItem("PLACEOS.last_booked_booking",JSON.stringify(i)),n.setView("success"),i})()}postFormForGroup(){var t=this;return(0,Z.Z)(function*(){const{members:n,group:s,type:l}=t._options.getValue();if(!s)throw"No group available to book for";const i=n.filter(_=>_.email!==(0,p.ar)().email);if(i.length<=0)throw"No members in your group to book for.";const d=t._form.getValue().value,r=yield t.available_assets.pipe((0,ce.q)(1)).toPromise(),u=r.find(_=>_.id===d.asset_id||_.map_id===d.asset_id),f=t._org.levelWithID([u.zone?.id]),m=[u,...yield t._getNearbyResources(f.map_id,d.asset_id,r,i.length)],v=[(0,p.ar)(),...i];yield Promise.all(v.map((_,k)=>t.checkResourceAvailable({...d,asset_id:m[k].map_id||m[k].id,user_email:_.email},l)));for(let _=0;_<v.length;_++){const k=v[_],x=m[_];t._form.getValue().patchValue({...d,user:k,asset_id:x?.id,asset_name:x.name,map_id:x?.map_id||x?.id,description:x.name,zones:x.zone?[x.zone?.parent_id,x.zone?.id]:[]}),t.postForm(!0)}})()}checkQuestions(){var t=this;return(0,Z.Z)(function*(){if(!1!==t._settings.get("app.desks.ignore_questions"))return;const n=t._dialog.open(J);if("done"!==(yield Promise.race([n.componentInstance.event.pipe((0,R.P)(i=>"done"===i.reason)).toPromise(),n.afterClosed().toPromise()]))?.reason)throw"User cancelled";const l=n.componentInstance.form.getRawValue();for(const i in l)if(l[i])throw"User failed questionaire";n.close()})()}checkResourceAvailable({asset_id:t,date:n,duration:s,user_email:l,all_day:i},d){var r=this;return(0,Z.Z)(function*(){s=i?720:s||60;const u=yield(0,h.F2)({period_start:(0,T.Z)(n),period_end:(0,T.Z)(n+60*s*1e3),type:d}).toPromise();if(u.find(m=>m.asset_id===t))throw`${t} is not available at the selected time`;const f=r._settings.get(`app.booking.allowed_daily_${d}_count`)??1;if(f>0&&u.filter(m=>m.user_email===(l||(0,p.ar)()?.email)&&"declined"!==m.status).length>=f){const m=l===(0,p.ar)()?.email;throw`${m?"You":l} already ${m?"have":"has"} a desk booked`}return!0})()}_getNearbyResources(t,n,s,l){return(0,Z.Z)(function*(){const i=[];let d=s.filter(r=>r.id!==n&&r.map_id!==n);for(let r=0;r<l;r++){const u=yield(0,F.gV)(t,n,d.map(f=>f.map_id||f.id));u&&(i.push(s.find(f=>f.id===u||f.map_id===u)),d=d.filter(f=>f.id!==u&&f.map_id!==u))}return i})()}}return o.\u0275fac=function(t){return new(t||o)(e.LFG(P.F0),e.LFG(p.gb),e.LFG(Q.w7),e.LFG(C.uw))},o.\u0275prov=e.Yz7({token:o,factory:o.\u0275fac,providedIn:"root"}),o})();a(1022),a(7303)}}]);
//# sourceMappingURL=default-libs_bookings_src_index_ts.js.map