"use strict";(self.webpackChunkconcierge=self.webpackChunkconcierge||[]).push([["default-libs_bookings_src_index_ts"],{4099:(De,G,d)=>{d.d(G,{$N:()=>x,fy:()=>Ae,jT:()=>Me,FD:()=>Ie,gV:()=>E,F2:()=>F,FP:()=>we,km:()=>R,Fo:()=>xe,Wp:()=>Y}),d(3362);var e=d(3184),A=d(5758),v=d(3294),N=d(6362),z=d(7317),c=(d(9697),d(587));d(2306),d(4770),d(4683),d(4742);var B=d(8390);function de(t,n){if(1&t){const o=e.EpF();e.TgZ(0,"div",2),e.TgZ(1,"h2",3),e._uU(2,"COVID-19 Questionnaire"),e.qZA(),e.TgZ(3,"main",4),e.TgZ(4,"div",5),e.TgZ(5,"label"),e._uU(6," Have you travelled overseas within the last 14 days?"),e.TgZ(7,"span"),e._uU(8,"*"),e.qZA(),e.qZA(),e.TgZ(9,"mat-radio-group",6),e.TgZ(10,"mat-radio-button",7),e._uU(11,"Yes"),e.qZA(),e.TgZ(12,"mat-radio-button",7),e._uU(13,"No"),e.qZA(),e.qZA(),e.qZA(),e.TgZ(14,"div",5),e.TgZ(15,"label"),e._uU(16," Are you unwell or experiencing any cold or flu-like symptoms?"),e.TgZ(17,"span"),e._uU(18,"*"),e.qZA(),e.qZA(),e.TgZ(19,"mat-radio-group",8),e.TgZ(20,"mat-radio-button",7),e._uU(21,"Yes"),e.qZA(),e.TgZ(22,"mat-radio-button",7),e._uU(23,"No"),e.qZA(),e.qZA(),e.qZA(),e.TgZ(24,"div",9),e.TgZ(25,"label"),e._uU(26," Have you had contact with anyone with suspected COVID-19?"),e.TgZ(27,"span"),e._uU(28,"*"),e.qZA(),e.qZA(),e.TgZ(29,"mat-radio-group",10),e.TgZ(30,"mat-radio-button",7),e._uU(31,"Yes"),e.qZA(),e.TgZ(32,"mat-radio-button",7),e._uU(33,"No"),e.qZA(),e.qZA(),e.qZA(),e.qZA(),e.TgZ(34,"footer",11),e.TgZ(35,"button",12),e.NdJ("click",function(){return e.CHM(o),e.oxw().submit()}),e._uU(36,"Submit"),e.qZA(),e.qZA(),e.TgZ(37,"button",13),e.TgZ(38,"i",14),e._uU(39,"close"),e.qZA(),e.qZA(),e.qZA()}if(2&t){const o=e.oxw();e.xp6(3),e.Q6J("formGroup",o.form),e.xp6(7),e.Q6J("value",!0),e.xp6(2),e.Q6J("value",!1),e.xp6(8),e.Q6J("value",!0),e.xp6(2),e.Q6J("value",!1),e.xp6(8),e.Q6J("value",!0),e.xp6(2),e.Q6J("value",!1)}}function ue(t,n){1&t&&(e.TgZ(0,"main",15),e.TgZ(1,"p",16),e._uU(2," Your request to work from the office has been rejected based on your response to the compulsory Covid-19 questions. Please feel free to submit a new request when circumstances change in a way that changes your answer to the questions. "),e.qZA(),e.TgZ(3,"button",13),e.TgZ(4,"i",14),e._uU(5,"close"),e.qZA(),e.qZA(),e.qZA())}let P=(()=>{class t{constructor(){this.event=new e.vpe}ngOnInit(){this.form=new c.cw({travelled:new c.NI("",[c.kI.required]),unwell:new c.NI("",[c.kI.required]),contact:new c.NI("",[c.kI.required])})}submit(){this.form.markAllAsTouched(),this.form.valid?Object.keys(this.form.value).find(o=>!0===this.form.value[o]||"true"===this.form.value[o])?this.failure=!0:this.event.emit({reason:"done"}):(0,v.cB)("All the questions must be answered")}}return t.\u0275fac=function(o){return new(o||t)},t.\u0275cmp=e.Xpm({type:t,selectors:[["desk-question-modal"]],outputs:{event:"event"},decls:3,vars:2,consts:[["class","relative",4,"ngIf","ngIfElse"],["fail_state",""],[1,"relative"],[1,"p-4","text-xl"],[1,"p-4",3,"formGroup"],[1,"flex","flex-col","mb-4"],["formControlName","travelled",1,"space-x-2"],[3,"value"],["formControlName","unwell",1,"space-x-2"],[1,"flex","flex-col"],["formControlName","contact",1,"space-x-2"],[1,"flex","justify-center","items-center","p-2"],["mat-button","",3,"click"],["close","","mat-icon-button","","mat-dialog-close",""],[1,"material-icons"],["failure","",1,"pt-8","relative"],[1,"p-4"]],template:function(o,s){if(1&o&&(e.YNc(0,de,40,7,"div",0),e.YNc(1,ue,6,0,"ng-template",null,1,e.W1O)),2&o){const i=e.MAs(2);e.Q6J("ngIf",!s.failure)("ngIfElse",i)}},directives:[N.O5,c.JL,c.sg,B.VQ,c.JJ,c.u,B.U0,z.lW,A.ZT],styles:["main[_ngcontent-%COMP%]{width:24rem;max-width:calc(100vw - 4.5rem)}[close][_ngcontent-%COMP%]{position:absolute;top:.5rem;right:.5rem}\n/*# sourceMappingURL=desk-questions-modal.component.ts-angular-inline--48.css.map*/"]}),t})();var w=d(4929),V=d(9481),ce=d(3619),C=d(3499),I=d(1810),D=d(2317),j=d(5148),me=d(8235),T=d(4505),Q=d(4139),J=d(7716),U=d(9128),ge=d(3298),q=d(9095),Z=d(6942),O=d(8759),he=d(823),$=d(5670),pe=d(3910),_e=d(5692),ve=d(8987),ke=d(5845),be=d(2757),ye=d(1233);class x{constructor(n={}){var o,s,i;this.id=n.id||"",this.asset_id=n.asset_id||"",this.asset_name=n.asset_name||(null===(o=n.extension_data)||void 0===o?void 0:o.asset_name)||"",this.zones=n.zones||[],this.booking_start=n.date/1e3||n.booking_start||(0,I.Z)((0,_e.Z)((0,D.Z)(Date.now(),5),{nearestTo:5})),this.booking_end=n.date/1e3+60*n.duration||n.booking_end||(0,I.Z)((0,D.Z)(1e3*this.booking_start,n.duration||60)),this.booking_type=n.booking_type||"",this.type=n.type||"booking",this.date=n.date||1e3*this.booking_start,this.duration=n.duration||Math.abs((0,ve.Z)(1e3*this.booking_start,1e3*this.booking_end)),this.timezone=n.timezone||Intl.DateTimeFormat().resolvedOptions().timeZone,this.user_email=n.user_email||"",this.user_id=n.user_id||"",this.user_name=n.user_name||"",this.title=n.title||"Desk booking",this.description=n.description||"",this.checked_in=!!n.checked_in,this.rejected=!!n.rejected,this.approved=!!n.approved,this.booked_by_id=n.booked_by_id||"",this.booked_by_name=n.booked_by_name||"",this.booked_by_email=n.booked_by_email||"",this.approver_id=n.approver_id||"",this.approver_email=n.approver_email||"",this.approver_name=n.approver_name||"",this.extension_data=n.extension_data||{},this.access=!!(null===(s=n.extension_data)||void 0===s?void 0:s.access),this.all_day=null!==(i=n.all_day)&&void 0!==i?i:this.duration>720,this.status=this.rejected?"declined":this.approved?"approved":"tentative";for(const r in n)r in this||(this.extension_data[r]=n[r]||this.extension_data[r])}toJSON(){const n=Object.assign({},this);return this.id||delete n.id,delete n.date,delete n.duration,n}get location(){return this.description}get is_today(){return(0,ke.Z)(this.date,new Date)}get is_done(){const n=new Date,o=this.all_day?(0,be.Z)(this.date,24):(0,D.Z)(this.date,this.duration);return(0,ye.Z)(n,o)}}var S=d(4922);function E(t,n,o=[]){return(0,w.mG)(this,void 0,void 0,function*(){const s=document.createElement("div");s.style.position="absolute",s.style.top="-9999px",s.style.width="1000px",s.style.height="1000px",document.body.appendChild(s);const i=yield(0,S.i9)({url:t,element:s}),r=(0,S.gA)(i),a=("string"==typeof n?r.mappings[n]:n)||{x:.5,y:.5};let g=10,m="";console.log("Desks:",o),console.log("Mappings:",r.mappings),console.log("Point:",a);for(const u of o){const{x:l,y:h}=r.mappings[u]||{x:2,y:2},p=Math.sqrt((l-a.x)*(l-a.x)+(h-a.y)*(h-a.y));console.log(`Desk ${u}:`,r.mappings[u],p),p<g&&(g=p,m=u)}return document.body.removeChild(s),(0,S.hX)(i),m})}var L=d(5038);const M="/api/staff/v1/bookings";function F(t){const n=(0,L.U)(t);return(0,C.U2M)(`${M}${n?"?"+n:""}`).pipe((0,Z.U)(o=>o.map(s=>new x(s))))}function xe(t){return(0,C.U2M)(`${M}/${encodeURIComponent(t)}`).pipe((0,Z.U)(n=>new x(n)))}function Y(t,n,o="patch"){return("patch"===o?C.r$K:C.gzd)(`${M}/${encodeURIComponent(t)}`,n).pipe((0,Z.U)(s=>new x(s)))}const R=t=>t.id?Y(t.id,t):function Ce(t){return(0,C.v_Q)(`${M}`,t).pipe((0,Z.U)(n=>new x(n)))}(t);function Me(t){return(0,C.v_Q)(`${M}/${encodeURIComponent(t)}/approve`,"").pipe((0,Z.U)(n=>new x(n)))}function we(t){return(0,C.v_Q)(`${M}/${encodeURIComponent(t)}/reject`,"").pipe((0,Z.U)(n=>new x(n)))}function Ie(t,n){const o=(0,L.U)({state:n});return(0,C.v_Q)(`${M}/${encodeURIComponent(t)}/check_in?${o}`,"").pipe((0,Z.U)(s=>new x(s)))}const Te=["book/desks"];let Ae=(()=>{class t extends v.KG{constructor(o,s,i,r){super(),this._router=o,this._settings=s,this._org=i,this._dialog=r,this._view=new T.X("form"),this._options=new T.X({type:"desk"}),this._form=new T.X(null),this._form_value=new T.X({}),this._booking=new T.X(null),this._loading=new T.X(""),this.last_success=new x(JSON.parse(sessionStorage.getItem("PLACEOS.last_booked_booking")||"{}")),this.loading=this._loading.asObservable(),this.options=this._options.pipe((0,U.d)(1)),this.assets=this.options.pipe(function fe(t,n){return(0,ge.x)((o,s)=>n?n(o[t],s[t]):o[t]===s[t])}("zone_id"),(0,q.w)(({type:a})=>this._org.building&&"desk"===a?(this._loading.next("Loading desks..."),(0,C.BW_)(this._org.building.id,{name:"desks"}).pipe((0,Z.U)(g=>(0,v.xH)(g.map(m=>{var u,l;return((null===(u=m.metadata.desks)||void 0===u?void 0:u.details)instanceof Array?null===(l=m.metadata.desks)||void 0===l?void 0:l.details:[]).map(h=>Object.assign(Object.assign({},h),{zone:m.zone}))}))))):(0,Q.of)([])),(0,O.b)(()=>this._loading.next("")),(0,U.d)(1)),this.features=this.assets.pipe((0,Z.U)(a=>{var g;const m=[];for(const u of a)null===(g=u.features)||void 0===g||g.forEach(l=>m.push(l));return(0,v.Tw)(m).sort((u,l)=>u.localeCompare(l))}),(0,U.d)(1)),this.available_assets=(0,J.aj)([this.options,this.assets,this._form_value]).pipe((0,he.b)(500),(0,O.b)(([{type:a}])=>this._loading.next(`Checking ${a} availability...`)),(0,q.w)(([a,g,m])=>F({period_start:(0,I.Z)(m.date),period_end:(0,I.Z)((0,D.Z)(m.date,m.duration||1440)),type:a.type,zones:a.zone_id}).pipe((0,Z.U)(u=>g.filter(l=>{var h,p,k;return!1!==l.bookable&&(!a.features||(null===(h=a.features)||void 0===h?void 0:h.every(f=>l.features.includes(f))))&&(!a.zone_id||a.zone_id===(null===(p=l.zone)||void 0===p?void 0:p.id)||a.zone_id===(null===(k=l.zone)||void 0===k?void 0:k.parent_id))&&!u.find(f=>f.asset_id===l.id&&"declined"!==f.status)})))),(0,O.b)(()=>this._loading.next("")),(0,U.d)(1)),this.grouped_availability=(0,J.aj)([this.options,this.available_assets]).pipe((0,Z.U)(([a,g])=>{var m;const u=[],l=[...g].sort((p,k)=>{var f,_,y;return null===(_=null===(f=p.zone)||void 0===f?void 0:f.id)||void 0===_?void 0:_.localeCompare(null===(y=k.zone)||void 0===y?void 0:y.id)}),h=(null===(m=a.members)||void 0===m?void 0:m.length)?a.members:[(0,v.ar)()];for(;l.length;){const p=[];let k=l.pop();for(;p.length<h.length&&(!p.length||p.find(f=>{var _,y;return(null===(_=f.zone)||void 0===_?void 0:_.id)===(null===(y=k.zone)||void 0===y?void 0:y.id)}));)p.push(k),k=l.pop();p.length<h.length||u.push(p)}return u})),this.subscription("router.bookings",this._router.events.subscribe(a=>{a instanceof V.m2&&!Te.find(g=>a.url.includes(g))&&this.clearForm()})),this._org.initialised.pipe((0,$.P)(a=>a)).subscribe(()=>this.setOptions({}))}get view(){return this._view.getValue()}get form(){return this._form.getValue()}get booking(){return this._booking.getValue()}newForm(o=new x){this._form.next(function Ze(t={}){var n,o;const s=new c.cw({id:new c.NI(t.id||""),date:new c.NI(t.date,[]),all_day:new c.NI(null!==(n=t.all_day)&&void 0!==n&&n),duration:new c.NI(t.duration),booking_type:new c.NI(t.booking_type),zones:new c.NI(t.zones),title:new c.NI(t.title),description:new c.NI(t.description),asset_id:new c.NI(t.asset_id),asset_name:new c.NI(t.description),map_id:new c.NI(null===(o=t.extension_data)||void 0===o?void 0:o.map_id),user:new c.NI((0,v.ar)()),user_id:new c.NI(t.user_id),user_email:new c.NI(t.user_email),booked_by:new c.NI((0,v.ar)()),booked_by_id:new c.NI(t.booked_by_id),booked_by_email:new c.NI(t.booked_by_email)});return s.valueChanges.subscribe(i=>{const r=i.user,a=i.booked_by;(a||r)&&s.patchValue({user_id:r.id||a.id,user_email:r.email||a.id,booked_by_id:a.id,booked_by_email:a.email},{emitEvent:!1})}),s}(o)),this.subscription("form_change",this._form.getValue().valueChanges.subscribe(()=>this.storeForm())),this._booking.next(o),this._options.next({type:this._options.getValue().type})}setView(o){this._view.next(o)}setOptions(o){this._options.next(Object.assign(Object.assign({},this._options.getValue()),o))}resetForm(){this._form.getValue()||this.newForm();const o=this._booking.getValue();this._form.getValue().patchValue(Object.assign(Object.assign({},o||{}),(null==o?void 0:o.extension_data)||{})),this._options.next({type:this._options.getValue().type})}clearForm(){sessionStorage.removeItem("PLACEOS.booking_form"),sessionStorage.removeItem("PLACEOS.booking_form_options"),this.newForm()}storeForm(){var o,s;sessionStorage.setItem("PLACEOS.booking_form",JSON.stringify((null===(o=this._form.getValue())||void 0===o?void 0:o.value)||{})),sessionStorage.setItem("PLACEOS.booking_form_filters",JSON.stringify(this._options.getValue()||{})),this._form_value.next((null===(s=this._form.getValue())||void 0===s?void 0:s.value)||{})}loadForm(){var o;this._form.getValue()||this.newForm(),this._form.getValue().patchValue(Object.assign({},JSON.parse(sessionStorage.getItem("PLACEOS.booking_form")||"{}"))),this.setOptions(Object.assign({zone_id:null===(o=this._org.building)||void 0===o?void 0:o.id},JSON.parse(sessionStorage.getItem("PLACEOS.booking_form_filters")||"{}")))}confirmPost(){return(0,w.mG)(this,void 0,void 0,function*(){yield this.checkQuestions();const o=this._options.getValue(),s=this._form.getValue();let i=`Would you like to book the ${o.type} ${s.value.asset_name} for ${(0,j.Z)(s.value.date,"dd MMM yyyy")}${s.value.duration<720?" at "+(0,j.Z)(s.value.date,"h:mm a"):""}`;o.group&&(i=`${i}.<br>You group members will be assigned desks nearby your selected desk.`);const r=yield(0,v._5)({title:`Book ${o.type}`,content:i,icon:{content:"event_available"}},this._dialog);if("done"!==(null==r?void 0:r.reason))throw"User cancelled";r.loading("Performing booking request..."),o.group?yield this.postFormForGroup().catch(a=>{throw(0,v.cB)(a),r.close(),a}):yield this.postForm().catch(a=>{throw(0,v.cB)(a),r.close(),a}),r.close()})}postForm(o=!1){var s;return(0,w.mG)(this,void 0,void 0,function*(){const i=this._form.getValue();if(!i)throw"No form for booking";if(!i.valid)throw`Some form fields are invalid. [${(0,v.RD)(i).join(", ")}]`;o||(yield this.checkResourceAvailable(i.value,this._options.getValue().type)),(i.value.duration>1380||i.value.all_day)&&i.patchValue({date:(0,me.Z)(i.value.date,{hours:12,minutes:0}),duration:60});const r=yield R(new x(i.value)).toPromise(),{booking_type:a}=i.value;return this.clearForm(),null===(s=this._form.getValue())||void 0===s||s.patchValue({booking_type:a}),this.last_success=r,sessionStorage.setItem("PLACEOS.last_booked_booking",JSON.stringify(r)),this.setView("success"),r})}postFormForGroup(){var o,s,i;return(0,w.mG)(this,void 0,void 0,function*(){const{members:r,group:a,type:g}=this._options.getValue();if(!a)throw"No group available to book for";const m=r.filter(_=>_.email!==(0,v.ar)().email);if(m.length<=0)throw"No members in your group to book for.";const u=this._form.getValue().value,l=yield this.available_assets.pipe((0,pe.q)(1)).toPromise(),h=l.find(_=>_.id===u.asset_id||_.map_id===u.asset_id),p=this._org.levelWithID([null===(o=h.zone)||void 0===o?void 0:o.id]),k=[h,...yield this._getNearbyResources(p.map_id,u.asset_id,l,m.length)];console.log("Selected Assets:",k);const f=[(0,v.ar)(),...m];yield Promise.all(f.map((_,y)=>this.checkResourceAvailable(Object.assign(Object.assign({},u),{asset_id:k[y].map_id||k[y].id,user_email:_.email}),g)));for(let _=0;_<f.length;_++){const y=f[_],b=k[_];this._form.getValue().patchValue(Object.assign(Object.assign({},u),{user:y,asset_id:null==b?void 0:b.id,asset_name:b.name,map_id:(null==b?void 0:b.map_id)||(null==b?void 0:b.id),description:b.name,zones:b.zone?[null===(s=b.zone)||void 0===s?void 0:s.parent_id,null===(i=b.zone)||void 0===i?void 0:i.id]:[]})),console.log("Form Value:",this._form.getValue().value),this.postForm(!0)}})}checkQuestions(){return(0,w.mG)(this,void 0,void 0,function*(){if(!1!==this._settings.get("app.desks.ignore_questions"))return;const o=this._dialog.open(P),s=yield Promise.race([o.componentInstance.event.pipe((0,$.P)(r=>"done"===r.reason)).toPromise(),o.afterClosed().toPromise()]);if("done"!==(null==s?void 0:s.reason))throw"User cancelled";const i=o.componentInstance.form.value;for(const r in i)if(i[r])throw"User failed questionaire";o.close()})}checkResourceAvailable({asset_id:o,date:s,duration:i,user_email:r},a){var g;return(0,w.mG)(this,void 0,void 0,function*(){const m=yield F({period_start:(0,I.Z)(s),period_end:(0,I.Z)(s+60*i*1e3),type:a}).toPromise();if(m.find(l=>l.asset_id===o))throw`${o} is not available at the selected time`;const u=null!==(g=this._settings.get(`app.booking.allowed_daily_${a}_count`))&&void 0!==g?g:1;if(u>0&&m.filter(l=>{var h;return l.user_email===(r||(null===(h=(0,v.ar)())||void 0===h?void 0:h.email))&&"declined"!==l.status}).length>=u){const l=r===(0,v.ar)().email;throw`${l?"You":r} already ${l?"have":"has"} a desk booked`}return!0})}_getNearbyResources(o,s,i,r){return(0,w.mG)(this,void 0,void 0,function*(){const a=[];let g=i.filter(m=>m.id!==s&&m.map_id!==s);console.log("Assets:",i,g,s);for(let m=0;m<r;m++){const u=yield E(o,s,g.map(l=>l.map_id||l.id));u&&(a.push(i.find(l=>l.id===u||l.map_id===u)),g=g.filter(l=>l.id!==u&&l.map_id!==u)),console.log("Asset List:",g)}return a})}}return t.\u0275fac=function(o){return new(o||t)(e.LFG(V.F0),e.LFG(v.gb),e.LFG(ce.w7),e.LFG(A.uw))},t.\u0275prov=e.Yz7({token:t,factory:t.\u0275fac,providedIn:"root"}),t})()}}]);
//# sourceMappingURL=default-libs_bookings_src_index_ts.js.map