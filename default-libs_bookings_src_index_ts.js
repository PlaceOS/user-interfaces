"use strict";(self.webpackChunkconcierge=self.webpackChunkconcierge||[]).push([["default-libs_bookings_src_index_ts"],{3231:(we,E,a)=>{a.d(E,{$N:()=>k,fy:()=>Me,jT:()=>Ze,FD:()=>ye,F2:()=>O,FP:()=>xe,km:()=>$,Fo:()=>ve}),a(8261);var e=a(4001),T=a(6298),p=a(3867),U=a(8267),S=a(7752),r=(a(8641),a(8346));a(7104),a(3981),a(8482),a(9372);var F=a(7435);function ie(o,n){if(1&o){const t=e.EpF();e.TgZ(0,"div",2),e.TgZ(1,"h2",3),e._uU(2,"COVID-19 Questionnaire"),e.qZA(),e.TgZ(3,"main",4),e.TgZ(4,"div",5),e.TgZ(5,"label"),e._uU(6," Have you travelled overseas within the last 14 days?"),e.TgZ(7,"span"),e._uU(8,"*"),e.qZA(),e.qZA(),e.TgZ(9,"mat-radio-group",6),e.TgZ(10,"mat-radio-button",7),e._uU(11,"Yes"),e.qZA(),e.TgZ(12,"mat-radio-button",7),e._uU(13,"No"),e.qZA(),e.qZA(),e.qZA(),e.TgZ(14,"div",5),e.TgZ(15,"label"),e._uU(16," Are you unwell or experiencing any cold or flu-like symptoms?"),e.TgZ(17,"span"),e._uU(18,"*"),e.qZA(),e.qZA(),e.TgZ(19,"mat-radio-group",8),e.TgZ(20,"mat-radio-button",7),e._uU(21,"Yes"),e.qZA(),e.TgZ(22,"mat-radio-button",7),e._uU(23,"No"),e.qZA(),e.qZA(),e.qZA(),e.TgZ(24,"div",9),e.TgZ(25,"label"),e._uU(26," Have you had contact with anyone with suspected COVID-19?"),e.TgZ(27,"span"),e._uU(28,"*"),e.qZA(),e.qZA(),e.TgZ(29,"mat-radio-group",10),e.TgZ(30,"mat-radio-button",7),e._uU(31,"Yes"),e.qZA(),e.TgZ(32,"mat-radio-button",7),e._uU(33,"No"),e.qZA(),e.qZA(),e.qZA(),e.qZA(),e.TgZ(34,"footer",11),e.TgZ(35,"button",12),e.NdJ("click",function(){return e.CHM(t),e.oxw().submit()}),e._uU(36,"Submit"),e.qZA(),e.qZA(),e.TgZ(37,"button",13),e.TgZ(38,"i",14),e._uU(39,"close"),e.qZA(),e.qZA(),e.qZA()}if(2&o){const t=e.oxw();e.xp6(3),e.Q6J("formGroup",t.form),e.xp6(7),e.Q6J("value",!0),e.xp6(2),e.Q6J("value",!1),e.xp6(8),e.Q6J("value",!0),e.xp6(2),e.Q6J("value",!1),e.xp6(8),e.Q6J("value",!0),e.xp6(2),e.Q6J("value",!1)}}function ae(o,n){1&o&&(e.TgZ(0,"main",15),e.TgZ(1,"p",16),e._uU(2," Your request to work from the office has been rejected based on your response to the compulsory Covid-19 questions. Please feel free to submit a new request when circumstances change in a way that changes your answer to the questions. "),e.qZA(),e.TgZ(3,"button",13),e.TgZ(4,"i",14),e._uU(5,"close"),e.qZA(),e.qZA(),e.qZA())}let B=(()=>{class o{constructor(){this.event=new e.vpe}ngOnInit(){this.form=new r.cw({travelled:new r.NI("",[r.kI.required]),unwell:new r.NI("",[r.kI.required]),contact:new r.NI("",[r.kI.required])})}submit(){this.form.markAllAsTouched(),this.form.valid?Object.keys(this.form.value).find(t=>!0===this.form.value[t]||"true"===this.form.value[t])?this.failure=!0:this.event.emit({reason:"done"}):(0,p.cB)("All the questions must be answered")}}return o.\u0275fac=function(t){return new(t||o)},o.\u0275cmp=e.Xpm({type:o,selectors:[["desk-question-modal"]],outputs:{event:"event"},decls:3,vars:2,consts:[["class","relative",4,"ngIf","ngIfElse"],["fail_state",""],[1,"relative"],[1,"p-4","text-xl"],[1,"p-4",3,"formGroup"],[1,"flex","flex-col","mb-4"],["formControlName","travelled",1,"space-x-2"],[3,"value"],["formControlName","unwell",1,"space-x-2"],[1,"flex","flex-col"],["formControlName","contact",1,"space-x-2"],[1,"flex","justify-center","items-center","p-2"],["mat-button","",3,"click"],["close","","mat-icon-button","","mat-dialog-close",""],[1,"material-icons"],["failure","",1,"pt-8","relative"],[1,"p-4"]],template:function(t,i){if(1&t&&(e.YNc(0,ie,40,7,"div",0),e.YNc(1,ae,6,0,"ng-template",null,1,e.W1O)),2&t){const s=e.MAs(2);e.Q6J("ngIf",!i.failure)("ngIfElse",s)}},directives:[U.O5,r.JL,r.sg,F.VQ,r.JJ,r.u,F.U0,S.lW,T.ZT],styles:["main[_ngcontent-%COMP%]{width:24rem;max-width:calc(100vw - 4.5rem)}[close][_ngcontent-%COMP%]{position:absolute;top:.5rem;right:.5rem}\n/*# sourceMappingURL=desk-questions-modal.component.ts-angular-inline--48.css.map*/"]}),o})();var D=a(8806),Q=a(1733),re=a(4555),Z=a(8222),M=a(373),I=a(5269),J=a(6613),le=a(3592),w=a(1119),q=a(8252),z=a(899),A=a(8537),de=a(8785),P=a(9026),v=a(8377),N=a(5029),ce=a(9820),j=a(4452),me=a(8945),ge=a(3375),fe=a(9717),_e=a(8730),he=a(8069);class k{constructor(n={}){var t,i;this.id=n.id||"",this.asset_id=n.asset_id||"",this.zones=n.zones||[],this.booking_start=n.date/1e3||n.booking_start||(0,M.Z)((0,me.Z)((0,I.Z)(Date.now(),5),{nearestTo:5})),this.booking_end=n.date/1e3+60*n.duration||n.booking_end||(0,M.Z)((0,I.Z)(1e3*this.booking_start,n.duration||60)),this.booking_type=n.booking_type||"",this.type=n.type||"booking",this.date=n.date||1e3*this.booking_start,this.duration=n.duration||Math.abs((0,ge.Z)(1e3*this.booking_start,1e3*this.booking_end)),this.timezone=n.timezone||Intl.DateTimeFormat().resolvedOptions().timeZone,this.user_email=n.user_email||"",this.user_id=n.user_id||"",this.user_name=n.user_name||"",this.title=n.title||"Desk booking",this.description=n.description||"",this.checked_in=!!n.checked_in,this.rejected=!!n.rejected,this.approved=!!n.approved,this.approver_id=n.approver_id||"",this.approver_email=n.approver_email||"",this.approver_name=n.approver_name||"",this.extension_data=n.extension_data||{},this.access=!!(null===(t=n.extension_data)||void 0===t?void 0:t.access),this.all_day=null!==(i=n.all_day)&&void 0!==i?i:this.duration>720,this.status=this.rejected?"declined":this.approved?"approved":"tentative";for(const s in n)s in this||(this.extension_data[s]=n[s]||this.extension_data[s])}toJSON(){const n=Object.assign({},this);return this.id||delete n.id,delete n.date,delete n.duration,n}get location(){return this.description}get is_today(){return(0,fe.Z)(this.date,new Date)}get is_done(){const n=new Date,t=this.all_day?(0,_e.Z)(this.date,24):(0,I.Z)(this.date,this.duration);return(0,he.Z)(n,t)}}var V=a(1378);const x="/api/staff/v1/bookings";function O(o){const n=(0,V.U)(o);return(0,Z.U2M)(`${x}${n?"?"+n:""}`).pipe((0,v.U)(t=>t.map(i=>new k(i))))}function ve(o){return(0,Z.U2M)(`${x}/${encodeURIComponent(o)}`).pipe((0,v.U)(n=>new k(n)))}const $=o=>o.id?function(o,n,t="patch"){return("patch"===t?Z.r$K:Z.gzd)(`${x}/${encodeURIComponent(o)}`,n).pipe((0,v.U)(i=>new k(i)))}(o.id,o):function(o){return(0,Z.v_Q)(`${x}`,o).pipe((0,v.U)(n=>new k(n)))}(o);function Ze(o){return(0,Z.v_Q)(`${x}/${encodeURIComponent(o)}/approve`,"").pipe((0,v.U)(n=>new k(n)))}function xe(o){return(0,Z.v_Q)(`${x}/${encodeURIComponent(o)}/reject`,"").pipe((0,v.U)(n=>new k(n)))}function ye(o,n){const t=(0,V.U)({state:n});return(0,Z.v_Q)(`${x}/${encodeURIComponent(o)}/check_in?${t}`,"").pipe((0,v.U)(i=>new k(i)))}const Ce=["book/desks"];let Me=(()=>{class o extends p.KG{constructor(t,i,s,c){super(),this._router=t,this._settings=i,this._org=s,this._dialog=c,this._view=new w.X("form"),this._options=new w.X({type:"desk"}),this._form=new w.X(null),this._form_value=new w.X({}),this._booking=new w.X(null),this._loading=new w.X(""),this.last_success=new k(JSON.parse(sessionStorage.getItem("PLACEOS.last_booked_booking")||"{}")),this.loading=this._loading.asObservable(),this.options=this._options.pipe((0,A.d)(1)),this.assets=this.options.pipe(function(o,n){return(0,de.x)((t,i)=>t[o]===i[o])}("zone_id"),(0,P.w)(({type:l})=>this._org.building&&"desk"===l?(this._loading.next("Loading desks..."),(0,Z.BW_)(this._org.building.id,{name:"desks"}).pipe((0,v.U)(g=>(0,p.xH)(g.map(u=>{var f,d;return((null===(f=u.metadata.desks)||void 0===f?void 0:f.details)instanceof Array?null===(d=u.metadata.desks)||void 0===d?void 0:d.details:[]).map(_=>Object.assign(Object.assign({},_),{zone:u.zone}))}))))):(0,q.of)([])),(0,N.b)(()=>this._loading.next("")),(0,A.d)(1)),this.features=this.assets.pipe((0,v.U)(l=>{var g;const u=[];for(const f of l)null===(g=f.features)||void 0===g||g.forEach(d=>u.push(d));return(0,p.Tw)(u).sort((f,d)=>f.localeCompare(d))}),(0,A.d)(1)),this.available_assets=(0,z.aj)([this.options,this.assets,this._form_value]).pipe((0,ce.b)(500),(0,N.b)(([{type:l}])=>this._loading.next(`Checking ${l} availability...`)),(0,P.w)(([l,g,u])=>O({period_start:(0,M.Z)(u.date),period_end:(0,M.Z)((0,I.Z)(u.date,u.duration||1440)),type:l.type,zones:l.zone_id}).pipe((0,v.U)(f=>g.filter(d=>{var _,h,b;return!1!==d.bookable&&(!l.features||(null===(_=l.features)||void 0===_?void 0:_.every(m=>d.features.includes(m))))&&(!l.zone_id||l.zone_id===(null===(h=d.zone)||void 0===h?void 0:h.id)||l.zone_id===(null===(b=d.zone)||void 0===b?void 0:b.parent_id))&&!f.find(m=>m.asset_id===d.id&&"declined"!==m.status)})))),(0,N.b)(()=>this._loading.next("")),(0,A.d)(1)),this.grouped_availability=(0,z.aj)([this.options,this.available_assets]).pipe((0,v.U)(([l,g])=>{var u;const f=[],d=[...g].sort((h,b)=>{var m,y,C;return null===(y=null===(m=h.zone)||void 0===m?void 0:m.id)||void 0===y?void 0:y.localeCompare(null===(C=b.zone)||void 0===C?void 0:C.id)}),_=(null===(u=l.members)||void 0===u?void 0:u.length)?l.members:[(0,p.ar)()];for(;d.length;){const h=[];let b=d.pop();for(;h.length<_.length&&(!h.length||h.find(m=>{var y,C;return(null===(y=m.zone)||void 0===y?void 0:y.id)===(null===(C=b.zone)||void 0===C?void 0:C.id)}));)h.push(b),b=d.pop();h.length<_.length||f.push(h)}return f})),this.subscription("router.bookings",this._router.events.subscribe(l=>{l instanceof Q.m2&&!Ce.find(g=>l.url.includes(g))&&this.clearForm()})),this._org.initialised.pipe((0,j.P)(l=>l)).subscribe(()=>this.setOptions({}))}get view(){return this._view.getValue()}get form(){return this._form.getValue()}get booking(){return this._booking.getValue()}newForm(t=new k){this._form.next(function(o={}){const n=new r.cw({id:new r.NI(o.id||""),date:new r.NI(o.date,[]),duration:new r.NI(o.duration),booking_type:new r.NI(o.booking_type),zones:new r.NI(o.zones),title:new r.NI(o.title),description:new r.NI(o.description),asset_id:new r.NI(o.asset_id),asset_name:new r.NI(o.description),map_id:new r.NI(o.extension_data.map_id),user:new r.NI((0,p.ar)()),user_id:new r.NI(o.user_id),user_email:new r.NI(o.user_email),booked_by:new r.NI((0,p.ar)()),booked_by_id:new r.NI(o.booked_by_id),booked_by_email:new r.NI(o.booked_by_email)});return n.valueChanges.subscribe(t=>{const i=t.user,s=t.booked_by;(s||i)&&n.patchValue({user_id:i.id||s.id,user_email:i.email||s.id,booked_by_id:s.id,booked_by_email:s.email},{emitEvent:!1})}),n}(t)),this.subscription("form_change",this._form.getValue().valueChanges.subscribe(()=>this.storeForm())),this._booking.next(t),this._options.next({type:this._options.getValue().type})}setView(t){this._view.next(t)}setOptions(t){this._options.next(Object.assign(Object.assign({},this._options.getValue()),t))}resetForm(){this._form.getValue()||this.newForm();const t=this._booking.getValue();this._form.getValue().patchValue(Object.assign(Object.assign({},t||{}),(null==t?void 0:t.extension_data)||{})),this._options.next({type:this._options.getValue().type})}clearForm(){sessionStorage.removeItem("PLACEOS.booking_form"),sessionStorage.removeItem("PLACEOS.booking_form_options"),this.newForm()}storeForm(){var t,i;sessionStorage.setItem("PLACEOS.booking_form",JSON.stringify((null===(t=this._form.getValue())||void 0===t?void 0:t.value)||{})),sessionStorage.setItem("PLACEOS.booking_form_filters",JSON.stringify(this._options.getValue()||{})),this._form_value.next((null===(i=this._form.getValue())||void 0===i?void 0:i.value)||{})}loadForm(){this._form.getValue()||this.newForm(),this._form.getValue().patchValue(Object.assign({},JSON.parse(sessionStorage.getItem("PLACEOS.booking_form")||"{}"))),this.setOptions(Object.assign({zone_id:this._org.building.id},JSON.parse(sessionStorage.getItem("PLACEOS.booking_form_filters")||"{}")))}confirmPost(){return(0,D.mG)(this,void 0,void 0,function*(){yield this.checkQuestions();const t=this._options.getValue(),i=this._form.getValue(),s=yield(0,p._5)({title:`Book ${t.type}`,content:`Would you like to book the ${t.type} ${i.value.asset_name} for ${(0,J.Z)(i.value.date,"dd MMM yyyy")}${i.value.duration<720?" at "+(0,J.Z)(i.value.date,"h:mm a"):""}`,icon:{content:"event_available"}},this._dialog);if("done"!==(null==s?void 0:s.reason))throw"User cancelled";s.loading("Performing booking request..."),yield this.postForm().catch(c=>{throw(0,p.cB)(c),s.close(),c}),s.close()})}postForm(){var t,i;return(0,D.mG)(this,void 0,void 0,function*(){const s=this._form.getValue();if(!s)throw"No form for booking";if(!s.valid)throw`Some form fields are invalid. [${(0,p.RD)(s).join(", ")}]`;const c=s.get("asset_id").value,l=yield O({period_start:(0,M.Z)(s.value.date),period_end:(0,M.Z)(s.value.date+60*s.value.duration*1e3),type:this._options.getValue().type}).toPromise();if(l.find(d=>d.asset_id===c))throw`${c} is not available at the selected time`;const g=null!==(t=this._settings.get(`app.booking.allowed_daily_${this._options.getValue().type}_count`))&&void 0!==t?t:1;if(g>0&&l.filter(d=>{var _;return d.user_email===(s.value.user_email||(null===(_=(0,p.ar)())||void 0===_?void 0:_.email))&&"declined"!==d.status}).length>=g)throw"You already have a desk booked";(s.value.duration>1380||s.value.all_day)&&s.patchValue({date:(0,le.Z)(s.value.date,{hours:12,minutes:0}),duration:60});const u=yield $(new k(s.value)).toPromise(),{booking_type:f}=s.value;return this.clearForm(),null===(i=this._form.getValue())||void 0===i||i.patchValue({booking_type:f}),this.last_success=u,sessionStorage.setItem("PLACEOS.last_booked_booking",JSON.stringify(u)),this.setView("success"),u})}checkQuestions(){return(0,D.mG)(this,void 0,void 0,function*(){if(!1!==this._settings.get("app.desks.ignore_questions"))return;const t=this._dialog.open(B),i=yield Promise.race([t.componentInstance.event.pipe((0,j.P)(c=>"done"===c.reason)).toPromise(),t.afterClosed().toPromise()]);if("done"!==(null==i?void 0:i.reason))throw"User cancelled";const s=t.componentInstance.form.value;for(const c in s)if(s[c])throw"User failed questionaire";t.close()})}}return o.\u0275fac=function(t){return new(t||o)(e.LFG(Q.F0),e.LFG(p.gb),e.LFG(re.w7),e.LFG(T.uw))},o.\u0275prov=e.Yz7({token:o,factory:o.\u0275fac,providedIn:"root"}),o})()}}]);
//# sourceMappingURL=default-libs_bookings_src_index_ts.js.map