"use strict";(self.webpackChunkconcierge=self.webpackChunkconcierge||[]).push([["default-libs_bookings_src_index_ts"],{9447:(Te,R,l)=>{l.d(R,{$N:()=>C.$,fy:()=>$,jT:()=>v.jT,FD:()=>v.FD,gV:()=>j,F2:()=>v.F2,FP:()=>v.FP,km:()=>v.km,Fo:()=>v.Fo,Wp:()=>v.Wp}),l(6850);var e=l(2560),I=l(1484),_=l(1506),y=l(4666),r=l(2508),F=(l(5074),l(1267),l(4522));l(1708),l(2306),l(9697);var J=l(2922);function ie(o,a){if(1&o){const t=e.EpF();e.TgZ(0,"div",2)(1,"h2",3),e._uU(2,"COVID-19 Questionnaire"),e.qZA(),e.TgZ(3,"main",4)(4,"div",5)(5,"label"),e._uU(6," Have you travelled overseas within the last 14 days?"),e.TgZ(7,"span"),e._uU(8,"*"),e.qZA()(),e.TgZ(9,"mat-radio-group",6)(10,"mat-radio-button",7),e._uU(11,"Yes"),e.qZA(),e.TgZ(12,"mat-radio-button",7),e._uU(13,"No"),e.qZA()()(),e.TgZ(14,"div",5)(15,"label"),e._uU(16," Are you unwell or experiencing any cold or flu-like symptoms?"),e.TgZ(17,"span"),e._uU(18,"*"),e.qZA()(),e.TgZ(19,"mat-radio-group",8)(20,"mat-radio-button",7),e._uU(21,"Yes"),e.qZA(),e.TgZ(22,"mat-radio-button",7),e._uU(23,"No"),e.qZA()()(),e.TgZ(24,"div",9)(25,"label"),e._uU(26," Have you had contact with anyone with suspected COVID-19?"),e.TgZ(27,"span"),e._uU(28,"*"),e.qZA()(),e.TgZ(29,"mat-radio-group",10)(30,"mat-radio-button",7),e._uU(31,"Yes"),e.qZA(),e.TgZ(32,"mat-radio-button",7),e._uU(33,"No"),e.qZA()()()(),e.TgZ(34,"footer",11)(35,"button",12),e.NdJ("click",function(){e.CHM(t);const s=e.oxw();return e.KtG(s.submit())}),e._uU(36,"Submit"),e.qZA()(),e.TgZ(37,"button",13)(38,"i",14),e._uU(39,"close"),e.qZA()()()}if(2&o){const t=e.oxw();e.xp6(3),e.Q6J("formGroup",t.form),e.xp6(7),e.Q6J("value",!0),e.xp6(2),e.Q6J("value",!1),e.xp6(8),e.Q6J("value",!0),e.xp6(2),e.Q6J("value",!1),e.xp6(8),e.Q6J("value",!0),e.xp6(2),e.Q6J("value",!1)}}function ae(o,a){1&o&&(e.TgZ(0,"main",15)(1,"p",16),e._uU(2," Your request to work from the office has been rejected based on your response to the compulsory Covid-19 questions. Please feel free to submit a new request when circumstances change in a way that changes your answer to the questions. "),e.qZA(),e.TgZ(3,"button",13)(4,"i",14),e._uU(5,"close"),e.qZA()()())}let Q=(()=>{class o{constructor(){this.event=new e.vpe,this.form=new r.cw({travelled:new r.NI(!1),unwell:new r.NI(!1),contact:new r.NI(!1)})}submit(){this.form.markAllAsTouched(),Object.keys(this.form.value).find(t=>!0===this.form.value[t]||"true"===this.form.value[t])?this.failure=!0:this.event.emit({reason:"done"})}}return o.\u0275fac=function(t){return new(t||o)},o.\u0275cmp=e.Xpm({type:o,selectors:[["desk-question-modal"]],outputs:{event:"event"},decls:3,vars:2,consts:[["class","relative",4,"ngIf","ngIfElse"],["fail_state",""],[1,"relative"],[1,"p-4","text-xl"],[1,"p-4",3,"formGroup"],[1,"flex","flex-col","mb-4"],["formControlName","travelled",1,"space-x-2"],[3,"value"],["formControlName","unwell",1,"space-x-2"],[1,"flex","flex-col"],["formControlName","contact",1,"space-x-2"],[1,"flex","justify-center","items-center","p-2"],["mat-button","",3,"click"],["close","","mat-icon-button","","mat-dialog-close",""],[1,"material-icons"],["failure","",1,"pt-8","relative"],[1,"p-4"]],template:function(t,n){if(1&t&&(e.YNc(0,ie,40,7,"div",0),e.YNc(1,ae,6,0,"ng-template",null,1,e.W1O)),2&t){const s=e.MAs(2);e.Q6J("ngIf",!n.failure)("ngIfElse",s)}},dependencies:[y.O5,r.JJ,r.JL,r.sg,r.u,J.VQ,J.U0,F.lW,I.ZT],styles:["main[_ngcontent-%COMP%]{width:24rem;max-width:calc(100vw - 4.5rem)}[close][_ngcontent-%COMP%]{position:absolute;top:.5rem;right:.5rem}\n/*# sourceMappingURL=desk-questions-modal.component.ts-angular-inline--57.css.map*/"]}),o})();var b=l(1670),E=l(3619),z=l(9885),re=l(3690),w=l(1810),le=l(2317),P=l(5148),de=l(8235),Z=l(4505),Y=l(4139),B=l(7716),T=l(9128),ce=l(3298),q=l(9095),M=l(6942),N=l(8759),ue=l(823),L=l(5670),fe=l(3910),C=l(6962),ge=l(8426),A=l(4922);function G(o=new C.$){const a=new r.cw({id:new r.NI(o.id||""),date:new r.NI(o.date,[r.kI.required]),all_day:new r.NI(o.all_day??!1),duration:new r.NI(o.duration,[ge.W]),booking_type:new r.NI(o.booking_type),zones:new r.NI(o.zones),title:new r.NI(o.title),description:new r.NI(o.description),booking_asset:new r.NI(null),asset_id:new r.NI(o.asset_id,[r.kI.required]),asset_name:new r.NI(o.description),assets:new r.NI(o.extension_data?.assets||[]),map_id:new r.NI(o.extension_data?.map_id),user:new r.NI((0,_.ar)()),user_id:new r.NI(o.user_id),user_email:new r.NI(o.user_email),booked_by:new r.NI((0,_.ar)()),booked_by_id:new r.NI(o.booked_by_id),booked_by_email:new r.NI(o.booked_by_email)});return a.valueChanges.subscribe(t=>{const n=t.user,s=t.booked_by;(s||n)&&a.patchValue({user_id:n.id||s.id,user_email:n.email||s.id,booked_by_id:s.id,booked_by_email:s.email},{emitEvent:!1})}),a}function j(o,a){return U.apply(this,arguments)}function U(){return(U=(0,b.Z)(function*(o,a,t=[]){const n=document.createElement("div");n.style.position="absolute",n.style.top="-9999px",n.style.width="1000px",n.style.height="1000px",document.body.appendChild(n);const s=yield(0,A.i9)({url:o,element:n}),d=(0,A.gA)(s),i=("string"==typeof a?d.mappings[a]:a)||{x:.5,y:.5};let c=10,m="";for(const f of t){const{x:g,y:u}=d.mappings[f]||{x:2,y:2},h=Math.sqrt((g-i.x)*(g-i.x)+(u-i.y)*(u-i.y));h<c&&(c=h,m=f)}return document.body.removeChild(n),(0,A.hX)(s),m})).apply(this,arguments)}var v=l(354);const pe=["book/desks"];let $=(()=>{class o extends _.KG{constructor(t,n,s,d){super(),this._router=t,this._settings=n,this._org=s,this._dialog=d,this._view=new Z.X("form"),this._options=new Z.X({type:"desk"}),this._form=new Z.X(G()),this._form_value=new Z.X({}),this._booking=new Z.X(null),this._loading=new Z.X(""),this.last_success=new C.$(JSON.parse(sessionStorage.getItem("PLACEOS.last_booked_booking")||"{}")),this.loading=this._loading.asObservable(),this.options=this._options.pipe((0,T.d)(1)),this.assets=this.options.pipe(function me(o,a){return(0,ce.x)((t,n)=>a?a(t[o],n[o]):t[o]===n[o])}("zone_id"),(0,q.w)(({type:i})=>this._org.building&&"desk"===i?(this._loading.next("Loading desks..."),(0,re.BW_)(this._org.building.id,{name:"desks"}).pipe((0,M.U)(c=>(0,_.xH)(c.map(m=>(m.metadata.desks?.details instanceof Array?m.metadata.desks?.details:[]).map(f=>({...f,zone:m.zone}))))))):(0,Y.of)([])),(0,N.b)(()=>this._loading.next("")),(0,T.d)(1)),this.features=this.assets.pipe((0,M.U)(i=>{const c=[];for(const{features:m}of i)m instanceof Array&&m.forEach(f=>c.push(f));return(0,_.Tw)(c).sort((m,f)=>m.localeCompare(f))}),(0,T.d)(1)),this.available_assets=(0,B.aj)([this.options,this.assets,this._form_value]).pipe((0,ue.b)(500),(0,N.b)(([{type:i}])=>this._loading.next(`Checking ${i} availability...`)),(0,q.w)(([i,c,m])=>(0,v.F2)({period_start:(0,w.Z)(m.date),period_end:(0,w.Z)((0,le.Z)(m.date,m.duration||1440)),type:i.type,zones:i.zone_id}).pipe((0,M.U)(f=>c.filter(g=>!1!==g.bookable&&(!i.features||i.features?.every(u=>g.features.includes(u)))&&(!i.zone_id||i.zone_id===g.zone?.id||i.zone_id===g.zone?.parent_id)&&!f.find(u=>u.asset_id===g.id&&"declined"!==u.status)&&(!i?.show_fav||this.favorite_desks.includes(g.id)))))),(0,N.b)(()=>this._loading.next("")),(0,T.d)(1)),this.grouped_availability=(0,B.aj)([this.options,this.available_assets]).pipe((0,M.U)(([i,c])=>{const m=[],f=[...c].sort((u,h)=>u.zone?.id?.localeCompare(h.zone?.id)),g=i.members?.length?i.members:[(0,_.ar)()];for(;f.length;){const u=[];let h=f.pop();for(;u.length<g.length&&(!u.length||u.find(p=>p.zone?.id===h.zone?.id));)u.push(h),h=f.pop();u.length<g.length||m.push(u)}return m})),this.subscription("router.bookings",this._router.events.subscribe(i=>{i instanceof z.m2&&!pe.find(c=>i.url.includes(c))&&this.clearForm()})),this._org.initialised.pipe((0,L.P)(i=>i)).subscribe(()=>this.setOptions({}))}get view(){return this._view.getValue()}get form(){return this._form.getValue()}get booking(){return this._booking.getValue()}get favorite_desks(){return this._settings.get("favourite_desks")||[]}newForm(t=new C.$){this._form.next(G(t)),this.subscription("form_change",this._form.getValue().valueChanges.subscribe(()=>this.storeForm())),this._booking.next(t),this._options.next({type:this._options.getValue().type})}setView(t){this._view.next(t)}setOptions(t){this._options.next({...this._options.getValue(),...t})}setFeature(t,n){if(!t?.length)return;const s=this._options.getValue()?.features||[];n&&!s.includes(t)&&s.push(t),!n&&s.includes(t)&&s.splice(s.findIndex(d=>d===t),1),this.setOptions({features:s})}resetForm(){this._form.getValue()||this.newForm();const t=this._booking.getValue();this._form.getValue().patchValue({...t||{},...t?.extension_data||{}}),this._options.next({type:this._options.getValue().type})}clearForm(){sessionStorage.removeItem("PLACEOS.booking_form"),sessionStorage.removeItem("PLACEOS.booking_form_options"),this.newForm()}storeForm(){sessionStorage.setItem("PLACEOS.booking_form",JSON.stringify(this._form.getValue()?.value||{})),sessionStorage.setItem("PLACEOS.booking_form_filters",JSON.stringify(this._options.getValue()||{})),this._form_value.next(this._form.getValue()?.value||{})}loadForm(){this._form.getValue()||this.newForm(),this._form.getValue().patchValue({...JSON.parse(sessionStorage.getItem("PLACEOS.booking_form")||"{}")}),this.setOptions({zone_id:this._org.building?.id,...JSON.parse(sessionStorage.getItem("PLACEOS.booking_form_filters")||"{}")})}confirmPost(){var t=this;return(0,b.Z)(function*(){yield t.checkQuestions();const n=t._options.getValue(),s=t._form.getValue();let d=`Would you like to book the ${n.type} ${s.value.asset_name} for ${(0,P.Z)(s.value.date,"dd MMM yyyy")}${s.value.duration<720?" at "+(0,P.Z)(s.value.date,"h:mm a"):""}`;n.group&&(d=`${d}.<br>You group members will be assigned desks nearby your selected desk.`);const i=yield(0,_._5)({title:`Book ${n.type}`,content:d,icon:{content:"event_available"}},t._dialog);if("done"!==i?.reason)throw"User cancelled";i.loading("Performing booking request..."),n.group?yield t.postFormForGroup().catch(c=>{throw(0,_.cB)(c),i.close(),c}):yield t.postForm().catch(c=>{throw(0,_.cB)(c),i.close(),c}),i.close()})()}postForm(t=!1){var n=this;return(0,b.Z)(function*(){const s=n._form.getValue();if(!s)throw"No form for booking";if(!s.valid)throw`Some form fields are invalid. [${(0,_.RD)(s).join(", ")}]`;t||(yield n.checkResourceAvailable(s.value,n._options.getValue().type)),(s.value.duration>=720||s.value.all_day)&&s.patchValue({date:(0,de.Z)(s.value.date,{hours:11,minutes:59}).valueOf(),duration:720}),n._loading.next("Saving booking");const d=yield(0,v.km)(new C.$(s.value)).toPromise();n._loading.next("");const{booking_type:i}=s.value;return n.clearForm(),n._form.getValue()?.patchValue({booking_type:i}),n.last_success=d,sessionStorage.setItem("PLACEOS.last_booked_booking",JSON.stringify(d)),n.setView("success"),d})()}postFormForGroup(){var t=this;return(0,b.Z)(function*(){const{members:n,group:s,type:d}=t._options.getValue();if(!s)throw"No group available to book for";const i=n.filter(p=>p.email!==(0,_.ar)().email);if(i.length<=0)throw"No members in your group to book for.";const c=t._form.getValue().value,m=yield t.available_assets.pipe((0,fe.q)(1)).toPromise(),f=m.find(p=>p.id===c.asset_id||p.map_id===c.asset_id),g=t._org.levelWithID([f.zone?.id]),u=[f,...yield t._getNearbyResources(g.map_id,c.asset_id,m,i.length)],h=[(0,_.ar)(),...i];yield Promise.all(h.map((p,x)=>t.checkResourceAvailable({...c,asset_id:u[x].map_id||u[x].id,user_email:p.email},d)));for(let p=0;p<h.length;p++){const x=h[p],k=u[p];t._form.getValue().patchValue({...c,user:x,asset_id:k?.id,asset_name:k.name,map_id:k?.map_id||k?.id,description:k.name,zones:k.zone?[k.zone?.parent_id,k.zone?.id]:[]}),t.postForm(!0)}})()}checkQuestions(){var t=this;return(0,b.Z)(function*(){if(!1!==t._settings.get("app.desks.ignore_questions"))return;const n=t._dialog.open(Q);if("done"!==(yield Promise.race([n.componentInstance.event.pipe((0,L.P)(i=>"done"===i.reason)).toPromise(),n.afterClosed().toPromise()]))?.reason)throw"User cancelled";const d=n.componentInstance.form.value;for(const i in d)if(d[i])throw"User failed questionaire";n.close()})()}checkResourceAvailable({asset_id:t,date:n,duration:s,user_email:d,all_day:i},c){var m=this;return(0,b.Z)(function*(){s=i?720:s||60;const f=yield(0,v.F2)({period_start:(0,w.Z)(n),period_end:(0,w.Z)(n+60*s*1e3),type:c}).toPromise();if(f.find(u=>u.asset_id===t))throw`${t} is not available at the selected time`;const g=m._settings.get(`app.booking.allowed_daily_${c}_count`)??1;if(g>0&&f.filter(u=>u.user_email===(d||(0,_.ar)()?.email)&&"declined"!==u.status).length>=g){const u=d===(0,_.ar)()?.email;throw`${u?"You":d} already ${u?"have":"has"} a desk booked`}return!0})()}_getNearbyResources(t,n,s,d){return(0,b.Z)(function*(){const i=[];let c=s.filter(m=>m.id!==n&&m.map_id!==n);for(let m=0;m<d;m++){const f=yield j(t,n,c.map(g=>g.map_id||g.id));f&&(i.push(s.find(g=>g.id===f||g.map_id===f)),c=c.filter(g=>g.id!==f&&g.map_id!==f))}return i})()}}return o.\u0275fac=function(t){return new(t||o)(e.LFG(z.F0),e.LFG(_.gb),e.LFG(E.w7),e.LFG(I.uw))},o.\u0275prov=e.Yz7({token:o,factory:o.\u0275fac,providedIn:"root"}),o})();l(1022),l(7303)}}]);
//# sourceMappingURL=default-libs_bookings_src_index_ts.js.map