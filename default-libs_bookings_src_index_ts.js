"use strict";(self.webpackChunkconcierge=self.webpackChunkconcierge||[]).push([["default-libs_bookings_src_index_ts"],{4099:(Te,q,r)=>{r.d(q,{$N:()=>v,fy:()=>De,jT:()=>Me,FD:()=>Ze,gV:()=>L,F2:()=>F,FP:()=>we,km:()=>G,Fo:()=>xe,Wp:()=>R}),r(7461);var e=r(2560),I=r(1484),g=r(3294),N=r(4666),c=r(2508),O=(r(5074),r(1267),r(4522));r(1708),r(2306),r(9697);var z=r(2922);function de(o,n){if(1&o){const t=e.EpF();e.TgZ(0,"div",2)(1,"h2",3),e._uU(2,"COVID-19 Questionnaire"),e.qZA(),e.TgZ(3,"main",4)(4,"div",5)(5,"label"),e._uU(6," Have you travelled overseas within the last 14 days?"),e.TgZ(7,"span"),e._uU(8,"*"),e.qZA()(),e.TgZ(9,"mat-radio-group",6)(10,"mat-radio-button",7),e._uU(11,"Yes"),e.qZA(),e.TgZ(12,"mat-radio-button",7),e._uU(13,"No"),e.qZA()()(),e.TgZ(14,"div",5)(15,"label"),e._uU(16," Are you unwell or experiencing any cold or flu-like symptoms?"),e.TgZ(17,"span"),e._uU(18,"*"),e.qZA()(),e.TgZ(19,"mat-radio-group",8)(20,"mat-radio-button",7),e._uU(21,"Yes"),e.qZA(),e.TgZ(22,"mat-radio-button",7),e._uU(23,"No"),e.qZA()()(),e.TgZ(24,"div",9)(25,"label"),e._uU(26," Have you had contact with anyone with suspected COVID-19?"),e.TgZ(27,"span"),e._uU(28,"*"),e.qZA()(),e.TgZ(29,"mat-radio-group",10)(30,"mat-radio-button",7),e._uU(31,"Yes"),e.qZA(),e.TgZ(32,"mat-radio-button",7),e._uU(33,"No"),e.qZA()()()(),e.TgZ(34,"footer",11)(35,"button",12),e.NdJ("click",function(){e.CHM(t);const i=e.oxw();return e.KtG(i.submit())}),e._uU(36,"Submit"),e.qZA()(),e.TgZ(37,"button",13)(38,"i",14),e._uU(39,"close"),e.qZA()()()}if(2&o){const t=e.oxw();e.xp6(3),e.Q6J("formGroup",t.form),e.xp6(7),e.Q6J("value",!0),e.xp6(2),e.Q6J("value",!1),e.xp6(8),e.Q6J("value",!0),e.xp6(2),e.Q6J("value",!1),e.xp6(8),e.Q6J("value",!0),e.xp6(2),e.Q6J("value",!1)}}function ce(o,n){1&o&&(e.TgZ(0,"main",15)(1,"p",16),e._uU(2," Your request to work from the office has been rejected based on your response to the compulsory Covid-19 questions. Please feel free to submit a new request when circumstances change in a way that changes your answer to the questions. "),e.qZA(),e.TgZ(3,"button",13)(4,"i",14),e._uU(5,"close"),e.qZA()()())}let B=(()=>{class o{constructor(){this.event=new e.vpe,this.form=new c.cw({travelled:new c.NI("",[c.kI.required]),unwell:new c.NI("",[c.kI.required]),contact:new c.NI("",[c.kI.required])})}submit(){this.form.markAllAsTouched(),this.form.valid?Object.keys(this.form.value).find(t=>!0===this.form.value[t]||"true"===this.form.value[t])?this.failure=!0:this.event.emit({reason:"done"}):(0,g.cB)("All the questions must be answered")}}return o.\u0275fac=function(t){return new(t||o)},o.\u0275cmp=e.Xpm({type:o,selectors:[["desk-question-modal"]],outputs:{event:"event"},decls:3,vars:2,consts:[["class","relative",4,"ngIf","ngIfElse"],["fail_state",""],[1,"relative"],[1,"p-4","text-xl"],[1,"p-4",3,"formGroup"],[1,"flex","flex-col","mb-4"],["formControlName","travelled",1,"space-x-2"],[3,"value"],["formControlName","unwell",1,"space-x-2"],[1,"flex","flex-col"],["formControlName","contact",1,"space-x-2"],[1,"flex","justify-center","items-center","p-2"],["mat-button","",3,"click"],["close","","mat-icon-button","","mat-dialog-close",""],[1,"material-icons"],["failure","",1,"pt-8","relative"],[1,"p-4"]],template:function(t,s){if(1&t&&(e.YNc(0,de,40,7,"div",0),e.YNc(1,ce,6,0,"ng-template",null,1,e.W1O)),2&t){const i=e.MAs(2);e.Q6J("ngIf",!s.failure)("ngIfElse",i)}},dependencies:[N.O5,c.JJ,c.JL,c.sg,c.u,z.VQ,z.U0,O.lW,I.ZT],styles:["main[_ngcontent-%COMP%]{width:24rem;max-width:calc(100vw - 4.5rem)}[close][_ngcontent-%COMP%]{position:absolute;top:.5rem;right:.5rem}\n/*# sourceMappingURL=desk-questions-modal.component.ts-angular-inline--55.css.map*/"]}),o})();var M=r(1670),P=r(9885),ue=r(3619),b=r(3690),w=r(1810),D=r(2317),V=r(3861),me=r(8235),Z=r(4505),Q=r(4139),J=r(7716),T=r(9128),pe=r(3298),$=r(9095),k=r(6942),U=r(8759),ge=r(823),E=r(5670),he=r(3910),_e=r(5692),ve=r(8987),ke=r(5845),ye=r(2757),be=r(1233);class v{constructor(n={}){this.id=n.id||"",this.asset_id=n.asset_id||"",this.asset_name=n.asset_name||n.extension_data?.asset_name||"",this.zones=n.zones||[],this.booking_start=n.date/1e3||n.booking_start||(0,w.Z)((0,_e.Z)((0,D.Z)(Date.now(),5),{nearestTo:5})),this.booking_end=n.date/1e3+60*n.duration||n.booking_end||(0,w.Z)((0,D.Z)(1e3*this.booking_start,n.duration||60)),this.booking_type=n.booking_type||"",this.type=n.type||"booking",this.date=n.date||1e3*this.booking_start,this.duration=n.duration||Math.abs((0,ve.Z)(1e3*this.booking_start,1e3*this.booking_end)),this.timezone=n.timezone||Intl.DateTimeFormat().resolvedOptions().timeZone,this.user_email=n.user_email||"",this.user_id=n.user_id||"",this.user_name=n.user_name||"",this.title=n.title||"Desk booking",this.description=n.description||"",this.checked_in=!!n.checked_in,this.rejected=!!n.rejected,this.approved=!!n.approved,this.deleted=!!n.deleted,this.booked_by_id=n.booked_by_id||"",this.booked_by_name=n.booked_by_name||"",this.booked_by_email=n.booked_by_email||"",this.approver_id=n.approver_id||"",this.approver_email=n.approver_email||"",this.approver_name=n.approver_name||"",this.extension_data=n.extension_data||{},this.access=!!n.extension_data?.access,this.all_day=n.all_day??this.duration>720,this.status=this.rejected?"declined":this.approved?"approved":"tentative";for(const t in n)t in this||(this.extension_data[t]=n[t]||this.extension_data[t])}toJSON(){const n={...this};return this.id||delete n.id,delete n.date,delete n.duration,n}get location(){return this.description}get is_today(){return(0,ke.Z)(this.date,new Date)}get is_done(){const n=new Date,t=this.all_day?(0,ye.Z)(this.date,24):(0,D.Z)(this.date,this.duration);return(0,be.Z)(n,t)}}var S=r(4922);function j(o=new v){const n=new c.cw({id:new c.NI(o.id||""),date:new c.NI(o.date,[]),all_day:new c.NI(o.all_day??!1),duration:new c.NI(o.duration),booking_type:new c.NI(o.booking_type),zones:new c.NI(o.zones),title:new c.NI(o.title),description:new c.NI(o.description),asset_id:new c.NI(o.asset_id),asset_name:new c.NI(o.description),map_id:new c.NI(o.extension_data?.map_id),user:new c.NI((0,g.ar)()),user_id:new c.NI(o.user_id),user_email:new c.NI(o.user_email),booked_by:new c.NI((0,g.ar)()),booked_by_id:new c.NI(o.booked_by_id),booked_by_email:new c.NI(o.booked_by_email)});return n.valueChanges.subscribe(t=>{const s=t.user,i=t.booked_by;(i||s)&&n.patchValue({user_id:s.id||i.id,user_email:s.email||i.id,booked_by_id:i.id,booked_by_email:i.email},{emitEvent:!1})}),n}function L(o,n){return A.apply(this,arguments)}function A(){return(A=(0,M.Z)(function*(o,n,t=[]){const s=document.createElement("div");s.style.position="absolute",s.style.top="-9999px",s.style.width="1000px",s.style.height="1000px",document.body.appendChild(s);const i=yield(0,S.i9)({url:o,element:s}),d=(0,S.gA)(i),a=("string"==typeof n?d.mappings[n]:n)||{x:.5,y:.5};let l=10,u="";console.log("Desks:",t),console.log("Mappings:",d.mappings),console.log("Point:",a);for(const p of t){const{x:f,y:m}=d.mappings[p]||{x:2,y:2},h=Math.sqrt((f-a.x)*(f-a.x)+(m-a.y)*(m-a.y));console.log(`Desk ${p}:`,d.mappings[p],h),h<l&&(l=h,u=p)}return document.body.removeChild(s),(0,S.hX)(i),u})).apply(this,arguments)}var Y=r(5038);const C="/api/staff/v1/bookings";function F(o){const n=(0,Y.U)(o);return(0,b.U2M)(`${C}${n?"?"+n:""}`).pipe((0,k.U)(t=>t.map(s=>new v(s))))}function xe(o){return(0,b.U2M)(`${C}/${encodeURIComponent(o)}`).pipe((0,k.U)(n=>new v(n)))}function R(o,n,t="patch"){return("patch"===t?b.r$K:b.gzd)(`${C}/${encodeURIComponent(o)}`,n).pipe((0,k.U)(s=>new v(s)))}const G=o=>o.id?R(o.id,o):function Ce(o){return(0,b.v_Q)(`${C}`,o).pipe((0,k.U)(n=>new v(n)))}(o);function Me(o){return(0,b.v_Q)(`${C}/${encodeURIComponent(o)}/approve`,"").pipe((0,k.U)(n=>new v(n)))}function we(o){return(0,b.v_Q)(`${C}/${encodeURIComponent(o)}/reject`,"").pipe((0,k.U)(n=>new v(n)))}function Ze(o,n){const t=(0,Y.U)({state:n});return(0,b.v_Q)(`${C}/${encodeURIComponent(o)}/check_in?${t}`,"").pipe((0,k.U)(s=>new v(s)))}const Ie=["book/desks"];let De=(()=>{class o extends g.KG{constructor(t,s,i,d){super(),this._router=t,this._settings=s,this._org=i,this._dialog=d,this._view=new Z.X("form"),this._options=new Z.X({type:"desk"}),this._form=new Z.X(j()),this._form_value=new Z.X({}),this._booking=new Z.X(null),this._loading=new Z.X(""),this.last_success=new v(JSON.parse(sessionStorage.getItem("PLACEOS.last_booked_booking")||"{}")),this.loading=this._loading.asObservable(),this.options=this._options.pipe((0,T.d)(1)),this.assets=this.options.pipe(function fe(o,n){return(0,pe.x)((t,s)=>n?n(t[o],s[o]):t[o]===s[o])}("zone_id"),(0,$.w)(({type:a})=>this._org.building&&"desk"===a?(this._loading.next("Loading desks..."),(0,b.BW_)(this._org.building.id,{name:"desks"}).pipe((0,k.U)(l=>(0,g.xH)(l.map(u=>(u.metadata.desks?.details instanceof Array?u.metadata.desks?.details:[]).map(p=>({...p,zone:u.zone}))))))):(0,Q.of)([])),(0,U.b)(()=>this._loading.next("")),(0,T.d)(1)),this.features=this.assets.pipe((0,k.U)(a=>{const l=[];for(const{features:u}of a)u instanceof Array&&u.forEach(p=>l.push(p));return(0,g.Tw)(l).sort((u,p)=>u.localeCompare(p))}),(0,T.d)(1)),this.available_assets=(0,J.aj)([this.options,this.assets,this._form_value]).pipe((0,ge.b)(500),(0,U.b)(([{type:a}])=>this._loading.next(`Checking ${a} availability...`)),(0,$.w)(([a,l,u])=>F({period_start:(0,w.Z)(u.date),period_end:(0,w.Z)((0,D.Z)(u.date,u.duration||1440)),type:a.type,zones:a.zone_id}).pipe((0,k.U)(p=>l.filter(f=>!1!==f.bookable&&(!a.features||a.features?.every(m=>f.features.includes(m)))&&(!a.zone_id||a.zone_id===f.zone?.id||a.zone_id===f.zone?.parent_id)&&!p.find(m=>m.asset_id===f.id&&"declined"!==m.status))))),(0,U.b)(()=>this._loading.next("")),(0,T.d)(1)),this.grouped_availability=(0,J.aj)([this.options,this.available_assets]).pipe((0,k.U)(([a,l])=>{const u=[],p=[...l].sort((m,h)=>m.zone?.id?.localeCompare(h.zone?.id)),f=a.members?.length?a.members:[(0,g.ar)()];for(;p.length;){const m=[];let h=p.pop();for(;m.length<f.length&&(!m.length||m.find(_=>_.zone?.id===h.zone?.id));)m.push(h),h=p.pop();m.length<f.length||u.push(m)}return u})),this.subscription("router.bookings",this._router.events.subscribe(a=>{a instanceof P.m2&&!Ie.find(l=>a.url.includes(l))&&this.clearForm()})),this._org.initialised.pipe((0,E.P)(a=>a)).subscribe(()=>this.setOptions({}))}get view(){return this._view.getValue()}get form(){return this._form.getValue()}get booking(){return this._booking.getValue()}newForm(t=new v){this._form.next(j(t)),this.subscription("form_change",this._form.getValue().valueChanges.subscribe(()=>this.storeForm())),this._booking.next(t),this._options.next({type:this._options.getValue().type})}setView(t){this._view.next(t)}setOptions(t){this._options.next({...this._options.getValue(),...t})}resetForm(){this._form.getValue()||this.newForm();const t=this._booking.getValue();this._form.getValue().patchValue({...t||{},...t?.extension_data||{}}),this._options.next({type:this._options.getValue().type})}clearForm(){sessionStorage.removeItem("PLACEOS.booking_form"),sessionStorage.removeItem("PLACEOS.booking_form_options"),this.newForm()}storeForm(){sessionStorage.setItem("PLACEOS.booking_form",JSON.stringify(this._form.getValue()?.value||{})),sessionStorage.setItem("PLACEOS.booking_form_filters",JSON.stringify(this._options.getValue()||{})),this._form_value.next(this._form.getValue()?.value||{})}loadForm(){this._form.getValue()||this.newForm(),this._form.getValue().patchValue({...JSON.parse(sessionStorage.getItem("PLACEOS.booking_form")||"{}")}),this.setOptions({zone_id:this._org.building?.id,...JSON.parse(sessionStorage.getItem("PLACEOS.booking_form_filters")||"{}")})}confirmPost(){var t=this;return(0,M.Z)(function*(){yield t.checkQuestions();const s=t._options.getValue(),i=t._form.getValue();let d=`Would you like to book the ${s.type} ${i.value.asset_name} for ${(0,V.Z)(i.value.date,"dd MMM yyyy")}${i.value.duration<720?" at "+(0,V.Z)(i.value.date,"h:mm a"):""}`;s.group&&(d=`${d}.<br>You group members will be assigned desks nearby your selected desk.`);const a=yield(0,g._5)({title:`Book ${s.type}`,content:d,icon:{content:"event_available"}},t._dialog);if("done"!==a?.reason)throw"User cancelled";a.loading("Performing booking request..."),s.group?yield t.postFormForGroup().catch(l=>{throw(0,g.cB)(l),a.close(),l}):yield t.postForm().catch(l=>{throw(0,g.cB)(l),a.close(),l}),a.close()})()}postForm(t=!1){var s=this;return(0,M.Z)(function*(){const i=s._form.getValue();if(!i)throw"No form for booking";if(!i.valid)throw`Some form fields are invalid. [${(0,g.RD)(i).join(", ")}]`;t||(yield s.checkResourceAvailable(i.value,s._options.getValue().type)),(i.value.duration>=720||i.value.all_day)&&i.patchValue({date:(0,me.Z)(i.value.date,{hours:11,minutes:59}).valueOf(),duration:720});const d=yield G(new v(i.value)).toPromise(),{booking_type:a}=i.value;return s.clearForm(),s._form.getValue()?.patchValue({booking_type:a}),s.last_success=d,sessionStorage.setItem("PLACEOS.last_booked_booking",JSON.stringify(d)),s.setView("success"),d})()}postFormForGroup(){var t=this;return(0,M.Z)(function*(){const{members:s,group:i,type:d}=t._options.getValue();if(!i)throw"No group available to book for";const a=s.filter(_=>_.email!==(0,g.ar)().email);if(a.length<=0)throw"No members in your group to book for.";const l=t._form.getValue().value,u=yield t.available_assets.pipe((0,he.q)(1)).toPromise(),p=u.find(_=>_.id===l.asset_id||_.map_id===l.asset_id),f=t._org.levelWithID([p.zone?.id]),m=[p,...yield t._getNearbyResources(f.map_id,l.asset_id,u,a.length)];console.log("Selected Assets:",m);const h=[(0,g.ar)(),...a];yield Promise.all(h.map((_,y)=>t.checkResourceAvailable({...l,asset_id:m[y].map_id||m[y].id,user_email:_.email},d)));for(let _=0;_<h.length;_++){const y=h[_],x=m[_];t._form.getValue().patchValue({...l,user:y,asset_id:x?.id,asset_name:x.name,map_id:x?.map_id||x?.id,description:x.name,zones:x.zone?[x.zone?.parent_id,x.zone?.id]:[]}),console.log("Form Value:",t._form.getValue().value),t.postForm(!0)}})()}checkQuestions(){var t=this;return(0,M.Z)(function*(){if(!1!==t._settings.get("app.desks.ignore_questions"))return;const s=t._dialog.open(B);if("done"!==(yield Promise.race([s.componentInstance.event.pipe((0,E.P)(a=>"done"===a.reason)).toPromise(),s.afterClosed().toPromise()]))?.reason)throw"User cancelled";const d=s.componentInstance.form.value;for(const a in d)if(d[a])throw"User failed questionaire";s.close()})()}checkResourceAvailable({asset_id:t,date:s,duration:i,user_email:d,all_day:a},l){var u=this;return(0,M.Z)(function*(){i=a?720:i||60;const p=yield F({period_start:(0,w.Z)(s),period_end:(0,w.Z)(s+60*i*1e3),type:l}).toPromise();if(p.find(m=>m.asset_id===t))throw`${t} is not available at the selected time`;const f=u._settings.get(`app.booking.allowed_daily_${l}_count`)??1;if(f>0&&p.filter(m=>m.user_email===(d||(0,g.ar)()?.email)&&"declined"!==m.status).length>=f){const m=d===(0,g.ar)().email;throw`${m?"You":d} already ${m?"have":"has"} a desk booked`}return!0})()}_getNearbyResources(t,s,i,d){return(0,M.Z)(function*(){const a=[];let l=i.filter(u=>u.id!==s&&u.map_id!==s);console.log("Assets:",i,l,s);for(let u=0;u<d;u++){const p=yield L(t,s,l.map(f=>f.map_id||f.id));p&&(a.push(i.find(f=>f.id===p||f.map_id===p)),l=l.filter(f=>f.id!==p&&f.map_id!==p)),console.log("Asset List:",l)}return a})()}}return o.\u0275fac=function(t){return new(t||o)(e.LFG(P.F0),e.LFG(g.gb),e.LFG(ue.w7),e.LFG(I.uw))},o.\u0275prov=e.Yz7({token:o,factory:o.\u0275fac,providedIn:"root"}),o})()}}]);
//# sourceMappingURL=default-libs_bookings_src_index_ts.js.map