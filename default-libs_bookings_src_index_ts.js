"use strict";(self.webpackChunkconcierge=self.webpackChunkconcierge||[]).push([["default-libs_bookings_src_index_ts"],{9276:(pe,Y,a)=>{a.d(Y,{$N:()=>C.$,fy:()=>ge,jT:()=>v.jT,FD:()=>v.FD,gV:()=>E,F2:()=>v.F2,FP:()=>v.FP,km:()=>v.km,Fo:()=>v.Fo,Wp:()=>v.Wp}),a(6850);var e=a(2560),M=a(1484),p=a(1506),T=a(4666),m=a(2508),S=(a(5074),a(1267),a(4522));a(1708),a(2306),a(9697);var A=a(2922);function se(o,l){if(1&o){const t=e.EpF();e.TgZ(0,"div",2)(1,"h2",3),e._uU(2,"COVID-19 Questionnaire"),e.qZA(),e.TgZ(3,"main",4)(4,"div",5)(5,"label"),e._uU(6," Have you travelled overseas within the last 14 days?"),e.TgZ(7,"span"),e._uU(8,"*"),e.qZA()(),e.TgZ(9,"mat-radio-group",6)(10,"mat-radio-button",7),e._uU(11,"Yes"),e.qZA(),e.TgZ(12,"mat-radio-button",7),e._uU(13,"No"),e.qZA()()(),e.TgZ(14,"div",5)(15,"label"),e._uU(16," Are you unwell or experiencing any cold or flu-like symptoms?"),e.TgZ(17,"span"),e._uU(18,"*"),e.qZA()(),e.TgZ(19,"mat-radio-group",8)(20,"mat-radio-button",7),e._uU(21,"Yes"),e.qZA(),e.TgZ(22,"mat-radio-button",7),e._uU(23,"No"),e.qZA()()(),e.TgZ(24,"div",9)(25,"label"),e._uU(26," Have you had contact with anyone with suspected COVID-19?"),e.TgZ(27,"span"),e._uU(28,"*"),e.qZA()(),e.TgZ(29,"mat-radio-group",10)(30,"mat-radio-button",7),e._uU(31,"Yes"),e.qZA(),e.TgZ(32,"mat-radio-button",7),e._uU(33,"No"),e.qZA()()()(),e.TgZ(34,"footer",11)(35,"button",12),e.NdJ("click",function(){e.CHM(t);const n=e.oxw();return e.KtG(n.submit())}),e._uU(36,"Submit"),e.qZA()(),e.TgZ(37,"button",13)(38,"i",14),e._uU(39,"close"),e.qZA()()()}if(2&o){const t=e.oxw();e.xp6(3),e.Q6J("formGroup",t.form),e.xp6(7),e.Q6J("value",!0),e.xp6(2),e.Q6J("value",!1),e.xp6(8),e.Q6J("value",!0),e.xp6(2),e.Q6J("value",!1),e.xp6(8),e.Q6J("value",!0),e.xp6(2),e.Q6J("value",!1)}}function ne(o,l){1&o&&(e.TgZ(0,"main",15)(1,"p",16),e._uU(2," Your request to work from the office has been rejected based on your response to the compulsory Covid-19 questions. Please feel free to submit a new request when circumstances change in a way that changes your answer to the questions. "),e.qZA(),e.TgZ(3,"button",13)(4,"i",14),e._uU(5,"close"),e.qZA()()())}let U=(()=>{class o{constructor(){this.event=new e.vpe,this.form=new m.cw({travelled:new m.NI(!1),unwell:new m.NI(!1),contact:new m.NI(!1)})}submit(){this.form.markAllAsTouched(),Object.keys(this.form.value).find(t=>!0===this.form.value[t]||"true"===this.form.value[t])?this.failure=!0:this.event.emit({reason:"done"})}}return o.\u0275fac=function(t){return new(t||o)},o.\u0275cmp=e.Xpm({type:o,selectors:[["desk-question-modal"]],outputs:{event:"event"},decls:3,vars:2,consts:[["class","relative",4,"ngIf","ngIfElse"],["fail_state",""],[1,"relative"],[1,"p-4","text-xl"],[1,"p-4",3,"formGroup"],[1,"flex","flex-col","mb-4"],["formControlName","travelled",1,"space-x-2"],[3,"value"],["formControlName","unwell",1,"space-x-2"],[1,"flex","flex-col"],["formControlName","contact",1,"space-x-2"],[1,"flex","justify-center","items-center","p-2"],["mat-button","",3,"click"],["close","","mat-icon-button","","mat-dialog-close",""],[1,"material-icons"],["failure","",1,"pt-8","relative"],[1,"p-4"]],template:function(t,s){if(1&t&&(e.YNc(0,se,40,7,"div",0),e.YNc(1,ne,6,0,"ng-template",null,1,e.W1O)),2&t){const n=e.MAs(2);e.Q6J("ngIf",!s.failure)("ngIfElse",n)}},dependencies:[T.O5,m.JJ,m.JL,m.sg,m.u,A.VQ,A.U0,S.lW,M.ZT],styles:["main[_ngcontent-%COMP%]{width:24rem;max-width:calc(100vw - 4.5rem)}[close][_ngcontent-%COMP%]{position:absolute;top:.5rem;right:.5rem}\n/*# sourceMappingURL=desk-questions-modal.component.ts-angular-inline--57.css.map*/"]}),o})();var b=a(1670),O=a(9885),ie=a(3619),ae=a(3690),w=a(1810),re=a(2317),P=a(5148),le=a(8235),x=a(4505),V=a(4139),z=a(7716),Z=a(9128),de=a(3298),J=a(9095),I=a(6942),N=a(8759),ue=a(823),Q=a(5670),me=a(3910),C=a(6962),D=a(4922);function B(o=new C.$){const l=new m.cw({id:new m.NI(o.id||""),date:new m.NI(o.date,[]),all_day:new m.NI(o.all_day??!1),duration:new m.NI(o.duration),booking_type:new m.NI(o.booking_type),zones:new m.NI(o.zones),title:new m.NI(o.title),description:new m.NI(o.description),asset_id:new m.NI(o.asset_id),asset_name:new m.NI(o.description),map_id:new m.NI(o.extension_data?.map_id),user:new m.NI((0,p.ar)()),user_id:new m.NI(o.user_id),user_email:new m.NI(o.user_email),booked_by:new m.NI((0,p.ar)()),booked_by_id:new m.NI(o.booked_by_id),booked_by_email:new m.NI(o.booked_by_email)});return l.valueChanges.subscribe(t=>{const s=t.user,n=t.booked_by;(n||s)&&l.patchValue({user_id:s.id||n.id,user_email:s.email||n.id,booked_by_id:n.id,booked_by_email:n.email},{emitEvent:!1})}),l}function E(o,l){return F.apply(this,arguments)}function F(){return(F=(0,b.Z)(function*(o,l,t=[]){const s=document.createElement("div");s.style.position="absolute",s.style.top="-9999px",s.style.width="1000px",s.style.height="1000px",document.body.appendChild(s);const n=yield(0,D.i9)({url:o,element:s}),d=(0,D.gA)(n),i=("string"==typeof l?d.mappings[l]:l)||{x:.5,y:.5};let r=10,c="";for(const f of t){const{x:g,y:u}=d.mappings[f]||{x:2,y:2},_=Math.sqrt((g-i.x)*(g-i.x)+(u-i.y)*(u-i.y));_<r&&(r=_,c=f)}return document.body.removeChild(s),(0,D.hX)(n),c})).apply(this,arguments)}var v=a(354);const fe=["book/desks"];let ge=(()=>{class o extends p.KG{constructor(t,s,n,d){super(),this._router=t,this._settings=s,this._org=n,this._dialog=d,this._view=new x.X("form"),this._options=new x.X({type:"desk"}),this._form=new x.X(B()),this._form_value=new x.X({}),this._booking=new x.X(null),this._loading=new x.X(""),this.last_success=new C.$(JSON.parse(sessionStorage.getItem("PLACEOS.last_booked_booking")||"{}")),this.loading=this._loading.asObservable(),this.options=this._options.pipe((0,Z.d)(1)),this.assets=this.options.pipe(function ce(o,l){return(0,de.x)((t,s)=>l?l(t[o],s[o]):t[o]===s[o])}("zone_id"),(0,J.w)(({type:i})=>this._org.building&&"desk"===i?(this._loading.next("Loading desks..."),(0,ae.BW_)(this._org.building.id,{name:"desks"}).pipe((0,I.U)(r=>(0,p.xH)(r.map(c=>(c.metadata.desks?.details instanceof Array?c.metadata.desks?.details:[]).map(f=>({...f,zone:c.zone}))))))):(0,V.of)([])),(0,N.b)(()=>this._loading.next("")),(0,Z.d)(1)),this.features=this.assets.pipe((0,I.U)(i=>{const r=[];for(const{features:c}of i)c instanceof Array&&c.forEach(f=>r.push(f));return(0,p.Tw)(r).sort((c,f)=>c.localeCompare(f))}),(0,Z.d)(1)),this.available_assets=(0,z.aj)([this.options,this.assets,this._form_value]).pipe((0,ue.b)(500),(0,N.b)(([{type:i}])=>this._loading.next(`Checking ${i} availability...`)),(0,J.w)(([i,r,c])=>(0,v.F2)({period_start:(0,w.Z)(c.date),period_end:(0,w.Z)((0,re.Z)(c.date,c.duration||1440)),type:i.type,zones:i.zone_id}).pipe((0,I.U)(f=>r.filter(g=>!1!==g.bookable&&(!i.features||i.features?.every(u=>g.features.includes(u)))&&(!i.zone_id||i.zone_id===g.zone?.id||i.zone_id===g.zone?.parent_id)&&!f.find(u=>u.asset_id===g.id&&"declined"!==u.status))))),(0,N.b)(()=>this._loading.next("")),(0,Z.d)(1)),this.grouped_availability=(0,z.aj)([this.options,this.available_assets]).pipe((0,I.U)(([i,r])=>{const c=[],f=[...r].sort((u,_)=>u.zone?.id?.localeCompare(_.zone?.id)),g=i.members?.length?i.members:[(0,p.ar)()];for(;f.length;){const u=[];let _=f.pop();for(;u.length<g.length&&(!u.length||u.find(h=>h.zone?.id===_.zone?.id));)u.push(_),_=f.pop();u.length<g.length||c.push(u)}return c})),this.subscription("router.bookings",this._router.events.subscribe(i=>{i instanceof O.m2&&!fe.find(r=>i.url.includes(r))&&this.clearForm()})),this._org.initialised.pipe((0,Q.P)(i=>i)).subscribe(()=>this.setOptions({}))}get view(){return this._view.getValue()}get form(){return this._form.getValue()}get booking(){return this._booking.getValue()}newForm(t=new C.$){this._form.next(B(t)),this.subscription("form_change",this._form.getValue().valueChanges.subscribe(()=>this.storeForm())),this._booking.next(t),this._options.next({type:this._options.getValue().type})}setView(t){this._view.next(t)}setOptions(t){this._options.next({...this._options.getValue(),...t})}resetForm(){this._form.getValue()||this.newForm();const t=this._booking.getValue();this._form.getValue().patchValue({...t||{},...t?.extension_data||{}}),this._options.next({type:this._options.getValue().type})}clearForm(){sessionStorage.removeItem("PLACEOS.booking_form"),sessionStorage.removeItem("PLACEOS.booking_form_options"),this.newForm()}storeForm(){sessionStorage.setItem("PLACEOS.booking_form",JSON.stringify(this._form.getValue()?.value||{})),sessionStorage.setItem("PLACEOS.booking_form_filters",JSON.stringify(this._options.getValue()||{})),this._form_value.next(this._form.getValue()?.value||{})}loadForm(){this._form.getValue()||this.newForm(),this._form.getValue().patchValue({...JSON.parse(sessionStorage.getItem("PLACEOS.booking_form")||"{}")}),this.setOptions({zone_id:this._org.building?.id,...JSON.parse(sessionStorage.getItem("PLACEOS.booking_form_filters")||"{}")})}confirmPost(){var t=this;return(0,b.Z)(function*(){yield t.checkQuestions();const s=t._options.getValue(),n=t._form.getValue();let d=`Would you like to book the ${s.type} ${n.value.asset_name} for ${(0,P.Z)(n.value.date,"dd MMM yyyy")}${n.value.duration<720?" at "+(0,P.Z)(n.value.date,"h:mm a"):""}`;s.group&&(d=`${d}.<br>You group members will be assigned desks nearby your selected desk.`);const i=yield(0,p._5)({title:`Book ${s.type}`,content:d,icon:{content:"event_available"}},t._dialog);if("done"!==i?.reason)throw"User cancelled";i.loading("Performing booking request..."),s.group?yield t.postFormForGroup().catch(r=>{throw(0,p.cB)(r),i.close(),r}):yield t.postForm().catch(r=>{throw(0,p.cB)(r),i.close(),r}),i.close()})()}postForm(t=!1){var s=this;return(0,b.Z)(function*(){const n=s._form.getValue();if(!n)throw"No form for booking";if(!n.valid)throw`Some form fields are invalid. [${(0,p.RD)(n).join(", ")}]`;t||(yield s.checkResourceAvailable(n.value,s._options.getValue().type)),(n.value.duration>=720||n.value.all_day)&&n.patchValue({date:(0,le.Z)(n.value.date,{hours:11,minutes:59}).valueOf(),duration:720});const d=yield(0,v.km)(new C.$(n.value)).toPromise(),{booking_type:i}=n.value;return s.clearForm(),s._form.getValue()?.patchValue({booking_type:i}),s.last_success=d,sessionStorage.setItem("PLACEOS.last_booked_booking",JSON.stringify(d)),s.setView("success"),d})()}postFormForGroup(){var t=this;return(0,b.Z)(function*(){const{members:s,group:n,type:d}=t._options.getValue();if(!n)throw"No group available to book for";const i=s.filter(h=>h.email!==(0,p.ar)().email);if(i.length<=0)throw"No members in your group to book for.";const r=t._form.getValue().value,c=yield t.available_assets.pipe((0,me.q)(1)).toPromise(),f=c.find(h=>h.id===r.asset_id||h.map_id===r.asset_id),g=t._org.levelWithID([f.zone?.id]),u=[f,...yield t._getNearbyResources(g.map_id,r.asset_id,c,i.length)],_=[(0,p.ar)(),...i];yield Promise.all(_.map((h,k)=>t.checkResourceAvailable({...r,asset_id:u[k].map_id||u[k].id,user_email:h.email},d)));for(let h=0;h<_.length;h++){const k=_[h],y=u[h];t._form.getValue().patchValue({...r,user:k,asset_id:y?.id,asset_name:y.name,map_id:y?.map_id||y?.id,description:y.name,zones:y.zone?[y.zone?.parent_id,y.zone?.id]:[]}),t.postForm(!0)}})()}checkQuestions(){var t=this;return(0,b.Z)(function*(){if(!1!==t._settings.get("app.desks.ignore_questions"))return;const s=t._dialog.open(U);if("done"!==(yield Promise.race([s.componentInstance.event.pipe((0,Q.P)(i=>"done"===i.reason)).toPromise(),s.afterClosed().toPromise()]))?.reason)throw"User cancelled";const d=s.componentInstance.form.value;for(const i in d)if(d[i])throw"User failed questionaire";s.close()})()}checkResourceAvailable({asset_id:t,date:s,duration:n,user_email:d,all_day:i},r){var c=this;return(0,b.Z)(function*(){n=i?720:n||60;const f=yield(0,v.F2)({period_start:(0,w.Z)(s),period_end:(0,w.Z)(s+60*n*1e3),type:r}).toPromise();if(f.find(u=>u.asset_id===t))throw`${t} is not available at the selected time`;const g=c._settings.get(`app.booking.allowed_daily_${r}_count`)??1;if(g>0&&f.filter(u=>u.user_email===(d||(0,p.ar)()?.email)&&"declined"!==u.status).length>=g){const u=d===(0,p.ar)()?.email;throw`${u?"You":d} already ${u?"have":"has"} a desk booked`}return!0})()}_getNearbyResources(t,s,n,d){return(0,b.Z)(function*(){const i=[];let r=n.filter(c=>c.id!==s&&c.map_id!==s);for(let c=0;c<d;c++){const f=yield E(t,s,r.map(g=>g.map_id||g.id));f&&(i.push(n.find(g=>g.id===f||g.map_id===f)),r=r.filter(g=>g.id!==f&&g.map_id!==f))}return i})()}}return o.\u0275fac=function(t){return new(t||o)(e.LFG(O.F0),e.LFG(p.gb),e.LFG(ie.w7),e.LFG(M.uw))},o.\u0275prov=e.Yz7({token:o,factory:o.\u0275fac,providedIn:"root"}),o})()}}]);
//# sourceMappingURL=default-libs_bookings_src_index_ts.js.map