(window.webpackJsonp=window.webpackJsonp||[]).push([[2],{T50y:function(t,e,s){"use strict";s.d(e,"a",(function(){return _}));var n=s("EM62"),i=s("C05f"),o=s("HM3f"),a=s("YtkY"),c=s("mWib"),r=s("jOdJ"),l=s("xVbo"),d=s("20lr"),h=s("dJst"),u=s("6CBO");let _=(()=>{class t extends d.b{constructor(t,e,s){super(),this._org=t,this._spaces=e,this._settings=s,this._level=new i.a(null),this._positions=new i.a({zoom:1,center:{x:.5,y:.5}}),this._styles=new i.a({}),this._features=new i.a({}),this._actions=new i.a({}),this._labels=new i.a({}),this._options=new i.a({}),this._message=new i.a(""),this.level=this._level.asObservable(),this.message=this._message.asObservable(),this.spaces=Object(o.a)([this._level,this._spaces.list]).pipe(Object(a.a)(([t,e])=>e.filter(e=>e.zones.includes(t.id)))),this.map_url=this._level.pipe(Object(a.a)(t=>(t?t.map_id:"")||"")),this.map_positions=this._positions.asObservable(),this.map_features=Object(o.a)([this._features,this._options]).pipe(Object(c.a)(200),Object(a.a)(t=>{const[e,s]=t;let n=[];for(const i in e)switch(i){case"devices":s.show_zones&&s.show_devices&&(n=n.concat(e[i]));break;case"contacts":s.show_contacts&&(n=n.concat(e[i]));break;default:n=n.concat(e[i])}return n})),this.map_actions=this._actions.pipe(Object(c.a)(200),Object(a.a)(t=>Object.values(t).reduce((t,e)=>t.concat(e),[]))),this.map_labels=Object(o.a)([this._labels,this._options]).pipe(Object(c.a)(200),Object(a.a)(t=>{const[e,s]=t;let n=[];for(const i in e)("zones"!==i||s.show_zones)&&(n=n.concat(e[i]));return n})),this.map_styles=Object(o.a)([this._styles,this._options]).pipe(Object(c.a)(200),Object(a.a)(t=>{const[e,s]=t,n=Object.keys(e).reduce((t,s)=>Object.assign(Object.assign({},t),e[s]),{});return s.show_zones||(n["#zones"]={display:"none"},n["#Zones"]={display:"none"}),n.text={display:"none"},n})),this.options=this._options.asObservable(),this._org.initialised.pipe(Object(r.a)(t=>t)).subscribe(()=>{this.subscription("building",this._org.active_building.pipe(Object(l.a)(t=>!!t)).subscribe(t=>{const e=this._level.getValue(),s=this._org.levelsForBuilding(t);!s.find(t=>(null==e?void 0:e.id)===t.id)&&s.length&&this.setLevel(s[0].id),this.setOptions({show_devices:!1!==this._settings.get("app.explore.display_devices")})}))})}get positions(){return this._positions.getValue()}get active_level(){return this._level.getValue()}setOptions(t){this._options.next(Object.assign(Object.assign({},this._options.getValue()),t))}setLevel(t){const e=this._org.levelWithID([t]);e&&this._level.next(e)}setStyles(t,e){const s=this._styles.getValue();s[t]=e,this._styles.next(s)}setFeatures(t,e){const s=this._features.getValue();s[t]=e,this._features.next(s)}setActions(t,e){const s=this._actions.getValue();s[t]=e,this._actions.next(s)}setLabels(t,e){const s=this._labels.getValue();s[t]=e,this._labels.next(s)}setPositions(t,e){this._positions.next({zoom:t,center:e})}}return t.\u0275fac=function(e){return new(e||t)(n.tc(h.c),n.tc(u.c),n.tc(d.e))},t.\u0275prov=n.cc({token:t,factory:t.\u0275fac,providedIn:"root"}),t})()},aAMe:function(t,e,s){"use strict";s.d(e,"a",(function(){return L})),s.d(e,"b",(function(){return _.a})),s.d(e,"c",(function(){return A}));var n=s("D57K"),i=s("EM62"),o=s("/It1"),a=s("C05f"),c=s("HM3f"),r=s("20lr"),l=s("05Mk"),d=(s("eZII"),s("Rc+I")),h=s("2kYt");s("OZ4H"),s("7JBE"),s("PBFl"),s("0/Ep");var u=s("nIj0");s("29Wa"),s("Cd2c"),s("Bk/k"),s("csyo");var _=s("T50y");const p={free:"#43a047",pending:"#ffb300",reserved:"#e65100",busy:"#e53935","not-bookable":"#757575",unknown:"#757575"};var b=s("dJst"),m=s("Sv/w"),f=s("U+d2"),g=s("w+hZ"),v=s("HYj3");const O=["dot"],k=["explore-device-info",""];function y(t,e){if(1&t&&(i.mc(0,"p"),i.mc(1,"label"),i.ad(2,"Manufacturer:"),i.lc(),i.ad(3),i.lc()),2&t){const t=i.Bc(2);i.Ub(3),i.cd(" ",t.manufacturer," ")}}function w(t,e){if(1&t&&(i.mc(0,"p"),i.mc(1,"label"),i.ad(2,"OS:"),i.lc(),i.ad(3),i.lc()),2&t){const t=i.Bc(2);i.Ub(3),i.cd(" ",t.os,"")}}function x(t,e){if(1&t&&(i.mc(0,"p"),i.mc(1,"label"),i.ad(2,"SSID:"),i.lc(),i.ad(3),i.lc()),2&t){const t=i.Bc(2);i.Ub(3),i.cd(" ",t.ssid,"")}}function j(t,e){if(1&t&&(i.mc(0,"p"),i.mc(1,"label"),i.ad(2,"Username:"),i.lc(),i.ad(3),i.lc()),2&t){const t=i.Bc(2);i.Ub(3),i.cd(" ",(null==t.user?null:t.user.name)||(null==t.user?null:t.user.username)||t.username," ")}}function M(t,e){if(1&t&&(i.mc(0,"p"),i.mc(1,"label"),i.ad(2,"Type:"),i.lc(),i.ad(3),i.lc()),2&t){const t=i.Bc(2);i.Ub(3),i.cd(" ",t.user.type,"")}}function I(t,e){if(1&t){const t=i.nc();i.mc(0,"div",4),i.xc("mouseleave",(function(){return i.Pc(t),i.Bc().close()})),i.hc(1,"div",5),i.mc(2,"div",6),i.mc(3,"p"),i.mc(4,"label"),i.ad(5,"MAC:"),i.lc(),i.ad(6),i.lc(),i.mc(7,"p"),i.mc(8,"label"),i.ad(9,"Accuracy:"),i.lc(),i.ad(10),i.lc(),i.mc(11,"p"),i.mc(12,"label"),i.ad(13,"Last Seen:"),i.lc(),i.ad(14),i.lc(),i.Yc(15,y,4,1,"p",7),i.Yc(16,w,4,1,"p",7),i.Yc(17,x,4,1,"p",7),i.Yc(18,j,4,1,"p",7),i.Yc(19,M,4,1,"p",7),i.lc(),i.lc()}if(2&t){const t=i.Bc();i.Ub(6),i.cd(" ",t.mac,""),i.Ub(4),i.cd(" ",t.variance,"m"),i.Ub(4),i.cd(" ",t.last_seen,""),i.Ub(1),i.Hc("ngIf",t.manufacturer),i.Ub(1),i.Hc("ngIf",t.os),i.Ub(1),i.Hc("ngIf",t.ssid),i.Ub(1),i.Hc("ngIf",t.username),i.Ub(1),i.Hc("ngIf",t.user)}}let P=(()=>{class t{constructor(t,e,s){this._details=t,this._element=e,this._overlay=s,this.username="",this.user=this._details.user,this.mac=this._details.mac,this.manufacturer=this._details.manufacturer,this.os=this._details.os,this.ssid=this._details.ssid,this.variance=this._details.variance.toFixed(2),this.diameter=100*this._details.variance,this.bg_color=this._details.bg_color||this.distance_color,this.overlay_ref=null,this.onEnter=()=>this.loadUser(),this.onLeave=()=>this.close(),this.onClick=()=>this.loadUser(),this.onTouch=()=>this.loadUser()}get last_seen(){return Object(f.a)(new Date(1e3*this._details.last_seen),{addSuffix:!0})}get distance(){return Math.abs(Object(g.a)(1e3*this._details.last_seen,new Date))}get distance_color(){return this.distance<10?"#43a047":this.distance<20?"#ffb300":"#e53935"}ngOnInit(t=0){t>10||setTimeout(()=>{var e;const s=null===(e=this._element.nativeElement.parentElement)||void 0===e?void 0:e.parentElement;if(!s)return this.ngOnInit(++t);const n=parseInt(s.style.top,10)/100,i=parseInt(s.style.left,10)/100;this.y_pos=n>=.5?"bottom":"top",this.x_pos=i>=.5?"end":"start"},200)}loadUser(){return Object(n.a)(this,void 0,void 0,(function*(){if(this.open(),this.username)return;const t=Object(o.e)(this._details.system,"LocationServices");if(t){this.username="Loading...";const e=yield t.execute("check_ownership_of",[this.mac]).catch(t=>null);this.username=e&&e.assigned_to?e.assigned_to:""}}))}open(){this.overlay_ref&&this.close(),this._portal&&(this.overlay_ref=this._overlay.create({positionStrategy:this._overlay.position().flexibleConnectedTo(this._dot).withPositions([{originX:"start"===this.x_pos?"end":"start",originY:"top"===this.y_pos?"bottom":"top",overlayX:this.x_pos||"end",overlayY:this.y_pos||"bottom"}])}),this.overlay_ref.attach(this._portal))}close(){this.overlay_ref&&(this.overlay_ref.dispose(),this.overlay_ref=null)}}return t.\u0275fac=function(e){return new(e||t)(i.gc(d.d),i.gc(i.r),i.gc(v.c))},t.\u0275cmp=i.ac({type:t,selectors:[["","explore-device-info",""]],viewQuery:function(t,e){if(1&t&&(i.fd(m.b,1),i.fd(O,1)),2&t){let t;i.Lc(t=i.yc())&&(e._portal=t.first),i.Lc(t=i.yc())&&(e._dot=t.first)}},hostBindings:function(t,e){1&t&&i.xc("mouseenter",(function(){return e.onEnter()}))("mouseleave",(function(){return e.onLeave()}))("click",(function(){return e.onClick()}))("touchend",(function(){return e.onTouch()}))},attrs:k,decls:4,vars:4,consts:[["name","radius",1,"radius","absolute","center","bg-blue-600","bg-opacity-25","border-4","border-dashed","border-blue-600","rounded-full",3,"mouseenter"],["name","dot",1,"h-2","w-2","absolute","center","rounded-full","pointer-events-auto"],["dot",""],["cdk-portal",""],["name","device-info",1,"rounded","bg-white","p-4","top-0","left-0","shadow","pointer-events-none",3,"mouseleave"],[1,"arrow"],[1,"details"],[4,"ngIf"]],template:function(t,e){1&t&&(i.mc(0,"div",0),i.xc("mouseenter",(function(){return e.loadUser()})),i.lc(),i.hc(1,"div",1,2),i.Yc(3,I,20,8,"ng-template",3)),2&t&&(i.Uc("height: "+e.diameter+"%; width: "+e.diameter+"%;"),i.Ub(1),i.Vc("background-color",e.bg_color))},directives:[m.i,h.n],styles:["[_nghost-%COMP%] {\n                pointer-events: auto;\n            }\n\n            [_nghost-%COMP%]    > [name='dot'][_ngcontent-%COMP%] {\n                box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.35);\n                background-color: #616161;\n            }\n\n            [_nghost-%COMP%]:hover    > [name='radius'][_ngcontent-%COMP%] {\n                opacity: 1;\n            }\n\n            [name='radius'][_ngcontent-%COMP%] {\n                opacity: 0;\n                transition: opacity 200ms;\n                pointer-events: none;\n            }\n\n            [name='device-info'][_ngcontent-%COMP%] {\n                width: 16rem;\n                pointer-events: none;\n            }"]}),t})();function C(t,e){if(1&t&&(i.mc(0,"p",6),i.ad(1),i.lc()),2&t){const t=i.Bc();i.Ub(1),i.bd(t.user)}}function U(t,e){if(1&t&&(i.mc(0,"p",7),i.ad(1),i.Cc(2,"date"),i.Cc(3,"date"),i.lc()),2&t){const t=i.Bc();i.Ub(1),i.dd(" ",i.Ec(2,2,t.start,"shortTime")," \u2013 ",i.Ec(3,5,t.end,"shortTime")," ")}}let B=(()=>{class t{constructor(t,e){this._details=t,this._element=e,this.map_id=this._details.map_id,this.user=this._details.user,this.start=this._details.start,this.end=this._details.end}ngOnInit(t=0){t>10||setTimeout(()=>{var e;const s=null===(e=this._element.nativeElement.parentElement)||void 0===e?void 0:e.parentElement;if(!s)return this.ngOnInit(++t);const n=parseInt(s.style.top,10)/100,i=parseInt(s.style.left,10)/100;this.y_pos=n>=.5?"bottom":"top",this.x_pos=i>=.5?"right":"left"},200)}get available_until(){return""}}return t.\u0275fac=function(e){return new(e||t)(i.gc(d.d),i.gc(i.r))},t.\u0275cmp=i.ac({type:t,selectors:[["explore-desk-info"]],decls:7,vars:6,consts:[["name","space-info",3,"id"],[1,"arrow"],[1,"details"],[1,"m-0","font-medium"],["class","mt-2 text-sm",4,"ngIf"],["class","mt-1 text-sm",4,"ngIf"],[1,"mt-2","text-sm"],[1,"mt-1","text-sm"]],template:function(t,e){1&t&&(i.mc(0,"div",0),i.hc(1,"div",1),i.mc(2,"div",2),i.mc(3,"h4",3),i.ad(4),i.lc(),i.Yc(5,C,2,1,"p",4),i.Yc(6,U,4,8,"p",5),i.lc(),i.lc()),2&t&&(i.Wb("absolute rounded bg-white p-4 top-0 left-0 shadow "+e.x_pos+" "+e.y_pos),i.Hc("id",e.map_id),i.Ub(4),i.bd(e.map_id),i.Ub(1),i.Hc("ngIf",e.user),i.Ub(1),i.Hc("ngIf",e.start))},directives:[h.n],pipes:[h.f],styles:["[_nghost-%COMP%] {\n                position: absolute;\n                top: 50%;\n                left: 50%;\n                transform: translate(-50%, -50%);\n                pointer-events: none;\n                z-index: 1;\n            }\n\n            [name='space-info'][_ngcontent-%COMP%] {\n                width: 16rem;\n            }\n\n            [name='status'][_ngcontent-%COMP%] {\n                background-color: #43a047;\n                font-weight: 500;\n            }\n\n            [name='status'].busy[_ngcontent-%COMP%] {\n                background-color: #e53935;\n            }\n\n            [name='status'].pending[_ngcontent-%COMP%] {\n                background-color: #ffb300;\n            }\n\n            [name='status'].not-bookable[_ngcontent-%COMP%] {\n                background-color: #757575;\n            }"]}),t})();var z=s("TLy2"),D=s("YtkY"),E=s("4e/d"),Y=s("jOdJ"),T=s("xduN"),H=s("9MvL"),V=s("KuCG");let L=(()=>{class t extends r.b{constructor(t,e,s,n){super(),this._state=t,this._org=e,this._settings=s,this._desks_service=n,this._level=null,this._in_use=new a.a([]),this._options=new a.a({}),this._desks=new a.a([]),this._reserved=new a.a([]),this._statuses={},this._bindings=[],this._stats=new a.a({free:0,occupied:0,total:0}),this._poll=new a.a(0),this._desk_bookings=Object(c.a)([this._state.level,this._poll]).pipe(Object(z.a)(([t,e])=>Object(l.e)({period_start:Object(T.a)(Object(H.a)(new Date)),period_end:Object(T.a)(Object(V.a)(new Date)),type:"desk",zones:t.id}))),this.desk_list=this._state.level.pipe(Object(z.a)(t=>Object(o.s)(t.id,{name:"desks"}).pipe(Object(D.a)(e=>e.details.map(e=>new b.b(Object.assign(Object.assign({},e),{zone:t})))))),Object(E.a)(t=>[])),this.ngOnInit()}ngOnInit(){return Object(n.a)(this,void 0,void 0,(function*(){yield this._org.initialised.pipe(Object(Y.a)(t=>t)).toPromise(),this.setOptions({enable_booking:!1!==this._settings.get("app.desks.enabled")}),this.subscription("spaces",this._state.level.subscribe(t=>{this.clearBindings(),this._level=t,this.bindToDesks()})),this.subscription("changes",Object(c.a)([this.desk_list,this._in_use,this._reserved,this._options]).subscribe(([t,e,s])=>{this._statuses={};for(const{id:n,bookable:i}of t){const t=e.some(t=>n===t),o=s.some(t=>n===t);this._statuses[n]=i?t?o?"reserved":"busy":"free":"not-bookable"}this.processDesks(t),this.timeout("update",()=>this.updateStatus(),100)})),this.subscription("desks",this.desk_list.subscribe(t=>this.processDesks(t))),this.subscription("desks_in_use_bookings",this._desk_bookings.subscribe(t=>this._in_use.next(t.map(t=>t.asset_id))))}))}ngOnDestroy(){super.ngOnDestroy(),this.clearBindings()}startPolling(t=3e4){this.interval("poll",()=>this._poll.next((new Date).valueOf()),t)}stopPolling(){this.clearInterval("poll")}setOptions(t){this._options.next(Object.assign(Object.assign({},this._options.getValue()),t))}clearBindings(){const t=["desks_in_use","desk_list"];for(const e of t)this.unsub(e);this._bindings.forEach(t=>t.unbind()),this._bindings=[],this._statuses={}}bindToDesks(){if(!this._level)return;if(!this._org.buildings.find(t=>t.id===this._level.parent_id))return;const t=this._org.building.bindings.area_management||this._org.organisation.bindings.area_management;if(!t)return void this.startPolling();let e=Object(o.e)(t,"AreaManagement").binding(this._level.id);this.subscription("desks_in_use",e.listen().subscribe(e=>{const s=((null==e?void 0:e.value)||[]).filter(t=>"desk"!==t.location),n=((null==e?void 0:e.value)||[]).filter(t=>"desk"===t.location);this._in_use.next(n.map(t=>t.map_id)),this._reserved.next(n.filter(t=>!t.at_location).map(t=>t.map_id)),this.processDevices(s,t)})),e.bind(),this._bindings.push(e),e=Object(o.e)(t,"AreaManagement").binding(this._level.id+":desk_ids"),this.subscription("desks_list",e.listen().subscribe(t=>this._desks.next(t||[]))),e.bind(),this._bindings.push(e)}updateStatus(){const t={},e=this._settings.get("app.explore.colors")||{};for(const s in this._statuses)this._statuses.hasOwnProperty(s)&&(t["#"+s]={fill:e["desk-"+this._statuses[s]]||e[""+this._statuses[s]]||p[""+this._statuses[s]],opacity:.6});this._state.setStyles("desks",t)}processDevices(t,e){var s,n;const i=[];for(const o of t){const t=o.x/o.map_width,a=o.y/o.map_height;i.push({location:{x:(null===(s=o.coordinates_from)||void 0===s?void 0:s.includes("right"))?1-t:t,y:(null===(n=o.coordinates_from)||void 0===n?void 0:n.includes("bottom"))?1-a:a},content:P,data:Object.assign(Object.assign({},o),{system:e})})}i.sort((t,e)=>1-Math.sqrt(Math.pow(t.x-.5,2)+Math.pow(t.x-.5,2))-(1-Math.sqrt(Math.pow(e.x-.5,2)+Math.pow(e.x-.5,2)))),this._state.setFeatures("devices",i)}processDesks(t){const e=[],s=[],n=this._options.getValue();for(const i of t)e.push({location:i.id,content:B,hover:!0,data:{map_id:i.name,status:this._statuses[i.map_id]}}),s.push({id:i.id,action:"click",callback:()=>this._desks_service.bookDesk({desks:[i],host:n.host,date:n.date})}),s.push({id:i.id,action:"touchend",callback:()=>this._desks_service.bookDesk({desks:[i],host:n.host,date:n.date})});this._state.setActions("desks",this._options.getValue().enable_booking?s:[]),this._state.setFeatures("desks",e)}}return t.\u0275fac=function(e){return new(e||t)(i.tc(_.a),i.tc(b.c),i.tc(r.e),i.tc(l.b))},t.\u0275prov=i.cc({token:t,factory:t.\u0275fac}),t})();s("sEIs"),s("R7+U"),s("mFH5"),s("mjT4"),s("6CBO"),s("lYMz"),s("gGs/");var S=s("k8N0");s("ROBh"),s("mWib"),s("wqq/"),s("ulve");var F=s("KXYN");let A=(()=>{class t{}return t.\u0275fac=function(e){return new(e||t)},t.\u0275mod=i.ec({type:t}),t.\u0275inj=i.dc({imports:[[h.c,d.b,u.h,u.p,S.b,v.f,m.g,F.a]]}),t})()},"gGs/":function(t,e,s){"use strict";s.d(e,"a",(function(){return c}));var n=s("EM62"),i=s("T50y"),o=s("PBFl"),a=s("0/Ep");let c=(()=>{class t{constructor(t){this._state=t,this.zoomIn=()=>this._state.setPositions(Math.min(10,1.2*this._state.positions.zoom),this._state.positions.center),this.zoomOut=()=>this._state.setPositions(Math.max(1,this._state.positions.zoom*(1/1.2)),this._state.positions.center),this.reset=()=>this._state.setPositions(1,{x:.5,y:.5})}}return t.\u0275fac=function(e){return new(e||t)(n.gc(i.a))},t.\u0275cmp=n.ac({type:t,selectors:[["explore-zoom-controls"]],decls:9,vars:0,consts:[["mat-icon-button","",1,"bg-white",3,"click"]],template:function(t,e){1&t&&(n.mc(0,"button",0),n.xc("click",(function(){return e.zoomIn()})),n.mc(1,"app-icon"),n.ad(2,"add"),n.lc(),n.lc(),n.mc(3,"button",0),n.xc("click",(function(){return e.zoomOut()})),n.mc(4,"app-icon"),n.ad(5,"remove"),n.lc(),n.lc(),n.mc(6,"button",0),n.xc("click",(function(){return e.reset()})),n.mc(7,"app-icon"),n.ad(8,"autorenew"),n.lc(),n.lc())},directives:[o.b,a.a],styles:["[_nghost-%COMP%] {\n                display: flex;\n                flex-direction: column;\n                padding: .5rem;\n            }\n\n            button[_ngcontent-%COMP%] {\n                border: 1px solid #ccc;\n                border-radius: 0;\n            }\n\n            button[_ngcontent-%COMP%]:first-child {\n                border-radius: 0.25rem 0.25rem 0 0;\n                border-bottom: none;\n            }\n\n            button[_ngcontent-%COMP%]:last-child {\n                border-radius: 0 0 0.25rem 0.25rem;\n                border-top: none;\n            }"]}),t})()}}]);
//# sourceMappingURL=default~desks-desks-module~facilities-facilities-module.6bdc160c037db755ca3e.js.map