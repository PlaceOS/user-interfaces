{"version":3,"file":"common.js","mappings":"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","names":["ScheduleStateService","AsyncHandler","constructor","_settings","_org","_lockers","_this","super","this","_poll","BehaviorSubject","_poll_type","_loading","_filters","shown_types","_date","Date","now","_update","combineLatest","pipe","debounceTime","tap","_","next","_deleted","_space_bookings","active_building","filter","distinctUntilKeyChanged","unsubWith","switchMap","id","requestSpacesForZone","distinctUntilChanged","s1","s2","list","map","space","binding","getModule","obs","listen","event_list","i","CalendarEvent","resources","attendees","email","resource","system","catchError","of","hasSubscription","subscription","bind","flatten","shareReplay","ws_events","date","user","currentUser","isSameDay","host","toLowerCase","find","a","api_events","query","period_start","getUnixTime","startOfDay","period_end","endOfDay","get","queryBookings","type","newCalendarEventFromBooking","queryEvents","events","t","timeout","visitors","console","error","desks","include_checked_out","parking","lockers","lockers$","_ref","_asyncToGenerator","bld","system_id","log","execute","catch","_x","apply","arguments","locker","locker_id","level","level_id","building","levelWithID","parent_id","Booking","valueOf","duration","title","description","locker_name","booking_type","all_day","asset_id","asset_name","zones","extension_data","map_id","e","data","bookings","v","d","p","l","sort","b","filtered_bookings","bkns","filters","includes","asObservable","loading","subscribe","JSON","parse","sessionStorage","getItem","triggerPoll","startPolling","delay","interval","document","visibilityState","stopPolling","clearInterval","setDate","removeItem","item","setAsDeleted","push","setItem","stringify","toggleType","name","clear","_this2","getValue","i0","i1","i2","i3","_angular_core__WEBPACK_IMPORTED_MODULE_23__","Yz7","factory","Éµfac","providedIn","_options","start","_schedule","options","schedule","calendars","timer","queryCalendars","mergeMap","addDays","calendar","timePeriodsIntersect","forkJoin","status","unique","setOptions","_angular_core__WEBPACK_IMPORTED_MODULE_19__","CalendarService","_calendars","calendar_list","freeBusy","q","querySpaceFreeBusy","availability","queryCalendarAvailability","initialised","first","init","_initialised","getFreeBusyDate","checkSpacesAvailability","system_ids","old_booking","result","join","toPromise","end","addMinutes","every","index","findIndex","block","splice","length","core"],"sourceRoot":"webpack:///","sources":["./apps/workplace/src/app/new-schedule/schedule-state.service.ts","./apps/workplace/src/app/schedule/schedule-state.service.ts","./libs/calendar/src/lib/calendar.service.ts"],"sourcesContent":["import { Injectable } from '@angular/core';\nimport { Booking, LockersService, queryBookings } from '@placeos/bookings';\nimport {\n    AsyncHandler,\n    currentUser,\n    flatten,\n    SettingsService,\n} from '@placeos/common';\nimport {\n    CalendarEvent,\n    newCalendarEventFromBooking,\n    queryEvents,\n} from '@placeos/events';\nimport { OrganisationService } from '@placeos/organisation';\nimport { requestSpacesForZone } from '@placeos/spaces';\nimport { getModule } from '@placeos/ts-client';\nimport { endOfDay, getUnixTime, isSameDay, startOfDay } from 'date-fns';\nimport { BehaviorSubject, combineLatest, Observable, of } from 'rxjs';\nimport {\n    catchError,\n    debounceTime,\n    distinctUntilChanged,\n    distinctUntilKeyChanged,\n    filter,\n    map,\n    shareReplay,\n    switchMap,\n    tap,\n} from 'rxjs/operators';\n\n@Injectable({\n    providedIn: 'root',\n})\nexport class ScheduleStateService extends AsyncHandler {\n    private _poll = new BehaviorSubject(0);\n    private _poll_type = new BehaviorSubject<'api' | 'ws'>('api');\n    private _loading = new BehaviorSubject(false);\n    private _filters = new BehaviorSubject({\n        shown_types: ['event', 'desk', 'parking', 'visitor', 'locker'],\n    });\n    private _date = new BehaviorSubject(Date.now());\n    private _update = combineLatest([this._date, this._poll]).pipe(\n        debounceTime(500),\n        tap((_) => this._loading.next(true))\n    );\n\n    private _deleted: string[] = [];\n\n    private _space_bookings: Observable<CalendarEvent[]> =\n        this._org.active_building.pipe(\n            filter((_) => !!_),\n            distinctUntilKeyChanged('id'),\n            debounceTime(300),\n            tap((_) => this.unsubWith('bind:')),\n            switchMap(({ id }) => {\n                this._loading.next(true);\n                return requestSpacesForZone(id);\n            }), // Get list of spaces for building\n            distinctUntilChanged(([s1], [s2]) => s1 !== s2),\n            switchMap((list) => {\n                this._loading.next(false);\n                return combineLatest(\n                    (list || []).map((space) => {\n                        const binding = getModule(space.id, 'Bookings').binding(\n                            'bookings'\n                        );\n                        const obs = binding.listen().pipe(\n                            map((event_list) =>\n                                (event_list || []).map(\n                                    (i) =>\n                                        new CalendarEvent({\n                                            ...i,\n                                            resources: i.attendees.filter(\n                                                (_) =>\n                                                    _.email === space.email ||\n                                                    _.resource\n                                            ),\n                                            system: space,\n                                        })\n                                )\n                            ),\n                            catchError((_) => of([]))\n                        );\n                        if (!this.hasSubscription(`bind:${space.id}`)) {\n                            this.subscription(\n                                `bind:${space.id}`,\n                                binding.bind()\n                            );\n                        }\n                        return obs;\n                    })\n                );\n            }),\n            map((_) => flatten<CalendarEvent>(_)),\n            shareReplay(1)\n        );\n\n    public readonly ws_events = combineLatest([\n        this._space_bookings,\n        this._update,\n    ]).pipe(\n        map(([_, [date]]) => {\n            const user = currentUser();\n            return _.filter(\n                (_) =>\n                    isSameDay(_.date, date) &&\n                    (_.host.toLowerCase() === user.email.toLowerCase() ||\n                        _.attendees.find(\n                            (a) =>\n                                a.email.toLowerCase() ===\n                                user.email.toLowerCase()\n                        ))\n            );\n        })\n    );\n    /** List of calendar events for the selected date */\n    public readonly api_events: Observable<CalendarEvent[]> = this._update.pipe(\n        switchMap(([date]) => {\n            const query = {\n                period_start: getUnixTime(startOfDay(date)),\n                period_end: getUnixTime(endOfDay(date)),\n            };\n            return this._settings.get('app.events.use_bookings')\n                ? queryBookings({ ...query, type: 'room' }).pipe(\n                      map((_) => _.map((i) => newCalendarEventFromBooking(i))),\n                      catchError((_) => of([]))\n                  )\n                : queryEvents({ ...query }).pipe(catchError((_) => of([])));\n        }),\n        shareReplay(1)\n    );\n    /** List of calendar events for the selected date */\n    public readonly events = combineLatest([this._poll_type]).pipe(\n        switchMap(([t]) => (t === 'api' ? this.api_events : this.ws_events)),\n        tap(() => this.timeout('end_loading', () => this._loading.next(false))),\n        shareReplay(1)\n    );\n    /** List of desk bookings for the selected date */\n    public readonly visitors: Observable<Booking[]> = this._update.pipe(\n        switchMap(([date]) =>\n            queryBookings({\n                period_start: getUnixTime(startOfDay(date)),\n                period_end: getUnixTime(endOfDay(date)),\n                type: 'visitor',\n            }).pipe(\n                catchError((_) => {\n                    console.error(_);\n                    return of([]);\n                })\n            )\n        ),\n        tap(() => this.timeout('end_loading', () => this._loading.next(false))),\n        shareReplay(1)\n    );\n    /** List of desk bookings for the selected date */\n    public readonly desks: Observable<Booking[]> = this._update.pipe(\n        switchMap(([date]) =>\n            queryBookings({\n                period_start: getUnixTime(startOfDay(date)),\n                period_end: getUnixTime(endOfDay(date)),\n                include_checked_out: true,\n                type: 'desk',\n            }).pipe(\n                catchError((_) => {\n                    console.error(_);\n                    return of([]);\n                })\n            )\n        ),\n        tap(() => this.timeout('end_loading', () => this._loading.next(false))),\n        shareReplay(1)\n    );\n    /** List of parking bookings for the selected date */\n    public readonly parking: Observable<Booking[]> = this._update.pipe(\n        switchMap(([date]) =>\n            queryBookings({\n                period_start: getUnixTime(startOfDay(date)),\n                period_end: getUnixTime(endOfDay(date)),\n                type: 'parking',\n            }).pipe(catchError((_) => of([])))\n        ),\n        tap(() => this.timeout('end_loading', () => this._loading.next(false))),\n        shareReplay(1)\n    );\n    /** List of parking bookings for the selected date */\n    public readonly lockers: Observable<Booking[]> = combineLatest([\n        this._org.active_building.pipe(\n            filter((_) => !!_),\n            distinctUntilKeyChanged('id')\n        ),\n        this._lockers.lockers$,\n    ]).pipe(\n        debounceTime(300),\n        switchMap(async ([bld, lockers]) => {\n            const system_id = this._org.binding('lockers');\n            console.log('Lockers:', bld, system_id);\n            if (!system_id) return of([[], lockers]);\n            const mod = getModule(system_id, 'LockerLocations');\n            return [\n                await mod.execute('lockers_allocated_to_me').catch((_) => []),\n                lockers,\n            ] as any;\n        }),\n        map(([_, lockers]) =>\n            _.map((i) => {\n                const locker = lockers.find((_) => _.id === i.locker_id);\n                i.level = i.level || locker?.level_id;\n                i.building =\n                    i.building ||\n                    this._org.levelWithID([locker.level_id])?.parent_id;\n                return new Booking({\n                    date: startOfDay(Date.now()).valueOf(),\n                    duration: 24 * 60 - 1,\n                    title: 'Locker Booking',\n                    description: i.locker_name,\n                    booking_type: 'locker',\n                    all_day: true,\n                    asset_id: i.locker_id,\n                    asset_name: i.locker_name,\n                    zones: [i.building, i.level],\n                    extension_data: {\n                        map_id: i.locker_id,\n                    },\n                });\n            })\n        ),\n        catchError((e) => {\n            console.log(e);\n            return of([]);\n        }),\n        tap((data) => {\n            console.log('Your Lockers:', data);\n            this.timeout('end_loading', () => this._loading.next(false));\n        }),\n        shareReplay(1)\n    );\n\n    /** List of events and bookings for the selected date */\n    public readonly bookings = combineLatest([\n        this.events,\n        this.visitors,\n        this.desks,\n        this.parking,\n        this.lockers,\n    ]).pipe(\n        map(([e, v, d, p, l]) =>\n            [...e, ...v, ...d, ...p, ...l].sort((a, b) => a.date - b.date)\n        )\n    );\n    /** Filtered list of events and bookings for the selected date */\n    public readonly filtered_bookings = combineLatest([\n        this.bookings,\n        this._filters,\n    ]).pipe(\n        map(([bkns, filters]) =>\n            bkns.filter(\n                (_) =>\n                    (!this._deleted.includes(_.id) &&\n                        _ instanceof CalendarEvent &&\n                        filters?.shown_types?.includes('event')) ||\n                    filters?.shown_types?.includes((_ as any).booking_type)\n            )\n        )\n    );\n    /** Currently selected date */\n    public readonly filters = this._filters.asObservable();\n    /** Currently selected date */\n    public readonly date = this._date.asObservable();\n    /** Whether events and bookings are loading */\n    public readonly loading = this._loading.asObservable();\n\n    constructor(\n        private _settings: SettingsService,\n        private _org: OrganisationService,\n        private _lockers: LockersService\n    ) {\n        super();\n        this.subscription(\n            'poll_type',\n            this._org.active_building.subscribe(() =>\n                this._poll_type.next(\n                    this._settings.get('app.schedule.use_websocket')\n                        ? 'ws'\n                        : 'api'\n                )\n            )\n        );\n        this._deleted = JSON.parse(\n            sessionStorage.getItem('PLACEOS.events.deleted') || '[]'\n        );\n    }\n\n    public triggerPoll() {\n        this._poll.next(Date.now());\n    }\n\n    public startPolling(delay = 60 * 1000) {\n        this.interval(\n            'poll',\n            () => {\n                document.visibilityState === 'visible'\n                    ? this._poll.next(Date.now())\n                    : '';\n            },\n            delay\n        );\n        return () => this.stopPolling();\n    }\n\n    public stopPolling() {\n        this.clearInterval('poll');\n    }\n\n    public setDate(date: number) {\n        this._date.next(date);\n    }\n\n    public removeItem(item) {\n        this.setAsDeleted(item.id);\n        this._poll.next(Date.now());\n    }\n\n    public setAsDeleted(id: string) {\n        this._deleted.push(id);\n        sessionStorage.setItem(\n            'PLACEOS.events.deleted',\n            JSON.stringify(this._deleted)\n        );\n    }\n\n    public async toggleType(name: string, clear: boolean = false) {\n        const filters = this._filters.getValue() || { shown_types: [] };\n        const { shown_types } = filters;\n        if (shown_types && (shown_types.includes(name) || clear)) {\n            this._filters.next({\n                ...filters,\n                shown_types: shown_types.filter((_) => _ !== name),\n            });\n        } else {\n            this._filters.next({\n                ...filters,\n                shown_types: [...shown_types, name],\n            });\n        }\n    }\n}\n","import { Injectable } from '@angular/core';\nimport { Booking, queryBookings } from '@placeos/bookings';\nimport { queryCalendars } from '@placeos/calendar';\nimport {\n    AsyncHandler,\n    SettingsService,\n    timePeriodsIntersect,\n    unique,\n} from '@placeos/common';\nimport {\n    CalendarEvent,\n    newCalendarEventFromBooking,\n    queryEvents,\n} from '@placeos/events';\nimport { addDays, endOfDay, getUnixTime, startOfDay } from 'date-fns';\nimport {\n    BehaviorSubject,\n    combineLatest,\n    forkJoin,\n    Observable,\n    timer,\n} from 'rxjs';\nimport {\n    catchError,\n    debounceTime,\n    map,\n    mergeMap,\n    shareReplay,\n    switchMap,\n    tap,\n} from 'rxjs/operators';\n\nexport type BookingLike = CalendarEvent & Booking;\n\nexport interface ScheduleOptions {\n    calendar?: string;\n    start: number;\n}\n\n@Injectable({\n    providedIn: 'root',\n})\nexport class ScheduleStateService extends AsyncHandler {\n    private _poll = new BehaviorSubject(0);\n    private _options = new BehaviorSubject<ScheduleOptions>({\n        start: Date.now(),\n    });\n    private _loading = new BehaviorSubject<string>('');\n    private _schedule = new BehaviorSubject<BookingLike[]>([]);\n\n    public readonly options = this._options.asObservable();\n    public readonly loading = this._loading.asObservable();\n    public readonly schedule = this._loading.asObservable();\n\n    public readonly calendars = timer(1000).pipe(\n        switchMap((_) => queryCalendars()),\n        shareReplay(1)\n    );\n\n    public readonly events: Observable<BookingLike[]> = combineLatest([\n        this._options,\n        this._poll,\n    ]).pipe(\n        debounceTime(1000),\n        mergeMap(([options]) => {\n            this._loading.next('Loading schedule...');\n            const query: any = {\n                period_start: getUnixTime(startOfDay(options.start)),\n                period_end: getUnixTime(addDays(endOfDay(options.start), 6)),\n            };\n            if (options.calendar) {\n                query.calendar = options.calendar;\n            }\n            this._schedule.next(\n                this._schedule\n                    .getValue()\n                    .filter(\n                        (_) =>\n                            !timePeriodsIntersect(\n                                query.period_start * 1000,\n                                query.period_end * 1000,\n                                _.date,\n                                _.date + _.duration * 60 * 1000\n                            )\n                    )\n            );\n            return forkJoin([\n                this._settings.get('app.events.use_bookings') === true\n                    ? queryBookings({ ...query, type: 'room' }).pipe(\n                          map((_) =>\n                              _.map((i) => newCalendarEventFromBooking(i))\n                          )\n                      )\n                    : queryEvents({ ...query }),\n                queryBookings({ ...query, type: 'desk' }),\n                queryBookings({ ...query, type: 'parking' }),\n            ]).pipe(catchError((_) => []));\n        }),\n        map(([events, bookings]) => {\n            const list = [\n                ...this._schedule.getValue(),\n                ...events,\n                ...bookings.filter((_) => _.status !== 'declined'),\n            ].sort((a, b) => a.date - b.date);\n            this._schedule.next(unique(list, 'id') as any);\n            return list;\n        }),\n        catchError((_) => []),\n        tap((_) => this._loading.next('')),\n        shareReplay(1)\n    );\n\n    constructor(private _settings: SettingsService) {\n        super();\n    }\n\n    public startPolling(delay: number = 15 * 1000) {\n        this.interval('poll', () => this._poll.next(Date.now()), delay);\n    }\n\n    public stopPolling() {\n        this.clearInterval('poll');\n    }\n\n    public setOptions(options: Partial<ScheduleOptions>) {\n        this._options.next({ ...this._options.getValue(), ...options });\n    }\n}\n","import { Injectable } from '@angular/core';\nimport { BehaviorSubject } from 'rxjs';\nimport { first, shareReplay, tap } from 'rxjs/operators';\nimport { addMinutes, endOfDay, getUnixTime, startOfDay } from 'date-fns';\n\nimport { Calendar } from './calendar.class';\n\nimport { AsyncHandler } from 'libs/common/src/lib/async-handler.class';\nimport { SettingsService } from 'libs/common/src/lib/settings.service';\nimport { OrganisationService } from 'libs/organisation/src/lib/organisation.service';\nimport { CalendarEvent } from 'libs/events/src/lib/event.class';\nimport { CalendarAvailabilityQueryParams } from './calendar.interfaces';\nimport {\n    queryCalendarAvailability,\n    queryCalendars,\n    querySpaceFreeBusy,\n} from './calendar.fn';\n\n@Injectable({\n    providedIn: 'root',\n})\nexport class CalendarService extends AsyncHandler {\n    private readonly _calendars = new BehaviorSubject<Calendar[]>([]);\n\n    /** Observable for the list of calendars */\n    public readonly calendar_list = queryCalendars().pipe(\n        tap((l) => this._calendars.next(l)),\n        shareReplay(1)\n    );\n\n    /* istanbul ignore next */\n    public readonly query = () => queryCalendars();\n    /* istanbul ignore next */\n    public readonly freeBusy = (q: CalendarAvailabilityQueryParams) =>\n        querySpaceFreeBusy(q, this._org);\n    /* istanbul ignore next */\n    public readonly availability = (q: CalendarAvailabilityQueryParams) =>\n        queryCalendarAvailability(q);\n\n    constructor(\n        private _org: OrganisationService,\n        private _settings: SettingsService\n    ) {\n        super();\n        this._org.initialised\n            .pipe(first((_) => _))\n            .subscribe(() => this.init());\n    }\n\n    public async init() {\n        if (this._settings.get('app.events.use_bookings')) return;\n        this._initialised.next(true);\n    }\n\n    public get calendars(): Calendar[] {\n        return this._calendars.getValue();\n    }\n\n    /** Get Free busy for the selected day\n     * @param calendars User calendar\n     * @param date Selected day\n     */\n    public getFreeBusyDate(date: number, calendars: string) {\n        return querySpaceFreeBusy(\n            {\n                period_start: getUnixTime(startOfDay(date)),\n                period_end: getUnixTime(endOfDay(date)),\n                calendars,\n            },\n            this._org\n        );\n    }\n\n    /** Check rooms availability */\n    public async checkSpacesAvailability(\n        system_ids: string[],\n        period_start: number,\n        period_end: number,\n        old_booking?: CalendarEvent\n    ) {\n        const result = await queryCalendarAvailability({\n            period_start,\n            period_end,\n            system_ids: system_ids.join(','),\n        }).toPromise();\n        const start = new Date(old_booking?.date).valueOf();\n        const end = addMinutes(start, old_booking?.duration).valueOf();\n        const available = result.every((i) => {\n            const availability = i.availability;\n            if (old_booking && i.id === old_booking.system?.email) {\n                const index = availability.findIndex((block) => {\n                    return (\n                        block.date >= start &&\n                        addMinutes(block.date, block.duration).valueOf() <= end\n                    );\n                });\n                if (index !== -1) {\n                    availability.splice(index, 1);\n                }\n            }\n            return !availability.length;\n        });\n        return !!available;\n    }\n}\n"],"x_google_ignoreList":[]}