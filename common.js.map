{"version":3,"mappings":"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","names":["DesksStateService","BaseClass","constructor","_org","_dialog","super","this","BehaviorSubject","_new_desks","asObservable","_loading","_filters","pipe","debounceTime","switchMap","filters","zones","n","includes","listChildMetadata","o","building","_a","id","name","map","m","i","metadata","desks","details","reduce","c","showMetadata","catchError","_","list","Array","sort","a","b","localeCompare","_desks","Desk","Object","qr_code","generateQRCode","location","origin","encodeURIComponent","shareReplay","next","date","Date","filter","z","length","levelsForBuilding","queryBookings","period_start","Math","floor","startOfDay","valueOf","period_end","endOfDay","type","join","_desk_bookings","Booking","extension_data","checkin_qr_code","asset_id","new_desk_count","e","getValue","setFilters","lvl","s","_b","_c","console","warn","startPolling","delay","interval","stopPolling","clearInterval","addDesks","concat","clearNewDesks","checkinDesk","desk","checkinBooking","toPromise","catch","notifyError","notifySuccess","user_name","approveDesk","approveBooking","format","rejectDesk","rejectBooking","giveAccess","success","saveBooking","access","rejectAllDesks","ref","open","ConfirmModalComponent","data","title","content","icon","class","Promise","resolve","reject","componentInstance","event","first","reason","subscribe","__awaiter","loading","all","close","afterClosed","then","notifyInfo","i0","factory"],"sources":["./apps/concierge/src/app/desks/desks-state.service.ts"],"sourcesContent":["import { Injectable } from '@angular/core';\nimport { BehaviorSubject, Observable } from 'rxjs';\nimport {\n    catchError,\n    debounceTime,\n    first,\n    map,\n    shareReplay,\n    switchMap,\n} from 'rxjs/operators';\nimport { endOfDay, format, startOfDay } from 'date-fns';\n\nimport {\n    approveBooking,\n    Booking,\n    checkinBooking,\n    queryBookings,\n    rejectBooking,\n    saveBooking,\n} from '@placeos/bookings';\nimport {\n    BaseClass,\n    notifyError,\n    notifyInfo,\n    notifySuccess,\n} from '@placeos/common';\nimport { listChildMetadata, showMetadata } from '@placeos/ts-client';\nimport { Desk, OrganisationService } from '@placeos/organisation';\nimport { MatDialog } from '@angular/material/dialog';\nimport { ConfirmModalComponent } from '@placeos/components';\n\nimport { generateQRCode } from 'libs/common/src/lib/qr-code';\n\nexport interface DeskFilters {\n    date?: number;\n    zones?: string[];\n    show_map?: boolean;\n    search?: string;\n}\n\n@Injectable({\n    providedIn: 'root',\n})\nexport class DesksStateService extends BaseClass {\n    private _filters = new BehaviorSubject<DeskFilters>({});\n    private _new_desks = new BehaviorSubject<Desk[]>([]);\n    private _desk_bookings: Booking[] = [];\n    private _desks: Desk[] = [];\n    private _loading = new BehaviorSubject<boolean>(false);\n\n    public readonly new_desks = this._new_desks.asObservable();\n\n    public get new_desk_count() { return this._new_desks.getValue()?.length || 0; }\n\n    public readonly loading = this._loading.asObservable();\n\n    public readonly filters = this._filters.asObservable();\n\n    public readonly desks: Observable<Desk[]> = this._filters.pipe(\n        debounceTime(500),\n        switchMap((filters) => {\n            const zones = filters.zones || [];\n            return !zones.includes('All')\n                ? showMetadata(zones[0], 'desks').pipe(map((m) => m.details))\n                : listChildMetadata(this._org.building?.id, {\n                      name: 'desks',\n                  }).pipe(\n                      map((m) =>\n                          m\n                              .map((i) => i.metadata.desks.details)\n                              .reduce((c: any[], i: any[]) => [...c, ...i], [])\n                      )\n                  );\n        }),\n        catchError((_) => []),\n        map((list) => {\n            if (!(list instanceof Array)) list = [];\n            list.sort((a, b) => a.name.localeCompare(b.name));\n            this._desks = list.map(\n                (i) =>\n                    new Desk({\n                        ...i,\n                        qr_code: generateQRCode(\n                            `${location.origin}/workplace/#/book/code?checkin=${encodeURIComponent(\n                                i.id\n                            )}`\n                        ),\n                    })\n            );\n            return this._desks;\n        }),\n        shareReplay(1)\n    );\n    public readonly bookings = this._filters.pipe(\n        debounceTime(500),\n        switchMap((filters) => {\n            this._loading.next(true);\n            const date = filters.date ? new Date(filters.date) : new Date();\n            let zones = (filters.zones || []).filter(\n                (z: any) => z !== -1 && z !== '-1' && z !== 'All'\n            );\n            if (!zones?.length) {\n                zones = this._org\n                    .levelsForBuilding(this._org.building)\n                    .map((i) => i.id);\n            }\n            return queryBookings({\n                period_start: Math.floor(startOfDay(date).valueOf() / 1000),\n                period_end: Math.floor(endOfDay(date).valueOf() / 1000),\n                type: 'desk',\n                zones: (zones || []).join(','),\n            });\n        }),\n        map((list) => {\n            list.sort((a, b) => a.date - b.date);\n            this._desk_bookings = list.map(\n                (_) =>\n                    new Booking({\n                        ..._,\n                        extension_data: {\n                            ..._.extension_data,\n                            checkin_qr_code: generateQRCode(\n                                `/workplace/#/book/code?checkin=${encodeURIComponent(\n                                    _.asset_id\n                                )}`\n                            ),\n                        },\n                    })\n            );\n            this._loading.next(false);\n            return list;\n        }),\n        shareReplay(1)\n    );\n\n    constructor(private _org: OrganisationService, private _dialog: MatDialog) {\n        super();\n    }\n\n    public setFilters(filters: DeskFilters) {\n        if (filters.zones?.includes('All')) {\n            filters.zones = [\n                'All',\n                ...this._org\n                    .levelsForBuilding(this._org.building)\n                    .map((lvl) => lvl.id),\n            ];\n        } else if (\n            filters.zones &&\n            this._filters.getValue()?.zones?.includes('All')\n        ) {\n            filters.zones = [];\n        }\n        console.warn('Filters:', filters);\n        this._filters.next({ ...this._filters.getValue(), ...filters });\n    }\n\n    public startPolling(delay: number = 30 * 1000) {\n        this.interval(\n            'poll',\n            () => this.setFilters(this._filters.getValue()),\n            delay\n        );\n    }\n\n    public stopPolling() {\n        this.clearInterval('poll');\n    }\n\n    public addDesks(list: Desk[]) {\n        this._new_desks.next(this._new_desks.getValue().concat(list));\n    }\n\n    public clearNewDesks() {\n        this._new_desks.next([]);\n    }\n\n    public async checkinDesk(desk: Booking) {\n        const success = await checkinBooking(desk.id, true)\n            .toPromise()\n            .catch((_) => 'failed');\n        success === 'failed'\n            ? notifyError('Error checking in desk booking')\n            : notifySuccess(`Checked in ${desk.user_name}.`);\n    }\n\n    public async approveDesk(desk: Booking) {\n        const success = await approveBooking(desk.id)\n            .toPromise()\n            .catch((_) => 'failed');\n        success === 'failed'\n            ? notifyError('Error approving in desk booking')\n            : notifySuccess(\n                  `Approved desk booking for ${desk.user_name} on ${format(\n                      desk.date,\n                      'MMM Do'\n                  )}.`\n              );\n    }\n\n    public async rejectDesk(desk: Booking) {\n        const success = await rejectBooking(desk.id)\n            .toPromise()\n            .catch((_) => 'failed');\n        success === 'failed'\n            ? notifyError('Error rejecting in desk booking')\n            : notifySuccess(\n                  `Rejected desk booking for ${desk.user_name} on ${format(\n                      desk.date,\n                      'MMM Do'\n                  )}.`\n              );\n    }\n\n    public async giveAccess(desk: Booking) {\n        const success = await saveBooking(\n            new Booking({ ...desk, access: true })\n        )\n            .toPromise()\n            .catch((_) => 'failed');\n        if (success === 'failed')\n            return notifyError('Error giving building access booking host');\n        notifySuccess(\n            `Successfully gave building access to ${desk.user_name} for desk booking.`\n        );\n        this._desk_bookings = [...this._desk_bookings, success] as any;\n    }\n\n    public async rejectAllDesks() {\n        const list = this._desk_bookings || [];\n        if (list.length > 0) {\n            const ref = this._dialog.open(ConfirmModalComponent, {\n                data: {\n                    title: 'Cancel all desk bookings',\n                    content:\n                        'Are you sure you want to cancel all bookings for the selected date?',\n                    icon: {\n                        type: 'icon',\n                        class: 'material-icons',\n                        content: 'delete',\n                    },\n                },\n            });\n            return new Promise((resolve, reject) => {\n                let success = false;\n                ref.componentInstance.event\n                    .pipe(first((_) => _.reason === 'done'))\n                    .subscribe(async () => {\n                        ref.componentInstance.loading =\n                            'Rejecting all desks for selected date...';\n                        success = true;\n                        await Promise.all(\n                            list.map((desk) =>\n                                rejectBooking(desk.id).toPromise()\n                            )\n                        );\n                        resolve('');\n                        notifySuccess(\n                            'Successfull rejected all desk bookings for selected date.'\n                        );\n                        ref.close();\n                    });\n                ref.afterClosed()\n                    .toPromise()\n                    .then(() => {\n                        if (!success) reject();\n                    });\n            });\n        } else {\n            notifyInfo('No desks to reject for the selected date');\n        }\n    }\n}\n"],"sourceRoot":"webpack:///","file":"common.js"}