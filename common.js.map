{"version":3,"file":"common.js","mappings":"oUA0CO,IAAMA,EAAb,MAAM,MAAOA,UAA6BC,KA2EtCC,YAAoBC,GAChBC,QADgBC,iBA1EZA,WAAQ,IAAIC,IAAgB,GAC5BD,cAAW,IAAIC,IAAiC,CACpDC,MAAOC,KAAKC,QAERJ,cAAW,IAAIC,IAAwB,IACvCD,eAAY,IAAIC,IAA+B,IAEvCD,aAAUA,KAAKK,SAASC,eACxBN,aAAUA,KAAKO,SAASD,eACxBN,cAAWA,KAAKO,SAASD,eAEzBN,gBAAYQ,OAAM,KAAMC,MACpCC,OAAWC,IAAMC,YACjBC,OAAY,IAGAb,aAAoCc,QAAc,CAC9Dd,KAAKK,SACLL,KAAKe,QACNN,MACCO,OAAa,MACbC,QAAS,EAAEC,MACPlB,KAAKO,SAASY,KAAK,uBACnB,MAAMC,EAAa,CACfC,cAAcC,QAAYC,OAAWL,EAAQhB,QAC7CsB,YAAYF,QAAYG,QAAQC,OAASR,EAAQhB,OAAQ,KAE7D,OAAIgB,EAAQS,WACRP,EAAMO,SAAWT,EAAQS,UAE7B3B,KAAK4B,UAAUT,KACXnB,KAAK4B,UACAC,WACAC,OACInB,KACIoB,QACwB,IAArBX,EAAMC,aACa,IAAnBD,EAAMI,WACNb,EAAEqB,KACFrB,EAAEqB,KAAoB,GAAbrB,EAAEsB,SAAgB,QAIxCC,OAAS,CACZlC,KAAKF,UAAUqC,IAAI,yBACbC,QAAc,IAAKhB,EAAOiB,KAAM,SAAU5B,MACtC6B,OAAK3B,GACDA,EAAE2B,IAAKC,IAAMC,QAA4BD,MAE7CE,OAAY9B,GAAM,MAEtB+B,QAAY,IAAKtB,IAASX,MAAKgC,OAAY9B,GAAM,MACvDyB,QAAc,IAAKhB,EAAOiB,KAAM,SAAU5B,MACtCgC,OAAY9B,GAAM,MAEtByB,QAAc,IAAKhB,EAAOiB,KAAM,YAAa5B,MACzCgC,OAAY9B,GAAM,UAI9B2B,OAAI,EAAEK,EAAQC,MACV,MAAMC,EAAO,IACN7C,KAAK4B,UAAUC,cACfc,KACAC,EAASd,OAAQnB,GAAmB,aAAbA,EAAEmC,SAC9BC,KAAK,CAACC,EAAGC,IAAMD,EAAEhB,KAAOiB,EAAEjB,MAC5B,YAAKJ,UAAUT,MAAK+B,QAAOL,EAAM,OAC1BA,KAEXJ,OAAY9B,GAAM,KAClBwC,OAAKxC,GAAMX,KAAKO,SAASY,KAAK,MAC9BN,OAAY,IAOTuC,aAAaC,EAAgB,MAChCrD,KAAKsD,SAAS,OAAQ,IAAMtD,KAAKe,MAAMI,KAAKhB,KAAKC,OAAQiD,GAGtDE,cACHvD,KAAKwD,cAAc,QAGhBC,WAAWvC,GACdlB,KAAKK,SAASc,KAAK,IAAKnB,KAAKK,SAASwB,cAAeX,kDAxFhDvB,GAAoB+D,wCAApB/D,EAAoBgE,QAApBhE,EAAoB,qBAFjB,SAEHA,GAAb","names":["ScheduleStateService","BaseClass","constructor","_settings","super","this","BehaviorSubject","start","Date","now","_options","asObservable","_loading","timer","pipe","switchMap","_","queryCalendars","shareReplay","combineLatest","_poll","debounceTime","mergeMap","options","next","query","period_start","getUnixTime","startOfDay","period_end","addDays","endOfDay","calendar","_schedule","getValue","filter","timePeriodsIntersect","date","duration","forkJoin","get","queryBookings","type","map","i","newCalendarEventFromBooking","catchError","queryEvents","events","bookings","list","status","sort","a","b","unique","tap","startPolling","delay","interval","stopPolling","clearInterval","setOptions","i0","factory"],"sourceRoot":"webpack:///","sources":["./apps/workplace/src/app/schedule/schedule-state.service.ts"],"sourcesContent":["import { Injectable } from '@angular/core';\nimport { Booking, queryBookings } from '@placeos/bookings';\nimport { queryCalendars } from '@placeos/calendar';\nimport {\n    BaseClass,\n    SettingsService,\n    timePeriodsIntersect,\n    unique,\n} from '@placeos/common';\nimport {\n    CalendarEvent,\n    newCalendarEventFromBooking,\n    queryEvents,\n} from '@placeos/events';\nimport { addDays, endOfDay, getUnixTime, startOfDay } from 'date-fns';\nimport {\n    BehaviorSubject,\n    combineLatest,\n    forkJoin,\n    Observable,\n    timer,\n} from 'rxjs';\nimport {\n    catchError,\n    debounceTime,\n    map,\n    mergeMap,\n    shareReplay,\n    switchMap,\n    tap,\n} from 'rxjs/operators';\n\nexport type BookingLike = CalendarEvent & Booking;\n\nexport interface ScheduleOptions {\n    calendar?: string;\n    start: number;\n}\n\n@Injectable({\n    providedIn: 'root',\n})\nexport class ScheduleStateService extends BaseClass {\n    private _poll = new BehaviorSubject(0);\n    private _options = new BehaviorSubject<ScheduleOptions>({\n        start: Date.now(),\n    });\n    private _loading = new BehaviorSubject<string>('');\n    private _schedule = new BehaviorSubject<BookingLike[]>([]);\n\n    public readonly options = this._options.asObservable();\n    public readonly loading = this._loading.asObservable();\n    public readonly schedule = this._loading.asObservable();\n\n    public readonly calendars = timer(1000).pipe(\n        switchMap((_) => queryCalendars()),\n        shareReplay(1)\n    );\n\n    public readonly events: Observable<BookingLike[]> = combineLatest([\n        this._options,\n        this._poll,\n    ]).pipe(\n        debounceTime(1000),\n        mergeMap(([options]) => {\n            this._loading.next('Loading schedule...');\n            const query: any = {\n                period_start: getUnixTime(startOfDay(options.start)),\n                period_end: getUnixTime(addDays(endOfDay(options.start), 6)),\n            };\n            if (options.calendar) {\n                query.calendar = options.calendar;\n            }\n            this._schedule.next(\n                this._schedule\n                    .getValue()\n                    .filter(\n                        (_) =>\n                            !timePeriodsIntersect(\n                                query.period_start * 1000,\n                                query.period_end * 1000,\n                                _.date,\n                                _.date + _.duration * 60 * 1000\n                            )\n                    )\n            );\n            return forkJoin([\n                this._settings.get('app.no_user_calendar')\n                    ? queryBookings({ ...query, type: 'room' }).pipe(\n                          map((_) =>\n                              _.map((i) => newCalendarEventFromBooking(i))\n                          ),\n                          catchError((_) => [])\n                      )\n                    : queryEvents({ ...query }).pipe(catchError((_) => [])),\n                queryBookings({ ...query, type: 'desk' }).pipe(\n                    catchError((_) => [])\n                ),\n                queryBookings({ ...query, type: 'parking' }).pipe(\n                    catchError((_) => [])\n                ),\n            ]);\n        }),\n        map(([events, bookings]) => {\n            const list = [\n                ...this._schedule.getValue(),\n                ...events,\n                ...bookings.filter((_) => _.status !== 'declined'),\n            ].sort((a, b) => a.date - b.date);\n            this._schedule.next(unique(list, 'id') as any);\n            return list;\n        }),\n        catchError((_) => []),\n        tap((_) => this._loading.next('')),\n        shareReplay(1)\n    );\n\n    constructor(private _settings: SettingsService) {\n        super();\n    }\n\n    public startPolling(delay: number = 15 * 1000) {\n        this.interval('poll', () => this._poll.next(Date.now()), delay);\n    }\n\n    public stopPolling() {\n        this.clearInterval('poll');\n    }\n\n    public setOptions(options: Partial<ScheduleOptions>) {\n        this._options.next({ ...this._options.getValue(), ...options });\n    }\n}\n"]}