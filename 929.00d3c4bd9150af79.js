"use strict";(self.webpackChunkconcierge=self.webpackChunkconcierge||[]).push([[929],{2084:(W,U,s)=>{s.d(U,{f:()=>v});var _=s(5861),p=s(3007),d=s(9112),D=s(8186),n=s(9972),b=s(9756),P=s(9925),F=s(3337),h=s(591),f=s(1086),O=s(3426),r=s(6787),S=s(8723),T=s(5154),C=s(13),B=s(9184),I=s(7545),y=s(2994),K=s(4850),G=s(2198),k=s(7224),Z=s(2986),w=s(565),N=s(6962),x=s(1980),$=s(354),V=s(4282),Q=s(8871),z=s(4367),Y=s(1562),L=s(4650),X=s(5938);const J=["book/desks","book/parking","book/new-desks","book/new-parking"];class v extends d.cx{get view(){return this._view.getValue()}get booking(){return this._booking.getValue()}newForm(e=new N.$){this.form.reset(),this.form.patchValue((0,D.sWL)({...e,...e.extension_data},[null,void 0,""])),this.subscription("form_change",this.form.valueChanges.subscribe(()=>this.storeForm())),this._booking.next(e),this._options.next({type:this._options.getValue().type})}constructor(e,o,t,u,l){super(),this._router=e,this._settings=o,this._org=t,this._dialog=u,this._payments=l,this._view=new h.X("form"),this._options=new h.X({type:"desk"}),this._booking=new h.X(null),this._loading=new h.X(""),this.last_success=new N.$(JSON.parse(sessionStorage.getItem("PLACEOS.last_booked_booking")||"{}")),this.loading=this._loading.asObservable(),this.options=this._options.pipe((0,T.d)(1)),this.form=(0,x.PR)(),this.resource=this.options.pipe((0,C.b)(300),(0,B.g)("type"),(0,I.w)(({type:a})=>{if(!this._org.building)return(0,f.of)([]);switch(a){case"desk":return this._loading.next("Loading desks..."),this.loadResourceList("desks");case"parking":return this._loading.next("Loading parking spaces..."),this.loadResourceList("parking_spaces")}return(0,f.of)([])}),(0,y.b)(()=>this._loading.next("")),(0,T.d)(1)),this.features=this.resource.pipe((0,K.U)(a=>{const E=[];for(const{features:c}of a)c instanceof Array&&c.forEach(i=>E.push(i));return(0,d.Tw)(E).sort((c,i)=>c.localeCompare(i))}),(0,T.d)(1)),this.available_resources=(0,O.aj)([this.options,this.resource,(0,r.T)(this.form.valueChanges,(0,S.H)(1e3))]).pipe((0,G.h)(()=>this.form.getRawValue().date>0&&this.form.getRawValue().duration>0),(0,C.b)(500),(0,y.b)(([{type:a}])=>this._loading.next(`Checking ${a} availability...`)),(0,I.w)(([a,E])=>(0,$.F2)({period_start:(0,n.Z)(this.form.getRawValue().date),period_end:(0,n.Z)((0,b.Z)(this.form.getRawValue().date,this.form.getRawValue().duration||1440)),type:a.type,zones:a.zone_id}).pipe((0,K.U)(c=>E.filter(i=>(!i.groups?.length||i.groups.some(g=>(0,d.ar)().groups.includes(g)))&&!1!==i.bookable&&(!a.features||a.features?.every(g=>i.features.includes(g)))&&(!a.zone_id||a.zone_id===i.zone?.id||a.zone_id===i.zone?.parent_id)&&!c.find(g=>g.asset_id===i.id&&"declined"!==g.status))))),(0,y.b)(()=>this._loading.next("")),(0,T.d)(1)),this.grouped_availability=(0,O.aj)([this.options,this.available_resources]).pipe((0,K.U)(([a,E])=>{const c=[],i=[...E].sort((M,m)=>M.zone?.id?.localeCompare(m.zone?.id)),g=a.members?.length?a.members:[(0,d.ar)()];for(;i.length;){const M=[];let m=i.pop();for(;M.length<g.length&&(!M.length||M.find(A=>A.zone?.id===m.zone?.id));)M.push(m),m=i.pop();M.length<g.length||c.push(M)}return c})),this.subscription("router.bookings",this._router.events.subscribe(a=>{a instanceof p.m2&&!J.find(E=>a.url.includes(E))&&this.clearForm()})),this._org.initialised.pipe((0,k.P)(a=>a)).subscribe(()=>this.setOptions({}))}setView(e){this._view.next(e)}setOptions(e){this._options.next({...this._options.getValue(),...e})}setFeature(e,o){if(!e?.length)return;const t=this._options.getValue()?.features||[];o&&!t.includes(e)&&t.push(e),!o&&t.includes(e)&&t.splice(t.findIndex(u=>u===e),1),this.setOptions({features:t})}resetForm(){const e=this._booking.getValue();this.form.reset(),this.form.patchValue((0,D.sWL)({...e||{},...e?.extension_data||{}},[null,void 0,""])),this._options.next({type:this._options.getValue().type})}clearForm(){sessionStorage.removeItem("PLACEOS.booking_form"),sessionStorage.removeItem("PLACEOS.booking_form_options"),this.newForm()}storeForm(){sessionStorage.setItem("PLACEOS.booking_form",JSON.stringify(this.form.getRawValue()||{})),sessionStorage.setItem("PLACEOS.booking_form_filters",JSON.stringify(this._options.getValue()||{}))}loadForm(){this.form.reset();const e=JSON.parse(sessionStorage.getItem("PLACEOS.booking_form")||"{}"),o=new N.$(e);this._booking.next(o),this.form.patchValue((0,D.sWL)({...o||{},...o?.extension_data||{}},[null,void 0,""])),this.setOptions({zone_id:this._org.building?.id,...JSON.parse(sessionStorage.getItem("PLACEOS.booking_form_filters")||"{}")})}clearOldState(){sessionStorage.removeItem("PLACEOS.last_booked_booking"),this.last_success=new N.$}openBookingLinkModal(e=!1){if(this.form.markAllAsTouched(),!this.form.valid&&!e)return;const o=new N.$({...this.booking,...this.form.getRawValue()});this._dialog.open(z.w,{data:o})}confirmPost(){var e=this;return(0,_.Z)(function*(){yield e.checkQuestions();const o=e._options.getValue(),t=e.form.getRawValue();let u=`Would you like to book the ${o.type} ${t.asset_name} for ${(0,P.Z)(t.date,"dd MMM yyyy")}${t.duration<720?" at "+(0,P.Z)(t.date,"h:mm a"):""}`;o.group&&(u=`${u}.<br>You group members will be assigned desks nearby your selected desk.`);const l=yield(0,d._5)({title:`Book ${o.type}`,content:u,icon:{content:"event_available"}},e._dialog);if("done"!==l?.reason)throw"User cancelled";l.loading("Performing booking request..."),o.group?yield e.postFormForGroup().catch(a=>{throw(0,d.cB)(JSON.stringify(a)),l.close(),a}):yield e.postForm().catch(a=>{throw(0,d.cB)(JSON.stringify(a)),l.close(),a}),l.close()})()}postForm(e=!1){var o=this;return(0,_.Z)(function*(){if(!o.form)throw"No form for booking";if(!o.form.valid)throw`Some form fields are invalid. [${(0,d.RD)(o.form).join(", ")}]`;o.form.patchValue({booking_type:o.form.getRawValue().booking_type||o._options.getValue().type});let t=o.form.getRawValue(),u=o._booking.getValue()||new N.$;if(e||(yield o.checkResourceAvailable(t,o._options.getValue().type)),(t.duration>=720||t.all_day)&&(o.form.patchValue({date:(0,F.Z)(t.date,{hours:11,minutes:59}).valueOf(),duration:720}),t=o.form.getRawValue()),o._payments.payment_module){const E=yield o._payments.makePayment({type:o._options.getValue().type,resource_name:t.asset_name,date:t.date,duration:t.duration,all_day:t.all_day});if(!E?.success)return;t.extension_data={invoice:E,invoice_id:E.invoice_id}}(t.assets?.length||u.extension_data.assets?.length)&&(yield(0,Y.cd)(`${t.booked_by_email}|${t.date}`,{date:t.date,duration:t.duration,host:t.booked_by_email},t.assets,u.extension_data.assets)),o._loading.next("Saving booking");const l=yield(0,$.km)(new N.$({...o._options.getValue(),...t,description:t.asset_name||t.description,user_name:t.user?.name,user_id:(t.user?.id?.includes("@")?"":t?.user?.id)||(0,d.ar)()?.id,extension_data:{...t.extension_data||{},department:t.user?.department||(0,d.ar)()?.department},approved:!!o._settings.get("app.bookings.no_approval")})).toPromise();o._loading.next("");const{booking_type:a}=t;return o.clearForm(),o.form?.patchValue({booking_type:a}),o.last_success=l,sessionStorage.setItem("PLACEOS.last_booked_booking",JSON.stringify(l)),o.setView("success"),l})()}postFormForGroup(){var e=this;return(0,_.Z)(function*(){const{members:o,group:t,type:u}=e._options.getValue();if(!t)throw"No group available to book for";const l=o.filter(m=>m.email!==(0,d.ar)().email);if(l.length<=0)throw"No members in your group to book for.";const a=e.form.value,E=yield e.available_resources.pipe((0,Z.q)(1)).toPromise(),c=E.find(m=>m.id===a.asset_id||m.map_id===a.asset_id),i=e._org.levelWithID([c.zone?.id]),g=[c,...yield e._getNearbyResources(i.map_id,a.asset_id,E,l.length)],M=(0,d.Tw)([(0,d.ar)(),...l],"email");yield Promise.all(M.map((m,A)=>e.checkResourceAvailable({...a,asset_id:g[A].map_id||g[A].id,user_email:m.email},u)));for(let m=0;m<M.length;m++){const A=M[m],R=g[m];e.form.patchValue({...a,user:A,asset_id:R?.id,asset_name:R.name,description:R.name,map_id:R?.map_id||R?.id,zones:R.zone?(0,d.Tw)([e._org.organisation.id,R.zone?.parent_id,R.zone?.id]):[e._org.organisation.id]}),e.postForm(!0)}})()}checkQuestions(){var e=this;return(0,_.Z)(function*(){if(!1!==e._settings.get("app.desks.ignore_questions"))return;const o=e._dialog.open(V.I);if("done"!==(yield Promise.race([o.componentInstance.event.pipe((0,k.P)(l=>"done"===l.reason)).toPromise(),o.afterClosed().toPromise()]))?.reason)throw"User cancelled";const u=o.componentInstance.form.getRawValue();for(const l in u)if(u[l])throw"User failed questionaire";o.close()})()}checkResourceAvailable({asset_id:e,date:o,duration:t,user_email:u,all_day:l},a){var E=this;return(0,_.Z)(function*(){t=l?720:t||60;const c=yield(0,$.F2)({period_start:(0,n.Z)(o),period_end:(0,n.Z)(o+60*t*1e3),type:a}).toPromise();if(c.find(g=>g.asset_id===e))throw e.includes("@")?`${e} already has an invite for the selected time`:`${e} is not available at the selected time`;const i=E._settings.get(`app.booking.allowed_daily_${a}_count`)??1;if(i>0&&c.filter(g=>g.user_email===(u||(0,d.ar)()?.email)&&"declined"!==g.status).length>=i){const g=u===(0,d.ar)()?.email;throw`${g?"You":u} already ${g?"have":"has"} a ${a} booked`}return!0})()}loadResourceList(e){return(0,D.BW_)(this._org.building.id,{name:e}).pipe((0,K.U)(o=>(0,d.xH)(o.map(t=>(t.metadata[e]?.details instanceof Array?t.metadata[e]?.details:[]).map(u=>({...u,zone:t.zone}))))))}_getNearbyResources(e,o,t,u){return(0,_.Z)(function*(){const l=[];let a=t.filter(E=>E.id!==o&&E.map_id!==o);for(let E=0;E<u;E++){const c=yield(0,x.gV)(e,o,a.map(i=>i.map_id||i.id));c&&(l.push(t.find(i=>i.id===c||i.map_id===c)),a=a.filter(i=>i.id!==c&&i.map_id!==c))}return l})()}}v.\u0275fac=function(e){return new(e||v)(L.LFG(p.F0),L.LFG(d.gb),L.LFG(w.w),L.LFG(X.uw),L.LFG(Q.c))},v.\u0275prov=L.Yz7({token:v,factory:v.\u0275fac,providedIn:"root"})},4367:(W,U,s)=>{s.d(U,{w:()=>f});var _=s(5938),p=s(719),d=s(9497),n=(s(6962),s(4650)),b=s(5306),P=s(3238),F=s(158),h=s(7202);class f{constructor(r,S){this._event=r,this._settings=S,this.outlook_link=(0,d.Y$)(this._event),this.google_link=(0,d.T$)(this._event),this.ical_link=(0,d.KS)(this._event)}}f.\u0275fac=function(r){return new(r||f)(n.Y36(_.WI),n.Y36(p.g))},f.\u0275cmp=n.Xpm({type:f,selectors:[["booking-link-modal"]],decls:22,vars:12,consts:function(){let O,r,S;return O=$localize`:␟34c16b14ad0e33db574c8bea543e66e766aa3a01␟4015832758698516701:Create in Outlook`,r=$localize`:␟f745484670e6b6bbb8a1c327c222e665fb25b863␟3788591245559456526:Create in Google Calendar`,S=$localize`:␟1af54061e7f4bcfb1048ffaa05c9b8f7c4b41679␟4894641609416495396:Download iCal File`,[[1,"p-4","w-full","pb-2"],[1,"flex","flex-col","items-center","space-y-4","p-4","relative"],["button","","matRipple","","target","_blank","rel","noopener noreferer",1,"flex","items-center","p-2","space-x-2","pr-4","w-64","rounded","inverse",3,"href"],["src","assets/icons/outlook.svg",1,"w-6"],O,["src","assets/icons/gcal.svg",1,"w-6"],r,[1,"text-xl"],S,["icon","","mat-dialog-close","",1,"absolute","top-2","right-0"]]},template:function(r,S){1&r&&(n.TgZ(0,"div",0),n._uU(1,"Add event to your calendar"),n.qZA(),n.TgZ(2,"div",1)(3,"a",2),n.ALo(4,"sanitize"),n._UZ(5,"img",3),n.TgZ(6,"span"),n.SDv(7,4),n.qZA()(),n.TgZ(8,"a",2),n.ALo(9,"sanitize"),n._UZ(10,"img",5),n.TgZ(11,"span"),n.SDv(12,6),n.qZA()(),n.TgZ(13,"a",2),n.ALo(14,"safe"),n.TgZ(15,"app-icon",7),n._uU(16,"download"),n.qZA(),n.TgZ(17,"span"),n.SDv(18,8),n.qZA()()(),n.TgZ(19,"button",9)(20,"app-icon"),n._uU(21,"close"),n.qZA()()),2&r&&(n.xp6(3),n.Q6J("href",n.xi3(4,3,S.outlook_link,"url"),n.LSH),n.xp6(5),n.Q6J("href",n.xi3(9,6,S.google_link,"url"),n.LSH),n.xp6(5),n.Q6J("href",n.xi3(14,9,S.ical_link,"url"),n.LSH))},dependencies:[_.ZT,b.o,P.wG,F.y,h.n],styles:["[_nghost-%COMP%]{position:relative}"]})},4282:(W,U,s)=>{s.d(U,{I:()=>f});var _=s(4650),p=s(4006),D=(s(9112),s(6895)),n=s(1948),b=s(5938),P=s(3238);function F(O,r){if(1&O){const S=_.EpF();_.TgZ(0,"div",2)(1,"h2",3),_.SDv(2,4),_.qZA(),_.TgZ(3,"main",5)(4,"div",6)(5,"label"),_.tHW(6,7),_._UZ(7,"span"),_.N_p(),_.qZA(),_.TgZ(8,"mat-radio-group",8)(9,"mat-radio-button",9),_._uU(10,"Yes"),_.qZA(),_.TgZ(11,"mat-radio-button",9),_._uU(12,"No"),_.qZA()()(),_.TgZ(13,"div",6)(14,"label"),_.tHW(15,10),_._UZ(16,"span"),_.N_p(),_.qZA(),_.TgZ(17,"mat-radio-group",11)(18,"mat-radio-button",9),_._uU(19,"Yes"),_.qZA(),_.TgZ(20,"mat-radio-button",9),_._uU(21,"No"),_.qZA()()(),_.TgZ(22,"div",12)(23,"label"),_.tHW(24,13),_._UZ(25,"span"),_.N_p(),_.qZA(),_.TgZ(26,"mat-radio-group",14)(27,"mat-radio-button",9),_._uU(28,"Yes"),_.qZA(),_.TgZ(29,"mat-radio-button",9),_._uU(30,"No"),_.qZA()()()(),_.TgZ(31,"footer",15)(32,"button",16),_.NdJ("click",function(){_.CHM(S);const C=_.oxw();return _.KtG(C.submit())}),_.SDv(33,17),_.qZA()(),_.TgZ(34,"button",18)(35,"i",19),_._uU(36,"close"),_.qZA()()()}if(2&O){const S=_.oxw();_.xp6(3),_.Q6J("formGroup",S.form),_.xp6(6),_.Q6J("value",!0),_.xp6(2),_.Q6J("value",!1),_.xp6(7),_.Q6J("value",!0),_.xp6(2),_.Q6J("value",!1),_.xp6(7),_.Q6J("value",!0),_.xp6(2),_.Q6J("value",!1)}}function h(O,r){1&O&&(_.TgZ(0,"main",20)(1,"p",21),_.SDv(2,22),_.qZA(),_.TgZ(3,"button",18)(4,"i",19),_._uU(5,"close"),_.qZA()()())}class f{constructor(){this.event=new _.vpe,this.form=new p.cw({travelled:new p.NI(!1),unwell:new p.NI(!1),contact:new p.NI(!1)})}submit(){this.form.markAllAsTouched(),Object.keys(this.form.value).find(r=>!0===this.form.value[r]||"true"===this.form.value[r])?this.failure=!0:this.event.emit({reason:"done"})}}f.\u0275fac=function(r){return new(r||f)},f.\u0275cmp=_.Xpm({type:f,selectors:[["desk-question-modal"]],outputs:{event:"event"},decls:3,vars:2,consts:function(){let O,r,S,T,C,B;return O=$localize`:␟02006a13b8e6aacb7a6e15bafd8004ed529f5d81␟877348132538805077:COVID-19 Questionnaire`,r=$localize`:␟dad7efbd2320e5ea935aef911f18cbcb24690133␟1650520403092579087: Have you travelled overseas within the last 14 days?${"\ufffd#7\ufffd"}:START_TAG_SPAN:*${"\ufffd/#7\ufffd"}:CLOSE_TAG_SPAN:`,S=$localize`:␟cf50bf8de6c6db836da440c89a375631f7ba3fb0␟1182497320820036810: Are you unwell or experiencing any cold or flu-like symptoms?${"\ufffd#16\ufffd"}:START_TAG_SPAN:*${"\ufffd/#16\ufffd"}:CLOSE_TAG_SPAN:`,T=$localize`:␟273153c91358de15d124ff2966859d9949080f4c␟737527639567676154: Have you had contact with anyone with suspected COVID-19?${"\ufffd#25\ufffd"}:START_TAG_SPAN:*${"\ufffd/#25\ufffd"}:CLOSE_TAG_SPAN:`,C=$localize`:␟71c77bb8cecdf11ec3eead24dd1ba506573fa9cd␟935187492052582731:Submit`,B=$localize`:␟17d62f424c2c025579e1ec0e3f5ad971f57681df␟4401678084033805848: Your request to work from the office has been rejected based on your response to the compulsory Covid-19 questions. Please feel free to submit a new request when circumstances change in a way that changes your answer to the questions. `,[["class","relative",4,"ngIf","ngIfElse"],["fail_state",""],[1,"relative"],[1,"p-4","text-xl"],O,[1,"p-4",3,"formGroup"],[1,"flex","flex-col","mb-4"],r,["formControlName","travelled",1,"space-x-2"],[3,"value"],S,["formControlName","unwell",1,"space-x-2"],[1,"flex","flex-col"],T,["formControlName","contact",1,"space-x-2"],[1,"flex","justify-center","items-center","p-2"],["btn","","matRipple","",3,"click"],C,["close","","icon","","matRipple","","mat-dialog-close",""],[1,"material-icons"],["failure","",1,"pt-8","relative"],[1,"p-4"],B]},template:function(r,S){if(1&r&&(_.YNc(0,F,37,7,"div",0),_.YNc(1,h,6,0,"ng-template",null,1,_.W1O)),2&r){const T=_.MAs(2);_.Q6J("ngIf",!S.failure)("ngIfElse",T)}},dependencies:[D.O5,p.JJ,p.JL,p.sg,p.u,n.VQ,n.U0,b.ZT,P.wG],styles:["main[_ngcontent-%COMP%]{width:24rem;max-width:calc(100vw - 4.5rem)}[close][_ngcontent-%COMP%]{position:absolute;top:.5rem;right:.5rem}"]})}}]);