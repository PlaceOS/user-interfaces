"use strict";(self.webpackChunkconcierge=self.webpackChunkconcierge||[]).push([["default-libs_bookings_src_lib_booking-form_service_ts-libs_bookings_src_lib_lockers_service_ts"],{8929:(k,b,o)=>{o.d(b,{f:()=>K});var e=o(1670),M=o(9885),i=o(9112),I=o(308),a=o(1810),B=o(2317),C=o(3861),N=o(7485),L=o(4505),O=o(4139),m=o(7716),l=o(8623),d=o(5398),S=o(9128),D=o(823),E=o(6116),T=o(9095),P=o(8759),y=o(6942),G=o(9151),x=o(5670),Z=o(3910),w=o(565),R=o(6962),W=o(1980),$=o(354),V=o(4282),Q=o(8871),j=o(4367),z=o(1562),F=o(2560),X=o(1484);const J=["book/desks","book/parking","book/new-desks","book/new-parking"];class K extends i.cx{get view(){return this._view.getValue()}get booking(){return this._booking.getValue()}newForm(t=new R.$){this.form.reset(),this.form.patchValue((0,I.sWL)({...t,...t.extension_data},[null,void 0,""])),this.subscription("form_change",this.form.valueChanges.subscribe(()=>this.storeForm())),this._booking.next(t),this._options.next({type:this._options.getValue().type})}constructor(t,n,s,u,c){super(),this._router=t,this._settings=n,this._org=s,this._dialog=u,this._payments=c,this._view=new L.X("form"),this._options=new L.X({type:"desk"}),this._booking=new L.X(null),this._loading=new L.X(""),this.last_success=new R.$(JSON.parse(sessionStorage.getItem("PLACEOS.last_booked_booking")||"{}")),this.loading=this._loading.asObservable(),this.options=this._options.pipe((0,S.d)(1)),this.form=(0,W.PR)(),this.resource=this.options.pipe((0,D.b)(300),(0,E.g)("type"),(0,T.w)(({type:_})=>{if(!this._org.building)return(0,O.of)([]);switch(_){case"desk":return this._loading.next("Loading desks..."),this.loadResourceList("desks");case"parking":return this._loading.next("Loading parking spaces..."),this.loadResourceList("parking_spaces")}return(0,O.of)([])}),(0,P.b)(()=>this._loading.next("")),(0,S.d)(1)),this.features=this.resource.pipe((0,y.U)(_=>{const g=[];for(const{features:f}of _)f instanceof Array&&f.forEach(r=>g.push(r));return(0,i.Tw)(g).sort((f,r)=>f.localeCompare(r))}),(0,S.d)(1)),this.available_resources=(0,m.aj)([this.options,this.resource,(0,l.T)(this.form.valueChanges,(0,d.H)(1e3))]).pipe((0,G.h)(()=>this.form.getRawValue().date>0&&this.form.getRawValue().duration>0),(0,D.b)(500),(0,P.b)(([{type:_}])=>this._loading.next(`Checking ${_} availability...`)),(0,T.w)(([_,g])=>(0,$.F2)({period_start:(0,a.Z)(this.form.getRawValue().date),period_end:(0,a.Z)((0,B.Z)(this.form.getRawValue().date,this.form.getRawValue().duration||1440)),type:_.type,zones:_.zone_id}).pipe((0,y.U)(f=>g.filter(r=>(!r.groups?.length||r.groups.some(p=>(0,i.ar)().groups.includes(p)))&&!1!==r.bookable&&(!_.features||_.features?.every(p=>r.features.includes(p)))&&(!_.zone_id||_.zone_id===r.zone?.id||_.zone_id===r.zone?.parent_id)&&!f.find(p=>p.asset_id===r.id&&"declined"!==p.status))))),(0,P.b)(()=>this._loading.next("")),(0,S.d)(1)),this.grouped_availability=(0,m.aj)([this.options,this.available_resources]).pipe((0,y.U)(([_,g])=>{const f=[],r=[...g].sort((v,h)=>v.zone?.id?.localeCompare(h.zone?.id)),p=_.members?.length?_.members:[(0,i.ar)()];for(;r.length;){const v=[];let h=r.pop();for(;v.length<p.length&&(!v.length||v.find(U=>U.zone?.id===h.zone?.id));)v.push(h),h=r.pop();v.length<p.length||f.push(v)}return f})),this.subscription("router.bookings",this._router.events.subscribe(_=>{_ instanceof M.m2&&!J.find(g=>_.url.includes(g))&&this.clearForm()})),this._org.initialised.pipe((0,x.P)(_=>_)).subscribe(()=>this.setOptions({}))}setView(t){this._view.next(t)}setOptions(t){this._options.next({...this._options.getValue(),...t})}setFeature(t,n){if(!t?.length)return;const s=this._options.getValue()?.features||[];n&&!s.includes(t)&&s.push(t),!n&&s.includes(t)&&s.splice(s.findIndex(u=>u===t),1),this.setOptions({features:s})}resetForm(){const t=this._booking.getValue();this.form.reset({user:(0,i.ar)(),booked_by:(0,i.ar)()}),this.form.patchValue((0,I.sWL)({...t||{},...t?.extension_data||{}},[null,void 0,""])),this._options.next({type:this._options.getValue().type})}clearForm(){sessionStorage.removeItem("PLACEOS.booking_form"),sessionStorage.removeItem("PLACEOS.booking_form_options"),this.newForm()}storeForm(){sessionStorage.setItem("PLACEOS.booking_form",JSON.stringify(this.form.getRawValue()||{})),sessionStorage.setItem("PLACEOS.booking_form_filters",JSON.stringify(this._options.getValue()||{}))}loadForm(){this.form.reset({user:(0,i.ar)(),booked_by:(0,i.ar)()});const t=JSON.parse(sessionStorage.getItem("PLACEOS.booking_form")||"{}"),n=new R.$(t);this._booking.next(n);const s=(0,I.sWL)({...t,...n||{},...n?.extension_data||{}},[null,void 0,""]);this.form.patchValue(s),this.setOptions({zone_id:this._org.building?.id,...JSON.parse(sessionStorage.getItem("PLACEOS.booking_form_filters")||"{}")})}clearOldState(){sessionStorage.removeItem("PLACEOS.last_booked_booking"),this.last_success=new R.$}openBookingLinkModal(t=!1){if(this.form.markAllAsTouched(),!this.form.valid&&!t)return;const n=new R.$({...this.booking,...this.form.getRawValue()});this._dialog.open(j.w,{data:n})}confirmPost(){var t=this;return(0,e.Z)(function*(){yield t.checkQuestions();const n=t._options.getValue(),s=t.form.getRawValue();let u=`Would you like to book the ${n.type} ${s.asset_name} for ${(0,C.Z)(s.date,"dd MMM yyyy")}${s.duration<720?" at "+(0,C.Z)(s.date,"h:mm a"):""}`;n.group&&(u=`${u}.<br>You group members will be assigned desks nearby your selected desk.`);const c=yield(0,i._5)({title:`Book ${n.type}`,content:u,icon:{content:"event_available"}},t._dialog);if("done"!==c?.reason)throw"User cancelled";c.loading("Performing booking request..."),n.group?yield t.postFormForGroup().catch(_=>{throw(0,i.cB)(JSON.stringify(_)),c.close(),_}):yield t.postForm().catch(_=>{throw(0,i.cB)(JSON.stringify(_)),c.close(),_}),c.close()})()}postForm(t=!1){var n=this;return(0,e.Z)(function*(){if(!n.form)throw"No form for booking";if(!n.form.valid)throw`Some form fields are invalid. [${(0,i.RD)(n.form).join(", ")}]`;n.form.patchValue({booking_type:n.form.getRawValue().booking_type||n._options.getValue().type});let s=n.form.getRawValue(),u=n._booking.getValue()||new R.$;if(t||(yield n.checkResourceAvailable(s,n._options.getValue().type)),(s.duration>=720||s.all_day)&&(n.form.patchValue({date:(0,N.Z)(s.date,{hours:11,minutes:59}).valueOf(),duration:720}),s=n.form.getRawValue()),n._payments.payment_module){const g=yield n._payments.makePayment({type:n._options.getValue().type,resource_name:s.asset_name,date:s.date,duration:s.duration,all_day:s.all_day});if(!g?.success)return;s.extension_data={invoice:g,invoice_id:g.invoice_id}}(s.assets?.length||u.extension_data.assets?.length)&&(yield(0,z.cd)(`${s.booked_by_email}|${s.date}`,{date:s.date,duration:s.duration,host:s.booked_by_email},s.assets,u.extension_data.assets)),n._loading.next("Saving booking");const c=yield(0,$.km)(new R.$({...n._options.getValue(),...s,description:s.asset_name||s.description,user_name:s.user?.name,user_id:(s.user?.id?.includes("@")?"":s?.user?.id)||(0,i.ar)()?.id,extension_data:{...s.extension_data||{},department:s.user?.department||(0,i.ar)()?.department},approved:!!n._settings.get("app.bookings.no_approval")})).toPromise();n._loading.next("");const{booking_type:_}=s;return n.clearForm(),n.form?.patchValue({booking_type:_}),n.last_success=c,sessionStorage.setItem("PLACEOS.last_booked_booking",JSON.stringify(c)),n.setView("success"),c})()}postFormForGroup(){var t=this;return(0,e.Z)(function*(){const{members:n,group:s,type:u}=t._options.getValue();if(!s)throw"No group available to book for";const c=n.filter(h=>h.email!==(0,i.ar)().email);if(c.length<=0)throw"No members in your group to book for.";const _=t.form.value,g=yield t.available_resources.pipe((0,Z.q)(1)).toPromise(),f=g.find(h=>h.id===_.asset_id||h.map_id===_.asset_id),r=t._org.levelWithID([f.zone?.id]),p=[f,...yield t._getNearbyResources(r.map_id,_.asset_id,g,c.length)],v=(0,i.Tw)([(0,i.ar)(),...c],"email");yield Promise.all(v.map((h,U)=>t.checkResourceAvailable({..._,asset_id:p[U].map_id||p[U].id,user_email:h.email},u)));for(let h=0;h<v.length;h++){const U=v[h],A=p[h];t.form.patchValue({..._,user:U,asset_id:A?.id,asset_name:A.name,description:A.name,map_id:A?.map_id||A?.id,zones:A.zone?(0,i.Tw)([t._org.organisation.id,A.zone?.parent_id,A.zone?.id]):[t._org.organisation.id]}),t.postForm(!0)}})()}checkQuestions(){var t=this;return(0,e.Z)(function*(){if(!1!==t._settings.get("app.desks.ignore_questions"))return;const n=t._dialog.open(V.I);if("done"!==(yield Promise.race([n.componentInstance.event.pipe((0,x.P)(c=>"done"===c.reason)).toPromise(),n.afterClosed().toPromise()]))?.reason)throw"User cancelled";const u=n.componentInstance.form.getRawValue();for(const c in u)if(u[c])throw"User failed questionaire";n.close()})()}checkResourceAvailable({asset_id:t,date:n,duration:s,user_email:u,all_day:c},_){var g=this;return(0,e.Z)(function*(){s=c?720:s||60;const f=yield(0,$.F2)({period_start:(0,a.Z)(n),period_end:(0,a.Z)(n+60*s*1e3),type:_}).toPromise();if(f.find(p=>p.asset_id===t))throw t.includes("@")?`${t} already has an invite for the selected time`:`${t} is not available at the selected time`;const r=g._settings.get(`app.booking.allowed_daily_${_}_count`)??1;if(r>0&&f.filter(p=>p.user_email===(u||(0,i.ar)()?.email)&&"declined"!==p.status).length>=r){const p=u===(0,i.ar)()?.email;throw`${p?"You":u} already ${p?"have":"has"} a ${_} booked`}return!0})()}loadResourceList(t){return(0,I.BW_)(this._org.building.id,{name:t}).pipe((0,y.U)(n=>(0,i.xH)(n.map(s=>(s.metadata[t]?.details instanceof Array?s.metadata[t]?.details:[]).map(u=>({...u,zone:s.zone}))))))}_getNearbyResources(t,n,s,u){return(0,e.Z)(function*(){const c=[];let _=s.filter(g=>g.id!==n&&g.map_id!==n);for(let g=0;g<u;g++){const f=yield(0,W.gV)(t,n,_.map(r=>r.map_id||r.id));f&&(c.push(s.find(r=>r.id===f||r.map_id===f)),_=_.filter(r=>r.id!==f&&r.map_id!==f))}return c})()}}K.\u0275fac=function(t){return new(t||K)(F.LFG(M.F0),F.LFG(i.gb),F.LFG(w.w),F.LFG(X.uw),F.LFG(Q.c))},K.\u0275prov=F.Yz7({token:K,factory:K.\u0275fac,providedIn:"root"})},4367:(k,b,o)=>{o.d(b,{w:()=>O});var e=o(1484),M=o(719),i=o(9497),a=(o(6962),o(2560)),B=o(5306),C=o(207),N=o(158),L=o(7202);class O{constructor(l,d){this._event=l,this._settings=d,this.outlook_link=(0,i.Y$)(this._event),this.google_link=(0,i.T$)(this._event),this.ical_link=(0,i.KS)(this._event)}}O.\u0275fac=function(l){return new(l||O)(a.Y36(e.WI),a.Y36(M.g))},O.\u0275cmp=a.Xpm({type:O,selectors:[["booking-link-modal"]],decls:22,vars:12,consts:function(){let m,l,d;return m=$localize`:␟34c16b14ad0e33db574c8bea543e66e766aa3a01␟4015832758698516701:Create in Outlook`,l=$localize`:␟f745484670e6b6bbb8a1c327c222e665fb25b863␟3788591245559456526:Create in Google Calendar`,d=$localize`:␟1af54061e7f4bcfb1048ffaa05c9b8f7c4b41679␟4894641609416495396:Download iCal File`,[[1,"p-4","w-full","pb-2"],[1,"flex","flex-col","items-center","space-y-4","p-4","relative"],["button","","matRipple","","target","_blank","rel","noopener noreferer",1,"flex","items-center","p-2","space-x-2","pr-4","w-64","rounded","inverse",3,"href"],["src","assets/icons/outlook.svg",1,"w-6"],m,["src","assets/icons/gcal.svg",1,"w-6"],l,[1,"text-xl"],d,["icon","","mat-dialog-close","",1,"absolute","top-2","right-0"]]},template:function(l,d){1&l&&(a.TgZ(0,"div",0),a._uU(1,"Add event to your calendar"),a.qZA(),a.TgZ(2,"div",1)(3,"a",2),a.ALo(4,"sanitize"),a._UZ(5,"img",3),a.TgZ(6,"span"),a.SDv(7,4),a.qZA()(),a.TgZ(8,"a",2),a.ALo(9,"sanitize"),a._UZ(10,"img",5),a.TgZ(11,"span"),a.SDv(12,6),a.qZA()(),a.TgZ(13,"a",2),a.ALo(14,"safe"),a.TgZ(15,"app-icon",7),a._uU(16,"download"),a.qZA(),a.TgZ(17,"span"),a.SDv(18,8),a.qZA()()(),a.TgZ(19,"button",9)(20,"app-icon"),a._uU(21,"close"),a.qZA()()),2&l&&(a.xp6(3),a.Q6J("href",a.xi3(4,3,d.outlook_link,"url"),a.LSH),a.xp6(5),a.Q6J("href",a.xi3(9,6,d.google_link,"url"),a.LSH),a.xp6(5),a.Q6J("href",a.xi3(14,9,d.ical_link,"url"),a.LSH))},dependencies:[e.ZT,B.o,C.wG,N.y,L.n],styles:["[_nghost-%COMP%]{position:relative}\n/*# sourceMappingURL=booking-link-modal.component.ts-angular-inline--62.css.map*/"]})},4282:(k,b,o)=>{o.d(b,{I:()=>O});var e=o(2560),M=o(2508),I=(o(9112),o(4666)),a=o(2922),B=o(1484),C=o(207);function N(m,l){if(1&m){const d=e.EpF();e.TgZ(0,"div",2)(1,"h2",3),e.SDv(2,4),e.qZA(),e.TgZ(3,"main",5)(4,"div",6)(5,"label"),e.tHW(6,7),e._UZ(7,"span"),e.N_p(),e.qZA(),e.TgZ(8,"mat-radio-group",8)(9,"mat-radio-button",9),e._uU(10,"Yes"),e.qZA(),e.TgZ(11,"mat-radio-button",9),e._uU(12,"No"),e.qZA()()(),e.TgZ(13,"div",6)(14,"label"),e.tHW(15,10),e._UZ(16,"span"),e.N_p(),e.qZA(),e.TgZ(17,"mat-radio-group",11)(18,"mat-radio-button",9),e._uU(19,"Yes"),e.qZA(),e.TgZ(20,"mat-radio-button",9),e._uU(21,"No"),e.qZA()()(),e.TgZ(22,"div",12)(23,"label"),e.tHW(24,13),e._UZ(25,"span"),e.N_p(),e.qZA(),e.TgZ(26,"mat-radio-group",14)(27,"mat-radio-button",9),e._uU(28,"Yes"),e.qZA(),e.TgZ(29,"mat-radio-button",9),e._uU(30,"No"),e.qZA()()()(),e.TgZ(31,"footer",15)(32,"button",16),e.NdJ("click",function(){e.CHM(d);const D=e.oxw();return e.KtG(D.submit())}),e.SDv(33,17),e.qZA()(),e.TgZ(34,"button",18)(35,"i",19),e._uU(36,"close"),e.qZA()()()}if(2&m){const d=e.oxw();e.xp6(3),e.Q6J("formGroup",d.form),e.xp6(6),e.Q6J("value",!0),e.xp6(2),e.Q6J("value",!1),e.xp6(7),e.Q6J("value",!0),e.xp6(2),e.Q6J("value",!1),e.xp6(7),e.Q6J("value",!0),e.xp6(2),e.Q6J("value",!1)}}function L(m,l){1&m&&(e.TgZ(0,"main",20)(1,"p",21),e.SDv(2,22),e.qZA(),e.TgZ(3,"button",18)(4,"i",19),e._uU(5,"close"),e.qZA()()())}class O{constructor(){this.event=new e.vpe,this.form=new M.cw({travelled:new M.NI(!1),unwell:new M.NI(!1),contact:new M.NI(!1)})}submit(){this.form.markAllAsTouched(),Object.keys(this.form.value).find(l=>!0===this.form.value[l]||"true"===this.form.value[l])?this.failure=!0:this.event.emit({reason:"done"})}}O.\u0275fac=function(l){return new(l||O)},O.\u0275cmp=e.Xpm({type:O,selectors:[["desk-question-modal"]],outputs:{event:"event"},decls:3,vars:2,consts:function(){let m,l,d,S,D,E;return m=$localize`:␟02006a13b8e6aacb7a6e15bafd8004ed529f5d81␟877348132538805077:COVID-19 Questionnaire`,l=$localize`:␟dad7efbd2320e5ea935aef911f18cbcb24690133␟1650520403092579087: Have you travelled overseas within the last 14 days?${"\ufffd#7\ufffd"}:START_TAG_SPAN:*${"\ufffd/#7\ufffd"}:CLOSE_TAG_SPAN:`,d=$localize`:␟cf50bf8de6c6db836da440c89a375631f7ba3fb0␟1182497320820036810: Are you unwell or experiencing any cold or flu-like symptoms?${"\ufffd#16\ufffd"}:START_TAG_SPAN:*${"\ufffd/#16\ufffd"}:CLOSE_TAG_SPAN:`,S=$localize`:␟273153c91358de15d124ff2966859d9949080f4c␟737527639567676154: Have you had contact with anyone with suspected COVID-19?${"\ufffd#25\ufffd"}:START_TAG_SPAN:*${"\ufffd/#25\ufffd"}:CLOSE_TAG_SPAN:`,D=$localize`:␟71c77bb8cecdf11ec3eead24dd1ba506573fa9cd␟935187492052582731:Submit`,E=$localize`:␟17d62f424c2c025579e1ec0e3f5ad971f57681df␟4401678084033805848: Your request to work from the office has been rejected based on your response to the compulsory Covid-19 questions. Please feel free to submit a new request when circumstances change in a way that changes your answer to the questions. `,[["class","relative",4,"ngIf","ngIfElse"],["fail_state",""],[1,"relative"],[1,"p-4","text-xl"],m,[1,"p-4",3,"formGroup"],[1,"flex","flex-col","mb-4"],l,["formControlName","travelled",1,"space-x-2"],[3,"value"],d,["formControlName","unwell",1,"space-x-2"],[1,"flex","flex-col"],S,["formControlName","contact",1,"space-x-2"],[1,"flex","justify-center","items-center","p-2"],["btn","","matRipple","",3,"click"],D,["close","","icon","","matRipple","","mat-dialog-close",""],[1,"material-icons"],["failure","",1,"pt-8","relative"],[1,"p-4"],E]},template:function(l,d){if(1&l&&(e.YNc(0,N,37,7,"div",0),e.YNc(1,L,6,0,"ng-template",null,1,e.W1O)),2&l){const S=e.MAs(2);e.Q6J("ngIf",!d.failure)("ngIfElse",S)}},dependencies:[I.O5,M.JJ,M.JL,M.sg,M.u,a.VQ,a.U0,B.ZT,C.wG],styles:["main[_ngcontent-%COMP%]{width:24rem;max-width:calc(100vw - 4.5rem)}[close][_ngcontent-%COMP%]{position:absolute;top:.5rem;right:.5rem}\n/*# sourceMappingURL=desk-questions-modal.component.ts-angular-inline--61.css.map*/"]})},7121:(k,b,o)=>{o.d(b,{A:()=>d});var e=o(1670),M=o(6221),i=o(308),I=o(4505),a=o(7716),B=o(4139),C=o(9151),N=o(9095),L=o(7418),O=o(6942),m=o(9128),l=o(2560);class d{setLevel(D){this._level.next(D)}constructor(D){this._org=D,this._level=new I.X(""),this._change=new I.X(0),this.lockers_banks$=(0,a.aj)([this._org.active_building,this._change]).pipe((0,C.h)(([E])=>!!E),(0,N.w)(([E])=>(0,i.rlq)(E.id,"lockers").pipe((0,L.K)(()=>(0,B.of)(new i.k44)))),(0,O.U)(E=>E.details||[]),(0,m.d)(1)),this.lockers$=this.lockers_banks$.pipe((0,O.U)(E=>{const T=[];for(const P of E)T.push(...P.lockers.map(y=>({...y,bank_id:P.id})));return T})),this.filtered_lockers$=(0,a.aj)([this._level,this.lockers$]).pipe((0,O.U)(([E,T])=>T.filter(P=>(!E||P.level_id===E)&&P.bookable)))}saveLockers(D){var E=this;return(0,e.Z)(function*(){yield(0,i.Ymr)(E._org.building.id,{name:"lockers",description:"",details:D}),E._change.next(Date.now())})()}}d.\u0275fac=function(D){return new(D||d)(l.LFG(M.w7))},d.\u0275prov=l.Yz7({token:d,factory:d.\u0275fac,providedIn:"root"})}}]);
//# sourceMappingURL=default-libs_bookings_src_lib_booking-form_service_ts-libs_bookings_src_lib_lockers_service_ts.js.map