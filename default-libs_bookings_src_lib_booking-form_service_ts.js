"use strict";(self.webpackChunkconcierge=self.webpackChunkconcierge||[]).push([["default-libs_bookings_src_lib_booking-form_service_ts"],{8929:($,B,n)=>{n.d(B,{f:()=>b});var e=n(1670),h=n(9885),r=n(9112),L=n(308),a=n(1810),R=n(2317),P=n(3861),y=n(7485),T=n(4505),E=n(4139),f=n(7716),l=n(8623),p=n(5398),S=n(9128),v=n(823),F=n(6116),I=n(9095),U=n(8759),K=n(6942),Z=n(9151),x=n(5670),w=n(3910),W=n(565),C=n(6962),G=n(1980),k=n(354),V=n(4282),Q=n(8871),z=n(4367),X=n(1562),A=n(2560),J=n(1484);const j=["book/desks","book/parking","book/new-desks","book/new-parking"];class b extends r.cx{get view(){return this._view.getValue()}get booking(){return this._booking.getValue()}newForm(o=new C.$){this.form.reset(),this.form.patchValue((0,L.sWL)({...o,...o.extension_data},[null,void 0,""])),this.subscription("form_change",this.form.valueChanges.subscribe(()=>this.storeForm())),this._booking.next(o),this._options.next({type:this._options.getValue().type})}constructor(o,s,t,u,d){super(),this._router=o,this._settings=s,this._org=t,this._dialog=u,this._payments=d,this._view=new T.X("form"),this._options=new T.X({type:"desk"}),this._booking=new T.X(null),this._loading=new T.X(""),this.last_success=new C.$(JSON.parse(sessionStorage.getItem("PLACEOS.last_booked_booking")||"{}")),this.loading=this._loading.asObservable(),this.options=this._options.pipe((0,S.d)(1)),this.form=(0,G.PR)(),this.resource=this.options.pipe((0,v.b)(300),(0,F.g)("type"),(0,I.w)(({type:i})=>{if(!this._org.building)return(0,E.of)([]);switch(i){case"desk":return this._loading.next("Loading desks..."),this.loadResourceList("desks");case"parking":return this._loading.next("Loading parking spaces..."),this.loadResourceList("parking_spaces")}return(0,E.of)([])}),(0,U.b)(()=>this._loading.next("")),(0,S.d)(1)),this.features=this.resource.pipe((0,K.U)(i=>{const c=[];for(const{features:g}of i)g instanceof Array&&g.forEach(_=>c.push(_));return(0,r.Tw)(c).sort((g,_)=>g.localeCompare(_))}),(0,S.d)(1)),this.available_resources=(0,f.aj)([this.options,this.resource,(0,l.T)(this.form.valueChanges,(0,p.H)(1e3))]).pipe((0,Z.h)(()=>this.form.getRawValue().date>0&&this.form.getRawValue().duration>0),(0,v.b)(500),(0,U.b)(([{type:i}])=>this._loading.next(`Checking ${i} availability...`)),(0,I.w)(([i,c])=>(0,k.F2)({period_start:(0,a.Z)(this.form.getRawValue().date),period_end:(0,a.Z)((0,R.Z)(this.form.getRawValue().date,this.form.getRawValue().duration||1440)),type:i.type,zones:i.zone_id}).pipe((0,K.U)(g=>c.filter(_=>(!_.groups?.length||_.groups.some(m=>(0,r.ar)().groups.includes(m)))&&!1!==_.bookable&&(!i.features||i.features?.every(m=>_.features.includes(m)))&&(!i.zone_id||i.zone_id===_.zone?.id||i.zone_id===_.zone?.parent_id)&&!g.find(m=>m.asset_id===_.id&&"declined"!==m.status))))),(0,U.b)(()=>this._loading.next("")),(0,S.d)(1)),this.grouped_availability=(0,f.aj)([this.options,this.available_resources]).pipe((0,K.U)(([i,c])=>{const g=[],_=[...c].sort((M,O)=>M.zone?.id?.localeCompare(O.zone?.id)),m=i.members?.length?i.members:[(0,r.ar)()];for(;_.length;){const M=[];let O=_.pop();for(;M.length<m.length&&(!M.length||M.find(N=>N.zone?.id===O.zone?.id));)M.push(O),O=_.pop();M.length<m.length||g.push(M)}return g})),this.subscription("router.bookings",this._router.events.subscribe(i=>{i instanceof h.m2&&!j.find(c=>i.url.includes(c))&&this.clearForm()})),this._org.initialised.pipe((0,x.P)(i=>i)).subscribe(()=>this.setOptions({}))}setView(o){this._view.next(o)}setOptions(o){this._options.next({...this._options.getValue(),...o})}setFeature(o,s){if(!o?.length)return;const t=this._options.getValue()?.features||[];s&&!t.includes(o)&&t.push(o),!s&&t.includes(o)&&t.splice(t.findIndex(u=>u===o),1),this.setOptions({features:t})}resetForm(){const o=this._booking.getValue();this.form.reset({user:(0,r.ar)(),booked_by:(0,r.ar)()}),this.form.patchValue((0,L.sWL)({...o||{},...o?.extension_data||{}},[null,void 0,""])),this._options.next({type:this._options.getValue().type})}clearForm(){sessionStorage.removeItem("PLACEOS.booking_form"),sessionStorage.removeItem("PLACEOS.booking_form_options"),this.newForm()}storeForm(){sessionStorage.setItem("PLACEOS.booking_form",JSON.stringify(this.form.getRawValue()||{})),sessionStorage.setItem("PLACEOS.booking_form_filters",JSON.stringify(this._options.getValue()||{}))}loadForm(){this.form.reset({user:(0,r.ar)(),booked_by:(0,r.ar)()});const o=JSON.parse(sessionStorage.getItem("PLACEOS.booking_form")||"{}"),s=new C.$(o);this._booking.next(s);const t=(0,L.sWL)({...o,...s||{},...s?.extension_data||{}},[null,void 0,""]);this.form.patchValue(t),this.setOptions({zone_id:this._org.building?.id,...JSON.parse(sessionStorage.getItem("PLACEOS.booking_form_filters")||"{}")})}clearOldState(){sessionStorage.removeItem("PLACEOS.last_booked_booking"),this.last_success=new C.$}openBookingLinkModal(o=!1){if(this.form.markAllAsTouched(),!this.form.valid&&!o)return;const s=new C.$({...this.booking,...this.form.getRawValue()});this._dialog.open(z.w,{data:s})}confirmPost(){var o=this;return(0,e.Z)(function*(){yield o.checkQuestions();const s=o._options.getValue(),t=o.form.getRawValue();let u=`Would you like to book the ${s.type} ${t.asset_name} for ${(0,P.Z)(t.date,"dd MMM yyyy")}${t.duration<720?" at "+(0,P.Z)(t.date,"h:mm a"):""}`;s.group&&(u=`${u}.<br>You group members will be assigned desks nearby your selected desk.`);const d=yield(0,r._5)({title:`Book ${s.type}`,content:u,icon:{content:"event_available"}},o._dialog);if("done"!==d?.reason)throw"User cancelled";d.loading("Performing booking request..."),s.group?yield o.postFormForGroup().catch(i=>{throw(0,r.cB)(JSON.stringify(i)),d.close(),i}):yield o.postForm().catch(i=>{throw(0,r.cB)(JSON.stringify(i)),d.close(),i}),d.close()})()}postForm(o=!1){var s=this;return(0,e.Z)(function*(){if(!s.form)throw"No form for booking";if(!s.form.valid)throw`Some form fields are invalid. [${(0,r.RD)(s.form).join(", ")}]`;s.form.patchValue({booking_type:s.form.getRawValue().booking_type||s._options.getValue().type});let t=s.form.getRawValue(),u=s._booking.getValue()||new C.$;if(o||(yield s.checkResourceAvailable(t,s._options.getValue().type)),(t.duration>=720||t.all_day)&&(s.form.patchValue({date:(0,y.Z)(t.date,{hours:11,minutes:59}).valueOf(),duration:720}),t=s.form.getRawValue()),s._payments.payment_module){const c=yield s._payments.makePayment({type:s._options.getValue().type,resource_name:t.asset_name,date:t.date,duration:t.duration,all_day:t.all_day});if(!c?.success)return;t.extension_data={invoice:c,invoice_id:c.invoice_id}}(t.assets?.length||u.extension_data.assets?.length)&&(yield(0,X.cd)(`${t.booked_by_email}|${t.date}`,{date:t.date,duration:t.duration,host:t.booked_by_email},t.assets,u.extension_data.assets)),s._loading.next("Saving booking");const d=yield(0,k.km)(new C.$({...s._options.getValue(),...t,description:t.asset_name||t.description,user_name:t.user?.name,user_id:(t.user?.id?.includes("@")?"":t?.user?.id)||(0,r.ar)()?.id,extension_data:{...t.extension_data||{},department:t.user?.department||(0,r.ar)()?.department},approved:!!s._settings.get("app.bookings.no_approval")})).toPromise();s._loading.next("");const{booking_type:i}=t;return s.clearForm(),s.form?.patchValue({booking_type:i}),s.last_success=d,sessionStorage.setItem("PLACEOS.last_booked_booking",JSON.stringify(d)),s.setView("success"),d})()}postFormForGroup(){var o=this;return(0,e.Z)(function*(){const{members:s,group:t,type:u}=o._options.getValue();if(!t)throw"No group available to book for";const d=s.filter(O=>O.email!==(0,r.ar)().email);if(d.length<=0)throw"No members in your group to book for.";const i=o.form.value,c=yield o.available_resources.pipe((0,w.q)(1)).toPromise(),g=c.find(O=>O.id===i.asset_id||O.map_id===i.asset_id),_=o._org.levelWithID([g.zone?.id]),m=[g,...yield o._getNearbyResources(_.map_id,i.asset_id,c,d.length)],M=(0,r.Tw)([(0,r.ar)(),...d],"email");yield Promise.all(M.map((O,N)=>o.checkResourceAvailable({...i,asset_id:m[N].map_id||m[N].id,user_email:O.email},u)));for(let O=0;O<M.length;O++){const N=M[O],D=m[O];o.form.patchValue({...i,user:N,asset_id:D?.id,asset_name:D.name,description:D.name,map_id:D?.map_id||D?.id,zones:D.zone?(0,r.Tw)([o._org.organisation.id,D.zone?.parent_id,D.zone?.id]):[o._org.organisation.id]}),o.postForm(!0)}})()}checkQuestions(){var o=this;return(0,e.Z)(function*(){if(!1!==o._settings.get("app.desks.ignore_questions"))return;const s=o._dialog.open(V.I);if("done"!==(yield Promise.race([s.componentInstance.event.pipe((0,x.P)(d=>"done"===d.reason)).toPromise(),s.afterClosed().toPromise()]))?.reason)throw"User cancelled";const u=s.componentInstance.form.getRawValue();for(const d in u)if(u[d])throw"User failed questionaire";s.close()})()}checkResourceAvailable({asset_id:o,date:s,duration:t,user_email:u,all_day:d},i){var c=this;return(0,e.Z)(function*(){t=d?720:t||60;const g=yield(0,k.F2)({period_start:(0,a.Z)(s),period_end:(0,a.Z)(s+60*t*1e3),type:i}).toPromise();if(g.find(m=>m.asset_id===o))throw o.includes("@")?`${o} already has an invite for the selected time`:`${o} is not available at the selected time`;const _=c._settings.get(`app.booking.allowed_daily_${i}_count`)??1;if(_>0&&g.filter(m=>m.user_email===(u||(0,r.ar)()?.email)&&"declined"!==m.status).length>=_){const m=u===(0,r.ar)()?.email;throw`${m?"You":u} already ${m?"have":"has"} a ${i} booked`}return!0})()}loadResourceList(o){return(0,L.BW_)(this._org.building.id,{name:o}).pipe((0,K.U)(s=>(0,r.xH)(s.map(t=>(t.metadata[o]?.details instanceof Array?t.metadata[o]?.details:[]).map(u=>({...u,zone:t.zone}))))))}_getNearbyResources(o,s,t,u){return(0,e.Z)(function*(){const d=[];let i=t.filter(c=>c.id!==s&&c.map_id!==s);for(let c=0;c<u;c++){const g=yield(0,G.gV)(o,s,i.map(_=>_.map_id||_.id));g&&(d.push(t.find(_=>_.id===g||_.map_id===g)),i=i.filter(_=>_.id!==g&&_.map_id!==g))}return d})()}}b.\u0275fac=function(o){return new(o||b)(A.LFG(h.F0),A.LFG(r.gb),A.LFG(W.w),A.LFG(J.uw),A.LFG(Q.c))},b.\u0275prov=A.Yz7({token:b,factory:b.\u0275fac,providedIn:"root"})},4367:($,B,n)=>{n.d(B,{w:()=>E});var e=n(1484),h=n(719),r=n(9497),a=(n(6962),n(2560)),R=n(5306),P=n(207),y=n(158),T=n(7202);class E{constructor(l,p){this._event=l,this._settings=p,this.outlook_link=(0,r.Y$)(this._event),this.google_link=(0,r.T$)(this._event),this.ical_link=(0,r.KS)(this._event)}}E.\u0275fac=function(l){return new(l||E)(a.Y36(e.WI),a.Y36(h.g))},E.\u0275cmp=a.Xpm({type:E,selectors:[["booking-link-modal"]],decls:22,vars:12,consts:function(){let f,l,p;return f=$localize`:␟34c16b14ad0e33db574c8bea543e66e766aa3a01␟4015832758698516701:Create in Outlook`,l=$localize`:␟f745484670e6b6bbb8a1c327c222e665fb25b863␟3788591245559456526:Create in Google Calendar`,p=$localize`:␟1af54061e7f4bcfb1048ffaa05c9b8f7c4b41679␟4894641609416495396:Download iCal File`,[[1,"p-4","w-full","pb-2"],[1,"flex","flex-col","items-center","space-y-4","p-4","relative"],["button","","matRipple","","target","_blank","rel","noopener noreferer",1,"flex","items-center","p-2","space-x-2","pr-4","w-64","rounded","inverse",3,"href"],["src","assets/icons/outlook.svg",1,"w-6"],f,["src","assets/icons/gcal.svg",1,"w-6"],l,[1,"text-xl"],p,["icon","","mat-dialog-close","",1,"absolute","top-2","right-0"]]},template:function(l,p){1&l&&(a.TgZ(0,"div",0),a._uU(1,"Add event to your calendar"),a.qZA(),a.TgZ(2,"div",1)(3,"a",2),a.ALo(4,"sanitize"),a._UZ(5,"img",3),a.TgZ(6,"span"),a.SDv(7,4),a.qZA()(),a.TgZ(8,"a",2),a.ALo(9,"sanitize"),a._UZ(10,"img",5),a.TgZ(11,"span"),a.SDv(12,6),a.qZA()(),a.TgZ(13,"a",2),a.ALo(14,"safe"),a.TgZ(15,"app-icon",7),a._uU(16,"download"),a.qZA(),a.TgZ(17,"span"),a.SDv(18,8),a.qZA()()(),a.TgZ(19,"button",9)(20,"app-icon"),a._uU(21,"close"),a.qZA()()),2&l&&(a.xp6(3),a.Q6J("href",a.xi3(4,3,p.outlook_link,"url"),a.LSH),a.xp6(5),a.Q6J("href",a.xi3(9,6,p.google_link,"url"),a.LSH),a.xp6(5),a.Q6J("href",a.xi3(14,9,p.ical_link,"url"),a.LSH))},dependencies:[e.ZT,R.o,P.wG,y.y,T.n],styles:["[_nghost-%COMP%]{position:relative}\n/*# sourceMappingURL=booking-link-modal.component.ts-angular-inline--62.css.map*/"]})},4282:($,B,n)=>{n.d(B,{I:()=>E});var e=n(2560),h=n(2508),L=(n(9112),n(4666)),a=n(2922),R=n(1484),P=n(207);function y(f,l){if(1&f){const p=e.EpF();e.TgZ(0,"div",2)(1,"h2",3),e.SDv(2,4),e.qZA(),e.TgZ(3,"main",5)(4,"div",6)(5,"label"),e.tHW(6,7),e._UZ(7,"span"),e.N_p(),e.qZA(),e.TgZ(8,"mat-radio-group",8)(9,"mat-radio-button",9),e._uU(10,"Yes"),e.qZA(),e.TgZ(11,"mat-radio-button",9),e._uU(12,"No"),e.qZA()()(),e.TgZ(13,"div",6)(14,"label"),e.tHW(15,10),e._UZ(16,"span"),e.N_p(),e.qZA(),e.TgZ(17,"mat-radio-group",11)(18,"mat-radio-button",9),e._uU(19,"Yes"),e.qZA(),e.TgZ(20,"mat-radio-button",9),e._uU(21,"No"),e.qZA()()(),e.TgZ(22,"div",12)(23,"label"),e.tHW(24,13),e._UZ(25,"span"),e.N_p(),e.qZA(),e.TgZ(26,"mat-radio-group",14)(27,"mat-radio-button",9),e._uU(28,"Yes"),e.qZA(),e.TgZ(29,"mat-radio-button",9),e._uU(30,"No"),e.qZA()()()(),e.TgZ(31,"footer",15)(32,"button",16),e.NdJ("click",function(){e.CHM(p);const v=e.oxw();return e.KtG(v.submit())}),e.SDv(33,17),e.qZA()(),e.TgZ(34,"button",18)(35,"i",19),e._uU(36,"close"),e.qZA()()()}if(2&f){const p=e.oxw();e.xp6(3),e.Q6J("formGroup",p.form),e.xp6(6),e.Q6J("value",!0),e.xp6(2),e.Q6J("value",!1),e.xp6(7),e.Q6J("value",!0),e.xp6(2),e.Q6J("value",!1),e.xp6(7),e.Q6J("value",!0),e.xp6(2),e.Q6J("value",!1)}}function T(f,l){1&f&&(e.TgZ(0,"main",20)(1,"p",21),e.SDv(2,22),e.qZA(),e.TgZ(3,"button",18)(4,"i",19),e._uU(5,"close"),e.qZA()()())}class E{constructor(){this.event=new e.vpe,this.form=new h.cw({travelled:new h.NI(!1),unwell:new h.NI(!1),contact:new h.NI(!1)})}submit(){this.form.markAllAsTouched(),Object.keys(this.form.value).find(l=>!0===this.form.value[l]||"true"===this.form.value[l])?this.failure=!0:this.event.emit({reason:"done"})}}E.\u0275fac=function(l){return new(l||E)},E.\u0275cmp=e.Xpm({type:E,selectors:[["desk-question-modal"]],outputs:{event:"event"},decls:3,vars:2,consts:function(){let f,l,p,S,v,F;return f=$localize`:␟02006a13b8e6aacb7a6e15bafd8004ed529f5d81␟877348132538805077:COVID-19 Questionnaire`,l=$localize`:␟dad7efbd2320e5ea935aef911f18cbcb24690133␟1650520403092579087: Have you travelled overseas within the last 14 days?${"\ufffd#7\ufffd"}:START_TAG_SPAN:*${"\ufffd/#7\ufffd"}:CLOSE_TAG_SPAN:`,p=$localize`:␟cf50bf8de6c6db836da440c89a375631f7ba3fb0␟1182497320820036810: Are you unwell or experiencing any cold or flu-like symptoms?${"\ufffd#16\ufffd"}:START_TAG_SPAN:*${"\ufffd/#16\ufffd"}:CLOSE_TAG_SPAN:`,S=$localize`:␟273153c91358de15d124ff2966859d9949080f4c␟737527639567676154: Have you had contact with anyone with suspected COVID-19?${"\ufffd#25\ufffd"}:START_TAG_SPAN:*${"\ufffd/#25\ufffd"}:CLOSE_TAG_SPAN:`,v=$localize`:␟71c77bb8cecdf11ec3eead24dd1ba506573fa9cd␟935187492052582731:Submit`,F=$localize`:␟17d62f424c2c025579e1ec0e3f5ad971f57681df␟4401678084033805848: Your request to work from the office has been rejected based on your response to the compulsory Covid-19 questions. Please feel free to submit a new request when circumstances change in a way that changes your answer to the questions. `,[["class","relative",4,"ngIf","ngIfElse"],["fail_state",""],[1,"relative"],[1,"p-4","text-xl"],f,[1,"p-4",3,"formGroup"],[1,"flex","flex-col","mb-4"],l,["formControlName","travelled",1,"space-x-2"],[3,"value"],p,["formControlName","unwell",1,"space-x-2"],[1,"flex","flex-col"],S,["formControlName","contact",1,"space-x-2"],[1,"flex","justify-center","items-center","p-2"],["btn","","matRipple","",3,"click"],v,["close","","icon","","matRipple","","mat-dialog-close",""],[1,"material-icons"],["failure","",1,"pt-8","relative"],[1,"p-4"],F]},template:function(l,p){if(1&l&&(e.YNc(0,y,37,7,"div",0),e.YNc(1,T,6,0,"ng-template",null,1,e.W1O)),2&l){const S=e.MAs(2);e.Q6J("ngIf",!p.failure)("ngIfElse",S)}},dependencies:[L.O5,h.JJ,h.JL,h.sg,h.u,a.VQ,a.U0,R.ZT,P.wG],styles:["main[_ngcontent-%COMP%]{width:24rem;max-width:calc(100vw - 4.5rem)}[close][_ngcontent-%COMP%]{position:absolute;top:.5rem;right:.5rem}\n/*# sourceMappingURL=desk-questions-modal.component.ts-angular-inline--61.css.map*/"]})}}]);
//# sourceMappingURL=default-libs_bookings_src_lib_booking-form_service_ts.js.map