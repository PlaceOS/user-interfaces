"use strict";(self.webpackChunkconcierge=self.webpackChunkconcierge||[]).push([["default-libs_bookings_src_lib_booking-form_service_ts"],{8929:(W,T,t)=>{t.d(T,{f:()=>$});var e=t(1670),v=t(9885),g=t(9112),U=t(3690),o=t(1810),L=t(2317),b=t(5148),I=t(7485),P=t(4505),A=t(4139),p=t(7716),E=t(9128),c=t(823),O=t(9095),M=t(6942),x=t(8759),V=t(9151),w=t(5670),K=t(3910),F=t(565),R=t(6962),Z=t(1980),B=t(354),S=t(4282),z=t(8871),N=t(4367),y=t(2560),Q=t(1484);const J=["book/desks","book/parking","book/newdesk","book/new-parking"];let $=(()=>{class k extends g.KG{constructor(s,i,_,l,d){super(),this._router=s,this._settings=i,this._org=_,this._dialog=l,this._payments=d,this._view=new P.X("form"),this._options=new P.X({type:"desk"}),this._form=new P.X((0,Z.PR)()),this._booking=new P.X(null),this._loading=new P.X(""),this.last_success=new R.$(JSON.parse(sessionStorage.getItem("PLACEOS.last_booked_booking")||"{}")),this.loading=this._loading.asObservable(),this.options=this._options.pipe((0,E.d)(1)),this.assets=this.options.pipe((0,c.b)(300),(0,O.w)(({type:n})=>{if(!this._org.building)return(0,A.of)([]);switch(n){case"desk":return this._loading.next("Loading desks..."),(0,U.BW_)(this._org.building.id,{name:"desks"}).pipe((0,M.U)(a=>(0,g.xH)(a.map(r=>(r.metadata.desks?.details instanceof Array?r.metadata.desks?.details:[]).map(u=>({...u,zone:r.zone}))))));case"parking":return this._loading.next("Loading parking spaces..."),(0,U.BW_)(this._org.building.id,{name:"parking_spaces"}).pipe((0,M.U)(a=>(0,g.xH)(a.map(r=>(r.metadata.desks?.details instanceof Array?r.metadata.desks?.details:[]).map(u=>({...u,zone:r.zone}))))))}return(0,A.of)([])}),(0,x.b)(()=>this._loading.next("")),(0,E.d)(1)),this.features=this.assets.pipe((0,M.U)(n=>{const a=[];for(const{features:r}of n)r instanceof Array&&r.forEach(u=>a.push(u));return(0,g.Tw)(a).sort((r,u)=>r.localeCompare(u))}),(0,E.d)(1)),this.available_assets=(0,p.aj)([this.options,this.assets,this._form]).pipe((0,V.h)(([n,a,r])=>r.getRawValue().date>0&&r.getRawValue().duration>0),(0,c.b)(500),(0,x.b)(([{type:n}])=>this._loading.next(`Checking ${n} availability...`)),(0,O.w)(([n,a,r])=>(0,B.F2)({period_start:(0,o.Z)(r.getRawValue().date),period_end:(0,o.Z)((0,L.Z)(r.getRawValue().date,r.getRawValue().duration||1440)),type:n.type,zones:n.zone_id}).pipe((0,M.U)(u=>a.filter(m=>!1!==m.bookable&&(!n.features||n.features?.every(f=>m.features.includes(f)))&&(!n.zone_id||n.zone_id===m.zone?.id||n.zone_id===m.zone?.parent_id)&&!u.find(f=>f.asset_id===m.id&&"declined"!==f.status))))),(0,x.b)(()=>this._loading.next("")),(0,E.d)(1)),this.grouped_availability=(0,p.aj)([this.options,this.available_assets]).pipe((0,M.U)(([n,a])=>{const r=[],u=[...a].sort((f,h)=>f.zone?.id?.localeCompare(h.zone?.id)),m=n.members?.length?n.members:[(0,g.ar)()];for(;u.length;){const f=[];let h=u.pop();for(;f.length<m.length&&(!f.length||f.find(C=>C.zone?.id===h.zone?.id));)f.push(h),h=u.pop();f.length<m.length||r.push(f)}return r})),this.subscription("router.bookings",this._router.events.subscribe(n=>{n instanceof v.m2&&!J.find(a=>n.url.includes(a))&&this.clearForm()})),this._org.initialised.pipe((0,w.P)(n=>n)).subscribe(()=>this.setOptions({}))}get view(){return this._view.getValue()}get form(){return this._form.getValue()}get booking(){return this._booking.getValue()}newForm(s=new R.$){this._form.next((0,Z.PR)(s)),this.subscription("form_change",this._form.getValue().valueChanges.subscribe(()=>this.storeForm())),this._booking.next(s),this._options.next({type:this._options.getValue().type})}setView(s){this._view.next(s)}setOptions(s){this._options.next({...this._options.getValue(),...s})}setFeature(s,i){if(!s?.length)return;const _=this._options.getValue()?.features||[];i&&!_.includes(s)&&_.push(s),!i&&_.includes(s)&&_.splice(_.findIndex(l=>l===s),1),this.setOptions({features:_})}resetForm(){this._form.getValue()||this.newForm();const s=this._booking.getValue();this._form.getValue().patchValue({...s||{},...s?.extension_data||{}}),this._options.next({type:this._options.getValue().type})}clearForm(){sessionStorage.removeItem("PLACEOS.booking_form"),sessionStorage.removeItem("PLACEOS.booking_form_options"),this.newForm()}storeForm(){sessionStorage.setItem("PLACEOS.booking_form",JSON.stringify(this._form.getValue()?.getRawValue()||{})),sessionStorage.setItem("PLACEOS.booking_form_filters",JSON.stringify(this._options.getValue()||{}))}loadForm(){this._form.getValue()||this.newForm(),this._form.getValue().patchValue({...JSON.parse(sessionStorage.getItem("PLACEOS.booking_form")||"{}")}),this.setOptions({zone_id:this._org.building?.id,...JSON.parse(sessionStorage.getItem("PLACEOS.booking_form_filters")||"{}")})}openBookingLinkModal(s=!1){const i=this._form.getValue();if(i.markAllAsTouched(),!i.valid&&!s)return;const _=new R.$({...this.booking,...i.getRawValue()});this._dialog.open(N.w,{data:_})}confirmPost(){var s=this;return(0,e.Z)(function*(){yield s.checkQuestions();const i=s._options.getValue(),l=s._form.getValue().getRawValue();let d=`Would you like to book the ${i.type} ${l.asset_name} for ${(0,b.Z)(l.date,"dd MMM yyyy")}${l.duration<720?" at "+(0,b.Z)(l.date,"h:mm a"):""}`;i.group&&(d=`${d}.<br>You group members will be assigned desks nearby your selected desk.`);const n=yield(0,g._5)({title:`Book ${i.type}`,content:d,icon:{content:"event_available"}},s._dialog);if("done"!==n?.reason)throw"User cancelled";n.loading("Performing booking request..."),i.group?yield s.postFormForGroup().catch(a=>{throw(0,g.cB)(a),n.close(),a}):yield s.postForm().catch(a=>{throw(0,g.cB)(a),n.close(),a}),n.close()})()}postForm(s=!1){var i=this;return(0,e.Z)(function*(){const _=i._form.getValue();if(!_)throw"No form for booking";if(!_.valid)throw`Some form fields are invalid. [${(0,g.RD)(_).join(", ")}]`;_.patchValue({booking_type:_.getRawValue().booking_type||i._options.getValue().type});const l=_.getRawValue();if(s||(yield i.checkResourceAvailable(l,i._options.getValue().type)),(l.duration>=720||l.all_day)&&_.patchValue({date:(0,I.Z)(l.date,{hours:11,minutes:59}).valueOf(),duration:720}),i._payments.payment_module){const a=yield i._payments.makePayment({type:i._options.getValue().type,resource_name:l.asset_name,date:l.date,duration:l.duration,all_day:l.all_day});if(!a?.success)return;l.extension_data={invoice:a,invoice_id:a.invoice_id}}i._loading.next("Saving booking");const d=yield(0,B.km)(new R.$({...i._options.getValue(),...l,approved:!!i._settings.get("app.bookings.no_approval")})).toPromise();i._loading.next("");const{booking_type:n}=l;return i.clearForm(),_?.patchValue({booking_type:n}),i.last_success=d,sessionStorage.setItem("PLACEOS.last_booked_booking",JSON.stringify(d)),i.setView("success"),d})()}postFormForGroup(){var s=this;return(0,e.Z)(function*(){const{members:i,group:_,type:l}=s._options.getValue();if(!_)throw"No group available to book for";const d=i.filter(h=>h.email!==(0,g.ar)().email);if(d.length<=0)throw"No members in your group to book for.";const n=s._form.getValue().value,a=yield s.available_assets.pipe((0,K.q)(1)).toPromise(),r=a.find(h=>h.id===n.asset_id||h.map_id===n.asset_id),u=s._org.levelWithID([r.zone?.id]),m=[r,...yield s._getNearbyResources(u.map_id,n.asset_id,a,d.length)],f=[(0,g.ar)(),...d];yield Promise.all(f.map((h,C)=>s.checkResourceAvailable({...n,asset_id:m[C].map_id||m[C].id,user_email:h.email},l)));for(let h=0;h<f.length;h++){const C=f[h],D=m[h];s._form.getValue().patchValue({...n,user:C,asset_id:D?.id,asset_name:D.name,map_id:D?.map_id||D?.id,description:D.name,zones:D.zone?[D.zone?.parent_id,D.zone?.id]:[]}),s.postForm(!0)}})()}checkQuestions(){var s=this;return(0,e.Z)(function*(){if(!1!==s._settings.get("app.desks.ignore_questions"))return;const i=s._dialog.open(S.I);if("done"!==(yield Promise.race([i.componentInstance.event.pipe((0,w.P)(d=>"done"===d.reason)).toPromise(),i.afterClosed().toPromise()]))?.reason)throw"User cancelled";const l=i.componentInstance.form.getRawValue();for(const d in l)if(l[d])throw"User failed questionaire";i.close()})()}checkResourceAvailable({asset_id:s,date:i,duration:_,user_email:l,all_day:d},n){var a=this;return(0,e.Z)(function*(){_=d?720:_||60;const r=yield(0,B.F2)({period_start:(0,o.Z)(i),period_end:(0,o.Z)(i+60*_*1e3),type:n}).toPromise();if(r.find(m=>m.asset_id===s))throw s.includes("@")?`${s} already has an invite for the selected time`:`${s} is not available at the selected time`;const u=a._settings.get(`app.booking.allowed_daily_${n}_count`)??1;if(u>0&&r.filter(m=>m.user_email===(l||(0,g.ar)()?.email)&&"declined"!==m.status).length>=u){const m=l===(0,g.ar)()?.email;throw`${m?"You":l} already ${m?"have":"has"} a ${n} booked`}return!0})()}_getNearbyResources(s,i,_,l){return(0,e.Z)(function*(){const d=[];let n=_.filter(a=>a.id!==i&&a.map_id!==i);for(let a=0;a<l;a++){const r=yield(0,Z.gV)(s,i,n.map(u=>u.map_id||u.id));r&&(d.push(_.find(u=>u.id===r||u.map_id===r)),n=n.filter(u=>u.id!==r&&u.map_id!==r))}return d})()}}return k.\u0275fac=function(s){return new(s||k)(y.LFG(v.F0),y.LFG(g.gb),y.LFG(F.w),y.LFG(Q.uw),y.LFG(z.c))},k.\u0275prov=y.Yz7({token:k,factory:k.\u0275fac,providedIn:"root"}),k})()},4367:(W,T,t)=>{t.d(T,{w:()=>A});var e=t(1484),v=t(719),g=t(9497),o=(t(6962),t(2560)),L=t(4522),b=t(5306),I=t(158),P=t(7202);let A=(()=>{class p{constructor(c,O){this._event=c,this._settings=O,this.outlook_link=(0,g.Y$)(this._event),this.google_link=(0,g.T$)(this._event),this.ical_link=(0,g.KS)(this._event)}}return p.\u0275fac=function(c){return new(c||p)(o.Y36(e.WI),o.Y36(v.g))},p.\u0275cmp=o.Xpm({type:p,selectors:[["booking-link-modal"]],decls:22,vars:12,consts:[[1,"p-4","w-full","pb-2"],[1,"flex","flex-col","items-center","space-y-4","p-4","relative"],["button","","matRipple","","target","_blank","rel","noopener noreferer",1,"flex","items-center","p-2","space-x-2","pr-4","w-64","rounded","inverse",3,"href"],["src","assets/icons/outlook.svg",1,"w-6"],["src","assets/icons/gcal.svg",1,"w-6"],[1,"text-xl"],["mat-icon-button","","mat-dialog-close","",1,"absolute","top-2","right-0"]],template:function(c,O){1&c&&(o.TgZ(0,"div",0),o._uU(1," Add event to your calendar "),o.qZA(),o.TgZ(2,"div",1)(3,"a",2),o.ALo(4,"sanitize"),o._UZ(5,"img",3),o.TgZ(6,"span"),o._uU(7,"Create in Outlook"),o.qZA()(),o.TgZ(8,"a",2),o.ALo(9,"sanitize"),o._UZ(10,"img",4),o.TgZ(11,"span"),o._uU(12,"Create in Google Calendar"),o.qZA()(),o.TgZ(13,"a",2),o.ALo(14,"safe"),o.TgZ(15,"app-icon",5),o._uU(16,"download"),o.qZA(),o.TgZ(17,"span"),o._uU(18,"Download iCal File"),o.qZA()()(),o.TgZ(19,"button",6)(20,"app-icon"),o._uU(21,"close"),o.qZA()()),2&c&&(o.xp6(3),o.Q6J("href",o.xi3(4,3,O.outlook_link,"url"),o.LSH),o.xp6(5),o.Q6J("href",o.xi3(9,6,O.google_link,"url"),o.LSH),o.xp6(5),o.Q6J("href",o.xi3(14,9,O.ical_link,"url"),o.LSH))},dependencies:[L.lW,e.ZT,b.o,I.y,P.n],styles:["[_nghost-%COMP%]{position:relative}\n/*# sourceMappingURL=booking-link-modal.component.ts-angular-inline--61.css.map*/"]}),p})()},4282:(W,T,t)=>{t.d(T,{I:()=>A});var e=t(2560),v=t(2508),U=(t(9112),t(4666)),o=t(2922),L=t(4522),b=t(1484);function I(p,E){if(1&p){const c=e.EpF();e.TgZ(0,"div",2)(1,"h2",3),e._uU(2,"COVID-19 Questionnaire"),e.qZA(),e.TgZ(3,"main",4)(4,"div",5)(5,"label"),e._uU(6," Have you travelled overseas within the last 14 days?"),e.TgZ(7,"span"),e._uU(8,"*"),e.qZA()(),e.TgZ(9,"mat-radio-group",6)(10,"mat-radio-button",7),e._uU(11,"Yes"),e.qZA(),e.TgZ(12,"mat-radio-button",7),e._uU(13,"No"),e.qZA()()(),e.TgZ(14,"div",5)(15,"label"),e._uU(16," Are you unwell or experiencing any cold or flu-like symptoms?"),e.TgZ(17,"span"),e._uU(18,"*"),e.qZA()(),e.TgZ(19,"mat-radio-group",8)(20,"mat-radio-button",7),e._uU(21,"Yes"),e.qZA(),e.TgZ(22,"mat-radio-button",7),e._uU(23,"No"),e.qZA()()(),e.TgZ(24,"div",9)(25,"label"),e._uU(26," Have you had contact with anyone with suspected COVID-19?"),e.TgZ(27,"span"),e._uU(28,"*"),e.qZA()(),e.TgZ(29,"mat-radio-group",10)(30,"mat-radio-button",7),e._uU(31,"Yes"),e.qZA(),e.TgZ(32,"mat-radio-button",7),e._uU(33,"No"),e.qZA()()()(),e.TgZ(34,"footer",11)(35,"button",12),e.NdJ("click",function(){e.CHM(c);const M=e.oxw();return e.KtG(M.submit())}),e._uU(36,"Submit"),e.qZA()(),e.TgZ(37,"button",13)(38,"i",14),e._uU(39,"close"),e.qZA()()()}if(2&p){const c=e.oxw();e.xp6(3),e.Q6J("formGroup",c.form),e.xp6(7),e.Q6J("value",!0),e.xp6(2),e.Q6J("value",!1),e.xp6(8),e.Q6J("value",!0),e.xp6(2),e.Q6J("value",!1),e.xp6(8),e.Q6J("value",!0),e.xp6(2),e.Q6J("value",!1)}}function P(p,E){1&p&&(e.TgZ(0,"main",15)(1,"p",16),e._uU(2," Your request to work from the office has been rejected based on your response to the compulsory Covid-19 questions. Please feel free to submit a new request when circumstances change in a way that changes your answer to the questions. "),e.qZA(),e.TgZ(3,"button",13)(4,"i",14),e._uU(5,"close"),e.qZA()()())}let A=(()=>{class p{constructor(){this.event=new e.vpe,this.form=new v.cw({travelled:new v.NI(!1),unwell:new v.NI(!1),contact:new v.NI(!1)})}submit(){this.form.markAllAsTouched(),Object.keys(this.form.value).find(c=>!0===this.form.value[c]||"true"===this.form.value[c])?this.failure=!0:this.event.emit({reason:"done"})}}return p.\u0275fac=function(c){return new(c||p)},p.\u0275cmp=e.Xpm({type:p,selectors:[["desk-question-modal"]],outputs:{event:"event"},decls:3,vars:2,consts:[["class","relative",4,"ngIf","ngIfElse"],["fail_state",""],[1,"relative"],[1,"p-4","text-xl"],[1,"p-4",3,"formGroup"],[1,"flex","flex-col","mb-4"],["formControlName","travelled",1,"space-x-2"],[3,"value"],["formControlName","unwell",1,"space-x-2"],[1,"flex","flex-col"],["formControlName","contact",1,"space-x-2"],[1,"flex","justify-center","items-center","p-2"],["mat-button","",3,"click"],["close","","mat-icon-button","","mat-dialog-close",""],[1,"material-icons"],["failure","",1,"pt-8","relative"],[1,"p-4"]],template:function(c,O){if(1&c&&(e.YNc(0,I,40,7,"div",0),e.YNc(1,P,6,0,"ng-template",null,1,e.W1O)),2&c){const M=e.MAs(2);e.Q6J("ngIf",!O.failure)("ngIfElse",M)}},dependencies:[U.O5,v.JJ,v.JL,v.sg,v.u,o.VQ,o.U0,L.lW,b.ZT],styles:["main[_ngcontent-%COMP%]{width:24rem;max-width:calc(100vw - 4.5rem)}[close][_ngcontent-%COMP%]{position:absolute;top:.5rem;right:.5rem}\n/*# sourceMappingURL=desk-questions-modal.component.ts-angular-inline--60.css.map*/"]}),p})()}}]);
//# sourceMappingURL=default-libs_bookings_src_lib_booking-form_service_ts.js.map