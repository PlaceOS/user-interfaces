"use strict";(self.webpackChunkconcierge=self.webpackChunkconcierge||[]).push([["default-libs_bookings_src_lib_booking-form_service_ts"],{8929:(k,b,t)=>{t.d(b,{f:()=>P});var e=t(3918),S=t(9885),c=t(3770),y=t(532),s=t(1810),B=t(2317),L=t(3861),R=t(7485),I=t(4505),h=t(4139),f=t(7716),l=t(9128),p=t(823),M=t(6116),v=t(9095),C=t(8759),T=t(6942),x=t(9151),$=t(5670),G=t(3910),w=t(565),F=t(6962),K=t(1980),U=t(354),Z=t(4282),W=t(8871),V=t(4367),A=t(2560),Q=t(5699);const z=["book/desks","book/parking","book/newdesk","book/new-parking"];class P extends c.KG{constructor(o,n,i,_,g){super(),this._router=o,this._settings=n,this._org=i,this._dialog=_,this._payments=g,this._view=new I.X("form"),this._options=new I.X({type:"desk"}),this._form=new I.X((0,K.PR)()),this._booking=new I.X(null),this._loading=new I.X(""),this.last_success=new F.$(JSON.parse(sessionStorage.getItem("PLACEOS.last_booked_booking")||"{}")),this.loading=this._loading.asObservable(),this.options=this._options.pipe((0,l.d)(1)),this.assets=this.options.pipe((0,p.b)(300),(0,M.g)("type"),(0,v.w)(({type:a})=>{if(!this._org.building)return(0,h.of)([]);switch(a){case"desk":return this._loading.next("Loading desks..."),this.loadAssets("desks");case"parking":return this._loading.next("Loading parking spaces..."),this.loadAssets("parking_spaces")}return(0,h.of)([])}),(0,C.b)(()=>this._loading.next("")),(0,l.d)(1)),this.features=this.assets.pipe((0,T.U)(a=>{const r=[];for(const{features:u}of a)u instanceof Array&&u.forEach(d=>r.push(d));return(0,c.Tw)(r).sort((u,d)=>u.localeCompare(d))}),(0,l.d)(1)),this.available_assets=(0,f.aj)([this.options,this.assets,this._form]).pipe((0,x.h)(([a,r,u])=>u.getRawValue().date>0&&u.getRawValue().duration>0),(0,p.b)(500),(0,C.b)(([{type:a}])=>this._loading.next(`Checking ${a} availability...`)),(0,v.w)(([a,r,u])=>(0,U.F2)({period_start:(0,s.Z)(u.getRawValue().date),period_end:(0,s.Z)((0,B.Z)(u.getRawValue().date,u.getRawValue().duration||1440)),type:a.type,zones:a.zone_id}).pipe((0,T.U)(d=>r.filter(m=>!1!==m.bookable&&(!a.features||a.features?.every(O=>m.features.includes(O)))&&(!a.zone_id||a.zone_id===m.zone?.id||a.zone_id===m.zone?.parent_id)&&!d.find(O=>O.asset_id===m.id&&"declined"!==O.status))))),(0,C.b)(()=>this._loading.next("")),(0,l.d)(1)),this.grouped_availability=(0,f.aj)([this.options,this.available_assets]).pipe((0,T.U)(([a,r])=>{const u=[],d=[...r].sort((O,E)=>O.zone?.id?.localeCompare(E.zone?.id)),m=a.members?.length?a.members:[(0,c.ar)()];for(;d.length;){const O=[];let E=d.pop();for(;O.length<m.length&&(!O.length||O.find(N=>N.zone?.id===E.zone?.id));)O.push(E),E=d.pop();O.length<m.length||u.push(O)}return u})),this.subscription("router.bookings",this._router.events.subscribe(a=>{a instanceof S.m2&&!z.find(r=>a.url.includes(r))&&this.clearForm()})),this._org.initialised.pipe((0,$.P)(a=>a)).subscribe(()=>this.setOptions({}))}get view(){return this._view.getValue()}get form(){return this._form.getValue()}get booking(){return this._booking.getValue()}newForm(o=new F.$){this._form.next((0,K.PR)(o)),this.subscription("form_change",this._form.getValue().valueChanges.subscribe(()=>this.storeForm())),this._booking.next(o),this._options.next({type:this._options.getValue().type})}setView(o){this._view.next(o)}setOptions(o){this._options.next({...this._options.getValue(),...o})}setFeature(o,n){if(!o?.length)return;const i=this._options.getValue()?.features||[];n&&!i.includes(o)&&i.push(o),!n&&i.includes(o)&&i.splice(i.findIndex(_=>_===o),1),this.setOptions({features:i})}resetForm(){this._form.getValue()||this.newForm();const o=this._booking.getValue();this._form.getValue().patchValue({...o||{},...o?.extension_data||{}}),this._options.next({type:this._options.getValue().type})}clearForm(){sessionStorage.removeItem("PLACEOS.booking_form"),sessionStorage.removeItem("PLACEOS.booking_form_options"),this.newForm()}storeForm(){sessionStorage.setItem("PLACEOS.booking_form",JSON.stringify(this._form.getValue()?.getRawValue()||{})),sessionStorage.setItem("PLACEOS.booking_form_filters",JSON.stringify(this._options.getValue()||{}))}loadForm(){this._form.getValue()||this.newForm(),this._form.getValue().patchValue({...JSON.parse(sessionStorage.getItem("PLACEOS.booking_form")||"{}")}),this.setOptions({zone_id:this._org.building?.id,...JSON.parse(sessionStorage.getItem("PLACEOS.booking_form_filters")||"{}")})}clearOldState(){sessionStorage.removeItem("PLACEOS.last_booked_booking"),this.last_success=new F.$}openBookingLinkModal(o=!1){const n=this._form.getValue();if(n.markAllAsTouched(),!n.valid&&!o)return;const i=new F.$({...this.booking,...n.getRawValue()});this._dialog.open(V.w,{data:i})}confirmPost(){var o=this;return(0,e.Z)(function*(){yield o.checkQuestions();const n=o._options.getValue(),_=o._form.getValue().getRawValue();let g=`Would you like to book the ${n.type} ${_.asset_name} for ${(0,L.Z)(_.date,"dd MMM yyyy")}${_.duration<720?" at "+(0,L.Z)(_.date,"h:mm a"):""}`;n.group&&(g=`${g}.<br>You group members will be assigned desks nearby your selected desk.`);const a=yield(0,c._5)({title:`Book ${n.type}`,content:g,icon:{content:"event_available"}},o._dialog);if("done"!==a?.reason)throw"User cancelled";a.loading("Performing booking request..."),n.group?yield o.postFormForGroup().catch(r=>{throw(0,c.cB)(JSON.stringify(r)),a.close(),r}):yield o.postForm().catch(r=>{throw(0,c.cB)(JSON.stringify(r)),a.close(),r}),a.close()})()}postForm(o=!1){var n=this;return(0,e.Z)(function*(){const i=n._form.getValue();if(!i)throw"No form for booking";if(!i.valid)throw`Some form fields are invalid. [${(0,c.RD)(i).join(", ")}]`;i.patchValue({booking_type:i.getRawValue().booking_type||n._options.getValue().type});let _=i.getRawValue();if(o||(yield n.checkResourceAvailable(_,n._options.getValue().type)),(_.duration>=720||_.all_day)&&(i.patchValue({date:(0,R.Z)(_.date,{hours:11,minutes:59}).valueOf(),duration:720}),_=i.getRawValue()),n._payments.payment_module){const r=yield n._payments.makePayment({type:n._options.getValue().type,resource_name:_.asset_name,date:_.date,duration:_.duration,all_day:_.all_day});if(!r?.success)return;_.extension_data={invoice:r,invoice_id:r.invoice_id}}n._loading.next("Saving booking"),console.log("User:",_.user,(0,c.ar)());const g=yield(0,U.km)(new F.$({...n._options.getValue(),..._,extension_data:{department:_.user.department||(0,c.ar)()?.department},approved:!!n._settings.get("app.bookings.no_approval")})).toPromise();n._loading.next("");const{booking_type:a}=_;return n.clearForm(),i?.patchValue({booking_type:a}),n.last_success=g,sessionStorage.setItem("PLACEOS.last_booked_booking",JSON.stringify(g)),n.setView("success"),g})()}postFormForGroup(){var o=this;return(0,e.Z)(function*(){const{members:n,group:i,type:_}=o._options.getValue();if(!i)throw"No group available to book for";const g=n.filter(E=>E.email!==(0,c.ar)().email);if(g.length<=0)throw"No members in your group to book for.";const a=o._form.getValue().value,r=yield o.available_assets.pipe((0,G.q)(1)).toPromise(),u=r.find(E=>E.id===a.asset_id||E.map_id===a.asset_id),d=o._org.levelWithID([u.zone?.id]),m=[u,...yield o._getNearbyResources(d.map_id,a.asset_id,r,g.length)],O=[(0,c.ar)(),...g];yield Promise.all(O.map((E,N)=>o.checkResourceAvailable({...a,asset_id:m[N].map_id||m[N].id,user_email:E.email},_)));for(let E=0;E<O.length;E++){const N=O[E],D=m[E];o._form.getValue().patchValue({...a,user:N,asset_id:D?.id,asset_name:D.name,map_id:D?.map_id||D?.id,description:D.name,zones:D.zone?(0,c.Tw)([o._org.organisation.id,D.zone?.parent_id,D.zone?.id]):[o._org.organisation.id]}),o.postForm(!0)}})()}checkQuestions(){var o=this;return(0,e.Z)(function*(){if(!1!==o._settings.get("app.desks.ignore_questions"))return;const n=o._dialog.open(Z.I);if("done"!==(yield Promise.race([n.componentInstance.event.pipe((0,$.P)(g=>"done"===g.reason)).toPromise(),n.afterClosed().toPromise()]))?.reason)throw"User cancelled";const _=n.componentInstance.form.getRawValue();for(const g in _)if(_[g])throw"User failed questionaire";n.close()})()}checkResourceAvailable({asset_id:o,date:n,duration:i,user_email:_,all_day:g},a){var r=this;return(0,e.Z)(function*(){i=g?720:i||60;const u=yield(0,U.F2)({period_start:(0,s.Z)(n),period_end:(0,s.Z)(n+60*i*1e3),type:a}).toPromise();if(u.find(m=>m.asset_id===o))throw o.includes("@")?`${o} already has an invite for the selected time`:`${o} is not available at the selected time`;const d=r._settings.get(`app.booking.allowed_daily_${a}_count`)??1;if(d>0&&u.filter(m=>m.user_email===(_||(0,c.ar)()?.email)&&"declined"!==m.status).length>=d){const m=_===(0,c.ar)()?.email;throw`${m?"You":_} already ${m?"have":"has"} a ${a} booked`}return!0})()}loadAssets(o){return(0,y.BW_)(this._org.building.id,{name:o}).pipe((0,T.U)(n=>(0,c.xH)(n.map(i=>(i.metadata[o]?.details instanceof Array?i.metadata[o]?.details:[]).map(_=>({..._,zone:i.zone}))))))}_getNearbyResources(o,n,i,_){return(0,e.Z)(function*(){const g=[];let a=i.filter(r=>r.id!==n&&r.map_id!==n);for(let r=0;r<_;r++){const u=yield(0,K.gV)(o,n,a.map(d=>d.map_id||d.id));u&&(g.push(i.find(d=>d.id===u||d.map_id===u)),a=a.filter(d=>d.id!==u&&d.map_id!==u))}return g})()}}P.\u0275fac=function(o){return new(o||P)(A.LFG(S.F0),A.LFG(c.gb),A.LFG(w.w),A.LFG(Q.uw),A.LFG(W.c))},P.\u0275prov=A.Yz7({token:P,factory:P.\u0275fac,providedIn:"root"})},4367:(k,b,t)=>{t.d(b,{w:()=>h});var e=t(5699),S=t(719),c=t(9497),s=(t(6962),t(2560)),B=t(5306),L=t(207),R=t(158),I=t(7202);class h{constructor(l,p){this._event=l,this._settings=p,this.outlook_link=(0,c.Y$)(this._event),this.google_link=(0,c.T$)(this._event),this.ical_link=(0,c.KS)(this._event)}}h.\u0275fac=function(l){return new(l||h)(s.Y36(e.WI),s.Y36(S.g))},h.\u0275cmp=s.Xpm({type:h,selectors:[["booking-link-modal"]],decls:22,vars:12,consts:function(){let f,l,p;return f=$localize`:␟34c16b14ad0e33db574c8bea543e66e766aa3a01␟4015832758698516701:Create in Outlook`,l=$localize`:␟f745484670e6b6bbb8a1c327c222e665fb25b863␟3788591245559456526:Create in Google Calendar`,p=$localize`:␟1af54061e7f4bcfb1048ffaa05c9b8f7c4b41679␟4894641609416495396:Download iCal File`,[[1,"p-4","w-full","pb-2"],[1,"flex","flex-col","items-center","space-y-4","p-4","relative"],["button","","matRipple","","target","_blank","rel","noopener noreferer",1,"flex","items-center","p-2","space-x-2","pr-4","w-64","rounded","inverse",3,"href"],["src","assets/icons/outlook.svg",1,"w-6"],f,["src","assets/icons/gcal.svg",1,"w-6"],l,[1,"text-xl"],p,["icon","","mat-dialog-close","",1,"absolute","top-2","right-0"]]},template:function(l,p){1&l&&(s.TgZ(0,"div",0),s._uU(1,"Add event to your calendar"),s.qZA(),s.TgZ(2,"div",1)(3,"a",2),s.ALo(4,"sanitize"),s._UZ(5,"img",3),s.TgZ(6,"span"),s.SDv(7,4),s.qZA()(),s.TgZ(8,"a",2),s.ALo(9,"sanitize"),s._UZ(10,"img",5),s.TgZ(11,"span"),s.SDv(12,6),s.qZA()(),s.TgZ(13,"a",2),s.ALo(14,"safe"),s.TgZ(15,"app-icon",7),s._uU(16,"download"),s.qZA(),s.TgZ(17,"span"),s.SDv(18,8),s.qZA()()(),s.TgZ(19,"button",9)(20,"app-icon"),s._uU(21,"close"),s.qZA()()),2&l&&(s.xp6(3),s.Q6J("href",s.xi3(4,3,p.outlook_link,"url"),s.LSH),s.xp6(5),s.Q6J("href",s.xi3(9,6,p.google_link,"url"),s.LSH),s.xp6(5),s.Q6J("href",s.xi3(14,9,p.ical_link,"url"),s.LSH))},dependencies:[e.ZT,B.o,L.wG,R.y,I.n],styles:["[_nghost-%COMP%]{position:relative}\n/*# sourceMappingURL=booking-link-modal.component.ts-angular-inline--62.css.map*/"]})},4282:(k,b,t)=>{t.d(b,{I:()=>h});var e=t(2560),S=t(2508),y=(t(3770),t(4666)),s=t(2922),B=t(5699),L=t(207);function R(f,l){if(1&f){const p=e.EpF();e.TgZ(0,"div",2)(1,"h2",3),e.SDv(2,4),e.qZA(),e.TgZ(3,"main",5)(4,"div",6)(5,"label"),e.tHW(6,7),e._UZ(7,"span"),e.N_p(),e.qZA(),e.TgZ(8,"mat-radio-group",8)(9,"mat-radio-button",9),e._uU(10,"Yes"),e.qZA(),e.TgZ(11,"mat-radio-button",9),e._uU(12,"No"),e.qZA()()(),e.TgZ(13,"div",6)(14,"label"),e.tHW(15,10),e._UZ(16,"span"),e.N_p(),e.qZA(),e.TgZ(17,"mat-radio-group",11)(18,"mat-radio-button",9),e._uU(19,"Yes"),e.qZA(),e.TgZ(20,"mat-radio-button",9),e._uU(21,"No"),e.qZA()()(),e.TgZ(22,"div",12)(23,"label"),e.tHW(24,13),e._UZ(25,"span"),e.N_p(),e.qZA(),e.TgZ(26,"mat-radio-group",14)(27,"mat-radio-button",9),e._uU(28,"Yes"),e.qZA(),e.TgZ(29,"mat-radio-button",9),e._uU(30,"No"),e.qZA()()()(),e.TgZ(31,"footer",15)(32,"button",16),e.NdJ("click",function(){e.CHM(p);const v=e.oxw();return e.KtG(v.submit())}),e.SDv(33,17),e.qZA()(),e.TgZ(34,"button",18)(35,"i",19),e._uU(36,"close"),e.qZA()()()}if(2&f){const p=e.oxw();e.xp6(3),e.Q6J("formGroup",p.form),e.xp6(6),e.Q6J("value",!0),e.xp6(2),e.Q6J("value",!1),e.xp6(7),e.Q6J("value",!0),e.xp6(2),e.Q6J("value",!1),e.xp6(7),e.Q6J("value",!0),e.xp6(2),e.Q6J("value",!1)}}function I(f,l){1&f&&(e.TgZ(0,"main",20)(1,"p",21),e.SDv(2,22),e.qZA(),e.TgZ(3,"button",18)(4,"i",19),e._uU(5,"close"),e.qZA()()())}class h{constructor(){this.event=new e.vpe,this.form=new S.cw({travelled:new S.NI(!1),unwell:new S.NI(!1),contact:new S.NI(!1)})}submit(){this.form.markAllAsTouched(),Object.keys(this.form.value).find(l=>!0===this.form.value[l]||"true"===this.form.value[l])?this.failure=!0:this.event.emit({reason:"done"})}}h.\u0275fac=function(l){return new(l||h)},h.\u0275cmp=e.Xpm({type:h,selectors:[["desk-question-modal"]],outputs:{event:"event"},decls:3,vars:2,consts:function(){let f,l,p,M,v,C;return f=$localize`:␟02006a13b8e6aacb7a6e15bafd8004ed529f5d81␟877348132538805077:COVID-19 Questionnaire`,l=$localize`:␟dad7efbd2320e5ea935aef911f18cbcb24690133␟1650520403092579087: Have you travelled overseas within the last 14 days?${"\ufffd#7\ufffd"}:START_TAG_SPAN:*${"\ufffd/#7\ufffd"}:CLOSE_TAG_SPAN:`,p=$localize`:␟cf50bf8de6c6db836da440c89a375631f7ba3fb0␟1182497320820036810: Are you unwell or experiencing any cold or flu-like symptoms?${"\ufffd#16\ufffd"}:START_TAG_SPAN:*${"\ufffd/#16\ufffd"}:CLOSE_TAG_SPAN:`,M=$localize`:␟273153c91358de15d124ff2966859d9949080f4c␟737527639567676154: Have you had contact with anyone with suspected COVID-19?${"\ufffd#25\ufffd"}:START_TAG_SPAN:*${"\ufffd/#25\ufffd"}:CLOSE_TAG_SPAN:`,v=$localize`:␟71c77bb8cecdf11ec3eead24dd1ba506573fa9cd␟935187492052582731:Submit`,C=$localize`:␟17d62f424c2c025579e1ec0e3f5ad971f57681df␟4401678084033805848: Your request to work from the office has been rejected based on your response to the compulsory Covid-19 questions. Please feel free to submit a new request when circumstances change in a way that changes your answer to the questions. `,[["class","relative",4,"ngIf","ngIfElse"],["fail_state",""],[1,"relative"],[1,"p-4","text-xl"],f,[1,"p-4",3,"formGroup"],[1,"flex","flex-col","mb-4"],l,["formControlName","travelled",1,"space-x-2"],[3,"value"],p,["formControlName","unwell",1,"space-x-2"],[1,"flex","flex-col"],M,["formControlName","contact",1,"space-x-2"],[1,"flex","justify-center","items-center","p-2"],["btn","","matRipple","",3,"click"],v,["close","","icon","","matRipple","","mat-dialog-close",""],[1,"material-icons"],["failure","",1,"pt-8","relative"],[1,"p-4"],C]},template:function(l,p){if(1&l&&(e.YNc(0,R,37,7,"div",0),e.YNc(1,I,6,0,"ng-template",null,1,e.W1O)),2&l){const M=e.MAs(2);e.Q6J("ngIf",!p.failure)("ngIfElse",M)}},dependencies:[y.O5,S.JJ,S.JL,S.sg,S.u,s.VQ,s.U0,B.ZT,L.wG],styles:["main[_ngcontent-%COMP%]{width:24rem;max-width:calc(100vw - 4.5rem)}[close][_ngcontent-%COMP%]{position:absolute;top:.5rem;right:.5rem}\n/*# sourceMappingURL=desk-questions-modal.component.ts-angular-inline--61.css.map*/"]})}}]);
//# sourceMappingURL=default-libs_bookings_src_lib_booking-form_service_ts.js.map