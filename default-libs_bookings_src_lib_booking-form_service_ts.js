"use strict";(self.webpackChunkconcierge=self.webpackChunkconcierge||[]).push([["default-libs_bookings_src_lib_booking-form_service_ts"],{8929:($,N,o)=>{o.d(N,{f:()=>z});var e=o(1670),M=o(9885),p=o(9112),B=o(3690),t=o(1810),F=o(2317),v=o(5148),y=o(7485),T=o(4505),L=o(4139),m=o(7716),f=o(9128),u=o(823),O=o(9095),S=o(6942),C=o(8759),R=o(9151),I=o(5670),x=o(3910),Z=o(565),K=o(6962),k=o(1980),U=o(354),G=o(4282),w=o(8871),W=o(4367),A=o(2560),V=o(1484);const Q=["book/desks","book/parking","book/newdesk","book/new-parking"];let z=(()=>{class P extends p.KG{constructor(s,a,l,r,c){super(),this._router=s,this._settings=a,this._org=l,this._dialog=r,this._payments=c,this._view=new T.X("form"),this._options=new T.X({type:"desk"}),this._form=new T.X((0,k.PR)()),this._booking=new T.X(null),this._loading=new T.X(""),this.last_success=new K.$(JSON.parse(sessionStorage.getItem("PLACEOS.last_booked_booking")||"{}")),this.loading=this._loading.asObservable(),this.options=this._options.pipe((0,f.d)(1)),this.assets=this.options.pipe((0,u.b)(300),(0,O.w)(({type:n})=>{if(!this._org.building)return(0,L.of)([]);switch(n){case"desk":return this._loading.next("Loading desks..."),(0,B.BW_)(this._org.building.id,{name:"desks"}).pipe((0,S.U)(i=>(0,p.xH)(i.map(_=>(_.metadata.desks?.details instanceof Array?_.metadata.desks?.details:[]).map(d=>({...d,zone:_.zone}))))));case"parking":return this._loading.next("Loading parking spaces..."),(0,B.BW_)(this._org.building.id,{name:"parking_spaces"}).pipe((0,S.U)(i=>(0,p.xH)(i.map(_=>(_.metadata.parking_spaces?.details instanceof Array?_.metadata.parking_spaces?.details:[]).map(d=>({...d,zone:_.zone}))))))}return(0,L.of)([])}),(0,C.b)(()=>this._loading.next("")),(0,f.d)(1)),this.features=this.assets.pipe((0,S.U)(n=>{const i=[];for(const{features:_}of n)_ instanceof Array&&_.forEach(d=>i.push(d));return(0,p.Tw)(i).sort((_,d)=>_.localeCompare(d))}),(0,f.d)(1)),this.available_assets=(0,m.aj)([this.options,this.assets,this._form]).pipe((0,R.h)(([n,i,_])=>_.getRawValue().date>0&&_.getRawValue().duration>0),(0,u.b)(500),(0,C.b)(([{type:n}])=>this._loading.next(`Checking ${n} availability...`)),(0,O.w)(([n,i,_])=>(0,U.F2)({period_start:(0,t.Z)(_.getRawValue().date),period_end:(0,t.Z)((0,F.Z)(_.getRawValue().date,_.getRawValue().duration||1440)),type:n.type,zones:n.zone_id}).pipe((0,S.U)(d=>i.filter(g=>!1!==g.bookable&&(!n.features||n.features?.every(E=>g.features.includes(E)))&&(!n.zone_id||n.zone_id===g.zone?.id||n.zone_id===g.zone?.parent_id)&&!d.find(E=>E.asset_id===g.id&&"declined"!==E.status))))),(0,C.b)(()=>this._loading.next("")),(0,f.d)(1)),this.grouped_availability=(0,m.aj)([this.options,this.available_assets]).pipe((0,S.U)(([n,i])=>{const _=[],d=[...i].sort((E,h)=>E.zone?.id?.localeCompare(h.zone?.id)),g=n.members?.length?n.members:[(0,p.ar)()];for(;d.length;){const E=[];let h=d.pop();for(;E.length<g.length&&(!E.length||E.find(b=>b.zone?.id===h.zone?.id));)E.push(h),h=d.pop();E.length<g.length||_.push(E)}return _})),this.subscription("router.bookings",this._router.events.subscribe(n=>{n instanceof M.m2&&!Q.find(i=>n.url.includes(i))&&this.clearForm()})),this._org.initialised.pipe((0,I.P)(n=>n)).subscribe(()=>this.setOptions({}))}get view(){return this._view.getValue()}get form(){return this._form.getValue()}get booking(){return this._booking.getValue()}newForm(s=new K.$){this._form.next((0,k.PR)(s)),this.subscription("form_change",this._form.getValue().valueChanges.subscribe(()=>this.storeForm())),this._booking.next(s),this._options.next({type:this._options.getValue().type})}setView(s){this._view.next(s)}setOptions(s){this._options.next({...this._options.getValue(),...s})}setFeature(s,a){if(!s?.length)return;const l=this._options.getValue()?.features||[];a&&!l.includes(s)&&l.push(s),!a&&l.includes(s)&&l.splice(l.findIndex(r=>r===s),1),this.setOptions({features:l})}resetForm(){this._form.getValue()||this.newForm();const s=this._booking.getValue();this._form.getValue().patchValue({...s||{},...s?.extension_data||{}}),this._options.next({type:this._options.getValue().type})}clearForm(){sessionStorage.removeItem("PLACEOS.booking_form"),sessionStorage.removeItem("PLACEOS.booking_form_options"),this.newForm()}storeForm(){sessionStorage.setItem("PLACEOS.booking_form",JSON.stringify(this._form.getValue()?.getRawValue()||{})),sessionStorage.setItem("PLACEOS.booking_form_filters",JSON.stringify(this._options.getValue()||{}))}loadForm(){this._form.getValue()||this.newForm(),this._form.getValue().patchValue({...JSON.parse(sessionStorage.getItem("PLACEOS.booking_form")||"{}")}),this.setOptions({zone_id:this._org.building?.id,...JSON.parse(sessionStorage.getItem("PLACEOS.booking_form_filters")||"{}")})}openBookingLinkModal(s=!1){const a=this._form.getValue();if(a.markAllAsTouched(),!a.valid&&!s)return;const l=new K.$({...this.booking,...a.getRawValue()});this._dialog.open(W.w,{data:l})}confirmPost(){var s=this;return(0,e.Z)(function*(){yield s.checkQuestions();const a=s._options.getValue(),r=s._form.getValue().getRawValue();let c=`Would you like to book the ${a.type} ${r.asset_name} for ${(0,v.Z)(r.date,"dd MMM yyyy")}${r.duration<720?" at "+(0,v.Z)(r.date,"h:mm a"):""}`;a.group&&(c=`${c}.<br>You group members will be assigned desks nearby your selected desk.`);const n=yield(0,p._5)({title:`Book ${a.type}`,content:c,icon:{content:"event_available"}},s._dialog);if("done"!==n?.reason)throw"User cancelled";n.loading("Performing booking request..."),a.group?yield s.postFormForGroup().catch(i=>{throw(0,p.cB)(i),n.close(),i}):yield s.postForm().catch(i=>{throw(0,p.cB)(i),n.close(),i}),n.close()})()}postForm(s=!1){var a=this;return(0,e.Z)(function*(){const l=a._form.getValue();if(!l)throw"No form for booking";if(!l.valid)throw`Some form fields are invalid. [${(0,p.RD)(l).join(", ")}]`;l.patchValue({booking_type:l.getRawValue().booking_type||a._options.getValue().type});const r=l.getRawValue();if(s||(yield a.checkResourceAvailable(r,a._options.getValue().type)),(r.duration>=720||r.all_day)&&l.patchValue({date:(0,y.Z)(r.date,{hours:11,minutes:59}).valueOf(),duration:720}),a._payments.payment_module){const i=yield a._payments.makePayment({type:a._options.getValue().type,resource_name:r.asset_name,date:r.date,duration:r.duration,all_day:r.all_day});if(!i?.success)return;r.extension_data={invoice:i,invoice_id:i.invoice_id}}a._loading.next("Saving booking");const c=yield(0,U.km)(new K.$({...a._options.getValue(),...r,approved:!!a._settings.get("app.bookings.no_approval")})).toPromise();a._loading.next("");const{booking_type:n}=r;return a.clearForm(),l?.patchValue({booking_type:n}),a.last_success=c,sessionStorage.setItem("PLACEOS.last_booked_booking",JSON.stringify(c)),a.setView("success"),c})()}postFormForGroup(){var s=this;return(0,e.Z)(function*(){const{members:a,group:l,type:r}=s._options.getValue();if(!l)throw"No group available to book for";const c=a.filter(h=>h.email!==(0,p.ar)().email);if(c.length<=0)throw"No members in your group to book for.";const n=s._form.getValue().value,i=yield s.available_assets.pipe((0,x.q)(1)).toPromise(),_=i.find(h=>h.id===n.asset_id||h.map_id===n.asset_id),d=s._org.levelWithID([_.zone?.id]),g=[_,...yield s._getNearbyResources(d.map_id,n.asset_id,i,c.length)],E=[(0,p.ar)(),...c];yield Promise.all(E.map((h,b)=>s.checkResourceAvailable({...n,asset_id:g[b].map_id||g[b].id,user_email:h.email},r)));for(let h=0;h<E.length;h++){const b=E[h],D=g[h];s._form.getValue().patchValue({...n,user:b,asset_id:D?.id,asset_name:D.name,map_id:D?.map_id||D?.id,description:D.name,zones:D.zone?[D.zone?.parent_id,D.zone?.id]:[]}),s.postForm(!0)}})()}checkQuestions(){var s=this;return(0,e.Z)(function*(){if(!1!==s._settings.get("app.desks.ignore_questions"))return;const a=s._dialog.open(G.I);if("done"!==(yield Promise.race([a.componentInstance.event.pipe((0,I.P)(c=>"done"===c.reason)).toPromise(),a.afterClosed().toPromise()]))?.reason)throw"User cancelled";const r=a.componentInstance.form.getRawValue();for(const c in r)if(r[c])throw"User failed questionaire";a.close()})()}checkResourceAvailable({asset_id:s,date:a,duration:l,user_email:r,all_day:c},n){var i=this;return(0,e.Z)(function*(){l=c?720:l||60;const _=yield(0,U.F2)({period_start:(0,t.Z)(a),period_end:(0,t.Z)(a+60*l*1e3),type:n}).toPromise();if(_.find(g=>g.asset_id===s))throw s.includes("@")?`${s} already has an invite for the selected time`:`${s} is not available at the selected time`;const d=i._settings.get(`app.booking.allowed_daily_${n}_count`)??1;if(d>0&&_.filter(g=>g.user_email===(r||(0,p.ar)()?.email)&&"declined"!==g.status).length>=d){const g=r===(0,p.ar)()?.email;throw`${g?"You":r} already ${g?"have":"has"} a ${n} booked`}return!0})()}_getNearbyResources(s,a,l,r){return(0,e.Z)(function*(){const c=[];let n=l.filter(i=>i.id!==a&&i.map_id!==a);for(let i=0;i<r;i++){const _=yield(0,k.gV)(s,a,n.map(d=>d.map_id||d.id));_&&(c.push(l.find(d=>d.id===_||d.map_id===_)),n=n.filter(d=>d.id!==_&&d.map_id!==_))}return c})()}}return P.\u0275fac=function(s){return new(s||P)(A.LFG(M.F0),A.LFG(p.gb),A.LFG(Z.w),A.LFG(V.uw),A.LFG(w.c))},P.\u0275prov=A.Yz7({token:P,factory:P.\u0275fac,providedIn:"root"}),P})()},4367:($,N,o)=>{o.d(N,{w:()=>L});var e=o(1484),M=o(719),p=o(9497),t=(o(6962),o(2560)),F=o(4522),v=o(5306),y=o(158),T=o(7202);let L=(()=>{class m{constructor(u,O){this._event=u,this._settings=O,this.outlook_link=(0,p.Y$)(this._event),this.google_link=(0,p.T$)(this._event),this.ical_link=(0,p.KS)(this._event)}}return m.\u0275fac=function(u){return new(u||m)(t.Y36(e.WI),t.Y36(M.g))},m.\u0275cmp=t.Xpm({type:m,selectors:[["booking-link-modal"]],decls:22,vars:12,consts:function(){let f,u,O;return f=$localize`:␟34c16b14ad0e33db574c8bea543e66e766aa3a01␟4015832758698516701:Create in Outlook`,u=$localize`:␟f745484670e6b6bbb8a1c327c222e665fb25b863␟3788591245559456526:Create in Google Calendar`,O=$localize`:␟1af54061e7f4bcfb1048ffaa05c9b8f7c4b41679␟4894641609416495396:Download iCal File`,[[1,"p-4","w-full","pb-2"],[1,"flex","flex-col","items-center","space-y-4","p-4","relative"],["button","","matRipple","","target","_blank","rel","noopener noreferer",1,"flex","items-center","p-2","space-x-2","pr-4","w-64","rounded","inverse",3,"href"],["src","assets/icons/outlook.svg",1,"w-6"],f,["src","assets/icons/gcal.svg",1,"w-6"],u,[1,"text-xl"],O,["mat-icon-button","","mat-dialog-close","",1,"absolute","top-2","right-0"]]},template:function(u,O){1&u&&(t.TgZ(0,"div",0),t._uU(1," Add event to your calendar "),t.qZA(),t.TgZ(2,"div",1)(3,"a",2),t.ALo(4,"sanitize"),t._UZ(5,"img",3),t.TgZ(6,"span"),t.SDv(7,4),t.qZA()(),t.TgZ(8,"a",2),t.ALo(9,"sanitize"),t._UZ(10,"img",5),t.TgZ(11,"span"),t.SDv(12,6),t.qZA()(),t.TgZ(13,"a",2),t.ALo(14,"safe"),t.TgZ(15,"app-icon",7),t._uU(16,"download"),t.qZA(),t.TgZ(17,"span"),t.SDv(18,8),t.qZA()()(),t.TgZ(19,"button",9)(20,"app-icon"),t._uU(21,"close"),t.qZA()()),2&u&&(t.xp6(3),t.Q6J("href",t.xi3(4,3,O.outlook_link,"url"),t.LSH),t.xp6(5),t.Q6J("href",t.xi3(9,6,O.google_link,"url"),t.LSH),t.xp6(5),t.Q6J("href",t.xi3(14,9,O.ical_link,"url"),t.LSH))},dependencies:[F.lW,e.ZT,v.o,y.y,T.n],styles:["[_nghost-%COMP%]{position:relative}\n/*# sourceMappingURL=booking-link-modal.component.ts-angular-inline--61.css.map*/"]}),m})()},4282:($,N,o)=>{o.d(N,{I:()=>L});var e=o(2560),M=o(2508),B=(o(9112),o(4666)),t=o(2922),F=o(4522),v=o(1484);function y(m,f){if(1&m){const u=e.EpF();e.TgZ(0,"div",2)(1,"h2",3),e.SDv(2,4),e.qZA(),e.TgZ(3,"main",5)(4,"div",6)(5,"label"),e.tHW(6,7),e._UZ(7,"span"),e.N_p(),e.qZA(),e.TgZ(8,"mat-radio-group",8)(9,"mat-radio-button",9),e._uU(10,"Yes"),e.qZA(),e.TgZ(11,"mat-radio-button",9),e._uU(12,"No"),e.qZA()()(),e.TgZ(13,"div",6)(14,"label"),e.tHW(15,10),e._UZ(16,"span"),e.N_p(),e.qZA(),e.TgZ(17,"mat-radio-group",11)(18,"mat-radio-button",9),e._uU(19,"Yes"),e.qZA(),e.TgZ(20,"mat-radio-button",9),e._uU(21,"No"),e.qZA()()(),e.TgZ(22,"div",12)(23,"label"),e.tHW(24,13),e._UZ(25,"span"),e.N_p(),e.qZA(),e.TgZ(26,"mat-radio-group",14)(27,"mat-radio-button",9),e._uU(28,"Yes"),e.qZA(),e.TgZ(29,"mat-radio-button",9),e._uU(30,"No"),e.qZA()()()(),e.TgZ(31,"footer",15)(32,"button",16),e.NdJ("click",function(){e.CHM(u);const S=e.oxw();return e.KtG(S.submit())}),e.SDv(33,17),e.qZA()(),e.TgZ(34,"button",18)(35,"i",19),e._uU(36,"close"),e.qZA()()()}if(2&m){const u=e.oxw();e.xp6(3),e.Q6J("formGroup",u.form),e.xp6(6),e.Q6J("value",!0),e.xp6(2),e.Q6J("value",!1),e.xp6(7),e.Q6J("value",!0),e.xp6(2),e.Q6J("value",!1),e.xp6(7),e.Q6J("value",!0),e.xp6(2),e.Q6J("value",!1)}}function T(m,f){1&m&&(e.TgZ(0,"main",20)(1,"p",21),e.SDv(2,22),e.qZA(),e.TgZ(3,"button",18)(4,"i",19),e._uU(5,"close"),e.qZA()()())}let L=(()=>{class m{constructor(){this.event=new e.vpe,this.form=new M.cw({travelled:new M.NI(!1),unwell:new M.NI(!1),contact:new M.NI(!1)})}submit(){this.form.markAllAsTouched(),Object.keys(this.form.value).find(u=>!0===this.form.value[u]||"true"===this.form.value[u])?this.failure=!0:this.event.emit({reason:"done"})}}return m.\u0275fac=function(u){return new(u||m)},m.\u0275cmp=e.Xpm({type:m,selectors:[["desk-question-modal"]],outputs:{event:"event"},decls:3,vars:2,consts:function(){let f,u,O,S,C,R;return f=$localize`:␟02006a13b8e6aacb7a6e15bafd8004ed529f5d81␟877348132538805077:COVID-19 Questionnaire`,u=$localize`:␟dad7efbd2320e5ea935aef911f18cbcb24690133␟1650520403092579087: Have you travelled overseas within the last 14 days?${"\ufffd#7\ufffd"}:START_TAG_SPAN:*${"\ufffd/#7\ufffd"}:CLOSE_TAG_SPAN:`,O=$localize`:␟cf50bf8de6c6db836da440c89a375631f7ba3fb0␟1182497320820036810: Are you unwell or experiencing any cold or flu-like symptoms?${"\ufffd#16\ufffd"}:START_TAG_SPAN:*${"\ufffd/#16\ufffd"}:CLOSE_TAG_SPAN:`,S=$localize`:␟273153c91358de15d124ff2966859d9949080f4c␟737527639567676154: Have you had contact with anyone with suspected COVID-19?${"\ufffd#25\ufffd"}:START_TAG_SPAN:*${"\ufffd/#25\ufffd"}:CLOSE_TAG_SPAN:`,C=$localize`:␟71c77bb8cecdf11ec3eead24dd1ba506573fa9cd␟935187492052582731:Submit`,R=$localize`:␟17d62f424c2c025579e1ec0e3f5ad971f57681df␟4401678084033805848: Your request to work from the office has been rejected based on your response to the compulsory Covid-19 questions. Please feel free to submit a new request when circumstances change in a way that changes your answer to the questions. `,[["class","relative",4,"ngIf","ngIfElse"],["fail_state",""],[1,"relative"],[1,"p-4","text-xl"],f,[1,"p-4",3,"formGroup"],[1,"flex","flex-col","mb-4"],u,["formControlName","travelled",1,"space-x-2"],[3,"value"],O,["formControlName","unwell",1,"space-x-2"],[1,"flex","flex-col"],S,["formControlName","contact",1,"space-x-2"],[1,"flex","justify-center","items-center","p-2"],["mat-button","",3,"click"],C,["close","","mat-icon-button","","mat-dialog-close",""],[1,"material-icons"],["failure","",1,"pt-8","relative"],[1,"p-4"],R]},template:function(u,O){if(1&u&&(e.YNc(0,y,37,7,"div",0),e.YNc(1,T,6,0,"ng-template",null,1,e.W1O)),2&u){const S=e.MAs(2);e.Q6J("ngIf",!O.failure)("ngIfElse",S)}},dependencies:[B.O5,M.JJ,M.JL,M.sg,M.u,t.VQ,t.U0,F.lW,v.ZT],styles:["main[_ngcontent-%COMP%]{width:24rem;max-width:calc(100vw - 4.5rem)}[close][_ngcontent-%COMP%]{position:absolute;top:.5rem;right:.5rem}\n/*# sourceMappingURL=desk-questions-modal.component.ts-angular-inline--60.css.map*/"]}),m})()}}]);
//# sourceMappingURL=default-libs_bookings_src_lib_booking-form_service_ts.js.map