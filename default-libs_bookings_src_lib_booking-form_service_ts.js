"use strict";(self.webpackChunkconcierge=self.webpackChunkconcierge||[]).push([["default-libs_bookings_src_lib_booking-form_service_ts"],{8929:(B,I,s)=>{s.d(I,{f:()=>$});var e=s(1670),h=s(9885),g=s(9112),T=s(3690),P=s(1810),R=s(2317),C=s(5148),x=s(7485),M=s(4505),U=s(4139),f=s(7716),v=s(9128),p=s(6116),A=s(9095),E=s(6942),L=s(8759),K=s(9151),W=s(823),V=s(5670),F=s(3910),S=s(6638),k=s(6962),Z=s(1980),w=s(354),N=s(4282),z=s(8871),D=s(2560),j=s(1484);const J=["book/desks"];let $=(()=>{class b extends g.KG{constructor(t,n,l,i,u){super(),this._router=t,this._settings=n,this._org=l,this._dialog=i,this._payments=u,this._view=new M.X("form"),this._options=new M.X({type:"desk"}),this._form=new M.X((0,Z.PR)()),this._booking=new M.X(null),this._loading=new M.X(""),this.last_success=new k.$(JSON.parse(sessionStorage.getItem("PLACEOS.last_booked_booking")||"{}")),this.loading=this._loading.asObservable(),this.options=this._options.pipe((0,v.d)(1)),this.assets=this.options.pipe((0,p.g)("zone_id"),(0,A.w)(({type:o})=>this._org.building&&"desk"===o?(this._loading.next("Loading desks..."),(0,T.BW_)(this._org.building.id,{name:"desks"}).pipe((0,E.U)(r=>(0,g.xH)(r.map(a=>(a.metadata.desks?.details instanceof Array?a.metadata.desks?.details:[]).map(_=>({..._,zone:a.zone}))))))):(0,U.of)([])),(0,L.b)(()=>this._loading.next("")),(0,v.d)(1)),this.features=this.assets.pipe((0,E.U)(o=>{const r=[];for(const{features:a}of o)a instanceof Array&&a.forEach(_=>r.push(_));return(0,g.Tw)(r).sort((a,_)=>a.localeCompare(_))}),(0,v.d)(1)),this.available_assets=(0,f.aj)([this.options,this.assets,this._form]).pipe((0,K.h)(([o,r,a])=>a.getRawValue().date>0&&a.getRawValue().duration>0),(0,W.b)(500),(0,L.b)(([{type:o}])=>this._loading.next(`Checking ${o} availability...`)),(0,A.w)(([o,r,a])=>(0,w.F2)({period_start:(0,P.Z)(a.getRawValue().date),period_end:(0,P.Z)((0,R.Z)(a.getRawValue().date,a.getRawValue().duration||1440)),type:o.type,zones:o.zone_id}).pipe((0,E.U)(_=>r.filter(d=>!1!==d.bookable&&(!o.features||o.features?.every(m=>d.features.includes(m)))&&(!o.zone_id||o.zone_id===d.zone?.id||o.zone_id===d.zone?.parent_id)&&!_.find(m=>m.asset_id===d.id&&"declined"!==m.status)&&(!o?.show_fav||this.favorite_desks.includes(d.id)))))),(0,L.b)(()=>this._loading.next("")),(0,v.d)(1)),this.grouped_availability=(0,f.aj)([this.options,this.available_assets]).pipe((0,E.U)(([o,r])=>{const a=[],_=[...r].sort((m,c)=>m.zone?.id?.localeCompare(c.zone?.id)),d=o.members?.length?o.members:[(0,g.ar)()];for(;_.length;){const m=[];let c=_.pop();for(;m.length<d.length&&(!m.length||m.find(y=>y.zone?.id===c.zone?.id));)m.push(c),c=_.pop();m.length<d.length||a.push(m)}return a})),this.subscription("router.bookings",this._router.events.subscribe(o=>{o instanceof h.m2&&!J.find(r=>o.url.includes(r))&&this.clearForm()})),this._org.initialised.pipe((0,V.P)(o=>o)).subscribe(()=>this.setOptions({}))}get view(){return this._view.getValue()}get form(){return this._form.getValue()}get booking(){return this._booking.getValue()}get favorite_desks(){return this._settings.get("favourite_desks")||[]}newForm(t=new k.$){this._form.next((0,Z.PR)(t)),this.subscription("form_change",this._form.getValue().valueChanges.subscribe(()=>this.storeForm())),this._booking.next(t),this._options.next({type:this._options.getValue().type})}setView(t){this._view.next(t)}setOptions(t){this._options.next({...this._options.getValue(),...t})}setFeature(t,n){if(!t?.length)return;const l=this._options.getValue()?.features||[];n&&!l.includes(t)&&l.push(t),!n&&l.includes(t)&&l.splice(l.findIndex(i=>i===t),1),this.setOptions({features:l})}resetForm(){this._form.getValue()||this.newForm();const t=this._booking.getValue();this._form.getValue().patchValue({...t||{},...t?.extension_data||{}}),this._options.next({type:this._options.getValue().type})}clearForm(){sessionStorage.removeItem("PLACEOS.booking_form"),sessionStorage.removeItem("PLACEOS.booking_form_options"),this.newForm()}storeForm(){sessionStorage.setItem("PLACEOS.booking_form",JSON.stringify(this._form.getValue()?.getRawValue()||{})),sessionStorage.setItem("PLACEOS.booking_form_filters",JSON.stringify(this._options.getValue()||{}))}loadForm(){this._form.getValue()||this.newForm(),this._form.getValue().patchValue({...JSON.parse(sessionStorage.getItem("PLACEOS.booking_form")||"{}")}),this.setOptions({zone_id:this._org.building?.id,...JSON.parse(sessionStorage.getItem("PLACEOS.booking_form_filters")||"{}")})}confirmPost(){var t=this;return(0,e.Z)(function*(){yield t.checkQuestions();const n=t._options.getValue(),i=t._form.getValue().getRawValue();let u=`Would you like to book the ${n.type} ${i.asset_name} for ${(0,C.Z)(i.date,"dd MMM yyyy")}${i.duration<720?" at "+(0,C.Z)(i.date,"h:mm a"):""}`;n.group&&(u=`${u}.<br>You group members will be assigned desks nearby your selected desk.`);const o=yield(0,g._5)({title:`Book ${n.type}`,content:u,icon:{content:"event_available"}},t._dialog);if("done"!==o?.reason)throw"User cancelled";o.loading("Performing booking request..."),n.group?yield t.postFormForGroup().catch(r=>{throw(0,g.cB)(r),o.close(),r}):yield t.postForm().catch(r=>{throw(0,g.cB)(r),o.close(),r}),o.close()})()}postForm(t=!1){var n=this;return(0,e.Z)(function*(){const l=n._form.getValue();if(!l)throw"No form for booking";if(!l.valid)throw`Some form fields are invalid. [${(0,g.RD)(l).join(", ")}]`;const i=l.getRawValue();t||(yield n.checkResourceAvailable(i,n._options.getValue().type)),(i.duration>=720||i.all_day)&&l.patchValue({date:(0,x.Z)(i.date,{hours:11,minutes:59}).valueOf(),duration:720}),n._payments.payment_module&&(yield n._payments.makePayment({type:"space",resource_name:i.asset_name,date:i.date,duration:i.duration,all_day:i.all_day})),n._loading.next("Saving booking");const u=yield(0,w.km)(new k.$({...n._options.getValue(),...i,approved:!!n._settings.get("app.bookings.no_approval")})).toPromise();n._loading.next("");const{booking_type:o}=i;return n.clearForm(),l?.patchValue({booking_type:o}),n.last_success=u,sessionStorage.setItem("PLACEOS.last_booked_booking",JSON.stringify(u)),n.setView("success"),u})()}postFormForGroup(){var t=this;return(0,e.Z)(function*(){const{members:n,group:l,type:i}=t._options.getValue();if(!l)throw"No group available to book for";const u=n.filter(c=>c.email!==(0,g.ar)().email);if(u.length<=0)throw"No members in your group to book for.";const o=t._form.getValue().value,r=yield t.available_assets.pipe((0,F.q)(1)).toPromise(),a=r.find(c=>c.id===o.asset_id||c.map_id===o.asset_id),_=t._org.levelWithID([a.zone?.id]),d=[a,...yield t._getNearbyResources(_.map_id,o.asset_id,r,u.length)],m=[(0,g.ar)(),...u];yield Promise.all(m.map((c,y)=>t.checkResourceAvailable({...o,asset_id:d[y].map_id||d[y].id,user_email:c.email},i)));for(let c=0;c<m.length;c++){const y=m[c],O=d[c];t._form.getValue().patchValue({...o,user:y,asset_id:O?.id,asset_name:O.name,map_id:O?.map_id||O?.id,description:O.name,zones:O.zone?[O.zone?.parent_id,O.zone?.id]:[]}),t.postForm(!0)}})()}checkQuestions(){var t=this;return(0,e.Z)(function*(){if(!1!==t._settings.get("app.desks.ignore_questions"))return;const n=t._dialog.open(N.I);if("done"!==(yield Promise.race([n.componentInstance.event.pipe((0,V.P)(u=>"done"===u.reason)).toPromise(),n.afterClosed().toPromise()]))?.reason)throw"User cancelled";const i=n.componentInstance.form.getRawValue();for(const u in i)if(i[u])throw"User failed questionaire";n.close()})()}checkResourceAvailable({asset_id:t,date:n,duration:l,user_email:i,all_day:u},o){var r=this;return(0,e.Z)(function*(){l=u?720:l||60;const a=yield(0,w.F2)({period_start:(0,P.Z)(n),period_end:(0,P.Z)(n+60*l*1e3),type:o}).toPromise();if(a.find(d=>d.asset_id===t))throw`${t} is not available at the selected time`;const _=r._settings.get(`app.booking.allowed_daily_${o}_count`)??1;if(_>0&&a.filter(d=>d.user_email===(i||(0,g.ar)()?.email)&&"declined"!==d.status).length>=_){const d=i===(0,g.ar)()?.email;throw`${d?"You":i} already ${d?"have":"has"} a desk booked`}return!0})()}_getNearbyResources(t,n,l,i){return(0,e.Z)(function*(){const u=[];let o=l.filter(r=>r.id!==n&&r.map_id!==n);for(let r=0;r<i;r++){const a=yield(0,Z.gV)(t,n,o.map(_=>_.map_id||_.id));a&&(u.push(l.find(_=>_.id===a||_.map_id===a)),o=o.filter(_=>_.id!==a&&_.map_id!==a))}return u})()}}return b.\u0275fac=function(t){return new(t||b)(D.LFG(h.F0),D.LFG(g.gb),D.LFG(S.w),D.LFG(j.uw),D.LFG(z.c))},b.\u0275prov=D.Yz7({token:b,factory:b.\u0275fac,providedIn:"root"}),b})()},4282:(B,I,s)=>{s.d(I,{I:()=>U});var e=s(2560),h=s(2508),T=(s(9112),s(4666)),P=s(2922),R=s(4522),C=s(1484);function x(f,v){if(1&f){const p=e.EpF();e.TgZ(0,"div",2)(1,"h2",3),e._uU(2,"COVID-19 Questionnaire"),e.qZA(),e.TgZ(3,"main",4)(4,"div",5)(5,"label"),e._uU(6," Have you travelled overseas within the last 14 days?"),e.TgZ(7,"span"),e._uU(8,"*"),e.qZA()(),e.TgZ(9,"mat-radio-group",6)(10,"mat-radio-button",7),e._uU(11,"Yes"),e.qZA(),e.TgZ(12,"mat-radio-button",7),e._uU(13,"No"),e.qZA()()(),e.TgZ(14,"div",5)(15,"label"),e._uU(16," Are you unwell or experiencing any cold or flu-like symptoms?"),e.TgZ(17,"span"),e._uU(18,"*"),e.qZA()(),e.TgZ(19,"mat-radio-group",8)(20,"mat-radio-button",7),e._uU(21,"Yes"),e.qZA(),e.TgZ(22,"mat-radio-button",7),e._uU(23,"No"),e.qZA()()(),e.TgZ(24,"div",9)(25,"label"),e._uU(26," Have you had contact with anyone with suspected COVID-19?"),e.TgZ(27,"span"),e._uU(28,"*"),e.qZA()(),e.TgZ(29,"mat-radio-group",10)(30,"mat-radio-button",7),e._uU(31,"Yes"),e.qZA(),e.TgZ(32,"mat-radio-button",7),e._uU(33,"No"),e.qZA()()()(),e.TgZ(34,"footer",11)(35,"button",12),e.NdJ("click",function(){e.CHM(p);const E=e.oxw();return e.KtG(E.submit())}),e._uU(36,"Submit"),e.qZA()(),e.TgZ(37,"button",13)(38,"i",14),e._uU(39,"close"),e.qZA()()()}if(2&f){const p=e.oxw();e.xp6(3),e.Q6J("formGroup",p.form),e.xp6(7),e.Q6J("value",!0),e.xp6(2),e.Q6J("value",!1),e.xp6(8),e.Q6J("value",!0),e.xp6(2),e.Q6J("value",!1),e.xp6(8),e.Q6J("value",!0),e.xp6(2),e.Q6J("value",!1)}}function M(f,v){1&f&&(e.TgZ(0,"main",15)(1,"p",16),e._uU(2," Your request to work from the office has been rejected based on your response to the compulsory Covid-19 questions. Please feel free to submit a new request when circumstances change in a way that changes your answer to the questions. "),e.qZA(),e.TgZ(3,"button",13)(4,"i",14),e._uU(5,"close"),e.qZA()()())}let U=(()=>{class f{constructor(){this.event=new e.vpe,this.form=new h.cw({travelled:new h.NI(!1),unwell:new h.NI(!1),contact:new h.NI(!1)})}submit(){this.form.markAllAsTouched(),Object.keys(this.form.value).find(p=>!0===this.form.value[p]||"true"===this.form.value[p])?this.failure=!0:this.event.emit({reason:"done"})}}return f.\u0275fac=function(p){return new(p||f)},f.\u0275cmp=e.Xpm({type:f,selectors:[["desk-question-modal"]],outputs:{event:"event"},decls:3,vars:2,consts:[["class","relative",4,"ngIf","ngIfElse"],["fail_state",""],[1,"relative"],[1,"p-4","text-xl"],[1,"p-4",3,"formGroup"],[1,"flex","flex-col","mb-4"],["formControlName","travelled",1,"space-x-2"],[3,"value"],["formControlName","unwell",1,"space-x-2"],[1,"flex","flex-col"],["formControlName","contact",1,"space-x-2"],[1,"flex","justify-center","items-center","p-2"],["mat-button","",3,"click"],["close","","mat-icon-button","","mat-dialog-close",""],[1,"material-icons"],["failure","",1,"pt-8","relative"],[1,"p-4"]],template:function(p,A){if(1&p&&(e.YNc(0,x,40,7,"div",0),e.YNc(1,M,6,0,"ng-template",null,1,e.W1O)),2&p){const E=e.MAs(2);e.Q6J("ngIf",!A.failure)("ngIfElse",E)}},dependencies:[T.O5,h.JJ,h.JL,h.sg,h.u,P.VQ,P.U0,R.lW,C.ZT],styles:["main[_ngcontent-%COMP%]{width:24rem;max-width:calc(100vw - 4.5rem)}[close][_ngcontent-%COMP%]{position:absolute;top:.5rem;right:.5rem}\n/*# sourceMappingURL=desk-questions-modal.component.ts-angular-inline--58.css.map*/"]}),f})()}}]);
//# sourceMappingURL=default-libs_bookings_src_lib_booking-form_service_ts.js.map