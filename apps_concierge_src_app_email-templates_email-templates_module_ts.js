"use strict";(self.webpackChunkconcierge=self.webpackChunkconcierge||[]).push([["apps_concierge_src_app_email-templates_email-templates_module_ts"],{53244:(A,D,i)=>{i.r(D),i.d(D,{EmailTemplatesModule:()=>ye});var u=i(60316),r=i(34456),f=i(26842),G=i(22168),m=i(63046),N=i(57915),O=i(40363),e=i(7404),B=i(45189),U=i(96843);const Y=["app-email-templates",""];let L=(()=>{class n{static#e=this.\u0275fac=function(s){return new(s||n)};static#t=this.\u0275cmp=e.VBU({type:n,selectors:[["","app-email-templates",""]],attrs:Y,decls:5,vars:0,consts:[[1,"flex","flex-1","h-px"],[1,"relative","flex","flex-col","flex-1","w-1/2","h-full"]],template:function(s,o){1&s&&(e.nrm(0,"app-topbar"),e.j41(1,"div",0),e.nrm(2,"app-sidebar"),e.j41(3,"main",1),e.nrm(4,"router-outlet"),e.k0s()())},dependencies:[B.S,U.c,f.n3],styles:["[_nghost-%COMP%]{display:flex;flex-direction:column;height:100%;width:100%;background-color:var(--b1)}\n\n/*# sourceMappingURL=email-templates.component.ts-angular-inline--192.css.map*/"]})}return n})();var g=i(89204),d=i(77375),M=i(12185),h=i(3998),V=i(99908),F=i(90521),k=i(42175),y=i(71536),$=i(68757),S=i(8627),I=i(71963),v=i(35443),T=i(29314),R=i(7841),E=i(33602);let z=(()=>{class n{_processTemplates(t,s){const o=t.details;return((o instanceof Array?o:"")||[]).map(a=>({...a,zone_id:s}))}constructor(t,s){this._org=t,this._settings=s,this._filters=new F.t({}),this._change=new F.t(0),this.template_definitions=(0,k.zV)([this._org.active_building,this._org.active_region,this._change]).pipe((0,S.p)(([o])=>!!o),(0,I.n)(()=>(0,h.bpY)(this._org.organisation.id,"email_template_fields").pipe((0,v.T)(o=>{const a=o?.details||{};return Object.keys(a).map(l=>({id:l,name:a[l].name,description:a[l].description||"",fields:a[l].fields.map(p=>({name:p.name,description:p.description||""}))}))})).pipe((0,T.W)(()=>(0,y.of)([])))),(0,R.t)(1)),this.templates=(0,k.zV)([this._org.active_building,this._org.active_region,this._change]).pipe((0,S.p)(([o])=>!!o),(0,I.n)(([o,a])=>(0,$.p)([(0,h.bpY)(this._org.organisation.id,"email_templates").pipe((0,v.T)(l=>this._processTemplates(l,this._org.organisation.id)),(0,T.W)(()=>(0,y.of)([]))),(0,h.bpY)(o.id,"email_templates").pipe((0,v.T)(l=>this._processTemplates(l,o.id)),(0,T.W)(()=>(0,y.of)([]))),a?(0,h.bpY)(a.id,"email_templates").pipe((0,v.T)(l=>this._processTemplates(l,a.id)),(0,T.W)(()=>(0,y.of)([]))):(0,y.of)([])])),(0,v.T)(([o,a,l])=>o.concat(a).concat(l)),(0,R.t)(1)),this.filters=this._filters.asObservable(),this.filtered_templates=(0,k.zV)([this.templates,this.filters]).pipe((0,v.T)(([o,a])=>{const l=a.category||"";return o.filter(p=>p.category===l||""===l)}))}loadTemplate(t){var s=this;return(0,g.A)(function*(){return(yield s.templates.pipe((0,E.s)(1)).toPromise()).find(a=>a.id===t)})()}saveTemplate(t){var s=this;return(0,g.A)(function*(){if(!t.zone_id)return;const o=yield s.templates.pipe((0,E.s)(1)).toPromise();t.id||(t.id=`template-${(0,d.DU)(8)}`,t.created_at=(0,V._)(Date.now())),t.updated_at=(0,V._)(Date.now());const a=o.filter(C=>C.zone_id===t.zone_id);delete{...t}.zone_id,console.log("Templates:",o);const p=[...a.filter(C=>C.id!==t.id),t];yield(0,h.D58)(t.zone_id,{name:"email_templates",details:p,description:"Email Templates for Zone"}).toPromise(),(0,d.VX)("Successfully saved template")})()}removeTemplate(t){var s=this;return(0,g.A)(function*(){const l=(yield s.templates.pipe((0,E.s)(1)).toPromise()).filter(p=>p.zone_id===t.zone_id).filter(p=>p.id!==t.id);yield(0,h.D58)(t.zone_id,{name:"email_templates",details:l,description:"Email Templates for Zone"}).toPromise(),(0,d.VX)("Successfully removed template")})()}setFilters(t){this._filters.next({...this._filters.getValue(),...t})}static#e=this.\u0275fac=function(s){return new(s||n)(e.KVO(M.yb),e.KVO(d.h$))};static#t=this.\u0275prov=e.jDH({token:n,factory:n.\u0275fac,providedIn:"root"})}return n})();var j=i(24950),_=i(25175),b=i(85060),x=i(31034),J=i(69434),P=i(88328),w=i(56062);const W=()=>["/email-templates","manage"],Q=()=>({key:"subject",name:"Title"}),Z=n=>({key:"category",name:"Category",show:n}),K=()=>({key:"trigger",name:"Trigger",empty:"No Trigger"}),H=n=>({key:"zone_id",name:"Building",content:n}),q=n=>({key:"created_at",name:"Created",size:"8rem",content:n}),ee=n=>({key:"actions",name:" ",size:"3.5rem",content:n,sortable:!1}),te=(n,c,t,s,o,a)=>[n,c,t,s,o,a],ne=n=>["/email-templates","manage",n];function oe(n,c){if(1&n&&(e.j41(0,"div",19),e.EFF(1),e.nI1(2,"date"),e.k0s()),2&n){const t=c.data;e.R7$(),e.SpI(" ",e.i5U(2,1,1e3*t,"mediumDate")," ")}}function ie(n,c){1&n&&(e.j41(0,"span",22),e.EFF(1," No Building "),e.k0s())}function se(n,c){if(1&n&&(e.j41(0,"div",20),e.EFF(1),e.nI1(2,"building"),e.DNE(3,ie,2,0,"span",21),e.nI1(4,"building"),e.k0s()),2&n){let t;const s=c.data;e.R7$(),e.SpI(" ",null==(t=e.bMT(2,2,s))?null:t.display_name," "),e.R7$(2),e.Y8G("ngIf",!e.bMT(4,4,s))}}function ae(n,c){if(1&n){const t=e.RV6();e.j41(0,"button",23)(1,"app-icon"),e.EFF(2,"more_vert"),e.k0s()(),e.j41(3,"mat-menu",null,3)(5,"button",24),e.bIt("click",function(){const o=e.eBV(t).row,a=e.XpG();return e.Njj(a.sendTestEmail(o))}),e.j41(6,"div",25)(7,"app-icon",15),e.EFF(8,"send"),e.k0s(),e.j41(9,"div"),e.EFF(10,"Send Test Email"),e.k0s()()(),e.j41(11,"a",26)(12,"div",25)(13,"app-icon",15),e.EFF(14,"edit"),e.k0s(),e.j41(15,"div"),e.EFF(16,"Edit Template"),e.k0s()()(),e.j41(17,"button",24),e.bIt("click",function(){const o=e.eBV(t).row,a=e.XpG();return e.Njj(a.removeTemplate(o))}),e.j41(18,"div",25)(19,"app-icon",27),e.EFF(20," delete "),e.k0s(),e.j41(21,"div"),e.EFF(22,"Delete Template"),e.k0s()()()()}if(2&n){const t=c.row,s=e.sdS(4);e.Y8G("matMenuTriggerFor",s),e.R7$(11),e.Y8G("routerLink",e.eq3(2,ne,t.id))}}let le=(()=>{class n{constructor(t,s){this._state=t,this._org=s,this.filters=this._state.filters,this.templates=this._state.filtered_templates,this.removeTemplate=o=>this._state.removeTemplate(o)}setFilters(t){this._state.setFilters(t)}sendTestEmail(t){var s=this;return(0,g.A)(function*(){s.sending_email=t.id;const o=s._org.binding("smtp");if(!o)return(0,d.UG)("Mailing system not configured for application.");yield(0,h.f_4)(o,"Mailer").execute("send_mail",[(0,d.Ny)()?.email,t.subject,t.text,t.html,[],[],[],[],t.reply_to||null,t.from||(0,d.Ny)()?.email]),(0,d.VX)("Successfully sent test email"),s.sending_email=null})()}static#e=this.\u0275fac=function(s){return new(s||n)(e.rXU(z),e.rXU(M.yb))};static#t=this.\u0275cmp=e.VBU({type:n,selectors:[["email-templates-list"]],decls:29,vars:27,consts:[["date_template",""],["bld_template",""],["actions_template",""],["menu","matMenu"],[1,"absolute","inset-0","flex","flex-col"],[1,"flex","items-center","justify-between","p-8","space-x-2"],[1,"text-2xl","font-medium"],[1,"flex-1"],["appearance","outline",1,"w-56","no-subscript"],["placeholder","All Categories",3,"ngModelChange","ngModel"],["value",""],["value","internal"],["value","external"],["btn","","matRipple","",3,"routerLink"],[1,"ml-2"],[1,"text-2xl"],[1,"h-1/2","flex-1","w-full","px-8","overflow-y-auto","relative"],[1,"w-full","min-h-full","overflow-x-auto"],["empty_message","No group events for selected period",1,"min-w-[56rem]","w-full","block","text-sm",3,"data","columns","sortable"],[1,"opacity-60","p-4"],[1,"p-4"],["class","opacity-30",4,"ngIf"],[1,"opacity-30"],["icon","","matRipple","",1,"mx-auto",3,"matMenuTriggerFor"],["mat-menu-item","",3,"click"],[1,"flex","items-center","space-x-2"],["mat-menu-item","",3,"routerLink"],[1,"text-2xl","text-error"]],template:function(s,o){if(1&s){const a=e.RV6();e.j41(0,"div",4)(1,"div",5)(2,"h2",6),e.EFF(3,"Email Templates"),e.k0s(),e.nrm(4,"div",7),e.j41(5,"mat-form-field",8)(6,"mat-select",9),e.nI1(7,"async"),e.bIt("ngModelChange",function(p){return e.eBV(a),e.Njj(o.setFilters({category:p}))}),e.j41(8,"mat-option",10),e.EFF(9,"All Categories"),e.k0s(),e.j41(10,"mat-option",11),e.EFF(11,"Internal"),e.k0s(),e.j41(12,"mat-option",12),e.EFF(13,"External"),e.k0s()()(),e.j41(14,"a",13)(15,"div",14),e.EFF(16,"Create Template"),e.k0s(),e.j41(17,"app-icon",15),e.EFF(18,"add"),e.k0s()()(),e.j41(19,"div",16)(20,"div",17),e.nrm(21,"simple-table",18),e.nI1(22,"async"),e.DNE(23,oe,3,4,"ng-template",null,0,e.C5r)(25,se,5,6,"ng-template",null,1,e.C5r)(27,ae,23,4,"ng-template",null,2,e.C5r),e.k0s()()()}if(2&s){let a,l;const p=e.sdS(24),C=e.sdS(26),Fe=e.sdS(28);e.R7$(6),e.Y8G("ngModel",null==(a=e.bMT(7,5,o.filters))?null:a.category),e.R7$(8),e.Y8G("routerLink",e.lJ4(9,W)),e.R7$(7),e.Y8G("data",o.templates)("columns",e.l4e(20,te,e.lJ4(10,Q),e.eq3(11,Z,!(null!=(l=e.bMT(22,7,o.filters))&&l.category)),e.lJ4(13,K),e.eq3(14,H,C),e.eq3(16,q,p),e.eq3(18,ee,Fe)))("sortable",!0)}},dependencies:[u.bT,r.BC,r.vS,j.rl,_.VO,b.wT,x.kk,x.fb,x.Cp,b.r6,J.R,P.O,f.Wk,u.Jj,u.vh,w.b]})}return n})();var re=i(52352),me=i(87984),ce=i(80640),pe=i(41134),de=i(81772);const fe=()=>["/email-templates"],ue=()=>[];function ge(n,c){if(1&n&&(e.j41(0,"mat-option",31),e.EFF(1),e.k0s()),2&n){const t=c.$implicit;e.Y8G("value",t.id),e.R7$(),e.SpI(" ",t.display_name||t.name," ")}}function he(n,c){if(1&n&&(e.j41(0,"mat-option",31),e.EFF(1),e.k0s()),2&n){const t=c.$implicit;e.Y8G("value",t.id),e.R7$(),e.SpI(" ",t.name," ")}}function ve(n,c){if(1&n){const t=e.RV6();e.j41(0,"button",32),e.bIt("click",function(){const o=e.eBV(t).$implicit,a=e.XpG();return e.Njj(a.copyField(o.name))}),e.j41(1,"div",33)(2,"div"),e.EFF(3),e.k0s(),e.j41(4,"div",34),e.EFF(5),e.k0s()()()}if(2&n){const t=c.$implicit;e.R7$(3),e.JRh(t.name),e.R7$(2),e.SpI(" ",t.description," ")}}function _e(n,c){if(1&n&&(e.j41(0,"div",35)(1,"div",36),e.nrm(2,"mat-spinner",37),e.j41(3,"p"),e.EFF(4),e.k0s()()()),2&n){const t=e.XpG();e.R7$(2),e.Y8G("diameter",32),e.R7$(2),e.JRh(t.loading)}}let X=(()=>{class n extends d.Tv{constructor(t,s,o,a,l){super(),this._org=t,this._state=s,this._route=o,this._router=a,this._clipboard=l,this.loading="",this.definitions=this._state.template_definitions,this.buildings=this._org.building_list,this.form=new r.gE({id:new r.MJ(""),reply_to:new r.MJ(""),from:new r.MJ(""),subject:new r.MJ("",[r.k0.required]),category:new r.MJ("internal"),trigger:new r.MJ(""),html:new r.MJ("",[r.k0.required]),zone_id:new r.MJ("")}),this.active_trigger=null}ngOnInit(){var t=this;this.subscription("route.params",this._route.paramMap.subscribe(function(){var s=(0,g.A)(function*(o){o.has("id")&&(t.loading="Loading email template...",t.template=yield t._state.loadTemplate(o.get("id")),t.loading="",console.log("Template:",t.template),t.template?t.form.patchValue(t.template):t._router.navigate(["/email-templates","manage"]))});return function(o){return s.apply(this,arguments)}}())),this.subscription("trigger",this.form.valueChanges.subscribe(function(){var s=(0,g.A)(function*(o){if(o.trigger){const a=yield t.definitions.pipe((0,E.s)(1)).toPromise();t.active_trigger=a.find(l=>l.id===o.trigger)}});return function(o){return s.apply(this,arguments)}}()))}copyField(t){this._clipboard.copy(t),(0,d.VX)(`Copied field "${t}" to clipboard.`)}save(){var t=this;return(0,g.A)(function*(){t.loading="Saving email template...",yield t._state.saveTemplate({...t.template||{},...t.form.getRawValue(),text:(0,d.y4)(t.form.getRawValue().html||"")}),t.loading="",(0,d.VX)("Successfully saved email template"),t._router.navigate(["/email-templates"])})()}static#e=this.\u0275fac=function(s){return new(s||n)(e.rXU(M.yb),e.rXU(z),e.rXU(f.nX),e.rXU(f.Ix),e.rXU(re.B0))};static#t=this.\u0275cmp=e.VBU({type:n,selectors:[["email-template-manage"]],features:[e.Vt3],decls:66,vars:14,consts:[["tracking_menu","matMenu"],["load_state",""],[1,"absolute","inset-0","bg-base-100","overflow-auto","p-8"],[1,"max-w-full","w-[48rem]","mx-auto","min-h-full",3,"formGroup"],[1,"flex","items-center","space-x-2","mb-8"],["icon","","matRipple","",1,"-ml-8",3,"routerLink"],[1,"text-2xl","font-medium"],[1,"flex-1"],["btn","","matRipple","","type","button",1,"w-48",3,"click"],[1,"flex","items-center","space-x-4"],[1,"flex-1","space-y-2","w-1/4"],["for","zone"],["appearance","outline",1,"w-full"],["name","zone","placeholder","Select Building","formControlName","zone_id"],[3,"value",4,"ngFor","ngForOf"],["for","category"],["name","category","placeholder","Select Category","formControlName","category"],["value","internal"],["value","external"],["for","trigger"],["name","trigger","placeholder","Select Trigger","formControlName","trigger"],["value",""],["btn","","matRipple","","matTooltip","Values that get replaced in the email template when sent",1,"flex-1","mt-2",3,"disabled"],["mat-menu-item","",3,"click",4,"ngFor","ngForOf"],[1,"flex","items-center","space-x-2"],["appearance","outline",1,"flex-1"],["matInput","","placeholder","Reply to address","formControlName","reply_to"],["matInput","","placeholder","From address","formControlName","from"],["matPrefix","",1,"text-2xl","relative","-left-1"],["matInput","","placeholder","Template Subject","formControlName","subject"],["formControlName","html","placeholder","Body of the email template",1,"min-h-[calc(100vh-28rem)]","block",3,"images_allowed"],[3,"value"],["mat-menu-item","",3,"click"],[1,"flex","flex-col","leading-tight"],[1,"text-xs","opacity-30"],[1,"absolute","inset-0","bg-base-100"],[1,"h-full","w-full","flex","flex-col","items-center","justify-center","space-y-2"],[3,"diameter"]],template:function(s,o){if(1&s){const a=e.RV6();e.j41(0,"div",2)(1,"form",3)(2,"div",4)(3,"a",5)(4,"app-icon"),e.EFF(5,"arrow_back"),e.k0s()(),e.j41(6,"h2",6),e.EFF(7),e.k0s(),e.nrm(8,"div",7),e.j41(9,"button",8),e.bIt("click",function(){return e.eBV(a),e.Njj(o.save())}),e.EFF(10," Save Template "),e.k0s()(),e.j41(11,"div",9)(12,"div",10)(13,"label",11),e.EFF(14,"Building"),e.k0s(),e.j41(15,"mat-form-field",12)(16,"mat-select",13),e.DNE(17,ge,2,2,"mat-option",14),e.nI1(18,"async"),e.k0s(),e.j41(19,"mat-error"),e.EFF(20,"A building is required"),e.k0s()()(),e.j41(21,"div",10)(22,"label",15),e.EFF(23,"Category"),e.k0s(),e.j41(24,"mat-form-field",12)(25,"mat-select",16)(26,"mat-option",17),e.EFF(27," Internal "),e.k0s(),e.j41(28,"mat-option",18),e.EFF(29," External "),e.k0s()(),e.j41(30,"mat-error"),e.EFF(31,"A category is required"),e.k0s()()(),e.j41(32,"div",10)(33,"label",19),e.EFF(34,"Trigger"),e.k0s(),e.j41(35,"mat-form-field",12)(36,"mat-select",20)(37,"mat-option",21),e.EFF(38,"None"),e.k0s(),e.DNE(39,he,2,2,"mat-option",14),e.nI1(40,"async"),e.k0s(),e.j41(41,"mat-error"),e.EFF(42,"A trigger is required"),e.k0s()()(),e.j41(43,"button",22),e.EFF(44," Placeholders "),e.k0s(),e.j41(45,"mat-menu",null,0),e.DNE(47,ve,6,2,"button",23),e.k0s()(),e.j41(48,"div",24)(49,"mat-form-field",25),e.nrm(50,"input",26),e.j41(51,"mat-error"),e.EFF(52,"A reply address is required"),e.k0s()(),e.j41(53,"mat-form-field",25),e.nrm(54,"input",27),e.j41(55,"mat-error"),e.EFF(56,"A from address is required"),e.k0s()()(),e.j41(57,"mat-form-field",12)(58,"app-icon",28),e.EFF(59," description "),e.k0s(),e.nrm(60,"input",29),e.j41(61,"mat-error"),e.EFF(62,"A title for the template is required"),e.k0s()(),e.nrm(63,"rich-text-input",30),e.k0s()(),e.DNE(64,_e,5,2,"ng-template",null,1,e.C5r)}2&s&&(e.R7$(),e.Y8G("formGroup",o.form),e.R7$(2),e.Y8G("routerLink",e.lJ4(12,fe)),e.R7$(4),e.SpI(" ",null!=o.template&&o.template.id?"Edit":"New"," Email Template "),e.R7$(10),e.Y8G("ngForOf",e.bMT(18,8,o.buildings)),e.R7$(22),e.Y8G("ngForOf",e.bMT(40,10,o.definitions)),e.R7$(4),e.Y8G("disabled",!o.form.value.trigger),e.R7$(4),e.Y8G("ngForOf",(null==o.active_trigger?null:o.active_trigger.fields)||e.lJ4(13,ue)),e.R7$(16),e.Y8G("images_allowed",!0))},dependencies:[u.Sq,r.qT,r.me,r.BC,r.cb,j.rl,j.TL,j.JW,me.fg,_.VO,b.wT,x.kk,x.fb,ce.oV,pe.LG,b.r6,r.j4,r.JD,de.d,J.R,f.Wk,u.Jj]})}return n})();const ke=[{path:"",component:L,children:[{path:"",component:le}]},{path:"manage",component:X},{path:"manage/:id",component:X},{path:"**",redirectTo:""}];let ye=(()=>{class n{static#e=this.\u0275fac=function(s){return new(s||n)};static#t=this.\u0275mod=e.$C({type:n});static#n=this.\u0275inj=e.G2t({imports:[u.MD,r.YN,O.r,G.lx,N.SG,m.cQ,f.iI.forChild(ke)]})}return n})()},57915:(A,D,i)=>{i.d(D,{Qr:()=>f.Qr,nx:()=>r.n,WS:()=>f.WS,SG:()=>u.S,DD:()=>m.DD,wk:()=>m.wk,Z$:()=>m.Z$,eW:()=>m.eW,u3:()=>m.u3,tj:()=>m.tj,WE:()=>m.WE,vB:()=>m.vB,U:()=>m.U,UN:()=>m.UN,X0:()=>m.X0,DO:()=>m.DO,vq:()=>m.vq,MV:()=>m.MV});var u=i(49478),r=i(18379),f=i(53857),m=(i(17141),i(18026));i(77375),i(45762),i(3367),i(67254),i(98796),i(1781),i(27547),i(67642),i(1593)}}]);
//# sourceMappingURL=apps_concierge_src_app_email-templates_email-templates_module_ts.js.map