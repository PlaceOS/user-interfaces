"use strict";(self.webpackChunkconcierge=self.webpackChunkconcierge||[]).push([["apps_concierge_src_app_email-templates_email-templates_module_ts"],{53244:(W,x,i)=>{i.r(x),i.d(x,{EmailTemplatesModule:()=>Te});var g=i(60316),r=i(34456),f=i(26842),N=i(22168),m=i(63046),Y=i(57915),B=i(40363),e=i(7404),O=i(45189),U=i(96843);const L=["app-email-templates",""];let J=(()=>{class n{static#e=this.\u0275fac=function(a){return new(a||n)};static#t=this.\u0275cmp=e.VBU({type:n,selectors:[["","app-email-templates",""]],attrs:L,decls:5,vars:0,consts:[[1,"flex","flex-1","h-px"],[1,"relative","flex","flex-col","flex-1","w-1/2","h-full"]],template:function(a,o){1&a&&(e.nrm(0,"app-topbar"),e.j41(1,"div",0),e.nrm(2,"app-sidebar"),e.j41(3,"main",1),e.nrm(4,"router-outlet"),e.k0s()())},dependencies:[O.S,U.c,f.n3],styles:["[_nghost-%COMP%]{display:flex;flex-direction:column;height:100%;width:100%;background-color:var(--b1)}\n\n/*# sourceMappingURL=email-templates.component.ts-angular-inline--192.css.map*/"]})}return n})();var h=i(89204),d=i(77375),C=i(12185),v=i(3998),R=i(99908),F=i(90521),k=i(42175),y=i(71536),$=i(68757),M=i(8627),D=i(71963),_=i(35443),T=i(29314),V=i(66e3),I=i(7841),j=i(33602);let z=(()=>{class n{_processTemplates(t,a){const o=t.details;return((o instanceof Array?o:"")||[]).map(s=>({...s,zone_id:a}))}constructor(t,a){this._org=t,this._settings=a,this._filters=new F.t({}),this._change=new F.t(0),this.template_definitions=(0,k.zV)([this._org.active_building,this._org.active_region,this._change]).pipe((0,M.p)(([o])=>!!o),(0,D.n)(()=>(0,v.bpY)(this._org.organisation.id,"email_template_fields").pipe((0,_.T)(o=>{const s=o?.details||{};return Object.keys(s).map(l=>({id:l,name:s[l].name,name_details:s[l].name.split(":"),description:s[l].description||"",fields:s[l].fields.map(p=>({name:p.name,description:p.description||""}))}))})).pipe((0,T.W)(()=>(0,y.of)([])))),(0,V.M)(o=>console.log("Templates:",o)),(0,I.t)(1)),this.templates=(0,k.zV)([this._org.active_building,this._org.active_region,this._change]).pipe((0,M.p)(([o])=>!!o),(0,D.n)(([o,s])=>(0,$.p)([(0,v.bpY)(this._org.organisation.id,"email_templates").pipe((0,_.T)(l=>this._processTemplates(l,this._org.organisation.id)),(0,T.W)(()=>(0,y.of)([]))),(0,v.bpY)(o.id,"email_templates").pipe((0,_.T)(l=>this._processTemplates(l,o.id)),(0,T.W)(()=>(0,y.of)([]))),s?(0,v.bpY)(s.id,"email_templates").pipe((0,_.T)(l=>this._processTemplates(l,s.id)),(0,T.W)(()=>(0,y.of)([]))):(0,y.of)([])])),(0,_.T)(([o,s,l])=>o.concat(s).concat(l)),(0,I.t)(1)),this.filters=this._filters.asObservable(),this.filtered_templates=(0,k.zV)([this.templates,this.filters]).pipe((0,_.T)(([o,s])=>{const l=s.category||"";return o.filter(p=>p.category===l||""===l)}))}loadTemplate(t){var a=this;return(0,h.A)(function*(){return(yield a.templates.pipe((0,j.s)(1)).toPromise()).find(s=>s.id===t)})()}saveTemplate(t){var a=this;return(0,h.A)(function*(){if(!t.zone_id)return;const o=yield a.templates.pipe((0,j.s)(1)).toPromise();t.id||(t.id=`template-${(0,d.DU)(8)}`,t.created_at=(0,R._)(Date.now())),t.updated_at=(0,R._)(Date.now());const s=o.filter(b=>b.zone_id===t.zone_id);delete{...t}.zone_id,console.log("Templates:",o);const p=[...s.filter(b=>b.id!==t.id),t];yield(0,v.D58)(t.zone_id,{name:"email_templates",details:p,description:"Email Templates for Zone"}).toPromise(),(0,d.VX)("Successfully saved template")})()}removeTemplate(t){var a=this;return(0,h.A)(function*(){const l=(yield a.templates.pipe((0,j.s)(1)).toPromise()).filter(p=>p.zone_id===t.zone_id).filter(p=>p.id!==t.id);yield(0,v.D58)(t.zone_id,{name:"email_templates",details:l,description:"Email Templates for Zone"}).toPromise(),(0,d.VX)("Successfully removed template")})()}setFilters(t){this._filters.next({...this._filters.getValue(),...t})}static#e=this.\u0275fac=function(a){return new(a||n)(e.KVO(C.yb),e.KVO(d.h$))};static#t=this.\u0275prov=e.jDH({token:n,factory:n.\u0275fac,providedIn:"root"})}return n})();var u=i(24950),G=i(25175),S=i(85060),E=i(31034),X=i(69434),w=i(88328),Q=i(56062);const Z=()=>["/email-templates","manage"],K=()=>({key:"subject",name:"Title"}),H=n=>({key:"category",name:"Category",show:n}),q=()=>({key:"trigger",name:"Trigger",empty:"No Trigger"}),ee=n=>({key:"zone_id",name:"Building",content:n}),te=n=>({key:"created_at",name:"Created",size:"8rem",content:n}),ne=n=>({key:"actions",name:" ",size:"3.5rem",content:n,sortable:!1}),oe=(n,c,t,a,o,s)=>[n,c,t,a,o,s],ie=n=>["/email-templates","manage",n];function ae(n,c){if(1&n&&(e.j41(0,"div",19),e.EFF(1),e.nI1(2,"date"),e.k0s()),2&n){const t=c.data;e.R7$(),e.SpI(" ",e.i5U(2,1,1e3*t,"mediumDate")," ")}}function se(n,c){1&n&&(e.j41(0,"span",22),e.EFF(1," No Building "),e.k0s())}function le(n,c){if(1&n&&(e.j41(0,"div",20),e.EFF(1),e.nI1(2,"building"),e.DNE(3,se,2,0,"span",21),e.nI1(4,"building"),e.k0s()),2&n){let t;const a=c.data;e.R7$(),e.SpI(" ",null==(t=e.bMT(2,2,a))?null:t.display_name," "),e.R7$(2),e.Y8G("ngIf",!e.bMT(4,4,a))}}function re(n,c){if(1&n){const t=e.RV6();e.j41(0,"button",23)(1,"app-icon"),e.EFF(2,"more_vert"),e.k0s()(),e.j41(3,"mat-menu",null,3)(5,"button",24),e.bIt("click",function(){const o=e.eBV(t).row,s=e.XpG();return e.Njj(s.sendTestEmail(o))}),e.j41(6,"div",25)(7,"app-icon",15),e.EFF(8,"send"),e.k0s(),e.j41(9,"div"),e.EFF(10,"Send Test Email"),e.k0s()()(),e.j41(11,"a",26)(12,"div",25)(13,"app-icon",15),e.EFF(14,"edit"),e.k0s(),e.j41(15,"div"),e.EFF(16,"Edit Template"),e.k0s()()(),e.j41(17,"button",24),e.bIt("click",function(){const o=e.eBV(t).row,s=e.XpG();return e.Njj(s.removeTemplate(o))}),e.j41(18,"div",25)(19,"app-icon",27),e.EFF(20," delete "),e.k0s(),e.j41(21,"div"),e.EFF(22,"Delete Template"),e.k0s()()()()}if(2&n){const t=c.row,a=e.sdS(4);e.Y8G("matMenuTriggerFor",a),e.R7$(11),e.Y8G("routerLink",e.eq3(2,ie,t.id))}}let me=(()=>{class n{constructor(t,a){this._state=t,this._org=a,this.filters=this._state.filters,this.templates=this._state.filtered_templates,this.removeTemplate=o=>this._state.removeTemplate(o)}setFilters(t){this._state.setFilters(t)}sendTestEmail(t){var a=this;return(0,h.A)(function*(){a.sending_email=t.id;const o=a._org.binding("smtp");if(!o)return(0,d.UG)("Mailing system not configured for application.");yield(0,v.f_4)(o,"Mailer").execute("send_mail",[(0,d.Ny)()?.email,t.subject,t.text,t.html,[],[],[],[],t.reply_to||null,t.from||(0,d.Ny)()?.email]),(0,d.VX)("Successfully sent test email"),a.sending_email=null})()}static#e=this.\u0275fac=function(a){return new(a||n)(e.rXU(z),e.rXU(C.yb))};static#t=this.\u0275cmp=e.VBU({type:n,selectors:[["email-templates-list"]],decls:29,vars:27,consts:[["date_template",""],["bld_template",""],["actions_template",""],["menu","matMenu"],[1,"absolute","inset-0","flex","flex-col"],[1,"flex","items-center","justify-between","p-8","space-x-2"],[1,"text-2xl","font-medium"],[1,"flex-1"],["appearance","outline",1,"w-56","no-subscript"],["placeholder","All Categories",3,"ngModelChange","ngModel"],["value",""],["value","internal"],["value","external"],["btn","","matRipple","",3,"routerLink"],[1,"ml-2"],[1,"text-2xl"],[1,"h-1/2","flex-1","w-full","px-8","overflow-y-auto","relative"],[1,"w-full","min-h-full","overflow-x-auto"],["empty_message","No group events for selected period",1,"min-w-[56rem]","w-full","block","text-sm",3,"data","columns","sortable"],[1,"opacity-60","p-4"],[1,"p-4"],["class","opacity-30",4,"ngIf"],[1,"opacity-30"],["icon","","matRipple","",1,"mx-auto",3,"matMenuTriggerFor"],["mat-menu-item","",3,"click"],[1,"flex","items-center","space-x-2"],["mat-menu-item","",3,"routerLink"],[1,"text-2xl","text-error"]],template:function(a,o){if(1&a){const s=e.RV6();e.j41(0,"div",4)(1,"div",5)(2,"h2",6),e.EFF(3,"Email Templates"),e.k0s(),e.nrm(4,"div",7),e.j41(5,"mat-form-field",8)(6,"mat-select",9),e.nI1(7,"async"),e.bIt("ngModelChange",function(p){return e.eBV(s),e.Njj(o.setFilters({category:p}))}),e.j41(8,"mat-option",10),e.EFF(9,"All Categories"),e.k0s(),e.j41(10,"mat-option",11),e.EFF(11,"Internal"),e.k0s(),e.j41(12,"mat-option",12),e.EFF(13,"External"),e.k0s()()(),e.j41(14,"a",13)(15,"div",14),e.EFF(16,"Create Template"),e.k0s(),e.j41(17,"app-icon",15),e.EFF(18,"add"),e.k0s()()(),e.j41(19,"div",16)(20,"div",17),e.nrm(21,"simple-table",18),e.nI1(22,"async"),e.DNE(23,ae,3,4,"ng-template",null,0,e.C5r)(25,le,5,6,"ng-template",null,1,e.C5r)(27,re,23,4,"ng-template",null,2,e.C5r),e.k0s()()()}if(2&a){let s,l;const p=e.sdS(24),b=e.sdS(26),Ee=e.sdS(28);e.R7$(6),e.Y8G("ngModel",null==(s=e.bMT(7,5,o.filters))?null:s.category),e.R7$(8),e.Y8G("routerLink",e.lJ4(9,Z)),e.R7$(7),e.Y8G("data",o.templates)("columns",e.l4e(20,oe,e.lJ4(10,K),e.eq3(11,H,!(null!=(l=e.bMT(22,7,o.filters))&&l.category)),e.lJ4(13,q),e.eq3(14,ee,b),e.eq3(16,te,p),e.eq3(18,ne,Ee)))("sortable",!0)}},dependencies:[g.bT,r.BC,r.vS,u.rl,G.VO,S.wT,E.kk,E.fb,E.Cp,S.r6,X.R,w.O,f.Wk,g.Jj,g.vh,Q.b]})}return n})();var ce=i(52352),pe=i(87984),de=i(80640),fe=i(41134),ue=i(81772);const ge=()=>["/email-templates"],A=()=>[];function he(n,c){if(1&n&&(e.j41(0,"mat-option",33),e.EFF(1),e.k0s()),2&n){const t=c.$implicit;e.Y8G("value",t.id),e.R7$(),e.SpI(" ",t.display_name||t.name," ")}}function ve(n,c){if(1&n&&(e.j41(0,"mat-option",33)(1,"div",34)(2,"div",35),e.EFF(3),e.k0s(),e.j41(4,"div",36),e.EFF(5),e.j41(6,"span",37),e.EFF(7,":"),e.k0s()()()()),2&n){const t=c.$implicit;e.Y8G("value",t.id),e.R7$(3),e.SpI(" ",t.name_details[0]," "),e.R7$(2),e.SpI(" ",t.name_details[1]," ")}}function _e(n,c){if(1&n){const t=e.RV6();e.j41(0,"button",38),e.bIt("click",function(){const o=e.eBV(t).$implicit,s=e.XpG();return e.Njj(s.copyField(o.name))}),e.j41(1,"div",39)(2,"div",40),e.EFF(3),e.k0s(),e.j41(4,"div",35),e.EFF(5),e.k0s()()()}if(2&n){const t=c.$implicit;e.R7$(3),e.SpI(" ",t.name," "),e.R7$(2),e.SpI(" ",t.description," ")}}function ke(n,c){1&n&&(e.j41(0,"button",41),e.EFF(1," No placeholders available "),e.k0s()),2&n&&e.Y8G("disabled",!0)}function ye(n,c){if(1&n&&(e.j41(0,"div",42)(1,"div",43),e.nrm(2,"mat-spinner",44),e.j41(3,"p"),e.EFF(4),e.k0s()()()),2&n){const t=e.XpG();e.R7$(2),e.Y8G("diameter",32),e.R7$(2),e.JRh(t.loading)}}let P=(()=>{class n extends d.Tv{constructor(t,a,o,s,l){super(),this._org=t,this._state=a,this._route=o,this._router=s,this._clipboard=l,this.loading="",this.definitions=this._state.template_definitions,this.buildings=this._org.building_list,this.form=new r.gE({id:new r.MJ(""),reply_to:new r.MJ(""),from:new r.MJ(""),subject:new r.MJ("",[r.k0.required]),category:new r.MJ("internal"),trigger:new r.MJ(""),html:new r.MJ("",[r.k0.required]),zone_id:new r.MJ("")}),this.active_trigger=null}ngOnInit(){var t=this;this.subscription("route.params",this._route.paramMap.subscribe(function(){var a=(0,h.A)(function*(o){o.has("id")&&(t.loading="Loading email template...",t.template=yield t._state.loadTemplate(o.get("id")),t.loading="",console.log("Template:",t.template),t.template?t.form.patchValue(t.template):t._router.navigate(["/email-templates","manage"]))});return function(o){return a.apply(this,arguments)}}())),this.subscription("trigger",this.form.valueChanges.subscribe(function(){var a=(0,h.A)(function*(o){if(o.trigger){const s=yield t.definitions.pipe((0,j.s)(1)).toPromise();t.active_trigger=s.find(l=>l.id===o.trigger)}});return function(o){return a.apply(this,arguments)}}()))}copyField(t){this._clipboard.copy("%{field}"),(0,d.VX)(`Copied field "${t}" to clipboard.`)}save(){var t=this;return(0,h.A)(function*(){t.loading="Saving email template...",yield t._state.saveTemplate({...t.template||{},...t.form.getRawValue(),text:(0,d.y4)(t.form.getRawValue().html||"")}),t.loading="",(0,d.VX)("Successfully saved email template"),t._router.navigate(["/email-templates"])})()}static#e=this.\u0275fac=function(a){return new(a||n)(e.rXU(C.yb),e.rXU(z),e.rXU(f.nX),e.rXU(f.Ix),e.rXU(ce.B0))};static#t=this.\u0275cmp=e.VBU({type:n,selectors:[["email-template-manage"]],features:[e.Vt3],decls:69,vars:17,consts:[["tracking_menu","matMenu"],["load_state",""],[1,"absolute","inset-0","bg-base-100","overflow-auto","p-8"],[1,"max-w-full","w-[48rem]","mx-auto","min-h-full",3,"formGroup"],[1,"flex","items-center","space-x-2","mb-8"],["icon","","matRipple","",1,"-ml-8",3,"routerLink"],[1,"text-2xl","font-medium"],[1,"flex-1"],["btn","","matRipple","","type","button",1,"w-48",3,"click"],[1,"flex","items-center","space-x-4"],[1,"flex-1","space-y-2","w-1/4"],["for","zone"],["appearance","outline",1,"w-full"],["name","zone","placeholder","Select Building","formControlName","zone_id"],["value",""],[3,"value",4,"ngFor","ngForOf"],["for","category"],["name","category","placeholder","Select Category","formControlName","category"],["value","internal"],["value","external"],["for","trigger"],["name","trigger","placeholder","Select Trigger","formControlName","trigger"],["btn","","matRipple","","matTooltip","Values that get replaced in the email template when sent",1,"flex-1","mt-2",3,"disabled","matMenuTriggerFor"],[1,"max-h-[24rem]"],["mat-menu-item","",3,"click",4,"ngFor","ngForOf"],["mat-menu-item","",3,"disabled",4,"ngIf"],[1,"flex","items-center","space-x-2"],["appearance","outline",1,"flex-1"],["matInput","","placeholder","Reply to address","formControlName","reply_to"],["matInput","","placeholder","From address","formControlName","from"],["matPrefix","",1,"text-2xl","relative","-left-1"],["matInput","","placeholder","Template Subject","formControlName","subject"],["formControlName","html","placeholder","Body of the email template",1,"min-h-[calc(100vh-28rem)]","block",3,"images_allowed"],[3,"value"],[1,"flex","flex-col-reverse","leading-tight","my-2"],[1,"text-xs","opacity-30"],[1,"text-sm"],[1,"opacity-0"],["mat-menu-item","",3,"click"],[1,"flex","flex-col","leading-tight"],[1,"font-mono","text-sm"],["mat-menu-item","",3,"disabled"],[1,"absolute","inset-0","bg-base-100"],[1,"h-full","w-full","flex","flex-col","items-center","justify-center","space-y-2"],[3,"diameter"]],template:function(a,o){if(1&a){const s=e.RV6();e.j41(0,"div",2)(1,"form",3)(2,"div",4)(3,"a",5)(4,"app-icon"),e.EFF(5,"arrow_back"),e.k0s()(),e.j41(6,"h2",6),e.EFF(7),e.k0s(),e.nrm(8,"div",7),e.j41(9,"button",8),e.bIt("click",function(){return e.eBV(s),e.Njj(o.save())}),e.EFF(10," Save Template "),e.k0s()(),e.j41(11,"div",9)(12,"div",10)(13,"label",11),e.EFF(14,"Building"),e.k0s(),e.j41(15,"mat-form-field",12)(16,"mat-select",13)(17,"mat-option",14),e.EFF(18," No Building "),e.k0s(),e.DNE(19,he,2,2,"mat-option",15),e.nI1(20,"async"),e.k0s(),e.j41(21,"mat-error"),e.EFF(22,"A building is required"),e.k0s()()(),e.j41(23,"div",10)(24,"label",16),e.EFF(25,"Category"),e.k0s(),e.j41(26,"mat-form-field",12)(27,"mat-select",17)(28,"mat-option",18),e.EFF(29," Internal "),e.k0s(),e.j41(30,"mat-option",19),e.EFF(31," External "),e.k0s()(),e.j41(32,"mat-error"),e.EFF(33,"A category is required"),e.k0s()()(),e.j41(34,"div",10)(35,"label",20),e.EFF(36,"Trigger"),e.k0s(),e.j41(37,"mat-form-field",12)(38,"mat-select",21)(39,"mat-option",14),e.EFF(40,"None"),e.k0s(),e.DNE(41,ve,8,3,"mat-option",15),e.nI1(42,"async"),e.k0s(),e.j41(43,"mat-error"),e.EFF(44,"A trigger is required"),e.k0s()()(),e.j41(45,"button",22),e.EFF(46," Placeholders "),e.k0s(),e.j41(47,"mat-menu",23,0),e.DNE(49,_e,6,2,"button",24)(50,ke,2,1,"button",25),e.k0s()(),e.j41(51,"div",26)(52,"mat-form-field",27),e.nrm(53,"input",28),e.j41(54,"mat-error"),e.EFF(55,"A reply address is required"),e.k0s()(),e.j41(56,"mat-form-field",27),e.nrm(57,"input",29),e.j41(58,"mat-error"),e.EFF(59,"A from address is required"),e.k0s()()(),e.j41(60,"mat-form-field",12)(61,"app-icon",30),e.EFF(62," description "),e.k0s(),e.nrm(63,"input",31),e.j41(64,"mat-error"),e.EFF(65,"A title for the template is required"),e.k0s()(),e.nrm(66,"rich-text-input",32),e.k0s()(),e.DNE(67,ye,5,2,"ng-template",null,1,e.C5r)}if(2&a){const s=e.sdS(48);e.R7$(),e.Y8G("formGroup",o.form),e.R7$(2),e.Y8G("routerLink",e.lJ4(14,ge)),e.R7$(4),e.SpI(" ",null!=o.template&&o.template.id?"Edit":"New"," Email Template "),e.R7$(12),e.Y8G("ngForOf",e.bMT(20,10,o.buildings)),e.R7$(22),e.Y8G("ngForOf",e.bMT(42,12,o.definitions)),e.R7$(4),e.Y8G("disabled",!o.form.value.trigger)("matMenuTriggerFor",s),e.R7$(4),e.Y8G("ngForOf",(null==o.active_trigger?null:o.active_trigger.fields)||e.lJ4(15,A)),e.R7$(),e.Y8G("ngIf",!((null==o.active_trigger?null:o.active_trigger.fields)||e.lJ4(16,A)).length),e.R7$(16),e.Y8G("images_allowed",!0)}},dependencies:[g.Sq,g.bT,r.qT,r.me,r.BC,r.cb,u.rl,u.TL,u.JW,pe.fg,G.VO,S.wT,E.kk,E.fb,E.Cp,de.oV,fe.LG,S.r6,r.j4,r.JD,ue.d,X.R,f.Wk,g.Jj]})}return n})();const Fe=[{path:"",component:J,children:[{path:"",component:me}]},{path:"manage",component:P},{path:"manage/:id",component:P},{path:"**",redirectTo:""}];let Te=(()=>{class n{static#e=this.\u0275fac=function(a){return new(a||n)};static#t=this.\u0275mod=e.$C({type:n});static#n=this.\u0275inj=e.G2t({imports:[g.MD,r.YN,B.r,N.lx,Y.SG,m.cQ,f.iI.forChild(Fe)]})}return n})()},57915:(W,x,i)=>{i.d(x,{Qr:()=>f.Qr,nx:()=>r.n,me:()=>f.me,WS:()=>f.WS,SG:()=>g.S,DD:()=>m.DD,wk:()=>m.wk,Z$:()=>m.Z$,eW:()=>m.eW,u3:()=>m.u3,tj:()=>m.tj,WE:()=>m.WE,vB:()=>m.vB,U:()=>m.U,UN:()=>m.UN,X0:()=>m.X0,DO:()=>m.DO,vq:()=>m.vq,MV:()=>m.MV});var g=i(49478),r=i(18379),f=i(53857),m=(i(17141),i(18026));i(77375),i(45762),i(3367),i(67254),i(98796),i(1781),i(27547),i(67642),i(1593)}}]);
//# sourceMappingURL=apps_concierge_src_app_email-templates_email-templates_module_ts.js.map